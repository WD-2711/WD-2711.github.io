<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>frida-reverse-analysis-2 | wd-z711&#39;s B10g</title>
  <meta name="author" content="wd-z711">
  
  <meta name="description" content="Common student in China. Interested in web &amp; re.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="frida-reverse-analysis-2"/>
  <meta property="og:site_name" content="wd-z711&#39;s B10g"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'G-YHJSKZDC3Y', 'auto');
  ga('send', 'pageview');
</script>




<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="wd-z711's B10g" type="application/atom+xml">
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">wd-z711&#39;s B10g</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> frida-reverse-analysis-2</h1>
		</div>
	



<div class="row post">

	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h1 id="Frida逆向与协议分析-2"><a href="#Frida逆向与协议分析-2" class="headerlink" title="Frida逆向与协议分析-2"></a>Frida逆向与协议分析-2</h1><p>&emsp;frida逆向与协议分析第二部分。</p>
<span id="more"></span>
<h2 id="0x03-Frida逆向之违法App协议分析与取证实战"><a href="#0x03-Frida逆向之违法App协议分析与取证实战" class="headerlink" title="0x03 Frida逆向之违法App协议分析与取证实战"></a>0x03 Frida逆向之违法App协议分析与取证实战</h2><p>&emsp;之前介绍了frida定位关键类的两种方式：基于trace（objection、Zentracer）、基于内存（Java.choose寻找实例）。本章以两个违法样本为例，对app关键协议进行分析，从而巩固之前的知识。</p>
<h3 id="加固app协议分析"><a href="#加固app协议分析" class="headerlink" title="加固app协议分析"></a>加固app协议分析</h3><h4 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h4><p>&emsp;抓包往往可以<strong>快速定位关键接口函数的位置</strong>。</p>
<p>&emsp;抓包原理：在手机上设置代理，将手机流量数据转发到计算机的代理软件后再完成上网，这样就可以再计算机上监听手机上的流量数据。由于中间人抓包无法应对app使用Https等加密协议进行通信的情况，因此需要<strong>将代理软件的证书导入手机系统并添加到证书信任列表中</strong>。如果app不信任用户添加到系统中的证书，那么需要<strong>将证书从用户信任去移动到系统信任列表中</strong>。</p>
<p>&emsp;代理方式有两种：</p>
<p>（1）wifi代理（应用层），如下所示：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231009213402929.png" alt="image-20231009213402929" style="zoom:67%;" /></p>
<p>&emsp;这种方式有两个弊端：（a）无法处理非http通信，例如websocket。（b）容易被app检测到，相关代码为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.getProperty(&quot;http.proxyHost&quot;)</span><br></pre></td></tr></table></figure>
<p>（2）vpn代理（更加推荐），相当于虚拟新网卡并修改手机路由表，工具为postern（注意要匹配所有地址）。</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231009230301580.png" alt="image-20231009230301580" style="zoom:67%;" /></p>
<p>&emsp;linux中间人中安装charles，并设置代理：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231009231938941.png" alt="image-20231009231938941" style="zoom:67%;" /></p>
<p>&emsp;movetv.apk的登陆界面抓包如下：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231009234020487.png" alt="image-20231009234020487" style="zoom:67%;" /></p>
<p><img src="/images/frida-reverse-analysis-2/image-20231009234104412.png" alt="image-20231009234104412" style="zoom:67%;" /></p>
<h4 id="注册-登录协议分析"><a href="#注册-登录协议分析" class="headerlink" title="注册/登录协议分析"></a>注册/登录协议分析</h4><p>&emsp;通过抓包分析，name与pass分别代表用户名与密码，而login始终为”login”。而key、rightkey、memi1等字段暂时还不确定。</p>
<p>&emsp;要对这些字段进行分析，需要<code>找到字段形成的地方</code>。除了<strong>静态工具分析</strong>外，推荐使用前面介绍的快速定位关键类的方式，即<code>基于内存枚举的关键类定位方案</code>，以确定字段形成的位置。</p>
<p>&emsp;在此，基于用户登录一定要单击<code>登录</code>按钮的特性，而按钮button属于view的继承类，因此可以通过hook view类的onClick函数快速得到当前控件的onClick函数所在的类，如下hookEvent.js所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jclazz = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> jobj = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getObjClassName</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!jclazz)&#123;</span><br><span class="line">        <span class="keyword">var</span> jclazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Class&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!jobj)&#123;</span><br><span class="line">        <span class="keyword">var</span> jobj = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Object&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> jclazz.<span class="property">getName</span>.<span class="title function_">call</span>(jobj.<span class="property">getClass</span>.<span class="title function_">call</span>(obj))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">watch</span>(<span class="params">obj, mtdName</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> listener_name = <span class="title function_">getObjClassName</span>(obj)</span><br><span class="line">    <span class="keyword">var</span> target = <span class="title class_">Java</span>.<span class="title function_">use</span>(listener_name)</span><br><span class="line">    <span class="comment">// target should have onClick method</span></span><br><span class="line">    <span class="keyword">if</span>(!target || !mtdName <span class="keyword">in</span> target)&#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    target[mtdName].<span class="property">overloads</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">overload</span>)&#123;</span><br><span class="line">        overload.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[WatchEvent] &quot;</span> + mtdName + <span class="string">&quot;: &quot;</span> + <span class="title function_">getObjClassName</span>(<span class="variable language_">this</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>[mtdName].<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">OnClickListener</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// start in spawn mode</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.view.View&quot;</span>).<span class="property">setOnClickListener</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">listener</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(listener != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="title function_">watch</span>(listener, <span class="string">&#x27;onClick&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setOnClickListener</span>(listener)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// start in attach mode</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;android.view.View$ListenerInfo&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">                instance = instance.<span class="property">mOnClickListener</span>.<span class="property">value</span></span><br><span class="line">                <span class="keyword">if</span>(instance)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;mOnClickListener : &quot;</span> + <span class="title function_">getObjClassName</span>(instance))</span><br><span class="line">                    <span class="title function_">watch</span>(instance, <span class="string">&#x27;onClick&#x27;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="title class_">OnClickListener</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 注入到前台 app 中</span><br><span class="line">frida -U -F -l hookEvent.js</span><br></pre></td></tr></table></figure>
<p>&emsp;结果为：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010110906554.png" alt="image-20231010110906554" style="zoom:67%;" /></p>
<p>&emsp;因此，找到字段形成的地方为<code>com.cz.babySister.activity.LoginActivity</code>。</p>
<p>&emsp;之后，要得到此类具体的代码，可以通过静态反编译工具进行。发现进行<a target="_blank" rel="noopener" href="https://www.isisy.com/1420.html">加壳处理</a>：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010112211340.png" alt="image-20231010112211340" style="zoom:67%;" /></p>
<p>&emsp;可以利用脱壳工具进行脱壳，例如一代<code>frida_dexdump</code>，二代抽取脱壳<code>frida_fart|FART</code>等。在此使用frida_dexdump，流程见<a target="_blank" rel="noopener" href="https://github.com/hluwa/frida-dexdump">链接</a>。脱壳出5个dex，在dex3中找到：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010115547318.png" alt="image-20231010115547318" style="zoom:67%;" /></p>
<p>&emsp;其中，猜测b()函数应该是提交用户名与密码到服务器的函数。使用objection对b()函数进行注入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objection -g com.cz.babySister explore</span><br><span class="line">android hooking watch class_method com.cz.babySister.activity.LoginActivity.b --dump-args --dump-return --dump-backtrace</span><br></pre></td></tr></table></figure>
<p>&emsp;结果如下所示：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010120458729.png" alt="image-20231010120458729" style="zoom:80%;" /></p>
<p>&emsp;因此确定b()传递用户名与密码。在用静态分析跟踪实现，最终确认到了q()函数，但是跟进后发现全为nop，如下所示：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010125607830.png" alt="image-20231010125607830" style="zoom:67%;" /></p>
<p>&emsp;经过查询资料，发现是<a target="_blank" rel="noopener" href="https://blog.csdn.net/zhangmiaoping23/article/details/52160473">二代抽取加固</a>，使用frida_fart，按照<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_15101562/2622401">链接</a>进行脱壳（注意到对movetv.apk设置读取sd卡的权限）。经历千辛万苦，终于找到了正常的逻辑：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010152911816.png" alt="image-20231010152911816" style="zoom:67%;" /></p>
<p>&emsp;依次跟进v5（key）、v6（rightkey）、v4（memi1）的实现逻辑，如下所示：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010153119863.png" alt="image-20231010153119863" style="zoom:67%;" /></p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010153237044.png" alt="image-20231010153237044" style="zoom:67%;" /></p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010153542277.png" alt="image-20231010153542277" style="zoom:67%;" /></p>
<p>&emsp;审计上述代码，发现：v5（key）实际上是app的签名，v6（rightkey）是app所安装的包的证书部分，v4（memi1）是android_id。这些值都是固定值，因此，无需借助app，只需要输入正确的用户名与密码，再传入固定的key、rightkey、memi1即可。</p>
<p>&emsp;app注册的逻辑与登陆类似。最终可以<strong>用python实现脱机注册与登录</strong>，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># invoke.py</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">requests.packages.urllib3.disable_warnings()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">tv</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.root = <span class="string">&quot;http://39.108.64.125/WebRoot/superMaster/Server&quot;</span></span><br><span class="line">        self.memi1 = <span class="string">&quot;34463b7d13ee6ad9&quot;</span></span><br><span class="line">        self.rightkey = <span class="string">&quot;376035775&quot;</span></span><br><span class="line">        self.key = <span class="string">&quot;308202d5308201bda00302010202041669d9bf300d06092a864886f70d01010b0500301b310b3009060355040613023836310c300a06035504031303776569301e170d3136303731383038313935395a170d3431303731323038313935395a301b310b3009060355040613023836310c300a0603550403130377656930820122300d06092a864886f70d01010105000382010f003082010a028201010095f85892400aae03ca4ed9dcd838d162290ae8dd51939aac6ecfde8282f207c4cd9e507929a279e0a36f1e4847330cb53908c92915b2c6a93d7064be452d073a472093f7ca14f4ab68f827582fe0988e9e4bc8a6ea3b56001cbbbb760f9eec571b0bbc97392e65aaf08c686f0e2ba353896d48a37c36716239977bd0e4dd878025cab497d8164537aec9f6599eefb98577dce972a1b794e211226520e23497beec3fd8548bb5b4d263120d40115cca28116bac32378df5033f536a0d7367fef78c587fefed28c5c9b35ba684ed6e46d9369c40950cf7ad7236d10b7a51dfd2a8f218db72323bbd19f46947410b1191f263012ad4ba8f749223e37591254ee7f50203010001a321301f301d0603551d0e041604143d43284bd5e4b0d322c9962a5b70aad4dcbc3634300d06092a864886f70d01010b050003820101000f04c51ff763311aa011777ba2842b441b15c316373d1e1ed4116cf86e29d55c6ed3fa4c475251b1fb4fac57195dbca0166ebe565d9834552a3758b97c4528bab1f7ab82bb3a9faa932f5bc10943f3daf52e0fe5889ffb58a6be67ea1c9a2fb37dc8aa6f3af476039a467336991a4e52dccd520195cd473eb5b984e702ed9ff638a14c3abb575a7a80ae4062084d1138a06a20e173be9df32df631311b07352898706198ddebaaa011f0da8e5f288f7cfb77505bc943f6476d6cc1feef56b68137aad91f23c4bb772169539d05653a6f0d75f7192164e822b934322f3a975df677903b1667f5dc1e9ddb185da3281d31bfb8f67a84bd23bbcb398f8bb637dd72&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, data=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            data = &#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> requests.post(url = self.root, data = data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register</span>(<span class="params">self, name, pw</span>):</span><br><span class="line">        ret = self.post(&#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>:name, </span><br><span class="line">            <span class="string">&quot;pass&quot;</span>:pw,</span><br><span class="line">            <span class="string">&quot;memi1&quot;</span>:self.memi1,</span><br><span class="line">            <span class="string">&quot;key&quot;</span>:self.key,</span><br><span class="line">            <span class="string">&quot;rightkey&quot;</span>:self.rightkey,</span><br><span class="line">            <span class="string">&quot;register&quot;</span>:<span class="string">&quot;register&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;register: &quot;</span>, ret.content.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">self, name, pw</span>):</span><br><span class="line">        ret = self.post(&#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>:name, </span><br><span class="line">            <span class="string">&quot;pass&quot;</span>:pw,</span><br><span class="line">            <span class="string">&quot;memi1&quot;</span>:self.memi1,</span><br><span class="line">            <span class="string">&quot;key&quot;</span>:self.key,</span><br><span class="line">            <span class="string">&quot;rightkey&quot;</span>:self.rightkey,</span><br><span class="line">            <span class="string">&quot;login&quot;</span>:<span class="string">&quot;login&quot;</span></span><br><span class="line">        &#125;)       </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;login: &quot;</span>, ret.content.decode(<span class="string">&#x27;utf-8&#x27;</span>)) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    tv = tv()</span><br><span class="line">    <span class="comment"># register</span></span><br><span class="line">    <span class="built_in">print</span>(tv.register(<span class="string">&quot;wd2711&quot;</span>, <span class="string">&quot;1111&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># login</span></span><br><span class="line">    <span class="built_in">print</span>(tv.login(<span class="string">&quot;wd2711&quot;</span>, <span class="string">&quot;1111&quot;</span>))</span><br></pre></td></tr></table></figure>
<p>&emsp;结果如下所示：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010155627948.png" alt="image-20231010155627948" style="zoom:67%;" /></p>
<h3 id="违法应用取证分析与vip破解"><a href="#违法应用取证分析与vip破解" class="headerlink" title="违法应用取证分析与vip破解"></a>违法应用取证分析与vip破解</h3><p>&emsp;安装fulao2.apk。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb install fulao2.apk</span><br></pre></td></tr></table></figure>
<h4 id="vip清晰度破解"><a href="#vip清晰度破解" class="headerlink" title="vip清晰度破解"></a>vip清晰度破解</h4><p>&emsp;手机app对应的服务器好像寄了，如下所示：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010163343163.png" alt="image-20231010163343163" style="zoom:67%;" /></p>
<p>&emsp;ok，那抓不了包了，日了。那直接定位关键类，由于书中写了，清晰度切换是一个按钮控件，这需要vip。因此，我们只需要使用之前抓取按钮的脚本hookEvent.js即可。但是由于我们进不去页面呀（hookEvent.js，此时清晰度控件应该还未加载），只能抓取到：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010164845820.png" alt="image-20231010164845820" style="zoom:67%;" /></p>
<p>&emsp;正常的话，应该抓取到<code>com.ilulutv.fulao2.film.l$t</code>。</p>
<p>&emsp;且验证此apk未加壳（PKID不准，movetv.apk放进去也显示这个）：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010165814405.png" alt="image-20231010165814405" style="zoom:67%;" /></p>
<p>&emsp;定位到<code>com.ilulutv.fulao2.film.l$t</code>这个类，如下所示，可以看到是一个判断语句。</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010170758627.png" alt="image-20231010170758627" style="zoom:67%;" /></p>
<p>&emsp;之后分析各个判断语句之后执行的操作：</p>
<p>（1）<code>this.d.i</code>：生成一个对话框，其中要求升级vip。</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010172852843.png" alt="image-20231010172852843" style="zoom:67%;" /></p>
<p>（2）…</p>
<p>&emsp;那么，如果将<code>l.d(this.d)</code>的值设置为true即可。由于此app已无法正常访问，因此以书中为准。使用frida脚本在内存中修改<code>l.d(this.d)</code>的值。<code>l.d</code>的实现如下，其中arg0为l类型：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010173538290.png" alt="image-20231010173538290" style="zoom:67%;" /></p>
<p>&emsp;脚本如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hookq0.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookq0</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.ilulutv.fulao2.film.l&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;found instance =&gt;&quot;</span>, instance)</span><br><span class="line">                instance.<span class="property">q0</span>.<span class="property">value</span> = <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;completed&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;最终调用成功了，可惜我这无法验证，呜呜。</p>
<h4 id="图片取证分析"><a href="#图片取证分析" class="headerlink" title="图片取证分析"></a>图片取证分析</h4><p>&emsp;之后分析app协议内容。协议分析的第一步：<code>针对样本流量的抓取与关键字段的定位</code>。</p>
<p>&emsp;本次抓包不使用之前的<code>中间人抓包（charles|postern）</code>，而是使用hook抓包，其优势在于：<code>（1）抓取的流量更加专一，不会受到手机上其他app流量的影响；（2）可以避免app本身对抗抓包的姿势，例如服务器校验客户端，SSL Pinning等</code>。但是，如果app有对抗frida等工具的手段，那么就需要bypass。<code>（3）hook可以打印调用栈，因此可确定函数之前经过的所有函数。</code></p>
<p>&emsp;hook抓包的效果取决于找到的hook点。（1）android有很多封装网络通信的库，例如okhttp3、retrofit。因此，可能需要针对不同的库设置hook点。（2）对于通信协议而言，只抓取http的hook点也不够全面。之后装逼时刻，r0ysue开发了r0capture，<code>hook系统中在socket层发送和接收数据包的关键函数，基本上能抓所有流量</code>。</p>
<p>&emsp;虽然跑不了，但是分析一波<a target="_blank" rel="noopener" href="https://github.com/r0ysue/r0capture">r0capture</a>，此书中利用r0capture抓取了图片（挖个坑）。抓取后的图片是加密的。那之后，就要找到图片解密的点。<code>图片要加载的时候，此时图片就被解密</code>。</p>
<p>&emsp;android中加载图片的过程：使用BitmapFactory类中的函数加载bitmap，最终通过ImageView加载Bitmap类型的图片。</p>
<p>&emsp;为了验证这个过程，使用objection插件wallbreaker在内存中搜索Bitmap对象，手动触发图片的加载后再次搜索Bitmap对象，前后数量不一致，因此可以确定此app使用Bitmap对象来保存图片。</p>
<p>&emsp;android开发中，BitmapFactory中有4个静态方法：<code>decodeFile、decodeResource、decodeStream、decodeByteArray</code>，分别用于从<code>文件系统、资源、输入流、字节数组</code>中加载出Bitmap对象。更暴力一点，对BitmapFactory中所有函数进行hook，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking watch class android.graphics.BitmapFactory </span><br></pre></td></tr></table></figure>
<p>&emsp;最终发现是使用<code>decodeByteArray</code>函数（static），此函数的第1个参数就是原始图片的字节信息。为了确认此图片信息为明文，使用frida脚本获取参数并保存。saveBitmap.js代码如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generate random string as image name</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">guid</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="keyword">function</span>(<span class="params">c</span>)&#123;</span><br><span class="line">        <span class="comment">// generate r in [0:1:15]</span></span><br><span class="line">        <span class="keyword">var</span> r = <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span> | <span class="number">0</span></span><br><span class="line">        <span class="keyword">var</span> v = c == <span class="string">&quot;x&quot;</span> ? r : (r&amp;<span class="number">0x3</span>|<span class="number">0x8</span>)</span><br><span class="line">        <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hook decodeByteArray</span></span><br><span class="line"><span class="comment">// decodeByteArray(byte[] data, int offset, int length, Options opts)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">saveBitmap_1</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">BitmapFactory</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.graphics.BitmapFactory&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> decodeByteArray_func = decodeByteArray.<span class="title function_">overload</span>(<span class="string">&quot;[B&quot;</span>, <span class="string">&quot;int&quot;</span>, <span class="string">&quot;int&quot;</span>, <span class="string">&quot;android.graphics.BitmapFactory$Options&quot;</span>)</span><br><span class="line">        decodeByteArray_func.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">data, offset, length, opts</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">decodeByteArray</span>(data, offset, length, opts)</span><br><span class="line">            <span class="keyword">var</span> path = <span class="string">&quot;/sdcard/Download/tmp&quot;</span> + <span class="title function_">guid</span>() + <span class="string">&quot;.jpg&quot;</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;path =&gt;&quot;</span>, path)</span><br><span class="line">            <span class="keyword">var</span> f = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.File&quot;</span>).$new(path)</span><br><span class="line">            <span class="keyword">var</span> fos = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.FileOutputStream&quot;</span>).$new(f)</span><br><span class="line">            fos.<span class="title function_">write</span>(data)</span><br><span class="line">            fos.<span class="title function_">close</span>()</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(saveBitmap_1)</span><br></pre></td></tr></table></figure>
<p>&emsp;之后，对上述脚本中的saveBitmap_1进行修改，以适应最后的rpc操作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hookBitmap.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">saveBitmap_1</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">BitmapFactory</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.graphics.BitmapFactory&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> decodeByteArray_func = <span class="title class_">BitmapFactory</span>.<span class="property">decodeByteArray</span>.<span class="title function_">overload</span>(<span class="string">&quot;[B&quot;</span>, <span class="string">&quot;int&quot;</span>, <span class="string">&quot;int&quot;</span>, <span class="string">&quot;android.graphics.BitmapFactory$Options&quot;</span>)</span><br><span class="line">        decodeByteArray_func.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">data, offset, length, opts</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">decodeByteArray</span>(data, offset, length, opts)</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            var path = &quot;/sdcard/Download/tmp&quot; + guid() + &quot;.jpg&quot;</span></span><br><span class="line"><span class="comment">            console.log(&quot;path =&gt;&quot;, path)</span></span><br><span class="line"><span class="comment">            var f = Java.use(&quot;java.io.File&quot;).$new(path)</span></span><br><span class="line"><span class="comment">            var fos = Java.use(&quot;java.io.FileOutputStream&quot;).$new(f)</span></span><br><span class="line"><span class="comment">            fos.write(data)</span></span><br><span class="line"><span class="comment">            fos.close()</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="title function_">send</span>(data)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(saveBitmap_1)</span><br></pre></td></tr></table></figure>
<p>&emsp;相应python脚本为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># saveBitmap.py</span></span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_message_handler</span>(<span class="params">message, payload</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;send&quot;</span>:</span><br><span class="line">        image = message[<span class="string">&quot;payload&quot;</span>]</span><br><span class="line">        </span><br><span class="line">        intArr = []</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> image:</span><br><span class="line">            ival = <span class="built_in">int</span>(m)</span><br><span class="line">            <span class="keyword">if</span> ival &lt; <span class="number">0</span>:</span><br><span class="line">                ival += <span class="number">256</span></span><br><span class="line">            intArr.append(ival)</span><br><span class="line">        bs = <span class="built_in">bytes</span>(intArr)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 根据 uuid 生成文件名</span></span><br><span class="line">        fileName = <span class="built_in">str</span>(uuid.uuid1()) + <span class="string">&quot;.jpg&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;fileName:&quot;</span>, fileName)</span><br><span class="line">        f = <span class="built_in">open</span>(filename, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">        <span class="comment"># 写入字节流</span></span><br><span class="line">        f.write(bs)</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line"><span class="comment"># 获得最上方的应用</span></span><br><span class="line">target = device.get_frontmost_application()</span><br><span class="line">session = device.attach(target.pid)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;hookBitmap.js&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line"><span class="comment"># 错误处理</span></span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>, my_message_handler)</span><br><span class="line">script.load()</span><br></pre></td></tr></table></figure>
<p>&emsp;运行saveBitmap.py后，再对图片进行刷新，就可以下载图片啦。但是！<code>我们目的不是为了下载图片，而是为了分析协议，也就是对如何对图片进行的解密</code>。</p>
<p>&emsp;我们使用objection hook decodeByteArray并打印调用栈：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking watch class_method android.graphics.BitmapFactory.decodeByteArray &quot;[B, int, int, android.graphics.BitmapFactory$Options&quot; --dump-backtrace </span><br></pre></td></tr></table></figure>
<p>&emsp;发现业务层代码<code>com.ilulutv.fulao2.other.helper.glide.b.a</code>。使用jeb找到此函数，如下所示：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010201958270.png" alt="image-20231010201958270" style="zoom:67%;" /></p>
<p>&emsp;跟进解密函数，其中arg3为密钥Key，arg4为向量IV，arg5是要解密的数据。</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231010202233421.png" alt="image-20231010202233421" style="zoom:67%;" /></p>
<p>&emsp;因此，可以使用主动调用的方式对key与IV进行获取，如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getKey.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getKey</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">CipherClient</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;net.idik.lib.cipher.so.CipherClient&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> key = <span class="title class_">CipherClient</span>.<span class="title function_">decodeImgKey</span>()</span><br><span class="line">        <span class="keyword">var</span> iv = <span class="title class_">CipherClient</span>.<span class="title function_">decodeImgIv</span>()</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(key, iv)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;获取到key与IV之后，采用rpc的方式来模拟，从而实现最终的脱机抓取图片数据。经过分析，前面抓包得到的图片数据其实是<code>com.ilulutv.fulao2.other.i.b.a</code>函数的返回值，因此可以写脚本：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// final.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_image_ciphertext</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> b = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ilulutv.fulao2.other.i.b&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> a_func = b.<span class="property">a</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.nio.ByteBuffer&quot;</span>)</span><br><span class="line">        a_func.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">a</span>(obj)</span><br><span class="line">            <span class="title function_">send</span>(result)</span><br><span class="line">            <span class="keyword">return</span> result            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># final.py</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">IMGdecrypt</span>(<span class="params"><span class="built_in">bytearray</span></span>):</span><br><span class="line">    key = <span class="string">&quot;xxxxx&quot;</span></span><br><span class="line">    iv = <span class="string">&quot;xxxx&quot;</span>    </span><br><span class="line">    imgkey = base64.decodebytes(<span class="built_in">bytes</span>(key), encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    imgiv = base64.decodebytes(<span class="built_in">bytes</span>(iv), encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    cipher = AES.new(imgkey, AES.MODE_CBC, imgiv)</span><br><span class="line">    msg = cipher.decrypt(<span class="built_in">bytearray</span>)</span><br><span class="line">    <span class="keyword">return</span> msg                      </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_message_handler</span>(<span class="params">message, payload</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;send&quot;</span>:</span><br><span class="line">        image = message[<span class="string">&quot;payload&quot;</span>]</span><br><span class="line">        intArr = []</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> image:</span><br><span class="line">            ival = <span class="built_in">int</span>(m)</span><br><span class="line">            <span class="keyword">if</span> ival &lt; <span class="number">0</span>:</span><br><span class="line">                ival += <span class="number">256</span></span><br><span class="line">            intArr.append(ival)</span><br><span class="line">        bs = <span class="built_in">bytes</span>(intArr)</span><br><span class="line">        bs = IMGdecrypt(bs)</span><br><span class="line">        <span class="comment"># 根据 uuid 生成文件名</span></span><br><span class="line">        fileName = <span class="built_in">str</span>(uuid.uuid1()) + <span class="string">&quot;.jpg&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;fileName:&quot;</span>, fileName)</span><br><span class="line">        f = <span class="built_in">open</span>(filename, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">        <span class="comment"># 写入字节流</span></span><br><span class="line">        f.write(bs)</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line"><span class="comment"># 获得最上方的应用                                  </span></span><br><span class="line">target = device.get_frontmost_application()</span><br><span class="line">session = device.attach(target.pid)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;final.js&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line"><span class="comment"># 错误处理</span></span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>, my_message_handler)</span><br><span class="line">script.load()</span><br></pre></td></tr></table></figure>
<h2 id="0x04-Xposed-Hook及主动调用与RPC实现"><a href="#0x04-Xposed-Hook及主动调用与RPC实现" class="headerlink" title="0x04 Xposed Hook及主动调用与RPC实现"></a>0x04 Xposed Hook及主动调用与RPC实现</h2><p>&emsp;Xposed 是 Frida 的前辈，其作为<code>系统框架类型的 hook 思想</code>对安卓安全研究有很大的影响。EdXposed 是 Xposed 的后续产品。本章主要介绍 Xposed 基本使用，并与 frida 做对比。</p>
<h3 id="Xposed-应用-hook"><a href="#Xposed-应用-hook" class="headerlink" title="Xposed 应用 hook"></a>Xposed 应用 hook</h3><h4 id="Xposed-安装-amp-Xposed插件（模块）"><a href="#Xposed-安装-amp-Xposed插件（模块）" class="headerlink" title="Xposed 安装&amp;Xposed插件（模块）"></a>Xposed 安装&amp;Xposed插件（模块）</h4><p>&emsp;需要在 Root 环境下通过 XposedInstaller App 安装对应系统的 xposed 框架，安装成功后，接着安装相应的 hook 框架并重启，从而完成对目标进程的 hook。xposed 本质上是替换安卓系统中的 zygote 与libart.so 库，来将 XposedBridge.jar 注入到应用中，从而实现进程的 hook。安装 xposed 需要满足：安卓版本小于等于7.1，系统 root。</p>
<p>&emsp;经过一番周折，终于将 Xposed 安装上了。</p>
<p>&emsp;Xposed插件以App的形式安装到系统中。举一个xposed插件（app）的例子，以说明xposed插件的开发流程。</p>
<p>（1）修改AndroidManifest.xml，在application节点下增加meta-data属性：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231019184544598.png" alt="image-20231019184544598" style="zoom:67%;" /></p>
<p>（2）在app目录下新建assets目录，并新建xposed_init文件，文件中填入Xposed模块入口类的完整类名，在此为：<code>com.roysue.xposed1.HookTest</code>。</p>
<p>（3）MainActivity.java中填入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.roysue.xposed1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AppCompatActivity 用于构建兼容的 Android 应用程序</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Button button;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="comment">// 设置 activity_main.xml 为当前布局</span></span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="comment">// 在当前布局中寻找 button</span></span><br><span class="line">        button = (Button) findViewById(R.id.button);</span><br><span class="line">        button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="comment">// 在屏幕底部提示消息</span></span><br><span class="line">                Toast.makeText(MainActivity.<span class="built_in">this</span>, toastMessage(<span class="string">&quot;我未被劫持&quot;</span>), Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toastMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;若没有hook代码，那么打开此插件后，会提示<code>我未被劫持</code>。下面，我们hook的目标为：<code>打印toastMessage函数的参数，并且修改返回值为&quot;你已被劫持&quot;</code>。那么该如何做咧？</p>
<p>（1）之前，在xposed_init中写入了<code>com.roysue.xposed1.HookTest</code>，从而指定了hook相关的类。我们要在此类中实现<code>IXposedHookLoadPackage</code>接口。之后，每个由Zygote孵化出的进程启动时都会调用接口中的<code>handleLoadPackage</code>函数。如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.roysue.xposed1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 其他的 import 在此先省略</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HookTest</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 函数逻辑 logic-1 在此先省略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其他函数在此先省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;如果想要hook指定进程，就需要对上述代码中的loadPackageParam进行过滤。loadPackageParam中包括一些成员变量，如下所示：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>成员变量类型</th>
<th>成员变量名</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>String</td>
<td>packageName</td>
<td>包名</td>
</tr>
<tr>
<td>String</td>
<td>processName</td>
<td>进程名</td>
</tr>
<tr>
<td>ClassLoader</td>
<td>classLoader</td>
<td>进程的类加载器</td>
</tr>
<tr>
<td>ApplicationInfo</td>
<td>appInfo</td>
<td>其他信息</td>
</tr>
</tbody>
</table>
</div>
<p>&emsp;通常使用packageName进行过滤。</p>
<p>（2）锁定目标进程后，接下来对目标进程的函数进行hook，其中需要使用xposed相关的类：<code>XposedHelpers</code>。此类中提供了java类、类成员的接口函数。在此例中，需要使用此类中的<code>findAndHookMethod</code>函数。此函数参数为：要hook函数所在类的handle、函数名、函数参数列表、hook回调类<code>XC_MethodHook</code>。在将<code>XC_MethodHook</code>作为参数传给<code>findAndHookMethod</code>之前，需要实现抽象回调函数：<code>beforeHookedMethod</code>与<code>afterHookedMethod</code>。顾名思义，不必多说。</p>
<p>&emsp;因此，可以完善 logic-1，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打印 hook 日志</span></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="comment">// log 日志</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 packageName 进行过滤</span></span><br><span class="line"><span class="keyword">if</span>(loadPackageParam.packageName.equals(<span class="string">&quot;com.roysue.xposed1&quot;</span>))&#123;</span><br><span class="line">    XposedBridge.log(<span class="string">&quot;has hooked!&quot;</span>);</span><br><span class="line">    XposedBridge.log(<span class="string">&quot;inner&quot;</span> + loadPackageParam.processName);</span><br><span class="line">    <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> loadPackageParam.classLoader.loadClass(<span class="string">&quot;com.roysue.xposed1.MainActivity&quot;</span>);</span><br><span class="line">    <span class="comment">// 使用 findAndHookMethod 来 hook 函数</span></span><br><span class="line">    XposedHelpers.findAndHookMethod(clazz, <span class="string">&quot;toastMessage&quot;</span>, String.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>()&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">oldText</span> <span class="operator">=</span> (String) param.args[<span class="number">0</span>];</span><br><span class="line">            Log.d(<span class="string">&quot;oldText&quot;</span>, oldText);</span><br><span class="line">            param.args[<span class="number">0</span>] = <span class="string">&quot;您已被劫持&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;在Xposed Installer中激活此插件（模块），并重启系统。最终可以得到：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231019193235633.png" alt="image-20231019193235633" style="zoom:37%;" /></p>
<h4 id="Hook-API-详解"><a href="#Hook-API-详解" class="headerlink" title="Hook API 详解"></a>Hook API 详解</h4><p>&emsp;本节介绍了被大量使用的Xposed插件（模块），即GravityBox。通过此插件，对Xposed的hook相关API作进一步介绍。<code>GravityBox可以修改状态栏、锁屏、电源等</code>，源码在<a target="_blank" rel="noopener" href="https://github.com/GravityBox/GravityBox">此</a>下载。</p>
<p>&emsp;GravityBox的分析路径如下：</p>
<p>（1）打开xposed_init，发现其中为：<code>com.ceco.r.gravitybox.GravityBox</code>。找到此类，此类实现了IXposedHookZygoteInit与IXposedHookLoadPackage的接口，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GravityBox</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookZygoteInit</span>, IXposedHookLoadPackage &#123;</span><br><span class="line">    <span class="comment">// 其中代码 logic-2 省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;在此类中，有函数initZygote，用于在Zygote进程启动时执行（每次开机执行一次），正常使用中，initZygote用于初始化工具类。在GravityBox类中，重写initZygote函数，用于初始化配置文件（initZygote重写后调用XSharedPreferences）、打印关键信息，如下所示（logic-2）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 其它函数</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initZygote</span><span class="params">(StartupParam startupParam)</span> &#123;</span><br><span class="line">    <span class="comment">// 其它逻辑</span></span><br><span class="line">    MODULE_PATH = startupParam.modulePath;</span><br><span class="line">    <span class="keyword">if</span> (XposedBridge.getXposedVersion() &lt; <span class="number">93</span>) &#123;</span><br><span class="line">        <span class="comment">// 初始化配置文件</span></span><br><span class="line">        prefs = <span class="keyword">new</span> <span class="title class_">XSharedPreferences</span>(prefsFileProt);</span><br><span class="line">        <span class="comment">// 其它逻辑</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 其它逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其它逻辑</span></span><br><span class="line">    <span class="keyword">if</span> (startupParam.startsSystemServer) &#123;</span><br><span class="line">        <span class="comment">// 打印关键信息</span></span><br><span class="line">        XposedBridge.log(<span class="string">&quot;GB:Hardware: &quot;</span> + Build.HARDWARE);</span><br><span class="line">        <span class="comment">// 其它逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其它逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 其他函数</span></span><br></pre></td></tr></table></figure>
<p>&emsp;在logic-2中，还有一个重要的函数，即handleLoadPackage，此函数是进程启动时被调用的函数，作用为<code>完成java函数的hook工作</code>，其调用时机早于Application.onCreate函数。此函数中有很多if语句，以区分启动的app，从而在一个xposed模块（插件）中hook多个应用。代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(LoadPackageParam lpparam)</span> &#123;</span><br><span class="line">    <span class="comment">// 其余逻辑</span></span><br><span class="line">    <span class="keyword">if</span> (lpparam.packageName.equals(SystemPropertyProvider.PACKAGE_NAME)) &#123;</span><br><span class="line">        SystemPropertyProvider.init(prefs, qhPrefs, tunerPrefs, lpparam.classLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (lpparam.packageName.equals(ModLowBatteryWarning.PACKAGE_NAME)) &#123;</span><br><span class="line">        ModLowBatteryWarning.init(prefs, qhPrefs, lpparam.classLoader);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 其余逻辑</span></span><br><span class="line">    <span class="keyword">if</span> (lpparam.packageName.equals(ModStatusbarColor.PACKAGE_NAME)) &#123;</span><br><span class="line">        ModStatusbarColor.init(lpparam.classLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其余逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;以<code>控制系统状态栏颜色</code>为例，跟踪ModStatusbarColor.init函数，发现其对函数的hook都是使用XposedHelpers类进行处理（使用类中的findAndHookMethod函数）。分析ModStatusbarColor.init函数代码，可以得到以下结论（分析过程略）：</p>
<ul>
<li><p>在afterHookedMethod或beforeHookedMethod函数中，使用<code>param.thisObject</code>即可拿到被hook函数的实例对象。</p>
</li>
<li><p>frida中获取实例对象的成员值，为<code>实例对象.成员名称.value</code>，而在xposed中为<code>XposedHelpers.get&lt;type&gt;Field(实例对象,成员名称)</code>，也有对应的<code>set&lt;type&gt;Field</code>方法。</p>
</li>
<li><p>frida中需要使用java.cast来完成类型的转换，而xposed本身就是java的，所以强制转换即可。</p>
</li>
</ul>
<p>&emsp;再来看GravityBox的ModAudio.java部分代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 其余逻辑</span></span><br><span class="line">XposedHelpers.findAndHookConstructor(<span class="string">&quot;android.media.AudioManager&quot;</span>, classLoader, Context.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">objService</span> <span class="operator">=</span> XposedHelpers.callMethod(param.thisObject, <span class="string">&quot;getService&quot;</span>);</span><br><span class="line">        <span class="type">Context</span> <span class="variable">mApplicationContext</span> <span class="operator">=</span> (Context) XposedHelpers.getObjectField(param.thisObject, <span class="string">&quot;mApplicationContext&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (objService != <span class="literal">null</span> &amp;&amp; mApplicationContext != <span class="literal">null</span>) &#123;</span><br><span class="line">            XposedHelpers.callMethod(param.thisObject, <span class="string">&quot;disableSafeMediaVolume&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 其余逻辑</span></span><br></pre></td></tr></table></figure>
<p>&emsp;可以看出，xposed还可以钩取类的构造函数，此时findAndHookConstructor无需传递函数名称。</p>
<p>&emsp;因此，可以说：<code>针对app中的类、函数、变量的处理都是通过XposedHelpers类中提供的函数实现的</code>。那么XposedHelpers是如何实现这些功能的呢？答案是用<code>java的反射</code>实现的。以XposedHelpers的getBooleanField为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">getBooleanField</span><span class="params">(Object obj, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> findField(obj.getClass(), fieldName).getBoolean(obj);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">findField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> findFieldRecursiveImpl(clazz, fieldName);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    fieldCache.put(fullFieldName, field);</span><br><span class="line">    <span class="keyword">return</span> field;    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Field <span class="title function_">findFieldRecursiveImpl</span><span class="params">(Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> <span class="keyword">throws</span> NoSuchFieldException &#123;</span><br><span class="line">    <span class="keyword">return</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;Frida与Xposed对比：Xposed可以在一个函数中完成针对所有进程的hook，在zygote重新启动后生效。而frida是单进程级别的hook。</p>
<h4 id="Xposed-Hook加固应用"><a href="#Xposed-Hook加固应用" class="headerlink" title="Xposed Hook加固应用"></a>Xposed Hook加固应用</h4><p>&emsp;对加固应用进行hook时，如果直接hook应用中的函数，则会提示ClassNotFoundException，同样，使用frida在spawn模式下对加固应用进行hook时，也会提示相同错误（但是frida使用attach进行hook时为什么不提示咧？）。</p>
<p>&emsp;答案是：时机不对，即类加载器ClassLoader在加固应用启动时切换，从而导致上述情况。具体而言，app中的类都是对应的ClassLoader加载到ART虚拟机中的，如果ClassLoader不正确，那么就无法找到对应的类。<code>当加固应用启动时，app的当前ClassLoader会发生切换，故而出现上述情况</code>。                      </p>
<p>&emsp;那么，如何让xposed在面对加固应用时也可以使用attach注入进程呢？</p>
<p>&emsp;我们来分析这个问题，首先，xposed注入进程的时机不可更改，即zygote启动时，此时app的Application类并未加载，也就导致用于加载app的业务相关的类的ClassLoader未出现。但是，我们可以<code>手动切换ClassLoader</code>。 </p>
<p>&emsp;举个例子，当我们静态分析加固app时发现，壳程序总是通过在应用进程中最先获得执行权限的application类中的attachBaseContext与onCreate函数完成对dex的释放与ClassLoader的切换，那么，我们可以hook 这两个函数来获得真实app的上下文。相关代码逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">XposedHelpers.findAndHookMethod(<span class="string">&quot;com.xxx.StubApp&quot;</span>, loadPackageParam.classloader, <span class="string">&quot;attachBaseContext&quot;</span>, Context.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 此时 param 指的应该是返回值</span></span><br><span class="line">        <span class="built_in">super</span>.afterHookedMethod(param);</span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> (Context) param.args[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// 获取真实业务代码的 classLoader</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">finalClassLoader</span> <span class="operator">=</span> context.getClassLoader();</span><br><span class="line">        <span class="comment">// 之后 hook 真实 classLoader 的 method 即可</span></span><br><span class="line">        XposedHelpers.findAndHookMethod(clzz, finalClassLoader, <span class="string">&quot;method&quot;</span>, ..., <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>()&#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>&emsp;上述方法有一个弊端，即一旦加固厂商改变相应继承Application类的类名，在此理解为方法名，即不一定为attachBaseContext函数，那么上述hook就失效了。那如何解决？</p>
<p>&emsp;再来补充知识：app被zygote孵化后，会通过<code>ActivityThread.main</code>启动相应app，在此函数中创建ActivityThread的实例，并进行初始化操作。ActivityThread类至关重要，它根据ActivityManager发送的请求对activities、broadcast Receviers等操作进行调度执行。<code>ActivityThread中的performLaunchActivity函数用于响应与activity相关的操作，ActivityThread中的mInitialApplication存放着当前的ClassLoader</code>。</p>
<p>&emsp;以movetv的MainActivity为例，实现hook的代码如下所示（代码放在函数handleLoadPackage中）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.app.Application;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(loadPackageParam.packageName.equals(<span class="string">&quot;com.cz.babySister&quot;</span>))&#123;</span><br><span class="line">    XposedBridge.log(<span class="string">&quot;hooked &quot;</span> + loadPackageParam.processName);</span><br><span class="line">    <span class="comment">// hook ActivityThread 类</span></span><br><span class="line">    <span class="type">Class</span> <span class="variable">ActivityThread</span> <span class="operator">=</span> XposedHelpers.findClass(<span class="string">&quot;android.app.ActivityThread&quot;</span>, loadPackageParam.classLoader);</span><br><span class="line">    <span class="comment">// performLaunchActivity 用于响应与 activity 相关的操作</span></span><br><span class="line">    XposedBridge.hookAllMethods(ActivityThread, <span class="string">&quot;performLaunchActivity&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable&#123;</span><br><span class="line">            <span class="built_in">super</span>.afterHookedMethod(param);</span><br><span class="line">            <span class="comment">// 获取 ActivityThread 类中的 mInitialApplication 成员</span></span><br><span class="line">            <span class="type">Application</span> <span class="variable">mInitialApplication</span> <span class="operator">=</span> (Application) XposedHelpers.getObjectField(param.thisObject, <span class="string">&quot;mInitialApplication&quot;</span>);</span><br><span class="line">            <span class="type">ClassLoader</span> <span class="variable">finalLoader</span> <span class="operator">=</span> mInitialApplication.getClassLoader();</span><br><span class="line">            XposedBridge.log(<span class="string">&quot;found classloader is =&gt; &quot;</span> + finalLoader.toString());</span><br><span class="line"></span><br><span class="line">            <span class="type">Class</span> <span class="variable">BabyLogin</span> <span class="operator">=</span> finalLoader.loadClass(<span class="string">&quot;com.cz.babySister.activity.LoginActivity&quot;</span>);</span><br><span class="line">            XposedBridge.log(<span class="string">&quot;Debug -&gt; &quot;</span> + BabyLogin.toString());</span><br><span class="line">            XposedBridge.hookAllMethods(BabyLogin, <span class="string">&quot;onCreate&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>()&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable&#123;</span><br><span class="line">                    <span class="comment">// 当启动 MainActivity 时进行 Log</span></span><br><span class="line">                    <span class="built_in">super</span>.beforeHookedMethod(param);</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;LoginActivity onCreate called&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;结果如下所示：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231020201257929.png" alt="image-20231020201257929" style="zoom:67%;" /></p>
<h4 id="Frida-探-Xposed-Hook"><a href="#Frida-探-Xposed-Hook" class="headerlink" title="Frida 探 Xposed Hook"></a>Frida 探 Xposed Hook</h4><p>&emsp;本节利用frida，来学习Xposed是如何进行hook的。以<code>Xposed 安装&amp;Xposed插件（模块）</code>一节中的示例插件为例，使用objection注入目标进程，搜索com.roysue.xposed1.HookTest，命令行如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objection -g com.roysue.xposed1 explore</span><br><span class="line">android hooking search classes HookTest</span><br></pre></td></tr></table></figure>
<p>&emsp;结果如下：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231020202510881.png" alt="image-20231020202510881" style="zoom:67%;" /></p>
<p>&emsp;但是，如果想要执行以下两条命令的任何一条时，就会报错，显示ClassNotFoundException：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 列出类中的函数</span><br><span class="line">android hooking list class_methods com.roysue.xposed1.HookTest</span><br><span class="line">android hooking list class_methods com.roysue.xposed1.HookTest$1</span><br><span class="line">// 钩取类中的所有函数</span><br><span class="line">android hooking watch class com.roysue.xposed1.HookTest</span><br><span class="line">android hooking watch class com.roysue.xposed1.HookTest$1</span><br></pre></td></tr></table></figure>
<p>&emsp;这里之所以报错，是因为：<code>ClassLoader不对，objection中并未结合frida中切换ClassLoader的功能，因此这部分需要自己写脚本完成。</code>如下traceXposed.js所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// traceXposed.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// enumerateClassLoaders 是 frida 的 api</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateClassLoaders</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">loader</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(loader.<span class="title function_">findClass</span>(<span class="string">&quot;com.roysue.xposed1.HookTest&quot;</span>))&#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;found!&quot;</span>)</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(loader)</span><br><span class="line">                        <span class="comment">// 切换 classLoader</span></span><br><span class="line">                        <span class="title class_">Java</span>.<span class="property">classFactory</span>.<span class="property">loader</span> = loader</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span>(error)&#123;&#125;</span><br><span class="line">            &#125;, <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(hook)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f com.roysue.xposed1 -l traceXposed.js --no-pause</span><br></pre></td></tr></table></figure>
<p>&emsp;输出此时含有com.roysue.xposed1.HookTest的ClassLoader，如下所示：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231020215345260.png" alt="image-20231020215345260" style="zoom:67%;" /></p>
<p>&emsp;完成切换后，对目标类进行hook发现不再报错，在下面的代码中，针对HookTest类中的PrintStack进行Hook，脚本如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// traceXposed.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// enumerateClassLoaders 是 frida 的 api</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateClassLoaders</span>(&#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// hook PrintStack 函数</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.roysue.xposed1.HookTest&quot;</span>).<span class="property">PrintStack</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hacked by wd&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(hook)</span><br></pre></td></tr></table></figure>
<p>&emsp;注入之后，点击应用的button，会调用PrintStack，此时会显示”hacked by wd”。作者发现，切换完ClassLoader之后，虽然能够获取com.roysue.xposed1.HookTest的类，但是对于Xposed提供的api，例如XposedBridge.log等，钩取时也会出现ClassNotFoundException错误，这说明：<code>使用Xposed实现的插件与Xposed自身的api不在一个ClassLoader所能加载的范围内</code>。</p>
<p>&emsp;我们先查看XposedBridge对应的ClassLoader叫啥？脚本如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// traceXposed.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// enumerateClassLoaders 是 frida 的 api</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateClassLoaders</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">loader</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(loader.<span class="title function_">findClass</span>(<span class="string">&quot;de.robv.android.xposed.XposedBridge&quot;</span>))&#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;found!&quot;</span>)</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(loader)</span><br><span class="line">                        <span class="comment">// 切换 classLoader</span></span><br><span class="line">                        <span class="title class_">Java</span>.<span class="property">classFactory</span>.<span class="property">loader</span> = loader</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span>(error)&#123;&#125;</span><br><span class="line">            &#125;, <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(hook)</span><br></pre></td></tr></table></figure>
<p>&emsp;结果如下所示：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231020215424099.png" alt="image-20231020215424099" style="zoom:67%;" /></p>
<p>&emsp;对比发现，Xposed插件在<code>/data/app/com.roysue.xposed1-1/base.apk</code>中，而Xposed的api在<code>/system/framework/XposedBridge.jar</code>中。结合代码，可以得出结论，Xposed插件实现了Xposed框架的IXposedHookLoadPackage接口，而XposedBridge则是调用XposedBridge.jar中的函数。</p>
<p>&emsp;再次分析上面xposed插件的代码，发现beforeHookedMethod与afterHookedMethod函数都在使用<code>new XC_MethodHook</code>构建的内部匿名类<code>HookTest$1</code>中，因此需要将ClassLoader切换为<code>HookTest$1</code>所在的loader。针对上面xposed插件，对beforeHookedMethod与afterHookedMethod进行hook，脚本如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hook.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">traceMethod</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateClassLoaders</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">loader</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="comment">// 切换为 com.roysue.xposed1.HookTest$1 类的 loader</span></span><br><span class="line">                    <span class="keyword">if</span>(loader.<span class="title function_">findClass</span>(<span class="string">&quot;com.roysue.xposed1.HookTest$1&quot;</span>))&#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;found!&quot;</span>)</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(loader)</span><br><span class="line">                        <span class="title class_">Java</span>.<span class="property">classFactory</span>.<span class="property">loader</span> = loader</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span>(error)&#123;&#125;</span><br><span class="line">            &#125;, <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)  </span><br><span class="line">        <span class="keyword">var</span> targetClassMethod = <span class="string">&quot;com.roysue.xposed1.HookTest$1.beforeHookedMethod&quot;</span></span><br><span class="line">        <span class="keyword">var</span> delim = targetClassMethod.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> targetClass = targetClassMethod.<span class="title function_">slice</span>(<span class="number">0</span>, delim)</span><br><span class="line">        <span class="keyword">var</span> targetMethod = targetClassMethod.<span class="title function_">slice</span>(delim + <span class="number">1</span>, targetClassMethod.<span class="property">length</span>)   </span><br><span class="line">        <span class="keyword">var</span> hook = <span class="title class_">Java</span>.<span class="title function_">use</span>(targetClass)</span><br><span class="line">        <span class="comment">// targetMethod 的重载数量</span></span><br><span class="line">        <span class="keyword">var</span> overloadCount = hook[targetMethod].<span class="property">overloads</span>.<span class="property">length</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Tracing &quot;</span> + targetClassMethod + <span class="string">&quot; [&quot;</span> + overloadCount + <span class="string">&quot; overload(s)]&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; overloadCount; i++) &#123;</span><br><span class="line">            hook[targetMethod].<span class="property">overloads</span>[i].<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;\n*** entered &quot;</span> + targetClassMethod)</span><br><span class="line">                <span class="comment">// 打印参数 arguments</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; j++) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg[&quot;</span> + j + <span class="string">&quot;]: &quot;</span> + <span class="variable language_">arguments</span>[j])</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 打印返回值 retval</span></span><br><span class="line">                <span class="keyword">var</span> retval = <span class="variable language_">this</span>[targetMethod].<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>)</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;retval: &quot;</span> + retval)</span><br><span class="line">                <span class="keyword">return</span> retval</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;)    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;之后点击button，显示：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231021164742074.png" alt="image-20231021164742074" style="zoom:67%;" /></p>
<p>&emsp;同理，钩取afterHookedMethod，显示：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231021164848886.png" alt="image-20231021164848886" style="zoom:67%;" /></p>
<p>&emsp;接下来，以GravityBox为例，来描述如何对beforeHookedMethod与afterHookedMethod进行hook。</p>
<p>（1）GravityBox.apk下载<a target="_blank" rel="noopener" href="https://www.modapkdown.com/com.ceco.nougat.gravitybox/download-by-happymod.html">链接</a>，下载并安装此插件。</p>
<p>（2）以修改状态栏颜色的类com.ceco.nougat.gravitybox.ModStatusbarColor为例，找其相关的匿名类（不使用之前的objection方法）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hook.js</span></span><br><span class="line"><span class="comment">// 寻找思想：默认存在 ModStatusbarColor$1 匿名类，获取相应的 loader，ModStatusbarColor$1 的其它匿名类也应该使用此 loader。因此，找寻此 loader 加载的所有 gravitybox 匿名类，且匿名类应该继承于 XC_MethodHook，匿名类中应该有 ModStatusbarColor 字符串。</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">lookClass</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// 查找所有的类，以它们为 loader，从而查找 ModStatusbarColor$1 匿名类，并将其作为 loader</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateClassLoaders</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span> (<span class="params">loader</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(loader.<span class="title function_">findClass</span>(<span class="string">&quot;com.ceco.nougat.gravitybox.ModStatusbarColor$1&quot;</span>))&#123;</span><br><span class="line">                        <span class="title class_">Java</span>.<span class="property">classFactory</span>.<span class="property">loader</span> = loader ;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span>(error)&#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// ModStatusbarColor$1 相应的 loader 可能会加载其他的匿名类</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="property">enumerateLoadedClasses</span> (&#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">className</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 找到 gravitybox 的所有匿名类</span></span><br><span class="line">                    <span class="keyword">if</span>(className.<span class="title function_">toString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;gravitybox&quot;</span>) &gt; <span class="number">0</span> &amp;&amp; className.<span class="title function_">toString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;$&quot;</span>) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="comment">// 获得匿名类的父类，应该是 XC_MethodHook 才对，这种匿名类有 beforeHookedMethod 与 afterHookedMethod 函数</span></span><br><span class="line">                        <span class="keyword">if</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(className).<span class="property">class</span>.<span class="title function_">getSuperclass</span>())&#123;</span><br><span class="line">                            <span class="keyword">var</span> superClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(className).<span class="property">class</span>.<span class="title function_">getSuperclass</span>().<span class="title function_">getName</span>()</span><br><span class="line">                            <span class="keyword">if</span> (superClass.<span class="title function_">indexOf</span>(<span class="string">&quot;XC_MethodHook&quot;</span>) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(className)</span><br><span class="line">                                <span class="comment">// traceClass(className)</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;     </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span>(error)&#123;&#125;</span><br><span class="line">            &#125;, <span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;search completed!&quot;</span>)     </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)  </span><br><span class="line">    &#125;)    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;这种寻找方法一个ModStatusbarColor匿名类也没找到，显然是错误的。这是为什么呢？<code>这是因为，由于Frida是进程级别的，而xposed在将代码对进程进行注入时做了进程的判断，例如xposed的ModStatusbarColor类是要对com.android.systemui进行注入，从而改变颜色。因此，只有判断进程是com.android.systemui时，才会初始化ModStatusbarColor类。但是，Frida脚本注入到了插件xposed1中，名字不为com.android.systemui，因此com.android.systemui类并未被初始化，也就找不到其匿名类。</code>原理如下图所示（Xposed开机时会钩取所有进程，此时给systemui注入了ModStatusbarColor）：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231021180801457.png" alt="image-20231021180801457" style="zoom:67%;" /></p>
<p>&emsp;那么，之后我们对systemui进程进行frida注入（hook.js代码无需修改），并进行搜索：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U com.android.systemui -l hook.js --no-pause</span><br></pre></td></tr></table></figure>
<p>&emsp;结果如下所示：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231021181737662.png" alt="image-20231021181737662" style="zoom:67%;" /></p>
<p>&emsp;之后，对上述寻找到的目标类中所有的函数进行hook，即实现上述代码中注释掉的traceClass函数，如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">traceMethod</span>(<span class="params">targetClassMethod</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> delim = targetClassMethod.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> targetClass = targetClassMethod.<span class="title function_">slice</span>(<span class="number">0</span>, delim)</span><br><span class="line">    <span class="keyword">var</span> targetMethod = targetClassMethod.<span class="title function_">slice</span>(delim + <span class="number">1</span>, targetClassMethod.<span class="property">length</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> hook = <span class="title class_">Java</span>.<span class="title function_">use</span>(targetClass);</span><br><span class="line">    <span class="keyword">var</span> overloadCount = hook[targetMethod].<span class="property">overloads</span>.<span class="property">length</span></span><br><span class="line">	<span class="comment">// hook 类中的所有函数的所有重载</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; overloadCount; i++) &#123;</span><br><span class="line">        hook[targetMethod].<span class="property">overloads</span>[i].<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;\n*** entered &quot;</span> + targetClassMethod)</span><br><span class="line">            <span class="comment">// print args</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; j++) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg[&quot;</span> + j + <span class="string">&quot;]: &quot;</span> + <span class="variable language_">arguments</span>[j])</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// print retval</span></span><br><span class="line">            <span class="keyword">var</span> retval = <span class="variable language_">this</span>[targetMethod].<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\nretval: &quot;</span> + retval)</span><br><span class="line">            <span class="keyword">return</span> retval</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uniqBy</span>(<span class="params">array, key</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> seen = &#123;&#125;;</span><br><span class="line">    <span class="keyword">return</span> array.<span class="title function_">filter</span>(<span class="keyword">function</span>(<span class="params">item</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> k = <span class="title function_">key</span>(item);</span><br><span class="line">        <span class="keyword">return</span> seen.<span class="title function_">hasOwnProperty</span>(k) ? <span class="literal">false</span> : (seen[k] = <span class="literal">true</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">traceClass</span>(<span class="params">targetClass</span>) &#123;</span><br><span class="line">    <span class="comment">// 使用 Java.use 新建对象</span></span><br><span class="line">    <span class="keyword">var</span> hook = <span class="title class_">Java</span>.<span class="title function_">use</span>(targetClass)</span><br><span class="line">    <span class="comment">// 利用反射的方式，拿到当前类的所有方法</span></span><br><span class="line">    <span class="keyword">var</span> methods = hook.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>()</span><br><span class="line">    <span class="comment">// 将对象释放掉</span></span><br><span class="line">    hook.<span class="property">$dispose</span></span><br><span class="line">    <span class="comment">// 将方法名保存到数组中</span></span><br><span class="line">    <span class="keyword">var</span> parsedMethods = []</span><br><span class="line">    methods.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">method</span>) &#123;</span><br><span class="line">        <span class="comment">// method_name</span></span><br><span class="line">        parsedMethods.<span class="title function_">push</span>(method.<span class="title function_">toString</span>().<span class="title function_">replace</span>(targetClass + <span class="string">&quot;.&quot;</span>, <span class="string">&quot;TOKEN&quot;</span>).<span class="title function_">match</span>(<span class="regexp">/\sTOKEN(.*)\(/</span>)[<span class="number">1</span>])</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 去掉重复值</span></span><br><span class="line">    <span class="keyword">var</span> targets = <span class="title function_">uniqBy</span>(parsedMethods, <span class="title class_">JSON</span>.<span class="property">stringify</span>)</span><br><span class="line">    <span class="comment">// 对数组中所有的方法进行 hook</span></span><br><span class="line">    targets.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">targetMethod</span>) &#123;</span><br><span class="line">        <span class="title function_">traceMethod</span>(targetClass + <span class="string">&quot;.&quot;</span> + targetMethod)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;上述代码中，traceClass函数必须先获得要钩取类的类名才行。那么，<code>如果我不知道类名，还要hook所有的beforeHookedMethod与afterHookedMethod，该用啥骚姿势？</code></p>
<p>&emsp;已经知道，afterHookedMethod/beforeHookedMethod是使用XC_MethodHook的抽象类实现的，前面插件中的HookTest$1，是匿名内部类，也是XC_MethodHook的子类，它有afterHookedMethod/beforeHookedMethod函数。<code>我们只需要关心XC_MethodHook即可。</code>相关脚本如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getAllXCMethodHook.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getAllXCMethodHook</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateClassLoaders</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span> (<span class="params">loader</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(loader.<span class="title function_">findClass</span>(<span class="string">&quot;com.ceco.nougat.gravitybox.ModStatusbarColor$1&quot;</span>))&#123;</span><br><span class="line">                        <span class="title class_">Java</span>.<span class="property">classFactory</span>.<span class="property">loader</span> = loader ;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span>(error)&#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Java</span>.<span class="property">enumerateLoadedClasses</span> (&#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">className</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(className.<span class="title function_">toString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;gravitybox&quot;</span>) &gt; <span class="number">0</span> &amp;&amp; className.<span class="title function_">toString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;$&quot;</span>) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(className).<span class="property">class</span>.<span class="title function_">getSuperclass</span>())&#123;</span><br><span class="line">                            <span class="keyword">var</span> superClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(className).<span class="property">class</span>.<span class="title function_">getSuperclass</span>().<span class="title function_">getName</span>()</span><br><span class="line">                            <span class="keyword">if</span> (superClass.<span class="title function_">indexOf</span>(<span class="string">&quot;XC_MethodHook&quot;</span>) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(superClass + <span class="string">&quot; | &quot;</span> + className)</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;    </span><br><span class="line">                &#125; <span class="keyword">catch</span>(error)&#123;&#125;</span><br><span class="line">            &#125;, <span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;search completed!&quot;</span>)     </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)  </span><br><span class="line">    &#125;)    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;注入到<code>com.android.systemui</code>中，上述脚本与hook.js好类似（一模一样），结果输出如下（输出了所有父类为XC_MethodHook的子类）：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231021223136596.png" alt="image-20231021223136596" style="zoom:67%;" /></p>
<p>&emsp;结合上述描述，<code>Xposed的原理是：通过新建专门用于实现hook的PathClassLoader，并注入目标进程，从而完成对目标函数的插桩。PathClassLoader加载的类列表中包含对目标进程Hook的逻辑，而原生的Xposed API则处于指向XposedBridge.jar文件的ClassLoader。</code></p>
<h3 id="Xposed-主动调用与-RPC-实现"><a href="#Xposed-主动调用与-RPC-实现" class="headerlink" title="Xposed 主动调用与 RPC 实现"></a>Xposed 主动调用与 RPC 实现</h3><h4 id="Xposed-主动调用函数"><a href="#Xposed-主动调用函数" class="headerlink" title="Xposed 主动调用函数"></a>Xposed 主动调用函数</h4><p>&emsp;以example.apk为例，目的是获取pin值，我们要获得正确的pin。app标识符为<code>org.teamsik.ahe17.qualification.easy</code>。</p>
<p>（1）使用 objection 分析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objection -g org.teamsik.ahe17.qualification.easy explore</span><br><span class="line">android hooking list classes</span><br></pre></td></tr></table></figure>
<p>&emsp;发现<code>org.teamsik.ahe17.qualification.MainActivity</code>类（仅有这一个），之后钩取MainActivity的所有函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking watch class org.teamsik.ahe17.qualification.MainActivity</span><br></pre></td></tr></table></figure>
<p>&emsp;之后点击<code>VERIFY PIN</code>，定位到验证函数：<code>org.teamsik.ahe17.qualification.MainActivity.verifyPasswordClick</code>。</p>
<p>（2）jeb找到verifyPasswordClick，源码如下，静态分析可以发现，PIN码长度为4，使用SHA1进行加密，并与指定密文对比：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231021232633646.png" alt="image-20231021232633646" style="zoom:67%;" /></p>
<p>&emsp;思路：<code>使用Xposed主动调用，暴力穷举，并与密文对比。</code>Xposed关于主动调用的API为<code>callMethod（用于调用对象实例所的动态静态函数）/callStaticMethod（调用类的静态函数）</code>。其函数签名各自为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">callMethod(Object obj, String methodName, Object... args)</span><br><span class="line">// &quot;Class&lt;?&gt; clazz&quot; 代表 clazz 是类就行</span><br><span class="line">callStaticMethod(Class&lt;?&gt; clazz, String methodName, Object... args)</span><br></pre></td></tr></table></figure>
<p>&emsp;使用Xposed要主动调用encodePassword，使用callStaticMethod函数。相关代码如下（Xposed插件）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 静态调用 encodePassword</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">	<span class="keyword">if</span>(loadPackageParam.packageName.equals(<span class="string">&quot;org.teamsik.ahe17.qualification.easy&quot;</span>))&#123;</span><br><span class="line">        XposedBridge.log(<span class="string">&quot;inner: &quot;</span> + loadPackageParam.processName);</span><br><span class="line">        <span class="comment">// 获取 verifier 类</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> XposedHelpers.findClass(<span class="string">&quot;org.teamsik.ahe17.qualification.Verifier&quot;</span>, loadPackageParam.classLoader);</span><br><span class="line">        <span class="comment">// 正确答案</span></span><br><span class="line">        <span class="type">byte</span>[] p = <span class="string">&quot;09042ec2c2c08c4cbece042681caf1d13984f24a&quot;</span>.getBytes();</span><br><span class="line">        <span class="type">String</span> <span class="variable">pStr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(p);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">999</span>; i &lt; <span class="number">10000</span>; i++)&#123;</span><br><span class="line">            <span class="comment">// 静态调用 encodePassword</span></span><br><span class="line">            <span class="type">byte</span>[] v = (<span class="type">byte</span>[])XposedHelpers.callStaticMethod(clazz, <span class="string">&quot;encodePassword&quot;</span>, String.valueOf(i));</span><br><span class="line">            <span class="type">String</span> <span class="variable">vStr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(v);</span><br><span class="line">            <span class="comment">// 作比较</span></span><br><span class="line">            <span class="keyword">if</span>(vStr.equals(pStr))&#123;</span><br><span class="line">                XposedBridge.log(<span class="string">&quot;right.pin =&gt; &quot;</span>+ String.valueOf(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;安装好后，之后打开example.apk，再打开日志，发现9083为正确的pin。<code>其实，java本身就存在主动调用函数的方式，即invoke反射，Xposed的主动调用函数本质上也是调用Invoke函数。</code>因此，可以更改代码为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">	<span class="keyword">if</span>(loadPackageParam.packageName.equals(<span class="string">&quot;org.teamsik.ahe17.qualification.easy&quot;</span>))&#123;</span><br><span class="line">        XposedBridge.log(<span class="string">&quot;inner: &quot;</span> + loadPackageParam.processName);</span><br><span class="line">        <span class="comment">// 反射获取 verifier 类与 Method </span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> loadPackageParam.classLoader.loadClass(<span class="string">&quot;org.teamsik.ahe17.qualification.Verifier&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">encodePassword</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;encodePassword&quot;</span>, String.class);</span><br><span class="line">        <span class="comment">// 允许函数通过外部反射调用，这里主要针对目标函数是 private 私有函数</span></span><br><span class="line">        encodePassword.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 正确答案</span></span><br><span class="line">        <span class="type">byte</span>[] p = <span class="string">&quot;09042ec2c2c08c4cbece042681caf1d13984f24a&quot;</span>.getBytes();</span><br><span class="line">        <span class="type">String</span> <span class="variable">pStr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(p);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">999</span>; i &lt; <span class="number">10000</span>; i++)&#123;</span><br><span class="line">            <span class="comment">// 静态调用 encodePassword</span></span><br><span class="line">            <span class="type">byte</span>[] v = (<span class="type">byte</span>[])encodePassword.invoke(<span class="literal">null</span>, String.valueOf(i));</span><br><span class="line">            <span class="type">String</span> <span class="variable">vStr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(v);</span><br><span class="line">            <span class="comment">// 作比较</span></span><br><span class="line">            <span class="keyword">if</span>(vStr.equals(pStr))&#123;</span><br><span class="line">                XposedBridge.log(<span class="string">&quot;right.pin =&gt; &quot;</span>+ String.valueOf(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;与frida主动调用类似，xposed主动调用面对的问题有：<code>参数构造；针对动态函数如何获取对象实例</code>。</p>
<p>&emsp;针对参数构造问题，要么就hook相同类型的数据（略），要么就自己构造参数。由于xposed是原生java而言的，因此，xposed相比frida在参数构造上有优势。例如，若想构造<code>verifyPassword(Context,String)</code>的Context参数，frida代码如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">ActivityThread</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.app.ActivityThread&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Context</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.content.Context&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = <span class="title class_">Java</span>.<span class="keyword">case</span>(<span class="title class_">ActivityThread</span>.<span class="title function_">currentApplication</span>().<span class="title function_">getApplicationContext</span>(), <span class="title class_">Context</span>)</span><br></pre></td></tr></table></figure>
<p>&emsp;而xposed代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> AndroidAppHelper.currentApplication();</span><br></pre></td></tr></table></figure>
<p>&emsp;相应的，xposed完整的主动调用verifyPassword函数的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">	<span class="keyword">if</span>(loadPackageParam.packageName.equals(<span class="string">&quot;org.teamsik.ahe17.qualification.easy&quot;</span>))&#123;</span><br><span class="line">        XposedBridge.log(<span class="string">&quot;inner: &quot;</span> + loadPackageParam.processName);</span><br><span class="line">        <span class="comment">// 反射获取 verifier 类与 Method </span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> loadPackageParam.classLoader.loadClass(<span class="string">&quot;org.teamsik.ahe17.qualification.Verifier&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">verifyPassword</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;verifyPassword&quot;</span>, Context.class, String.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> AndroidAppHelper.currentApplication();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">999</span>; i &lt; <span class="number">10000</span>; i++)&#123;</span><br><span class="line">            <span class="comment">// invoke 主动调用 verifyPassword</span></span><br><span class="line">            <span class="keyword">if</span>((<span class="type">boolean</span>)verifyPassword.invoke(<span class="literal">null</span>, context, String.valueOf(i)))&#123;</span><br><span class="line">                XposedBridge.log(<span class="string">&quot;right.pin =&gt; &quot;</span>+ String.valueOf(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;上面是xposed构造复杂参数。在主动构造实例对象时，可以使用java Constructor类的newInstance进行构造，也可以使用封装过的XposedHelpers.newInstance()进行构造，相应代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java Constructor类的newInstance</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">	<span class="keyword">if</span>(loadPackageParam.packageName.equals(<span class="string">&quot;org.teamsik.ahe17.qualification.easy&quot;</span>))&#123;</span><br><span class="line">        <span class="comment">// 获取 Verifier 对象</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">cons</span> <span class="operator">=</span> XposedHelpers.findConstructorExact(<span class="string">&quot;org.teamsik.ahe17.qualification.Verifier&quot;</span>, loadPackageParam.classLoader);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">Verifier</span> <span class="operator">=</span> cons.newInstance();</span><br><span class="line">        </span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> AndroidAppHelper.currentApplication();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">999</span>; i &lt; <span class="number">10000</span>; i++)&#123;</span><br><span class="line">            <span class="comment">// Verifier 对象调用 verifyPassword</span></span><br><span class="line">            <span class="keyword">if</span>((<span class="type">boolean</span>)XposedHelpers.callMethod(Verifier, <span class="string">&quot;verifyPassword&quot;</span>, context, String.valueOf(i)))&#123;</span><br><span class="line">                XposedBridge.log(<span class="string">&quot;right.pin =&gt; &quot;</span>+ String.valueOf(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// XposedHelpers.newInstance()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">	<span class="keyword">if</span>(loadPackageParam.packageName.equals(<span class="string">&quot;org.teamsik.ahe17.qualification.easy&quot;</span>))&#123;</span><br><span class="line">        <span class="comment">// 获取 Verifier 对象</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> XposedHelpers.findClass(<span class="string">&quot;org.teamsik.ahe17.qualification.Verifier&quot;</span>, loadPackageParam.classLoader);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">Verifier</span> <span class="operator">=</span> XposedHelpers.newInstance(clazz);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> AndroidAppHelper.currentApplication();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">999</span>; i &lt; <span class="number">10000</span>; i++)&#123;</span><br><span class="line">            <span class="comment">// Verifier 对象调用 verifyPassword</span></span><br><span class="line">            <span class="keyword">if</span>((<span class="type">boolean</span>)XposedHelpers.callMethod(Verifier, <span class="string">&quot;verifyPassword&quot;</span>, context, String.valueOf(i)))&#123;</span><br><span class="line">                XposedBridge.log(<span class="string">&quot;right.pin =&gt; &quot;</span>+ String.valueOf(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;<code>上文并未介绍xposed hook拿到实例对象的方法，这是因为verifier类中函数全为static的，因此verifier类并未初始化，也就hook不到了。</code>那咋办？换一个类然后再介绍hook拿实例对象呗。以MainActivity中的showSuccessDialog为例（不是静态函数），<code>首先hook MainActivity的onCreate方法，创建MainActivity对象，在hook的afterHookMethod中，主动调用showSuccessDialog函数。</code>代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">	<span class="keyword">if</span>(loadPackageParam.packageName.equals(<span class="string">&quot;org.teamsik.ahe17.qualification.easy&quot;</span>))&#123;</span><br><span class="line">        <span class="comment">// 获取 MainActivity 类</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> loadPackageParam.classLoader.loadClass(<span class="string">&quot;org.teamsik.ahe17.qualification.MainActivity&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// hook onCreate</span></span><br><span class="line">        XposedBridge.hookAllMethods(clazz, <span class="string">&quot;onCreate&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable&#123;</span><br><span class="line">                <span class="built_in">super</span>.afterHookedMethod(param);</span><br><span class="line">                <span class="comment">// 获取 MainActivity 对象</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">mMainActivity</span> <span class="operator">=</span> param.thisObject;</span><br><span class="line">                <span class="comment">// 主动调用 showSuccessDialog 函数</span></span><br><span class="line">                XposedHelpers.callMethod(mMainActivity, <span class="string">&quot;showSuccessDialog&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;这样的话，打开example.apk就显示congratulation的成功提示。</p>
<h4 id="Xposed-结合-NanoHTTPD-实现-RPC-调用"><a href="#Xposed-结合-NanoHTTPD-实现-RPC-调用" class="headerlink" title="Xposed 结合 NanoHTTPD 实现 RPC 调用"></a>Xposed 结合 NanoHTTPD 实现 RPC 调用</h4><p>&emsp;Xposed本身未提供RPC调用支持，但是可以结合NanoHTTPD（轻量级HTTP服务器）将主动调用导出为web服务实现。以demoso1工程为例，此工程中存在两个native函数，在应用打开后被循环调用。其中method01是静态函数，对输入进行加密并返回，method02是成员函数，对密文解密并返回。</p>
<p>&emsp;首先用xposed主动调用method01与method02：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">	<span class="keyword">if</span>(loadPackageParam.packageName.equals(<span class="string">&quot;com.example.demoso1&quot;</span>))&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> loadPackageParam.classLoader.loadClass(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>);</span><br><span class="line">        <span class="comment">// 方法1：通过 hook 获取 MainActivity 对象实例</span></span><br><span class="line">        <span class="comment">// 得到 object 之前必须 hook onCreate 方法</span></span><br><span class="line">        XposedBridge.hookAllMethods(clazz, <span class="string">&quot;onCreate&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>()&#123;</span><br><span class="line">            <span class="comment">// 由于 method01 与 method02 是 native 的，因此在 onCreate 执行前 method01/02 就已经准备就绪</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable&#123;</span><br><span class="line">                <span class="built_in">super</span>.beforeHookedMethod(param);</span><br><span class="line">                <span class="comment">// 获取 MainActivity 对象</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">mMainActivity</span> <span class="operator">=</span> param.thisObject;</span><br><span class="line">                <span class="comment">// 主动调用 method01 与 method02 函数</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">cipherText</span> <span class="operator">=</span> (String)XposedHelpers.callMethod(mMainActivity, <span class="string">&quot;method01&quot;</span>, <span class="string">&quot;wd2711&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">clearText</span> <span class="operator">=</span> (String)XposedHelpers.callMethod(mMainActivity, <span class="string">&quot;method02&quot;</span>, <span class="string">&quot;47fcda3822cd10a8e2f667fa49da783f&quot;</span>);</span><br><span class="line">                XposedBridge.log(<span class="string">&quot;(1) cipherText =&gt; &quot;</span> + cipherText);</span><br><span class="line">                XposedBridge.log(<span class="string">&quot;(1) clearText =&gt; &quot;</span> + clearText);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 方法2：通过 newInstance 获取对象实例</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">newMainActivity</span> <span class="operator">=</span> XposedHelpers.newInstance(clazz);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cipherText</span> <span class="operator">=</span> (String)XposedHelpers.callMethod(newMainActivity, <span class="string">&quot;method01&quot;</span>, <span class="string">&quot;wd2711&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">clearText</span> <span class="operator">=</span> (String)XposedHelpers.callMethod(newMainActivity, <span class="string">&quot;method02&quot;</span>, <span class="string">&quot;47fcda3822cd10a8e2f667fa49da783f&quot;</span>);</span><br><span class="line">        XposedBridge.log(<span class="string">&quot;(2) cipherText =&gt; &quot;</span> + cipherText);</span><br><span class="line">        XposedBridge.log(<span class="string">&quot;(2) clearText =&gt; &quot;</span> + clearText);</span><br><span class="line">        <span class="comment">// logic-4</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;结果如下所示：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231022154106062.png" alt="image-20231022154106062" style="zoom:67%;" /></p>
<p>&emsp;接下来，导入NanoHTTPD以进行RPC：</p>
<p>（1）在app/build.gradle文件的dependencies下增加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation &#x27;org.nanohttpd:nanohttpd:2.3.1&#x27;</span><br></pre></td></tr></table></figure>
<p>&emsp;Nanohttpd只存在一个抽象类NanoHTTPD，主要有：start（启动web服务器）、stop（停止web服务器）、serve（收到web请求后的回调函数）。<code>serve只有一个参数，为IHTTPSession类型，可用于判断浏览器请求内容，包括请求方法、参数、URL等。</code>NanoHTTPD的构造函数可以指定web服务监听的端口。在此，简单的以NanoHTTPD实现hello world界面（应该加在上述代码的logic-4中）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_">NanoHTTPD</span>&#123;</span><br><span class="line">    <span class="comment">// App 构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">App</span><span class="params">()</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="comment">// 指定监听端口</span></span><br><span class="line">        <span class="built_in">super</span>(<span class="number">8899</span>);</span><br><span class="line">        <span class="comment">// start 启动 HTTP 服务</span></span><br><span class="line">        start(NanoHTTPD.SOCKET_READ_TIMEOUT, <span class="literal">true</span>);</span><br><span class="line">        XposedBridge.log(<span class="string">&quot;Running!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// serve 回调函数</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> NanoHTTPD.Response <span class="title function_">serve</span><span class="params">(IHTTPSession session)</span>&#123;</span><br><span class="line">        <span class="comment">// 获取 HTTP 方法：POST、GET</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> session.getMethod();</span><br><span class="line">        <span class="comment">// 获取 URI</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> session.getUri();</span><br><span class="line">        <span class="comment">// 获取访问者 IP</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">RemoteIP</span> <span class="operator">=</span> session.getRemoteIpAddress();</span><br><span class="line">        <span class="comment">// 获取访问者 HostName</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">RemoteHostName</span> <span class="operator">=</span> session.getRemoteHostName();</span><br><span class="line">        Log.i(<span class="string">&quot;nanohttpd&quot;</span>, <span class="string">&quot;Method =&gt; &quot;</span> + method);</span><br><span class="line">        Log.i(<span class="string">&quot;nanohttpd&quot;</span>, <span class="string">&quot;URI =&gt; &quot;</span> + uri);</span><br><span class="line">        Log.i(<span class="string">&quot;nanohttpd&quot;</span>, <span class="string">&quot;Remote_IP =&gt; &quot;</span> + RemoteIP);</span><br><span class="line">        Log.i(<span class="string">&quot;nanohttpd&quot;</span>, <span class="string">&quot;RemoteHostName =&gt; &quot;</span> + RemoteHostName);</span><br><span class="line">        <span class="comment">// 页面返回值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;&lt;html&gt;&lt;body&gt;Hello wd2711\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> newFixedLengthResponse(Response.Status.OK, NanoHTTPD.MIME_PLAINTEXT, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">App</span>();</span><br></pre></td></tr></table></figure>
<p>&emsp;安装好xposed插件，启动demoso1，并访问<code>手机IP+端口</code>，结果显示如下：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231022160559470.png" alt="image-20231022160559470" style="zoom:67%;" /></p>
<p>&emsp;浏览器访问结果如下：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231022160635723.png" alt="image-20231022160635723" style="zoom:67%;" /></p>
<p>（2）经过上面的测试，NanoHTTPD服务启动正常，接着更改serve内容，以增加函数主动调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> NanoHTTPD.Response <span class="title function_">serve</span><span class="params">(IHTTPSession session)</span>&#123;</span><br><span class="line">    <span class="comment">// 获取 URI</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> session.getUri();</span><br><span class="line">    <span class="comment">// 解析 POST 方法访问时的传参内容</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">paramBody</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    Map&lt;String, String&gt;params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">// session.parseBody(params) 的目的是试着 parse 一下，看 session 是否是合理的</span></span><br><span class="line">        session.parseBody(params);</span><br><span class="line">        paramBody = session.getQueryParameterString();</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span>(ResponseException e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(uri.contains(<span class="string">&quot;encrypt&quot;</span>))&#123;</span><br><span class="line">        <span class="comment">// getActivity() 函数返回之前获取的 MainActivity 对象</span></span><br><span class="line">        result = (String)XposedHelpers.callMethod(getActivity(), <span class="string">&quot;method01&quot;</span>, paramBody);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(uri.contains(<span class="string">&quot;decrypt&quot;</span>))&#123;</span><br><span class="line">        result = (String)XposedHelpers.callMethod(getActivity(), <span class="string">&quot;method02&quot;</span>, paramBody);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newFixedLengthResponse(Response.Status.OK, NanoHTTPD.MIME_PLAINTEXT, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;安装好xposed插件，启动demoso1，使用 curl进行post，结果如下：</p>
<p><img src="/images/frida-reverse-analysis-2/image-20231022164520100.png" alt="image-20231022164520100" style="zoom:67%;" /></p>
<p>（3）最后，使用python进行进一步封装：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">param</span>):</span><br><span class="line">    url = <span class="string">&quot;http://192.168.48.14:8899/encrypt&quot;</span></span><br><span class="line">    headers = &#123;<span class="string">&quot;Content-Type&quot;</span>:<span class="string">&quot;application/x-www-form-urlencoded&quot;</span>&#125;</span><br><span class="line">    r = requests.post(url = url, data = param, headers = headers)</span><br><span class="line">    <span class="built_in">print</span>(r.content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">param</span>):</span><br><span class="line">    url = <span class="string">&quot;http://192.168.48.14:8899/decrypt&quot;</span></span><br><span class="line">    headers = &#123;<span class="string">&quot;Content-Type&quot;</span>:<span class="string">&quot;application/x-www-form-urlencoded&quot;</span>&#125;</span><br><span class="line">    r = requests.post(url = url, data = param, headers = headers)</span><br><span class="line">    <span class="built_in">print</span>(r.content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    encrypt(<span class="string">&quot;wd&quot;</span>)</span><br><span class="line">    decrypt(<span class="string">&quot;169dc260893dab88cd619d5e35e17634&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>&emsp;Hook上，frida与xposed不分伯仲。但是<code>在细节上，xposed支持使用setAdditionalInstanceField、setAdditionalStaticField等函数给实例对象添加动静态成员，而frida支持Java.choose从进程堆中搜索目标对象。在宏观上，frida可以热重载（不用重启），作用对象是特定进程，Hook原理类似于调试器，而xposed针对所有进程，类似于系统框架级服务。</code></p>

  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2023/10/13/muraen-source-code-reading/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> 上一页</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2023/09/25/intern-ms-prepare/" type="button" class="btn btn-default ">下一页<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>


	<!-- comment -->
	
<section id="comment">
    <h2 class="title">留言</h2>

    <!-- 
    <div id="disqus_thread" class="ds-thread">
        <script type="text/javascript">
            /**
             * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
             * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
             */
                /*
                 var disqus_config = function () {
                 this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                 this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                 };
                 */
            (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');

                s.src = 'https://https-wd-2711-tech.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by
                Disqus.</a></noscript>
    </div> -->
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <div id="vcomments"></div>
    <script>
        new Valine({
            el: '#vcomments',
            appId: 'wLIJ70s3fPvW8WJPgVVAuWVR-gzGzoHsz',
            appKey: 'NVGqxhUkqtFv2CbwmXXWjCdR'
        })
    </script>

    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2023-10-09 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/re-book/">re-book<span>11</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Frida%E9%80%86%E5%90%91%E4%B8%8E%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90-2"><span class="toc-article-text">Frida逆向与协议分析-2</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#0x03-Frida%E9%80%86%E5%90%91%E4%B9%8B%E8%BF%9D%E6%B3%95App%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%96%E8%AF%81%E5%AE%9E%E6%88%98"><span class="toc-article-text">0x03 Frida逆向之违法App协议分析与取证实战</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%8A%A0%E5%9B%BAapp%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90"><span class="toc-article-text">加固app协议分析</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E6%8A%93%E5%8C%85"><span class="toc-article-text">抓包</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E6%B3%A8%E5%86%8C-%E7%99%BB%E5%BD%95%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90"><span class="toc-article-text">注册&#x2F;登录协议分析</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E8%BF%9D%E6%B3%95%E5%BA%94%E7%94%A8%E5%8F%96%E8%AF%81%E5%88%86%E6%9E%90%E4%B8%8Evip%E7%A0%B4%E8%A7%A3"><span class="toc-article-text">违法应用取证分析与vip破解</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#vip%E6%B8%85%E6%99%B0%E5%BA%A6%E7%A0%B4%E8%A7%A3"><span class="toc-article-text">vip清晰度破解</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E5%9B%BE%E7%89%87%E5%8F%96%E8%AF%81%E5%88%86%E6%9E%90"><span class="toc-article-text">图片取证分析</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#0x04-Xposed-Hook%E5%8F%8A%E4%B8%BB%E5%8A%A8%E8%B0%83%E7%94%A8%E4%B8%8ERPC%E5%AE%9E%E7%8E%B0"><span class="toc-article-text">0x04 Xposed Hook及主动调用与RPC实现</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Xposed-%E5%BA%94%E7%94%A8-hook"><span class="toc-article-text">Xposed 应用 hook</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Xposed-%E5%AE%89%E8%A3%85-amp-Xposed%E6%8F%92%E4%BB%B6%EF%BC%88%E6%A8%A1%E5%9D%97%EF%BC%89"><span class="toc-article-text">Xposed 安装&amp;Xposed插件（模块）</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Hook-API-%E8%AF%A6%E8%A7%A3"><span class="toc-article-text">Hook API 详解</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Xposed-Hook%E5%8A%A0%E5%9B%BA%E5%BA%94%E7%94%A8"><span class="toc-article-text">Xposed Hook加固应用</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Frida-%E6%8E%A2-Xposed-Hook"><span class="toc-article-text">Frida 探 Xposed Hook</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Xposed-%E4%B8%BB%E5%8A%A8%E8%B0%83%E7%94%A8%E4%B8%8E-RPC-%E5%AE%9E%E7%8E%B0"><span class="toc-article-text">Xposed 主动调用与 RPC 实现</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Xposed-%E4%B8%BB%E5%8A%A8%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-article-text">Xposed 主动调用函数</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Xposed-%E7%BB%93%E5%90%88-NanoHTTPD-%E5%AE%9E%E7%8E%B0-RPC-%E8%B0%83%E7%94%A8"><span class="toc-article-text">Xposed 结合 NanoHTTPD 实现 RPC 调用</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-article-text">总结</span></a></li></ol></li></ol></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>

	<!-- copyright -->
	<div>
    <ul class="post-copyright">
      <li class="post-copyright-author">
      <strong>作者:  </strong>wd-z711</a>
      </li>
      <li class="post-copyright-link">
      <strong>文章链接:  </strong>
      <a href="/" target="_blank" title="">https://wd-2711.tech/</a>
      </li>
      <li class="post-copyright-license">
        <strong>版权声明:   </strong>
        本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
        许可协议。转载请注明出处!
      </li>
    </ul>
  <div>
 	

		


</div><!-- row -->




	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2023 wd-z711
  
      <!-- with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.     -->

     <!-- <script type="text/javascript">
      (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
      (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
      e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
      })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
      
      _st('install','aB-vgeB8gEDrnRJuhceL','2.0.0');
    </script> -->
    </p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
