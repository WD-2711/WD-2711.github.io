<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>re-part-6 | wd-z711&#39;s B10g</title>
  <meta name="author" content="wd-z711">
  
  <meta name="description" content="Offensive and defensive world difficulty 6 wp.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="re-part-6"/>
  <meta property="og:site_name" content="wd-z711&#39;s B10g"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'G-YHJSKZDC3Y', 'auto');
  ga('send', 'pageview');
</script>




<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="wd-z711's B10g" type="application/atom+xml">
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">wd-z711&#39;s B10g</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> re-part-6</h1>
		</div>
	



<div class="row post">

	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> Offensive and defensive world difficulty 6 wp.
		 </div> <!-- alert -->
	  		

	  <p>历经千辛万苦，终于到难度6啦。</p>
<hr>
<h1 id="easy-Maze"><a href="#easy-Maze" class="headerlink" title="easy_Maze"></a>easy_Maze</h1><p>&emsp;64位ELF。</p>
<p><img src="/images/re-part-6/image-20230522105434362.png" alt="image-20230522105434362" style="zoom:67%;" /></p>
<p>&emsp;第一个红框生成迷宫，第二个红框开始走迷宫。跟踪<code>Step_2</code>，得到：</p>
<span id="more"></span>
<p><img src="/images/re-part-6/image-20230522105513692.png" alt="image-20230522105513692" style="zoom:67%;" /></p>
<p>&emsp;动态调试得到迷宫：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1001111</span><br><span class="line">1011001</span><br><span class="line">1110111</span><br><span class="line">0001100</span><br><span class="line">1111000</span><br><span class="line">1000111</span><br><span class="line">1111101</span><br></pre></td></tr></table></figure>
<p>&emsp;从左上角走到右下角，最后flag为<code>UNCTF&#123;ssddwdwdddssaasasaaassddddwdds&#125;</code>。</p>
<h1 id="ey-or"><a href="#ey-or" class="headerlink" title="ey-or"></a>ey-or</h1><p>&emsp;题目说此文件包含一个标志，并提取。<code>tar.gz</code>文件。文件比较大，23MB。</p>
<p>任务1：找到print函数是什么？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">调用链：</span><br><span class="line">1. print sub_300000114AC8</span><br><span class="line">2. print sub_600000603960</span><br><span class="line">3. print sub_600000DE9230</span><br><span class="line">4. print sub_300000115A74</span><br><span class="line"># 5. print sub_600000DE9230 jmp 00003000001164F5 （没打断点）</span><br><span class="line">6. print sub_300000114AC8 （没打断点）</span><br><span class="line">7. print 0000600000E1FD00</span><br><span class="line">8. print 600000163050h, jmp 60000053B110</span><br><span class="line">9. print sub_3000001164F5</span><br><span class="line">10.print sub_300000114AC8</span><br><span class="line">11.000030000011B284</span><br><span class="line">12.没有 call, syscall</span><br></pre></td></tr></table></figure>
<p>输入存在哪儿：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># flag&#123;afffffffffffffffffffffffffffffffff&#125;</span><br><span class="line"># 1lag&#123;afffffffffffffffffffffffffffffffff&#125;</span><br><span class="line"># 1234567812345678123456781234567812345678</span><br><span class="line">最初：0000600000652878-000060000065289F</span><br><span class="line">之后：000060000064D0A8-000060000064D0CF（用于判断长度）</span><br><span class="line">最后：000060000064C188-000060000064C1AF（用于判断是否是0-9）</span><br><span class="line">还有：0000600000656088-00006000006560AF</span><br><span class="line">还调试到程序拿 000060000064C188 中的字符作比较，判断是否在 &quot;0-9&quot; 之间</span><br><span class="line">000060000064C168   + F40</span><br><span class="line">000060000064C188                 third</span><br><span class="line">000060000064D0A8   + 57D0        second</span><br><span class="line">复制flag中的字符到0000600000651FA8中（应该不是）</span><br><span class="line">0000600000651190 ascii 码表（4个）</span><br></pre></td></tr></table></figure>
<p>&emsp;调试了一天半，没做出来，仍需努力。（<strong>感觉还是不够耐心，看到代码太多太复杂就没有勇气看了</strong>）</p>
<h2 id="0x01-wp复现"><a href="#0x01-wp复现" class="headerlink" title="0x01 wp复现"></a>0x01 wp复现</h2><p>&emsp;佬们说这是Elymas语言。说实话，这个，就算我再看一天，应该也看不出来。（搜索资料的能力太差了。）</p>
<p>&emsp;其他师傅首先看文件字符串，看到有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">] == f</span><br><span class="line">secret len == l</span><br><span class="line">[ ] == buffer</span><br><span class="line">0 == i</span><br><span class="line">0 == j</span><br><span class="line">&quot;Enter Password line by line\n&quot; sys .out .writeall</span><br><span class="line">&#123;</span><br><span class="line">    #str .fromArray secret bxor</span><br><span class="line">    txt .consume .u</span><br><span class="line">    =j</span><br><span class="line">    [ buffer _ len dearray j ] = buffer</span><br><span class="line">    [ secret _ len dearray j eq &#123; &#125; &#123; 1 sys .exit &#125; ? * ] = secret</span><br><span class="line">    i 1 add = i </span><br><span class="line">    i l eq &#123;</span><br><span class="line">        buffer f bxor str .fromArray sys .out .writeall</span><br><span class="line">        0 sys .exit</span><br><span class="line">    &#125; &#123; &#125; ? *</span><br><span class="line">&#125; sys .in .eachLine</span><br><span class="line">&#125; &quot;ey_or&quot; sys .freeze</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">	Groovy 编程语言编写的程序，用于读取用户输入的密码并进行加密解密操作。</span><br><span class="line"></span><br><span class="line">首先，程序输出一条提示信息，要求用户逐行输入密码。然后，程序使用一个循环来逐行读取用户输入的密码。在每次循环中，程序会将输入的密码和预设的密钥进行异或操作，并将结果存储在一个名为 buffer 的数组中。同时，程序也会将预设的密钥和输入的密码存储在名为 secret 的数组中，以便后续的解密操作使用。</span><br><span class="line"></span><br><span class="line">在每次循环结束后，程序会将循环计数器 i 的值加 1。当 i 的值等于密码数组的长度时，程序会将 buffer 数组和预设的密钥数组进行异或操作，并将结果输出到标准输出。然后，程序会结束执行并退出。</span><br></pre></td></tr></table></figure>
<p>&emsp;反正我没根据上述程序搜到Elymas语言，直接给chatGPT，它的解释如上所示。整理一下程序思路：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">i = <span class="number">0</span></span><br><span class="line">j = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Enter Password line by line&quot;</span>)</span><br><span class="line">secret = [??]</span><br><span class="line">f = [??]</span><br><span class="line">l = <span class="built_in">len</span>(secret)</span><br><span class="line">buffer = []</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	j = readline()</span><br><span class="line">	buffer.append(j)</span><br><span class="line">	<span class="keyword">if</span> secert[i] != j:</span><br><span class="line">		exit(<span class="number">0</span>)</span><br><span class="line">	i += <span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> i == l:</span><br><span class="line">		<span class="built_in">print</span>(buffer ^ f)</span><br><span class="line">		exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>&emsp;那么我们就可以：<strong>输入一个字符，如果程序结束，则说明输入的字符不对，如果程序继续运行，那么程序的输入就是正确的。</strong></p>
<p>&emsp;下面是使用<code>subprocess</code>操控程序的脚本，自己写的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">result = []</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment"># 遍历每一个字符</span></span><br><span class="line">    <span class="keyword">for</span> inp <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="number">256</span>)):</span><br><span class="line">        process = subprocess.Popen([<span class="string">&#x27;./ey_or&#x27;</span>], stdin=subprocess.PIPE, stdout=subprocess.PIPE)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构造输入</span></span><br><span class="line">        all_inp_str = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> result:</span><br><span class="line">            all_inp_str += i</span><br><span class="line">        inp_str = <span class="built_in">str</span>(inp) + <span class="string">&quot;\n&quot;</span></span><br><span class="line">        all_inp_str += inp_str</span><br><span class="line"></span><br><span class="line">        process.stdin.write(all_inp_str.encode())</span><br><span class="line">        process.stdin.close()</span><br><span class="line"></span><br><span class="line">        return_code = process.wait(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果程序结束，则返回 1</span></span><br><span class="line">        <span class="keyword">if</span> return_code == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># 程序正常结束，返回 0</span></span><br><span class="line">        <span class="keyword">elif</span> return_code == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;input:&quot;</span>, result)</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result.append(inp_str)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">process = subprocess.Popen([<span class="string">&#x27;./ey_or&#x27;</span>], stdin=subprocess.PIPE, stdout=subprocess.PIPE)</span><br><span class="line">result = [<span class="string">&#x27;36\n&#x27;</span>, <span class="string">&#x27;30\n&#x27;</span>, <span class="string">&#x27;156\n&#x27;</span>, <span class="string">&#x27;30\n&#x27;</span>, <span class="string">&#x27;43\n&#x27;</span>, <span class="string">&#x27;6\n&#x27;</span>, <span class="string">&#x27;116\n&#x27;</span>, <span class="string">&#x27;22\n&#x27;</span>, <span class="string">&#x27;211\n&#x27;</span>, <span class="string">&#x27;66\n&#x27;</span>, <span class="string">&#x27;151\n&#x27;</span>, <span class="string">&#x27;89\n&#x27;</span>, <span class="string">&#x27;36\n&#x27;</span>, <span class="string">&#x27;82\n&#x27;</span>, <span class="string">&#x27;254\n&#x27;</span>, <span class="string">&#x27;81\n&#x27;</span>, <span class="string">&#x27;182\n&#x27;</span>, <span class="string">&#x27;134\n&#x27;</span>, <span class="string">&#x27;24\n&#x27;</span>, <span class="string">&#x27;90\n&#x27;</span>, <span class="string">&#x27;119\n&#x27;</span>, <span class="string">&#x27;6\n&#x27;</span>, <span class="string">&#x27;88\n&#x27;</span>, <span class="string">&#x27;137\n&#x27;</span>, <span class="string">&#x27;64\n&#x27;</span>, <span class="string">&#x27;197\n&#x27;</span>, <span class="string">&#x27;251\n&#x27;</span>, <span class="string">&#x27;15\n&#x27;</span>, <span class="string">&#x27;116\n&#x27;</span>, <span class="string">&#x27;220\n&#x27;</span>, <span class="string">&#x27;161\n&#x27;</span>, <span class="string">&#x27;94\n&#x27;</span>, <span class="string">&#x27;154\n&#x27;</span>, <span class="string">&#x27;252\n&#x27;</span>, <span class="string">&#x27;139\n&#x27;</span>, <span class="string">&#x27;11\n&#x27;</span>, <span class="string">&#x27;41\n&#x27;</span>, <span class="string">&#x27;215\n&#x27;</span>, <span class="string">&#x27;27\n&#x27;</span>, <span class="string">&#x27;158\n&#x27;</span>, <span class="string">&#x27;143\n&#x27;</span>, <span class="string">&#x27;140\n&#x27;</span>, <span class="string">&#x27;54\n&#x27;</span>, <span class="string">&#x27;189\n&#x27;</span>, <span class="string">&#x27;146\n&#x27;</span>, <span class="string">&#x27;48\n&#x27;</span>, <span class="string">&#x27;167\n&#x27;</span>, <span class="string">&#x27;56\n&#x27;</span>, <span class="string">&#x27;84\n&#x27;</span>, <span class="string">&#x27;226\n&#x27;</span>, <span class="string">&#x27;15\n&#x27;</span>, <span class="string">&#x27;188\n&#x27;</span>, <span class="string">&#x27;126\n&#x27;</span>, <span class="string">&#x27;24\n&#x27;</span>]</span><br><span class="line">all_inp_str = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> result:</span><br><span class="line">    all_inp_str += i</span><br><span class="line">stdout_data, stderr_data = process.communicate(<span class="built_in">input</span>=all_inp_str.encode())</span><br><span class="line"><span class="built_in">print</span>(stdout_data)</span><br><span class="line"><span class="comment"># 32C3_wE_kNoW_EvErYbOdY_LiKeS_eLyMaS</span></span><br></pre></td></tr></table></figure>
<p>&emsp;总结一下：<strong>不要头铁，多找找题目信息。一股脑调试2天，自己真傻逼呀。</strong></p>
<h1 id="libdroid"><a href="#libdroid" class="headerlink" title="libdroid"></a>libdroid</h1><p>&emsp;apk文件，用jeb打开，审计字节码。</p>
<p>&emsp;发现：</p>
<p><img src="/images/re-part-6/image-20230524125534936.png" alt="image-20230524125534936" style="zoom:67%;" /></p>
<p>&emsp;但是<code>getFlag</code>是在本地实现的，其声明如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public static native String getFlag() &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;于是猜测是不是在apk自带的库中，发现：</p>
<p><img src="/images/re-part-6/image-20230524125711635.png" alt="image-20230524125711635" style="zoom:67%;" /></p>
<p>&emsp;这不是<code>flag</code>，返回的值为<code>v2</code>函数处理后的，<code>v2</code>是由<code>v1</code>得来的，<code>v1</code>是此函数的参数，并不清楚此函数参数的传值。所以打算使用mumu+jeb3动态调试此程序。</p>
<p>&emsp;结果此apk不支持调试，所以打算加上调试选项（重签名等操作），最后得到：</p>
<p><img src="/images/re-part-6/image-20230524142701240.png" alt="image-20230524142701240" style="zoom:67%;" /></p>
<p>&emsp;对此apk进行动态调试，如下所示：</p>
<p><img src="/images/re-part-6/image-20230524165057620.png" alt="image-20230524165057620" style="zoom:67%;" /></p>
<p>&emsp;其中，<code>v7</code>与<code>v4</code>分别为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v7 = [&#x27;FE&#x27;, &#x27;A0&#x27;, &#x27;AD&#x27;, &#x27;80&#x27;, &#x27;20&#x27;, &#x27;59&#x27;, &#x27;AB&#x27;, &#x27;12&#x27;, &#x27;D7&#x27;, &#x27;C3&#x27;, &#x27;9C&#x27;, &#x27;88&#x27;, &#x27;FA&#x27;, &#x27;2C&#x27;, &#x27;1D&#x27;, &#x27;FC&#x27;, &#x27;81&#x27;, &#x27;46&#x27;, &#x27;0D&#x27;, &#x27;DC&#x27;, &#x27;E9&#x27;, &#x27;CE&#x27;, &#x27;CC&#x27;, &#x27;57&#x27;, &#x27;78&#x27;, &#x27;F5&#x27;, &#x27;41&#x27;, &#x27;5F&#x27;, &#x27;52&#x27;, &#x27;2&#x27;, &#x27;36&#x27;, &#x27;D5&#x27;, &#x27;33&#x27;, &#x27;18&#x27;, &#x27;66&#x27;, &#x27;3A&#x27;, &#x27;40&#x27;, &#x27;26&#x27;, &#x27;E8&#x27;, &#x27;6E&#x27;, &#x27;B6&#x27;, &#x27;CD&#x27;, &#x27;72&#x27;, &#x27;B7&#x27;, &#x27;3C&#x27;, &#x27;1&#x27;, &#x27;66&#x27;, &#x27;B1&#x27;, &#x27;4F&#x27;, &#x27;99&#x27;, &#x27;23&#x27;, &#x27;63&#x27;, &#x27;95&#x27;, &#x27;77&#x27;, &#x27;34&#x27;, &#x27;61&#x27;, &#x27;69&#x27;, &#x27;F6&#x27;, &#x27;A9&#x27;, &#x27;53&#x27;, &#x27;40&#x27;, &#x27;37&#x27;, &#x27;41&#x27;, &#x27;43&#x27;, &#x27;4F&#x27;, &#x27;98&#x27;, &#x27;95&#x27;, &#x27;2C&#x27;, &#x27;7A&#x27;, &#x27;27&#x27;, &#x27;3C&#x27;, &#x27;98&#x27;, &#x27;68&#x27;, &#x27;1A&#x27;, &#x27;88&#x27;, &#x27;A8&#x27;, &#x27;B7&#x27;, &#x27;85&#x27;, &#x27;BB&#x27;, &#x27;15&#x27;, &#x27;4F&#x27;, &#x27;1A&#x27;, &#x27;1&#x27;, &#x27;4D&#x27;, &#x27;C9&#x27;, &#x27;C8&#x27;, &#x27;9B&#x27;, &#x27;75&#x27;, &#x27;78&#x27;, &#x27;57&#x27;, &#x27;7F&#x27;, &#x27;98&#x27;, &#x27;0D&#x27;, &#x27;D8&#x27;, &#x27;51&#x27;, &#x27;A8&#x27;, &#x27;22&#x27;, &#x27;B9&#x27;, &#x27;5E&#x27;, &#x27;59&#x27;, &#x27;4D&#x27;, &#x27;71&#x27;, &#x27;4F&#x27;, &#x27;1A&#x27;, &#x27;81&#x27;, &#x27;A9&#x27;, &#x27;BF&#x27;, &#x27;7&#x27;, &#x27;29&#x27;, &#x27;ED&#x27;, &#x27;FD&#x27;, &#x27;83&#x27;]</span><br><span class="line">  </span><br><span class="line">v4 = [&#x27;21&#x27;, &#x27;0&#x27;, &#x27;86&#x27;, &#x27;B7&#x27;, &#x27;FF&#x27;, &#x27;86&#x27;, &#x27;5D&#x27;, &#x27;6&#x27;, &#x27;2D&#x27;, &#x27;30&#x27;, 6 次输入]</span><br></pre></td></tr></table></figure>
<p>&emsp;其中，<code>phoneHome</code>函数如下所示：</p>
<p><img src="/images/re-part-6/image-20230524173252277.png" alt="image-20230524173252277" style="zoom:67%;" /></p>
<p>&emsp;这是一个静态函数，保存在<code>liblibdroid.so</code>中，里面第18行、19行、20行调用的别的函数，是静态链接到<code>bytecode</code>上的。</p>
<p><img src="/images/re-part-6/image-20230524173332616.png" alt="image-20230524173332616" style="zoom:67%;" /></p>
<p>&emsp;下面需要调研一下静态链接是怎么连接到apk文件中的。</p>
<p>&emsp;没咋调研出来，准备直接猜上面函数的各种操作，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">a3_init = [<span class="string">&#x27;FE&#x27;</span>, <span class="string">&#x27;A0&#x27;</span>, <span class="string">&#x27;AD&#x27;</span>, <span class="string">&#x27;80&#x27;</span>, <span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;59&#x27;</span>, <span class="string">&#x27;AB&#x27;</span>, <span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;D7&#x27;</span>, <span class="string">&#x27;C3&#x27;</span>, <span class="string">&#x27;9C&#x27;</span>, <span class="string">&#x27;88&#x27;</span>, <span class="string">&#x27;FA&#x27;</span>, <span class="string">&#x27;2C&#x27;</span>, <span class="string">&#x27;1D&#x27;</span>, <span class="string">&#x27;FC&#x27;</span>, <span class="string">&#x27;81&#x27;</span>, <span class="string">&#x27;46&#x27;</span>, <span class="string">&#x27;0D&#x27;</span>, <span class="string">&#x27;DC&#x27;</span>, <span class="string">&#x27;E9&#x27;</span>, <span class="string">&#x27;CE&#x27;</span>, <span class="string">&#x27;CC&#x27;</span>, <span class="string">&#x27;57&#x27;</span>, <span class="string">&#x27;78&#x27;</span>, <span class="string">&#x27;F5&#x27;</span>, <span class="string">&#x27;41&#x27;</span>, <span class="string">&#x27;5F&#x27;</span>, <span class="string">&#x27;52&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;36&#x27;</span>, <span class="string">&#x27;D5&#x27;</span>, <span class="string">&#x27;33&#x27;</span>, <span class="string">&#x27;18&#x27;</span>, <span class="string">&#x27;66&#x27;</span>, <span class="string">&#x27;3A&#x27;</span>, <span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;26&#x27;</span>, <span class="string">&#x27;E8&#x27;</span>, <span class="string">&#x27;6E&#x27;</span>, <span class="string">&#x27;B6&#x27;</span>, <span class="string">&#x27;CD&#x27;</span>, <span class="string">&#x27;72&#x27;</span>, <span class="string">&#x27;B7&#x27;</span>, <span class="string">&#x27;3C&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;66&#x27;</span>, <span class="string">&#x27;B1&#x27;</span>, <span class="string">&#x27;4F&#x27;</span>, <span class="string">&#x27;99&#x27;</span>, <span class="string">&#x27;23&#x27;</span>, <span class="string">&#x27;63&#x27;</span>, <span class="string">&#x27;95&#x27;</span>, <span class="string">&#x27;77&#x27;</span>, <span class="string">&#x27;34&#x27;</span>, <span class="string">&#x27;61&#x27;</span>, <span class="string">&#x27;69&#x27;</span>, <span class="string">&#x27;F6&#x27;</span>, <span class="string">&#x27;A9&#x27;</span>, <span class="string">&#x27;53&#x27;</span>, <span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;37&#x27;</span>, <span class="string">&#x27;41&#x27;</span>, <span class="string">&#x27;43&#x27;</span>, <span class="string">&#x27;4F&#x27;</span>, <span class="string">&#x27;98&#x27;</span>, <span class="string">&#x27;95&#x27;</span>, <span class="string">&#x27;2C&#x27;</span>, <span class="string">&#x27;7A&#x27;</span>, <span class="string">&#x27;27&#x27;</span>, <span class="string">&#x27;3C&#x27;</span>, <span class="string">&#x27;98&#x27;</span>, <span class="string">&#x27;68&#x27;</span>, <span class="string">&#x27;1A&#x27;</span>, <span class="string">&#x27;88&#x27;</span>, <span class="string">&#x27;A8&#x27;</span>, <span class="string">&#x27;B7&#x27;</span>, <span class="string">&#x27;85&#x27;</span>, <span class="string">&#x27;BB&#x27;</span>, <span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;4F&#x27;</span>, <span class="string">&#x27;1A&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;4D&#x27;</span>, <span class="string">&#x27;C9&#x27;</span>, <span class="string">&#x27;C8&#x27;</span>, <span class="string">&#x27;9B&#x27;</span>, <span class="string">&#x27;75&#x27;</span>, <span class="string">&#x27;78&#x27;</span>, <span class="string">&#x27;57&#x27;</span>, <span class="string">&#x27;7F&#x27;</span>, <span class="string">&#x27;98&#x27;</span>, <span class="string">&#x27;0D&#x27;</span>, <span class="string">&#x27;D8&#x27;</span>, <span class="string">&#x27;51&#x27;</span>, <span class="string">&#x27;A8&#x27;</span>, <span class="string">&#x27;22&#x27;</span>, <span class="string">&#x27;B9&#x27;</span>, <span class="string">&#x27;5E&#x27;</span>, <span class="string">&#x27;59&#x27;</span>, <span class="string">&#x27;4D&#x27;</span>, <span class="string">&#x27;71&#x27;</span>, <span class="string">&#x27;4F&#x27;</span>, <span class="string">&#x27;1A&#x27;</span>, <span class="string">&#x27;81&#x27;</span>, <span class="string">&#x27;A9&#x27;</span>, <span class="string">&#x27;BF&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;29&#x27;</span>, <span class="string">&#x27;ED&#x27;</span>, <span class="string">&#x27;FD&#x27;</span>, <span class="string">&#x27;83&#x27;</span>] </span><br><span class="line">a4_init = [<span class="string">&#x27;21&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;86&#x27;</span>, <span class="string">&#x27;B7&#x27;</span>, <span class="string">&#x27;FF&#x27;</span>, <span class="string">&#x27;86&#x27;</span>, <span class="string">&#x27;5D&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;2D&#x27;</span>, <span class="string">&#x27;30&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(a3_init))</span><br><span class="line">all_in = [<span class="number">0x20</span>, ]</span><br><span class="line"><span class="keyword">for</span> i1 <span class="keyword">in</span> tqdm(all_in):</span><br><span class="line">    <span class="keyword">for</span> i2 <span class="keyword">in</span> all_in:</span><br><span class="line">        <span class="keyword">for</span> i3 <span class="keyword">in</span> all_in:</span><br><span class="line">            <span class="keyword">for</span> i4 <span class="keyword">in</span> all_in:</span><br><span class="line">                <span class="keyword">for</span> i5 <span class="keyword">in</span> all_in:</span><br><span class="line">                    <span class="keyword">for</span> i6 <span class="keyword">in</span> all_in: </span><br><span class="line">                        a3 = [<span class="built_in">int</span>(i, <span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> a3_init]</span><br><span class="line">                        <span class="built_in">print</span>([<span class="built_in">hex</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> a3])</span><br><span class="line">                        a4 = [<span class="built_in">int</span>(i, <span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> a4_init] + [i1, i2, i3, i4, i5, i6]</span><br><span class="line">                        <span class="built_in">print</span>([<span class="built_in">hex</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> a4])</span><br><span class="line">                        <span class="keyword">assert</span> <span class="built_in">len</span>(a4) == <span class="number">16</span></span><br><span class="line"></span><br><span class="line">                        v8 = a4</span><br><span class="line">                        v10 = v8[<span class="number">0</span>] | (v8[<span class="number">3</span>] &lt;&lt; <span class="number">24</span>) | (v8[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) | (v8[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>)</span><br><span class="line">                        v11 = (v8[<span class="number">5</span>] &lt;&lt; <span class="number">8</span>) | v8[<span class="number">4</span>] | (v8[<span class="number">7</span>] &lt;&lt; <span class="number">24</span>) | (v8[<span class="number">6</span>] &lt;&lt; <span class="number">16</span>)</span><br><span class="line">                        v12 = v8[<span class="number">8</span>] | (v8[<span class="number">11</span>] &lt;&lt; <span class="number">24</span>) | (v8[<span class="number">9</span>] &lt;&lt; <span class="number">8</span>) | (v8[<span class="number">10</span>] &lt;&lt; <span class="number">16</span>)</span><br><span class="line">                        v13 = v8[<span class="number">12</span>] | (v8[<span class="number">15</span>] &lt;&lt; <span class="number">24</span>) | (v8[<span class="number">13</span>] &lt;&lt; <span class="number">8</span>) | (v8[<span class="number">14</span>] &lt;&lt; <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">                        v14 = <span class="number">1</span></span><br><span class="line">                        v15 = <span class="number">8</span> * ((<span class="built_in">len</span>(a3)-<span class="number">1</span>) &gt;&gt; <span class="number">3</span>) + <span class="number">9</span></span><br><span class="line">                        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                            v16 = <span class="number">0xD5B7DDE0</span></span><br><span class="line">                            v17 = (a3[v14] &lt;&lt; <span class="number">8</span>) | a3[v14-<span class="number">1</span>] | (a3[v14+<span class="number">2</span>] &lt;&lt; <span class="number">24</span>) | (a3[v14+<span class="number">1</span>] &lt;&lt; <span class="number">16</span>)</span><br><span class="line">                            v18 = (a3[v14+<span class="number">4</span>] &lt;&lt; <span class="number">8</span>) | a3[v14+<span class="number">3</span>] | (a3[v14+<span class="number">6</span>] &lt;&lt; <span class="number">24</span>) | (a3[v14+<span class="number">5</span>] &lt;&lt; <span class="number">16</span>)</span><br><span class="line">                            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                                v18 = (v18 - ((v17 + v16) ^ (<span class="number">16</span> * v17 + v12) ^ (v13 + (v17 &gt;&gt; <span class="number">5</span>)))) &amp; <span class="number">0xffffffff</span></span><br><span class="line">                                v17 = (v18 - ((v18 + v16) ^ (<span class="number">16</span> * v18 + v10) ^ (v11 + (v18 &gt;&gt; <span class="number">5</span>)))) &amp; <span class="number">0xffffffff</span></span><br><span class="line">                                v16 = (v16 + <span class="number">0x21524111</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">                                <span class="keyword">if</span> v16 == <span class="number">0</span>:</span><br><span class="line">                                    <span class="keyword">break</span></span><br><span class="line">                            v14 += <span class="number">8</span></span><br><span class="line">                            v17_bytelow = (v17) &amp; <span class="number">0xff</span></span><br><span class="line">                            v17_byte1 = (v17 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">                            v17_byte2 = (v17 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span></span><br><span class="line">                            v17_bytehigh = (v17 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line">                            v18_bytelow = (v18) &amp; <span class="number">0xff</span></span><br><span class="line">                            v18_byte1 = (v18 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">                            v18_byte2 = (v18 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span></span><br><span class="line">                            v18_bytehigh = (v18 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line">                            <span class="comment"># a3[v14-8] = v17_byte1</span></span><br><span class="line">                            <span class="comment"># a3[v14-7] = v17_byte2</span></span><br><span class="line">                            <span class="comment"># a3[v14-4] = v18_byte1</span></span><br><span class="line"></span><br><span class="line">                            a3[v14-<span class="number">9</span>] = v17_bytelow</span><br><span class="line">                            a3[v14-<span class="number">8</span>] = v17_byte1</span><br><span class="line">                            a3[v14-<span class="number">7</span>] = v17_byte2</span><br><span class="line">                            a3[v14-<span class="number">6</span>] = v17_bytehigh</span><br><span class="line"></span><br><span class="line">                            a3[v14-<span class="number">5</span>] = v18_bytelow</span><br><span class="line">                            a3[v14-<span class="number">4</span>] = v18_byte1</span><br><span class="line">                            a3[v14-<span class="number">3</span>] = v18_byte2</span><br><span class="line">                            a3[v14-<span class="number">2</span>] = v18_bytehigh        </span><br><span class="line"></span><br><span class="line">                            <span class="comment"># a3[v14-3] = v18_byte2</span></span><br><span class="line">                            <span class="comment"># a3[v14-6] = v17_bytehigh</span></span><br><span class="line">                            <span class="comment"># a3[v14-2] = v18_bytehigh     </span></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> v14 == v15:</span><br><span class="line">                                <span class="keyword">break</span>  </span><br><span class="line">                        <span class="built_in">print</span>([<span class="built_in">hex</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> a3])</span><br><span class="line">                        tt = <span class="string">&quot;&quot;</span></span><br><span class="line">                        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">                            tt += <span class="built_in">chr</span>(a3[i])</span><br><span class="line">                        <span class="keyword">if</span> <span class="string">&quot;ratula&quot;</span> <span class="keyword">in</span> tt:</span><br><span class="line">                            <span class="built_in">print</span>(i1, i2, i3, i4, i5, i6)</span><br></pre></td></tr></table></figure>
<p>&emsp;上述脚本一直跑不出来，看到其他人的wp所示：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41071646/article/details/90232128">https://blog.csdn.net/qq_41071646/article/details/90232128</a></p>
<p>&emsp;思路很正确，感觉是我脚本写的有问题，明天再看看。改完之后的，脚本有点小问题：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">a3_init = [<span class="string">&#x27;FE&#x27;</span>, <span class="string">&#x27;A0&#x27;</span>, <span class="string">&#x27;AD&#x27;</span>, <span class="string">&#x27;80&#x27;</span>, <span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;59&#x27;</span>, <span class="string">&#x27;AB&#x27;</span>, <span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;D7&#x27;</span>, <span class="string">&#x27;C3&#x27;</span>, <span class="string">&#x27;9C&#x27;</span>, <span class="string">&#x27;88&#x27;</span>, <span class="string">&#x27;FA&#x27;</span>, <span class="string">&#x27;2C&#x27;</span>, <span class="string">&#x27;1D&#x27;</span>, <span class="string">&#x27;FC&#x27;</span>, <span class="string">&#x27;81&#x27;</span>, <span class="string">&#x27;46&#x27;</span>, <span class="string">&#x27;0D&#x27;</span>, <span class="string">&#x27;DC&#x27;</span>, <span class="string">&#x27;E9&#x27;</span>, <span class="string">&#x27;CE&#x27;</span>, <span class="string">&#x27;CC&#x27;</span>, <span class="string">&#x27;57&#x27;</span>, <span class="string">&#x27;78&#x27;</span>, <span class="string">&#x27;F5&#x27;</span>, <span class="string">&#x27;41&#x27;</span>, <span class="string">&#x27;5F&#x27;</span>, <span class="string">&#x27;52&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;36&#x27;</span>, <span class="string">&#x27;D5&#x27;</span>, <span class="string">&#x27;33&#x27;</span>, <span class="string">&#x27;18&#x27;</span>, <span class="string">&#x27;66&#x27;</span>, <span class="string">&#x27;3A&#x27;</span>, <span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;26&#x27;</span>, <span class="string">&#x27;E8&#x27;</span>, <span class="string">&#x27;6E&#x27;</span>, <span class="string">&#x27;B6&#x27;</span>, <span class="string">&#x27;CD&#x27;</span>, <span class="string">&#x27;72&#x27;</span>, <span class="string">&#x27;B7&#x27;</span>, <span class="string">&#x27;3C&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;66&#x27;</span>, <span class="string">&#x27;B1&#x27;</span>, <span class="string">&#x27;4F&#x27;</span>, <span class="string">&#x27;99&#x27;</span>, <span class="string">&#x27;23&#x27;</span>, <span class="string">&#x27;63&#x27;</span>, <span class="string">&#x27;95&#x27;</span>, <span class="string">&#x27;77&#x27;</span>, <span class="string">&#x27;34&#x27;</span>, <span class="string">&#x27;61&#x27;</span>, <span class="string">&#x27;69&#x27;</span>, <span class="string">&#x27;F6&#x27;</span>, <span class="string">&#x27;A9&#x27;</span>, <span class="string">&#x27;53&#x27;</span>, <span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;37&#x27;</span>, <span class="string">&#x27;41&#x27;</span>, <span class="string">&#x27;43&#x27;</span>, <span class="string">&#x27;4F&#x27;</span>, <span class="string">&#x27;98&#x27;</span>, <span class="string">&#x27;95&#x27;</span>, <span class="string">&#x27;2C&#x27;</span>, <span class="string">&#x27;7A&#x27;</span>, <span class="string">&#x27;27&#x27;</span>, <span class="string">&#x27;3C&#x27;</span>, <span class="string">&#x27;98&#x27;</span>, <span class="string">&#x27;68&#x27;</span>, <span class="string">&#x27;1A&#x27;</span>, <span class="string">&#x27;88&#x27;</span>, <span class="string">&#x27;A8&#x27;</span>, <span class="string">&#x27;B7&#x27;</span>, <span class="string">&#x27;85&#x27;</span>, <span class="string">&#x27;BB&#x27;</span>, <span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;4F&#x27;</span>, <span class="string">&#x27;1A&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;4D&#x27;</span>, <span class="string">&#x27;C9&#x27;</span>, <span class="string">&#x27;C8&#x27;</span>, <span class="string">&#x27;9B&#x27;</span>, <span class="string">&#x27;75&#x27;</span>, <span class="string">&#x27;78&#x27;</span>, <span class="string">&#x27;57&#x27;</span>, <span class="string">&#x27;7F&#x27;</span>, <span class="string">&#x27;98&#x27;</span>, <span class="string">&#x27;0D&#x27;</span>, <span class="string">&#x27;D8&#x27;</span>, <span class="string">&#x27;51&#x27;</span>, <span class="string">&#x27;A8&#x27;</span>, <span class="string">&#x27;22&#x27;</span>, <span class="string">&#x27;B9&#x27;</span>, <span class="string">&#x27;5E&#x27;</span>, <span class="string">&#x27;59&#x27;</span>, <span class="string">&#x27;4D&#x27;</span>, <span class="string">&#x27;71&#x27;</span>, <span class="string">&#x27;4F&#x27;</span>, <span class="string">&#x27;1A&#x27;</span>, <span class="string">&#x27;81&#x27;</span>, <span class="string">&#x27;A9&#x27;</span>, <span class="string">&#x27;BF&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;29&#x27;</span>, <span class="string">&#x27;ED&#x27;</span>, <span class="string">&#x27;FD&#x27;</span>, <span class="string">&#x27;83&#x27;</span>] </span><br><span class="line"></span><br><span class="line">a4_init = [<span class="string">&#x27;21&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;86&#x27;</span>, <span class="string">&#x27;B7&#x27;</span>, <span class="string">&#x27;FF&#x27;</span>, <span class="string">&#x27;86&#x27;</span>, <span class="string">&#x27;5D&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;2D&#x27;</span>, <span class="string">&#x27;30&#x27;</span>]</span><br><span class="line"></span><br><span class="line">all_in = [<span class="number">0x20</span>, <span class="number">0x31</span>, <span class="number">0x32</span>, <span class="number">0x33</span>, <span class="number">0x34</span>, <span class="number">0x35</span>, <span class="number">0x36</span>, <span class="number">0x37</span>, <span class="number">0x38</span>, <span class="number">0x39</span>]</span><br><span class="line"><span class="keyword">for</span> i1 <span class="keyword">in</span> tqdm(all_in):</span><br><span class="line">    <span class="keyword">for</span> i2 <span class="keyword">in</span> all_in:</span><br><span class="line">        <span class="keyword">for</span> i3 <span class="keyword">in</span> all_in:</span><br><span class="line">            <span class="keyword">for</span> i4 <span class="keyword">in</span> all_in:</span><br><span class="line">                <span class="keyword">for</span> i5 <span class="keyword">in</span> all_in:</span><br><span class="line">                    <span class="keyword">for</span> i6 <span class="keyword">in</span> all_in: </span><br><span class="line">                        a3 = [<span class="built_in">int</span>(i, <span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> a3_init]</span><br><span class="line">                        a4 = [<span class="built_in">int</span>(i, <span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> a4_init] + [i1, i2, i3, i4, i5, i6]</span><br><span class="line"></span><br><span class="line">                        v8 = a4</span><br><span class="line">                        v10 = v8[<span class="number">0</span>] | (v8[<span class="number">3</span>] &lt;&lt; <span class="number">24</span>) | (v8[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) | (v8[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>)</span><br><span class="line">                        v11 = (v8[<span class="number">5</span>] &lt;&lt; <span class="number">8</span>) | v8[<span class="number">4</span>] | (v8[<span class="number">7</span>] &lt;&lt; <span class="number">24</span>) | (v8[<span class="number">6</span>] &lt;&lt; <span class="number">16</span>)</span><br><span class="line">                        v12 = v8[<span class="number">8</span>] | (v8[<span class="number">11</span>] &lt;&lt; <span class="number">24</span>) | (v8[<span class="number">9</span>] &lt;&lt; <span class="number">8</span>) | (v8[<span class="number">10</span>] &lt;&lt; <span class="number">16</span>)</span><br><span class="line">                        v13 = v8[<span class="number">12</span>] | (v8[<span class="number">15</span>] &lt;&lt; <span class="number">24</span>) | (v8[<span class="number">13</span>] &lt;&lt; <span class="number">8</span>) | (v8[<span class="number">14</span>] &lt;&lt; <span class="number">16</span>)</span><br><span class="line">                        v14 = <span class="number">1</span></span><br><span class="line">                        v15 = <span class="number">8</span> * ((<span class="built_in">len</span>(a3)-<span class="number">1</span>) &gt;&gt; <span class="number">3</span>) + <span class="number">9</span></span><br><span class="line">                        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                            v16 = <span class="number">0xD5B7DDE0</span></span><br><span class="line">                            v17 = (a3[v14] &lt;&lt; <span class="number">8</span>) | a3[v14-<span class="number">1</span>] | (a3[v14+<span class="number">2</span>] &lt;&lt; <span class="number">24</span>) | (a3[v14+<span class="number">1</span>] &lt;&lt; <span class="number">16</span>)</span><br><span class="line">                            v18 = (a3[v14+<span class="number">4</span>] &lt;&lt; <span class="number">8</span>) | a3[v14+<span class="number">3</span>] | (a3[v14+<span class="number">6</span>] &lt;&lt; <span class="number">24</span>) | (a3[v14+<span class="number">5</span>] &lt;&lt; <span class="number">16</span>)</span><br><span class="line">                            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                                v18 = (v18 - ((v17 + v16) ^ (<span class="number">16</span> * v17 + v12) ^ (v13 + (v17 &gt;&gt; <span class="number">5</span>))) &amp; <span class="number">0xffffffff</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">                                v17 = (v17 - ((v18 + v16) ^ (<span class="number">16</span> * v18 + v10) ^ (v11 + (v18 &gt;&gt; <span class="number">5</span>))) &amp; <span class="number">0xffffffff</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">                                v16 = (v16 + <span class="number">0x21524111</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">                                <span class="keyword">if</span> v16 == <span class="number">0</span>:</span><br><span class="line">                                    <span class="keyword">break</span></span><br><span class="line">                            v14 += <span class="number">8</span></span><br><span class="line">                            v17_bytelow = (v17) &amp; <span class="number">0xff</span></span><br><span class="line">                            v17_byte1 = (v17 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">                            v17_byte2 = (v17 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span></span><br><span class="line">                            v17_bytehigh = (v17 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line">                            v18_bytelow = (v18) &amp; <span class="number">0xff</span></span><br><span class="line">                            v18_byte1 = (v18 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">                            v18_byte2 = (v18 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span></span><br><span class="line">                            v18_bytehigh = (v18 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line">                            a3[v14-<span class="number">9</span>] = v17_bytelow</span><br><span class="line">                            a3[v14-<span class="number">8</span>] = v17_byte1</span><br><span class="line">                            a3[v14-<span class="number">7</span>] = v17_byte2</span><br><span class="line">                            a3[v14-<span class="number">6</span>] = v17_bytehigh</span><br><span class="line"></span><br><span class="line">                            a3[v14-<span class="number">5</span>] = v18_bytelow</span><br><span class="line">                            a3[v14-<span class="number">4</span>] = v18_byte1</span><br><span class="line">                            a3[v14-<span class="number">3</span>] = v18_byte2</span><br><span class="line">                            a3[v14-<span class="number">2</span>] = v18_bytehigh        </span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> v14 == v15:</span><br><span class="line">                                <span class="keyword">break</span>  </span><br><span class="line"></span><br><span class="line">                        tt = <span class="string">&quot;&quot;</span></span><br><span class="line">                        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">                            tt += <span class="built_in">chr</span>(a3[i])</span><br><span class="line">                        <span class="keyword">if</span> <span class="string">&quot;ratula&quot;</span> <span class="keyword">in</span> tt:</span><br><span class="line">                            <span class="built_in">print</span>(<span class="built_in">hex</span>(i1), <span class="built_in">hex</span>(i2), <span class="built_in">hex</span>(i3), <span class="built_in">hex</span>(i4), <span class="built_in">hex</span>(i5), <span class="built_in">hex</span>(i6))</span><br><span class="line">                            <span class="keyword">for</span> i <span class="keyword">in</span> a3:</span><br><span class="line">                                <span class="built_in">print</span>(<span class="built_in">chr</span>(i), end = <span class="string">&quot;&quot;</span>)</span><br><span class="line">                            exit(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 0x31 0x20 0x33 0x38 0x37 0x35</span></span><br><span class="line"><span class="comment"># Congratulations! The rootkit is sucessfully installed. The Flag is 32C3_this_is_build_for_flag_ship_phones  </span></span><br></pre></td></tr></table></figure>
<h1 id="leaked-license-64（未做出）"><a href="#leaked-license-64（未做出）" class="headerlink" title="leaked-license-64（未做出）"></a>leaked-license-64（未做出）</h1><p>&emsp;解压后，有两个文件：<code>admin@nsa.gov.us_license</code>、<code>Leaked_Lisence.dll</code>。<code>admin@nsa.gov.us_license</code>的值为<code>7e43ecf0b4e27dacfb5e613437b17acb46e8deab2c70510dc71844b492a691ec</code>，<code>Leaked_Lisence.dll</code>是一个32位dll。</p>
<p>&emsp;思路：将<code>7e43ecf0b4e27dacfb5e613437b17acb46e8deab2c70510dc71844b492a691ec</code>输入到某个函数（dll中存储）中，出<code>flag</code>。其中有一个<code>verify</code>函数，是<code>Leaked_Lisence.dll</code>唯一的导出函数。</p>
<p>&emsp;感觉这个题，我的思路就是一点一点分析，或者就是直接调用dll函数。</p>
<p><img src="/images/re-part-6/image-20230528220804201.png" alt="image-20230528220804201" style="zoom:67%;" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">arg_0   char* 长度为16</span><br><span class="line">arg_10  &amp;int</span><br><span class="line">arg_14  &amp;int </span><br><span class="line">arg_18  char* 长度为16</span><br><span class="line">arg_2C  &amp;int</span><br></pre></td></tr></table></figure>
<p>&emsp;写了个程序调试此dll，如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">bool</span> <span class="params">(*MYFUNC)</span><span class="params">(<span class="type">char</span>*, <span class="type">int</span>*, <span class="type">int</span>*, <span class="type">char</span>*, <span class="type">int</span>*)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">   HINSTANCE hdll = <span class="built_in">LoadLibrary</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;d:\\code\\c\\ctf\\genlisence-dll.dll&quot;</span>));</span><br><span class="line">   <span class="keyword">if</span> (hdll != <span class="literal">NULL</span>)</span><br><span class="line">   &#123;</span><br><span class="line">       MYFUNC myfunc = (MYFUNC)<span class="built_in">GetProcAddress</span>(hdll, <span class="string">&quot;verify&quot;</span>);</span><br><span class="line">       <span class="keyword">if</span> (myfunc != <span class="literal">NULL</span>)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="type">char</span>* arg1 = <span class="string">&quot;string11111111111111111111111&quot;</span>;</span><br><span class="line">           <span class="type">int</span> arg2;</span><br><span class="line">           <span class="type">int</span> arg3;</span><br><span class="line">           <span class="type">char</span>* arg4 = <span class="string">&quot;string2&quot;</span>;</span><br><span class="line">           <span class="type">int</span> arg5;</span><br><span class="line">           <span class="type">bool</span> result = <span class="built_in">myfunc</span>(arg1, &amp;arg2, &amp;arg3, arg4, &amp;arg5);</span><br><span class="line">           <span class="built_in">printf</span>(<span class="string">&quot;result: %d\n&quot;</span>, result);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="built_in">printf</span>(<span class="string">&quot;failed to get function address.\n&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="built_in">FreeLibrary</span>(hdll);</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to load dll.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;上述脚本一直在控制台上输出奇怪的字符。</p>
<p>&emsp;此问题就是动态加载dll，每次调试都要对dll中的verify函数重新组织成函数，所以想静态调试。</p>
<p>&emsp;使用pexports.exe将dll变为lib（但是函数的可执行代码并没有放到lib中），之后修改上述脚本：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;C:\\Users\\23957\\Desktop\\maze\\leaked-license-64-dir\\Leaked_Lisence.lib&quot;</span>)</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">bool</span> <span class="title">verify</span><span class="params">(<span class="type">char</span>*, <span class="type">int</span>*, <span class="type">int</span>*, <span class="type">char</span>*, <span class="type">int</span>*)</span></span>;</span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span>* arg1 = <span class="string">&quot;string&quot;</span>;</span><br><span class="line">    <span class="type">int</span> arg2;</span><br><span class="line">    <span class="type">int</span> arg3;</span><br><span class="line">    <span class="type">char</span>* arg4 = <span class="string">&quot;string2&quot;</span>;</span><br><span class="line">    <span class="type">int</span> arg5;</span><br><span class="line">    <span class="type">bool</span> result = <span class="built_in">verify</span>(arg1, &amp;arg2, &amp;arg3, arg4, &amp;arg5);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;此脚本一直报堆栈错误，说调用的<code>genlisence-dll.dll</code>有bug（其实是没有bug的，只是静态链接的原因而已）。最后脚本如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//typedef bool (*MYFUNC)(char*, int*, int*, char*, int*);</span></span><br><span class="line"><span class="comment">//int _tmain(int argc, _TCHAR* argv[])</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//    HINSTANCE hdll = LoadLibrary(TEXT(&quot;d:\\code\\c\\ctf\\genlisence-dll.dll&quot;));</span></span><br><span class="line"><span class="comment">//    if (hdll != NULL)</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        MYFUNC myfunc = (MYFUNC)GetProcAddress(hdll, &quot;verify&quot;);</span></span><br><span class="line"><span class="comment">//        if (myfunc != NULL)</span></span><br><span class="line"><span class="comment">//        &#123;</span></span><br><span class="line"><span class="comment">//			char arg1[16] = &#123;&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;, &#x27;e&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;, &#x27;e&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;, &#x27;e&#x27;, &#x27;f&#x27;&#125;;</span></span><br><span class="line"><span class="comment">//			int arg2 = 1;</span></span><br><span class="line"><span class="comment">//			int arg3 = 2;</span></span><br><span class="line"><span class="comment">//			char arg4[16] = &#123;&#x27;c&#x27;, &#x27;d&#x27;&#125;;</span></span><br><span class="line"><span class="comment">//			int arg5 = 3;</span></span><br><span class="line"><span class="comment">//            bool result = myfunc(arg1, &amp;arg2, &amp;arg3, arg4, &amp;arg5);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        else</span></span><br><span class="line"><span class="comment">//        &#123;</span></span><br><span class="line"><span class="comment">//            printf(&quot;failed to get function address.\n&quot;);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        FreeLibrary(hdll);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    else</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        printf(&quot;failed to load dll.\n&quot;);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    return 0;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//#pragma comment(lib, &quot;c:\\users\\23957\\desktop\\maze\\leaked-license-64-dir\\leaked_lisence.lib&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">bool</span> <span class="title">verify</span><span class="params">(<span class="type">char</span>*, <span class="type">int</span>*, <span class="type">int</span>*, <span class="type">char</span>*, <span class="type">int</span>*)</span></span>;</span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> arg1[<span class="number">16</span>];</span><br><span class="line">	<span class="built_in">strncpy</span>(arg1, argv[<span class="number">1</span>], <span class="number">15</span>);</span><br><span class="line">	arg1[<span class="number">15</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> arg2;</span><br><span class="line">	<span class="type">int</span> arg3;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> arg4[<span class="number">16</span>];</span><br><span class="line">	<span class="built_in">strncpy</span>(arg4, argv[<span class="number">2</span>], <span class="number">15</span>);</span><br><span class="line">	arg4[<span class="number">15</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> arg5;</span><br><span class="line">    <span class="type">bool</span> result = <span class="built_in">verify</span>(arg1, &amp;arg2, &amp;arg3, arg4, &amp;arg5);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;最后始终没有静态链接，就这么调试吧，唉。</p>
<p>&emsp;折磨，直接看wp吧。好多代码，看着心烦。</p>
<h2 id="0x01-wp"><a href="#0x01-wp" class="headerlink" title="0x01 wp"></a>0x01 wp</h2><p>&emsp;全是转的外网的博客，外网的博客现在也没了。中文的有：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/DirWang/p/11469346.html">https://www.cnblogs.com/DirWang/p/11469346.html</a></p>
<p>&emsp;思路就是构造一个消息结构，之后dll调用。感觉之后还得仔细调试。<strong>不能太浮躁！！</strong></p>
<p>&emsp;思绪良久，打算总结一下这道题的答案。dll中verify函数的具体参数为两个magic数据结构，magic数据结构如下所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span>  <span class="title class_">magic</span> &#123; </span><br><span class="line">    <span class="keyword">union</span> &#123; </span><br><span class="line">        <span class="type">char</span>  *s1; </span><br><span class="line">        <span class="type">char</span>  s2[<span class="number">16</span>]; </span><br><span class="line">    &#125;; </span><br><span class="line">    <span class="type">int</span>  size; </span><br><span class="line">    <span class="type">int</span>  real_length; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>&emsp;算法本身的逻辑如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">ID, licence</span>):</span><br><span class="line">	<span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;secret.key&quot;</span>) <span class="keyword">as</span> secret_file:</span><br><span class="line">        secret = secret_file.read()</span><br><span class="line">        checkstring = sha256(secret).decode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">id</span>) &lt; <span class="number">32</span>:</span><br><span class="line">            <span class="built_in">id</span> = <span class="built_in">id</span> + <span class="built_in">id</span></span><br><span class="line">        secretFromUser = <span class="string">&quot;&quot;</span></span><br><span class="line">        license = license.decode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line">        <span class="keyword">from</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">            secretFromUser += <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="built_in">id</span>[i])) ^ <span class="built_in">ord</span>(license[i])</span><br><span class="line">        check2 = sha256(secretFromUser).decode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> check2 == checkstring:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>&emsp;下一道下一道！！</p>
<h1 id="pingpong"><a href="#pingpong" class="headerlink" title="pingpong"></a>pingpong</h1><p>&emsp;apk文件。程序逻辑如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>:</span><br><span class="line">    p = <span class="number">0</span></span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    ttt = <span class="number">1000000</span></span><br><span class="line">    tt = ttt</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ping</span>:</span><br><span class="line">    <span class="keyword">if</span> tt % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">        p = <span class="number">0</span></span><br><span class="line">        num = <span class="number">0</span></span><br><span class="line">        tt = ttt</span><br><span class="line">    tt--</span><br><span class="line">    p = lib_ping(p, num)</span><br><span class="line">    num++</span><br><span class="line">    <span class="keyword">if</span> num &gt;= <span class="number">7</span>:</span><br><span class="line">        num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> tt == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;success&quot;</span>,p)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pong</span>:</span><br><span class="line">    <span class="keyword">if</span> tt % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">        p = <span class="number">0</span></span><br><span class="line">        num = <span class="number">0</span></span><br><span class="line">        tt = ttt</span><br><span class="line">    tt--</span><br><span class="line">    p = lib_pong(p, num)</span><br><span class="line">    num++</span><br><span class="line">    <span class="keyword">if</span> num &gt;= <span class="number">7</span>:</span><br><span class="line">        num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> tt == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;success&quot;</span>,p)</span><br></pre></td></tr></table></figure>
<p>&emsp;我们想要<code>tt=0</code>，这样的话就要先ping，再pong，循环往复<code>1000000/2</code>次，才可以。</p>
<p>&emsp;两个函数<code>ping</code>、<code>pong</code>保存在pp库中：</p>
<p><img src="/images/re-part-6/image-20230530110719172.png" alt="image-20230530110719172" style="zoom:67%;" /></p>
<p>&emsp;<code>pp</code>库使用了OLLVM保护。如下所示：</p>
<p><img src="/images/re-part-6/image-20230530111102933.png" alt="image-20230530111102933" style="zoom:67%;" /></p>
<p>&emsp;原来的那个脚本失效了。所以得手撕OLLVM。</p>
<h2 id="0x00-手撕OLLVM的尝试"><a href="#0x00-手撕OLLVM的尝试" class="headerlink" title="0x00 手撕OLLVM的尝试"></a>0x00 手撕OLLVM的尝试</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pong 分析</span><br><span class="line">R0 &lt;- R0+R4</span><br><span class="line">R0 &lt;- R0 % 0x0A + R4</span><br><span class="line">    ([var_30] * [var_30+4]) % 0x0A + R4</span><br><span class="line">    ([var_30] * [var_30+4]) % 0x0A + p</span><br><span class="line">ret &lt;- ([var_30] * [var_30+4]) % 0x0A + p </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ping 分析</span><br><span class="line">ret &lt;- ([var_2C] * [var_2C+4]) % 0x0A + var_1C </span><br><span class="line">var_2C = (1&lt;&lt;1E)*n1</span><br><span class="line">var_2C+4 = (1&lt;&lt;1E)</span><br><span class="line">var_1C = p+n2</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ping </span><br><span class="line">v2  | v3(p) | v4(num) |  ([var_2C] * [var_28]) % 0x0A</span><br><span class="line">E   &lt;- 9       2           5</span><br><span class="line">4   &lt;- 0       0           4</span><br><span class="line">1C  &lt;- 16      4           6</span><br><span class="line">11  &lt;- C       2           5    </span><br><span class="line">1E  &lt;- 19      4           5     </span><br><span class="line">2A  &lt;- 27      6           3  </span><br><span class="line">32  &lt;- 30      3           2</span><br><span class="line">27  &lt;- 25      6           2</span><br><span class="line">2A  &lt;- 28      1           2</span><br><span class="line">2F  &lt;- 2C      3           3</span><br><span class="line">3A  &lt;- 31      5           9   </span><br><span class="line">40  &lt;- 3C      0           4    </span><br><span class="line">4D  &lt;- 48      2           5       </span><br></pre></td></tr></table></figure>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>R0</th>
<th>R1</th>
<th>R2</th>
<th>R3</th>
<th>R4</th>
<th>R5</th>
<th>R6</th>
<th>R7</th>
<th>var_1C</th>
<th>var_2C+4</th>
<th>var_2C</th>
<th>var_20</th>
<th>var_24</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>1&lt;&lt;1e</td>
<td>0x12ABCDA2</td>
<td>0</td>
<td>num</td>
<td></td>
<td>3</td>
<td>num</td>
<td>1</td>
<td>p</td>
<td>1&lt;&lt;1e</td>
<td>0</td>
<td>0</td>
<td>1&lt;&lt;1e</td>
</tr>
<tr>
<td></td>
<td></td>
<td>0xC40FA35D</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>1/0</td>
<td>0xD175216E</td>
<td>0x9EE75616</td>
<td>0x3CD203AF</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>0xE5925FB</td>
<td>0xF133E736/<strong>0xE5925FB</strong></td>
<td>var_18</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>0x65982633</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>0x72FA0C29</td>
<td></td>
<td></td>
<td></td>
<td>1</td>
<td></td>
<td>num</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>0xE5D890A5</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>0x18C23607</td>
<td><strong>0x8B06AA34</strong>/0x18C23607</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0xA</td>
<td>0xE5D890A5</td>
<td></td>
<td></td>
<td></td>
<td>0xA*1</td>
<td></td>
<td>num-1</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>…</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0xA</td>
<td>0xE5D890A5</td>
<td></td>
<td></td>
<td></td>
<td>0xA**num</td>
<td></td>
<td>0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>0x18C23607</td>
<td>0x8B06AA34/<strong>0x18C23607</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>5(var_1C%2=1)</td>
<td>1</td>
<td>0xF4B872E4/<strong>0xF10822ED</strong></td>
<td>0xFFFFFFF0^var_1C</td>
<td>var_1C</td>
<td>num</td>
<td></td>
<td>1</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>6(var_1C%3!=0)</td>
<td>0/1</td>
<td>0xCDB35A57/<strong>0xC5866837</strong></td>
<td>0xC5866837</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>end</td>
<td>[var_2C*(var_2C+4)]%0xA+var_1C</td>
<td>0xA</td>
<td>0xA**num</td>
<td>0xC5866837</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>6(var_1C%3=0)</td>
<td>0/1</td>
<td><strong>0xCDB35A57</strong>/0xC5866837</td>
<td>0xC5866837</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>1+var_1C</td>
<td>0xC5866837</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>p+1</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>end</td>
<td>[var_2C*(var_2C+4)]%0xA+var_1C</td>
<td>0xA</td>
<td>0xA**num</td>
<td>0xC5866837</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>5(var_1C%2=0)</td>
<td>1</td>
<td><strong>0xF4B872E4</strong>/0xF10822ED</td>
<td>0xFFFFFFF0^var_1C</td>
<td>var_1C</td>
<td>num</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>var_1C+1</td>
<td>0xF10822ED</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>p+1</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>0xE5925FB</td>
<td><strong>0xF133E736</strong>/0xE5925FB</td>
<td>var_18</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>-1</td>
<td>0x12ABCDA2</td>
<td>var_24</td>
<td>0</td>
<td>var_20*var_24</td>
<td>5</td>
<td></td>
<td>2</td>
<td></td>
<td>var_2C+4</td>
<td>var_2C+(var_2C+4)</td>
<td>var_24</td>
<td>0</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">label_B:</span><br><span class="line"><span class="keyword">if</span> var_20 &gt; var_24:</span><br><span class="line">	var_18 = <span class="number">1</span></span><br><span class="line">	R1 = <span class="number">0xD175216E</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	var_18 = <span class="number">0</span></span><br><span class="line">	R1 = <span class="number">0xD175216E</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> var_18 == <span class="number">1</span>:</span><br><span class="line">	R1 = <span class="number">0xF133E736</span></span><br><span class="line">    var_23 = var_24</span><br><span class="line">    var_24 = <span class="number">0</span></span><br><span class="line">    var_2C = var_2C+(var_2C+<span class="number">4</span>)</span><br><span class="line">    go label_B</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	R1 = <span class="number">0xE5925FB</span></span><br><span class="line">    R5 = <span class="number">0xA</span> ** num</span><br><span class="line">    <span class="keyword">if</span> var_1C % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">        R1 = <span class="number">0xF10822ED</span></span><br><span class="line">        <span class="keyword">if</span> var_1C % <span class="number">3</span> == <span class="number">0</span>:</span><br><span class="line">            R1 = <span class="number">0xCDB35A57</span></span><br><span class="line">            var_1C += <span class="number">1</span></span><br><span class="line">            go label_A</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">    label_A:</span><br><span class="line">            R1 = <span class="number">0xC5866837</span></span><br><span class="line">            <span class="keyword">return</span> [var_2C*(var_2C+<span class="number">4</span>)]%<span class="number">0xA</span>+var_1C</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        R1 = <span class="number">0xF4B872E4</span></span><br><span class="line">        var_1C += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> var_1C % <span class="number">3</span> == <span class="number">0</span>:</span><br><span class="line">            R1 = <span class="number">0xCDB35A57</span></span><br><span class="line">            var_1C += <span class="number">1</span></span><br><span class="line">            go label_A</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">    label_A:</span><br><span class="line">            R1 = <span class="number">0xC5866837</span></span><br><span class="line">            <span class="keyword">return</span> [var_2C*(var_2C+<span class="number">4</span>)]%<span class="number">0xA</span>+var_1C	</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">var_1C = p</span><br><span class="line">var_2C+<span class="number">4</span> = <span class="number">1</span>&lt;&lt;<span class="number">0x1e</span></span><br><span class="line"></span><br><span class="line">label_B:</span><br><span class="line"><span class="keyword">if</span> var_20 &gt; var_24:</span><br><span class="line">	var_18 = <span class="number">1</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	var_18 = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> var_18 == <span class="number">1</span>:</span><br><span class="line">    var_23 = var_24</span><br><span class="line">    var_24 = <span class="number">0</span></span><br><span class="line">    var_2C = var_2C+(var_2C+<span class="number">4</span>)</span><br><span class="line">    go label_B</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    R5 = <span class="number">0xA</span> ** num</span><br><span class="line">    <span class="keyword">if</span> var_1C % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> var_1C % <span class="number">3</span> == <span class="number">0</span>:</span><br><span class="line">            var_1C += <span class="number">1</span></span><br><span class="line">            go label_A</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">    label_A:</span><br><span class="line">            <span class="keyword">return</span> [var_2C*(var_2C+<span class="number">4</span>)]%<span class="number">0xA</span>+var_1C</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        var_1C += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> var_1C % <span class="number">3</span> == <span class="number">0</span>:</span><br><span class="line">            var_1C += <span class="number">1</span></span><br><span class="line">            go label_A</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">    label_A:</span><br><span class="line">            <span class="keyword">return</span> [var_2C*(var_2C+<span class="number">4</span>)]%<span class="number">0xA</span>+var_1C	</span><br></pre></td></tr></table></figure>
<p> &emsp;撕不出来啊，看wp。</p>
<h2 id="0x01-WP"><a href="#0x01-WP" class="headerlink" title="0x01 WP"></a>0x01 WP</h2><p>&emsp;其实不难看出，只要用模拟执行，模拟出ping/pong循环往复的过程，就可以。</p>
<p>&emsp;wp中使用了frida进行模拟执行。</p>
<p>&emsp;远古时候曾经用过frida：<a href="https://wd-2711.tech/2022/11/15/android-app-100-wp/">https://wd-2711.tech/2022/11/15/android-app-100-wp/</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida, sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message, data</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(message[<span class="string">&#x27;payload&#x27;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line">jscode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">// 将 JavaScript 的执行上下文切换到 Java 线程中，从而可以直接访问和操作 Java 对象和方法。</span></span><br><span class="line"><span class="string">Java.perform(function()&#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    //遍历模块找基址</span></span><br><span class="line"><span class="string">    Process.enumerateModules(&#123;</span></span><br><span class="line"><span class="string">        onMatch: function (exp) &#123;</span></span><br><span class="line"><span class="string">            send(exp.name + &quot;|&quot; + exp.base + &quot;|&quot; + exp.size + &quot;|&quot; + exp.path);</span></span><br><span class="line"><span class="string">            if (exp.name == &#x27;libpp.so&#x27;) &#123;</span></span><br><span class="line"><span class="string">                send(&#x27;enumerateModules find&#x27;);</span></span><br><span class="line"><span class="string">                send(exp.name + &quot;|&quot; + exp.base + &quot;|&quot; + exp.size + &quot;|&quot; + exp.path);</span></span><br><span class="line"><span class="string">                send(exp);</span></span><br><span class="line"><span class="string">                return &#x27;stop&#x27;;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        onComplete: function () &#123;</span></span><br><span class="line"><span class="string">            send(&#x27;enumerateModules stop&#x27;);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    //通过模块名直接查找libpp基址</span></span><br><span class="line"><span class="string">    var soAddr = Module.findBaseAddress(&quot;libpp.so&quot;);</span></span><br><span class="line"><span class="string">    send(&quot;soAddr:&quot; + soAddr);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // 从libpp中导出ping与pong两个函数</span></span><br><span class="line"><span class="string">    // 总是比ida看的地址+1，对于so文件，符号执行验证了这一点</span></span><br><span class="line"><span class="string">    var aping = 0x1308 + 1</span></span><br><span class="line"><span class="string">    var fping = Module.findExportByName(&quot;libpp.so&quot;, &quot;Java_com_geekerchina_pingpongmachine_MainActivity_ping&quot;)</span></span><br><span class="line"><span class="string">    fping = new NativePointer(soAddr).add(aping);</span></span><br><span class="line"><span class="string">    // var ping = new NativeFunction(fping, &quot;int&quot;, [&#x27;pointer&#x27;,&#x27;pointer&#x27;,&#x27;int&#x27;, &#x27;int&#x27;]);</span></span><br><span class="line"><span class="string">    var ping = new NativeFunction(fping, &quot;int&quot;, [&#x27;pointer&#x27;,&#x27;pointer&#x27;,&#x27;int&#x27;, &#x27;int&#x27;]);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    var apong = 0x1564 + 1</span></span><br><span class="line"><span class="string">    var fpong = Module.findExportByName(&quot;libpp.so&quot;, &quot;Java_com_geekerchina_pingpongmachine_MainActivity_pong&quot;)</span></span><br><span class="line"><span class="string">    fpong = new NativePointer(soAddr).add(apong);</span></span><br><span class="line"><span class="string">    var pong = new NativeFunction(fpong, &quot;int&quot;, [&#x27;pointer&#x27;,&#x27;pointer&#x27;,&#x27;int&#x27;, &#x27;int&#x27;]);    </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // 模拟运行</span></span><br><span class="line"><span class="string">    var env = Java.vm.getEnv();  // 获得当前线程的JNI环境，JNI（Java Native Interface）是 Java 提供的一种机制，用于在 Java 和本地代码之间相互调用。</span></span><br><span class="line"><span class="string">    var obj = ptr(0);            // 定义一个指针</span></span><br><span class="line"><span class="string">    var tt = 1000000;</span></span><br><span class="line"><span class="string">    var p = 0;</span></span><br><span class="line"><span class="string">    var num = 0;</span></span><br><span class="line"><span class="string">    while(true) &#123;</span></span><br><span class="line"><span class="string">        if (tt % 2 == 1)&#123;</span></span><br><span class="line"><span class="string">            // pong函数</span></span><br><span class="line"><span class="string">            --tt;</span></span><br><span class="line"><span class="string">            p = pong(env, obj, p, num);</span></span><br><span class="line"><span class="string">            ++num;</span></span><br><span class="line"><span class="string">            if(num &gt;= 7) &#123;</span></span><br><span class="line"><span class="string">                num = 0;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">            // ping函数</span></span><br><span class="line"><span class="string">            --tt;</span></span><br><span class="line"><span class="string">            p = ping(env, obj, p, num);</span></span><br><span class="line"><span class="string">            ++num;</span></span><br><span class="line"><span class="string">            if(num &gt;= 7)&#123;</span></span><br><span class="line"><span class="string">                num = 0;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        if (tt == 0) &#123;</span></span><br><span class="line"><span class="string">            send(&quot;tt:&quot; + tt + &quot;|num:&quot; + num)</span></span><br><span class="line"><span class="string">            send(&quot;FLAG : &quot;+&quot;BCTF&#123;MagicNum&quot; + p+ &quot;&#125;&quot;);</span></span><br><span class="line"><span class="string">            break;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">process = frida.get_usb_device().attach(<span class="number">9009</span>)</span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>
<p>&emsp;上述脚本一直找不到<code>libpp.so</code>，搜索发现是<code>模拟器一般是x86 或者x86-64架构，只会加载对应lib/x86 和lib/x86-64下面的so文件，真机才会加载lib/arm*的so文件，所以想让app加载arm 可以真机，或者arm架构的模拟器</code>。也就是说，frida只会搜索x86下的文件夹，而armabi下的文件夹无法搜索。所以，我首先把armabi下的libpp.so复制到x86文件夹下，发现不行。</p>
<p>&emsp;然后，我并没有找到arm架构的模拟器。所以就用了自己的本机，但是本机没有root，所以运行不了<code>frida-server</code>，root风险太高，所以就打算用frida-gadget（非root）的方法，但是最后还是不能正常调试，显示<code>Failed to attach: unable to connect to remote frida-server: closed</code>。</p>
<p>&emsp;就这样吧，下一道，wp为<code>BCTF&#123;MagicNum4500009&#125;</code>。</p>
<h1 id="childRE"><a href="#childRE" class="headerlink" title="childRE"></a>childRE</h1><p>&emsp;没有pdb文件的PE64。</p>
<p>&emsp;动调了一下，发现可能有反调试。验证了一下没有hh，只是调试器加参数的时候加错了。</p>
<p><img src="/images/re-part-6/image-20230531214310135.png" alt="image-20230531214310135" style="zoom:67%;" /></p>
<p>&emsp;程序逻辑如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 输入长度为31的字符串</span><br><span class="line">2. 使用输入构成满二叉树（询问newbing得到）</span><br><span class="line">3. 使用深度优先遍历遍历二叉树，得到v5</span><br><span class="line">4. UnDecorateSymbolName将v5变成outputstring</span><br></pre></td></tr></table></figure>
<p>&emsp;容易得到<code>outputstring=private: char * __thiscall R0Pxx::My_Aut0_PWN(unsigned char *)</code>，使用newbing，可以得到其原始值为<code>?My_Aut0_PWN@R0Pxx@@AAEPADPAE@Z</code>，之后只要构成满二叉树，按层遍历即可。满二叉树如下所示：</p>
<p><img src="/images/re-part-6/image-20230531214746719.png" alt="image-20230531214746719" style="zoom:67%;" /></p>
<p>&emsp;相应脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"># @Time  : 2023/05/31 18:43:43</span></span><br><span class="line"><span class="string"># @Author: wd-2711</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">target1 = <span class="string">&#x27;(_@4620!08!6_0*0442!@186%%0@3=66!!974*3234=&amp;0^3&amp;1@=&amp;0908!6_0*&amp;&#x27;</span></span><br><span class="line">target2 = <span class="string">&#x27;55565653255552225565565555243466334653663544426565555525555222&#x27;</span></span><br><span class="line">change_arr = [<span class="number">0x31</span>, <span class="number">0x32</span>, <span class="number">0x33</span>, <span class="number">0x34</span>, <span class="number">0x35</span>, <span class="number">0x36</span>, <span class="number">0x37</span>, <span class="number">0x38</span>, <span class="number">0x39</span>, <span class="number">0x30</span>, <span class="number">0x2D</span>, <span class="number">0x3D</span>, <span class="number">0x21</span>, <span class="number">0x40</span>, <span class="number">0x23</span>, <span class="number">0x24</span>, <span class="number">0x25</span>, <span class="number">0x5E</span>, <span class="number">0x26</span>, <span class="number">0x2A</span>, <span class="number">0x28</span>, <span class="number">0x29</span>, <span class="number">0x5F</span>, <span class="number">0x2B</span>, <span class="number">0x71</span>, <span class="number">0x77</span>, <span class="number">0x65</span>, <span class="number">0x72</span>, <span class="number">0x74</span>, <span class="number">0x79</span>, <span class="number">0x75</span>, <span class="number">0x69</span>, <span class="number">0x6F</span>, <span class="number">0x70</span>, <span class="number">0x5B</span>, <span class="number">0x5D</span>, <span class="number">0x51</span>, <span class="number">0x57</span>, <span class="number">0x45</span>, <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x59</span>, <span class="number">0x55</span>, <span class="number">0x49</span>, <span class="number">0x4F</span>, <span class="number">0x50</span>, <span class="number">0x7B</span>, <span class="number">0x7D</span>, <span class="number">0x61</span>, <span class="number">0x73</span>, <span class="number">0x64</span>, <span class="number">0x66</span>, <span class="number">0x67</span>, <span class="number">0x68</span>, <span class="number">0x6A</span>, <span class="number">0x6B</span>, <span class="number">0x6C</span>, <span class="number">0x3B</span>, <span class="number">0x27</span>, <span class="number">0x41</span>, <span class="number">0x53</span>, <span class="number">0x44</span>, <span class="number">0x46</span>, <span class="number">0x47</span>, <span class="number">0x48</span>, <span class="number">0x4A</span>, <span class="number">0x4B</span>, <span class="number">0x4C</span>, <span class="number">0x3A</span>, <span class="number">0x22</span>, <span class="number">0x5A</span>, <span class="number">0x58</span>, <span class="number">0x43</span>, <span class="number">0x56</span>, <span class="number">0x42</span>, <span class="number">0x4E</span>, <span class="number">0x4D</span>, <span class="number">0x3C</span>, <span class="number">0x3E</span>, <span class="number">0x3F</span>, <span class="number">0x7A</span>, <span class="number">0x78</span>, <span class="number">0x63</span>, <span class="number">0x76</span>, <span class="number">0x62</span>, <span class="number">0x6E</span>, <span class="number">0x6D</span>, <span class="number">0x2C</span>, <span class="number">0x2E</span>, <span class="number">0x2F</span>, <span class="number">0x00</span>]</span><br><span class="line">ouputString = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">62</span>):</span><br><span class="line">    right = target1[i]</span><br><span class="line">    reminder = change_arr.index(<span class="built_in">ord</span>(right))</span><br><span class="line">    right = target2[i]</span><br><span class="line">    quotient = change_arr.index(<span class="built_in">ord</span>(right))    </span><br><span class="line">    n = quotient * <span class="number">23</span> + reminder</span><br><span class="line">    ouputString += <span class="built_in">chr</span>(n)</span><br><span class="line"><span class="built_in">print</span>(ouputString)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">private: char * __thiscall R0Pxx::My_Aut0_PWN(unsigned char *)</span></span><br><span class="line"><span class="string"> |  NewBing</span></span><br><span class="line"><span class="string">?My_Aut0_PWN@R0Pxx@@AAEPADPAE@Z</span></span><br><span class="line"><span class="string"> |  Plot</span></span><br><span class="line"><span class="string">Z0@tRAEyuP@xAAA?M_A0_WNPx@@EPDP</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">plaintext = <span class="string">&quot;Z0@tRAEyuP@xAAA?M_A0_WNPx@@EPDP&quot;</span></span><br><span class="line">md5 = hashlib.md5()</span><br><span class="line">md5.update(plaintext.encode())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;flag&#123;&quot;</span> + md5.hexdigest() + <span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line"><span class="comment"># flag&#123;63b148e750fed3a33419168ac58083f5&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="MyDriver2-397"><a href="#MyDriver2-397" class="headerlink" title="MyDriver2-397"></a>MyDriver2-397</h1><p>&emsp;发现是一个sys驱动文件。通常用于存储设备驱动程序。sys文件不能直接运行，需要通过注册表配置和加载驱动程序的命令来安装和启动。</p>
<p>&emsp;尝试动调一下此程序。</p>
<h2 id="0x00-环境部署"><a href="#0x00-环境部署" class="headerlink" title="0x00 环境部署"></a>0x00 环境部署</h2><p>&emsp;首先部署windbg双机调试环境，见tool-use。</p>
<p>&emsp;其次，安装驱动文件sys，见tool-use，具体而言：关闭win7的强制签名<code>bcdedit /set testsigning on</code>，之后使用OsrLoader<strong>安装</strong>驱动。</p>
<p>&emsp;之后，打开win7虚拟机进入调试模式，之后立即打开windbg，命令行为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">windbg.exe -b -k com:pipe,port=\\.\pipe\com_1,resets=0</span><br></pre></td></tr></table></figure>
<p>&emsp;然后在sys文件上打断点，如<code>bp MyDriver2+0xxx</code>。运行windbg进入桌面，之后使用OsrLoader<strong>打开</strong>驱动。</p>
<h2 id="0x01-苦逼的调试过程"><a href="#0x01-苦逼的调试过程" class="headerlink" title="0x01 苦逼的调试过程"></a>0x01 苦逼的调试过程</h2><p>参考链接：<a target="_blank" rel="noopener" href="https://estongsy.wordpress.com/2012/07/17/debugging-a-driver-sys-file-using-windbg/">https://estongsy.wordpress.com/2012/07/17/debugging-a-driver-sys-file-using-windbg/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">windbg.exe -b -k com:pipe,port=\\.\pipe\com_1,resets=0</span><br><span class="line">bp MyDriver2+0x16F8   // 程序入口</span><br><span class="line">info address : fffffa80`19864000</span><br><span class="line">bp MyDriver2+0x17f7   // sub_113C8</span><br><span class="line">bp MyDriver2+0x1194   // v5 &lt;- 修改前的CreateFile</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">nt!NtCreateFile:</span><br><span class="line">fffff800`041b107c 4c8bdc          mov     r11,rsp</span><br><span class="line">fffff800`041b107f 4881ec88000000  sub     rsp,88h</span><br><span class="line">fffff800`041b1086 33c0            xor     eax,eax</span><br><span class="line">fffff800`041b1088 498943f0        mov     qword ptr [r11-10h],rax</span><br><span class="line">fffff800`041b108c c744247020000000 mov     dword ptr [rsp+70h],20h</span><br><span class="line">fffff800`041b1094 89442468        mov     dword ptr [rsp+68h],eax</span><br><span class="line">fffff800`041b1098 498943d8        mov     qword ptr [r11-28h],rax</span><br><span class="line">fffff800`041b109c 89442458        mov     dword ptr [rsp+58h],eax</span><br><span class="line">fffff800`041b10a0 8b8424e0000000  mov     eax,dword ptr [rsp+0E0h]</span><br><span class="line">fffff800`041b10a7 89442450        mov     dword ptr [rsp+50h],eax</span><br><span class="line">fffff800`041b10ab 488b8424d8000000 mov     rax,qword ptr [rsp+0D8h]</span><br><span class="line">fffff800`041b10b3 498943c0        mov     qword ptr [r11-40h],rax</span><br><span class="line">fffff800`041b10b7 8b8424d0000000  mov     eax,dword ptr [rsp+0D0h]</span><br><span class="line">fffff800`041b10be 89442440        mov     dword ptr [rsp+40h],eax</span><br><span class="line">fffff800`041b10c2 8b8424c8000000  mov     eax,dword ptr [rsp+0C8h]</span><br><span class="line">fffff800`041b10c9 89442438        mov     dword ptr [rsp+38h],eax</span><br><span class="line">fffff800`041b10cd 8b8424c0000000  mov     eax,dword ptr [rsp+0C0h]</span><br><span class="line">fffff800`041b10d4 89442430        mov     dword ptr [rsp+30h],eax</span><br><span class="line">fffff800`041b10d8 8b8424b8000000  mov     eax,dword ptr [rsp+0B8h]</span><br><span class="line">fffff800`041b10df 89442428        mov     dword ptr [rsp+28h],eax</span><br><span class="line">fffff800`041b10e3 488b8424b0000000 mov     rax,qword ptr [rsp+0B0h]</span><br><span class="line">fffff800`041b10eb 49894398        mov     qword ptr [r11-68h],rax</span><br><span class="line">fffff800`041b10ef e8bcb71600      call    nt!IopCreateFile (fffff800`0431c8b0)</span><br><span class="line">fffff800`041b10f4 4881c488000000  add     rsp,88h</span><br><span class="line">fffff800`041b10fb c3              ret</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v5 = 0xfffffa80`1a282150</span><br><span class="line">fffff800`041b107c 4c8bdc          mov     r11,rsp</span><br><span class="line">fffff800`041b107f 4881ec88000000  sub     rsp,88h</span><br><span class="line">fffff800`041b1086 33c0            xor     eax,eax</span><br><span class="line">fffff800`041b1088 498943f0        mov     qword ptr [r11-10h],rax</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp MyDriver2+0x11F6   // v9 &lt;- v5 &lt;- 修改前的CreateFile</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v9 = fffffa80`1ac088b0</span><br><span class="line">fffff800`041b107c 4c8bdc          mov     r11,rsp</span><br><span class="line">fffff800`041b107f 4881ec88000000  sub     rsp,88h</span><br><span class="line">fffff800`041b1086 33c0            xor     eax,eax</span><br><span class="line">fffff800`041b1088 498943f0        mov     qword ptr [r11-10h],rax</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp MyDriver2+0x12AC   // return</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">nt!NtCreateFile:</span><br><span class="line">fffff800`041b107c ff2500000000    jmp     qword ptr [nt!NtCreateFile+0x6 (fffff800`041b1082)]</span><br><span class="line">fffff800`041b1082 d0a4a30580f8ff  shl     byte ptr [rbx-77FFBh],1</span><br><span class="line">fffff800`041b1089 ff9090c74424    call    qword ptr [rax+2444C790h]</span><br><span class="line">fffff800`041b108f 7020            jo      nt!NtCreateFile+0x35 (fffff800`041b10b1)</span><br><span class="line"></span><br><span class="line">fffff800`041b1091 0000            add     byte ptr [rax],al</span><br><span class="line">fffff800`041b1093 008944246849    add     byte ptr [rcx+49682444h],cl</span><br><span class="line">fffff800`041b1099 8943d8          mov     dword ptr [rbx-28h],eax</span><br><span class="line">fffff800`041b109c 89442458        mov     dword ptr [rsp+58h],eax</span><br><span class="line">fffff800`041b10a0 8b8424e0000000  mov     eax,dword ptr [rsp+0E0h]</span><br><span class="line">fffff800`041b10a7 89442450        mov     dword ptr [rsp+50h],eax</span><br><span class="line">fffff800`041b10ab 488b8424d8000000 mov     rax,qword ptr [rsp+0D8h]</span><br><span class="line"></span><br><span class="line">fffff800`041b10b1 0000            add     byte ptr [rax],al</span><br><span class="line"></span><br><span class="line">fffff800`041b10b3 498943c0        mov     qword ptr [r11-40h],rax</span><br><span class="line">fffff800`041b10b7 8b8424d0000000  mov     eax,dword ptr [rsp+0D0h]</span><br><span class="line">fffff800`041b10be 89442440        mov     dword ptr [rsp+40h],eax</span><br><span class="line">fffff800`041b10c2 8b8424c8000000  mov     eax,dword ptr [rsp+0C8h]</span><br><span class="line">fffff800`041b10c9 89442438        mov     dword ptr [rsp+38h],eax</span><br><span class="line">fffff800`041b10cd 8b8424c0000000  mov     eax,dword ptr [rsp+0C0h]</span><br><span class="line">fffff800`041b10d4 89442430        mov     dword ptr [rsp+30h],eax</span><br><span class="line">fffff800`041b10d8 8b8424b8000000  mov     eax,dword ptr [rsp+0B8h]</span><br><span class="line">fffff800`041b10df 89442428        mov     dword ptr [rsp+28h],eax</span><br><span class="line">fffff800`041b10e3 488b8424b0000000 mov     rax,qword ptr [rsp+0B0h]</span><br><span class="line">fffff800`041b10eb 49894398        mov     qword ptr [r11-68h],rax</span><br><span class="line">fffff800`041b10ef e8bcb71600      call    nt!IopCreateFile (fffff800`0431c8b0)</span><br><span class="line">fffff800`041b10f4 4881c488000000  add     rsp,88h</span><br><span class="line">fffff800`041b10fb c3              ret</span><br></pre></td></tr></table></figure>
<p><img src="/images/re-part-6/image-20230601212329344.png" alt="image-20230601212329344" style="zoom:67%;" /></p>
<p>&emsp;这个<code>call  qword ptr [rax+2444C790h]</code>很奇怪啊，难不成调用<code>nt!NtCreateFile</code>的时候<code>rax</code>都是固定的？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp fffff800`041b107c   // 在nt!NtCreateFile上打断点</span><br></pre></td></tr></table></figure>
<p>&emsp;调试后发现完全不一样啦。</p>
<p>&emsp;发现第一行jmp到了sub_114D0函数。如下所示：</p>
<p><img src="/images/re-part-6/image-20230601215414383.png" alt="image-20230601215414383" style="zoom:67%;" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp MyDriver2+0x1552   // 调用wcsstr的时候</span><br></pre></td></tr></table></figure>
<p>&emsp;发现<code>wcsstr(*(*(a3 + 16) + 8i64)</code>指向<code>\??\MountPointManager</code>。<code>SubStr</code>指向<code>P_giveMe_flag_233.txt</code>。那我想，运行此驱动，然后立即打开<code>P_giveMe_flag_233.txt</code>，不就得了。但是先别停，这样不稳，继续调下去才稳。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">r rax=1</span><br><span class="line">bp MyDriver2+0x156A   // 判断dword_16428 != -1</span><br><span class="line">bp MyDriver2+0x1577   // 判断(v9 + 1) &gt;= 8  (也要修改一下)</span><br><span class="line">bp MyDriver2+0x15A0   // sub_115DC()</span><br></pre></td></tr></table></figure>
<p>&emsp;查看此时r12对应的值，如下所示：</p>
<p><img src="/images/re-part-6/image-20230601223939213.png" alt="image-20230601223939213" style="zoom:67%;" /></p>
<p>&emsp;写入文件的值为：<code>the flag is A_simple_Inline_hook_Drv</code>。Flag为<code>RCTF&#123;A_simple_Inline_hook_Drv&#125;</code>。</p>
<h2 id="0x02-题目总结"><a href="#0x02-题目总结" class="headerlink" title="0x02 题目总结"></a>0x02 题目总结</h2><p>&emsp;题目逻辑如下：钩取<code>CreateFile</code>函数，如果调用此函数的文件是<code>P_giveMe_flag_233.txt</code>，那么就把flag写入到文件中，否则直接使系统崩溃。</p>
<h1 id="Junk-Instruction"><a href="#Junk-Instruction" class="headerlink" title="Junk_Instruction"></a>Junk_Instruction</h1><p>&emsp;西湖论剑预选赛的题目，既然是预选赛，看来应该很简单。看来re还是任重道远。但是庆幸的是，今天终于可以re啦！</p>
<p>&emsp;是一个32位的GUI程序，输入字符串并且判断是否正确，不正确输出error。没有符号表。<strong>有很多的垃圾指令。</strong></p>
<h2 id="0x00-探索"><a href="#0x00-探索" class="headerlink" title="0x00 探索"></a>0x00 探索</h2><p>&emsp;猜测是MFC程序。查看之前做过的题，链接为：<code>https://wd-2711.tech/2022/11/23/re-part-4/</code>。其中的MFC逆向-200，还有就是：<code>https://wd-2711.tech/2022/12/04/mfc-study/</code>。</p>
<p>&emsp;使用xspy，程序输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">message map=0x004BF724(Junk_Instruction.exe+0x17f724)</span><br><span class="line">msg map entries at 0x004BF730(Junk_Instruction.exe+0x17f730)</span><br><span class="line">OnMsg:WM_SYSCOMMAND(0112),func=0x003421F0(Junk_Instruction.exe+0x0021f0)</span><br><span class="line">OnMsg:WM_PAINT(000f),func=0x00342300(Junk_Instruction.exe+0x002300)</span><br><span class="line">OnMsg:WM_QUERYDRAGICON(0037),func=0x00342410(Junk_Instruction.exe+0x002410)</span><br><span class="line">OnCommand: notifycode=0000 id=03e9,func=0x00342420(Junk_Instruction.exe+0x002420)</span><br></pre></td></tr></table></figure>
<p>&emsp;补充：xspy 输出的 OnMsg 与 OnCommand 有一些区别。OnMsg 表示程序收到了一个普通的消息，例如 WM_PAINT、WM_LBUTTONDOWN 等，这些消息通常是由系统或用户的操作产生的。<strong>OnCommand 表示程序收到了一个命令消息，例如 ID_FILE_OPEN、ID_EDIT_COPY 等，这些消息通常是由菜单或工具栏上的按钮产生的。</strong></p>
<p>&emsp;所以，猜测<code>OnCommand</code>是面板中的<code>check</code>按钮。定位到<code>0x400000+0x002420=0x402420</code>。发现是一个SEH（异常处理函数）。</p>
<p><img src="/images/re-part-6/image-20230615122346601.png" alt="image-20230615122346601" style="zoom:67%;" /></p>
<p>&emsp;相当于：</p>
<p><img src="/images/re-part-6/image-20230615122955662.png" alt="image-20230615122955662" style="zoom:67%;" /></p>
<p>&emsp;而：</p>
<p><img src="/images/re-part-6/image-20230615123053074.png" alt="image-20230615123053074" style="zoom:67%;" /></p>
<p>&emsp;相当于：</p>
<p><img src="/images/re-part-6/image-20230615123742945.png" alt="image-20230615123742945" style="zoom:67%;" /></p>
<p>&emsp;还有把<code>call $+5</code>改为<code>push 下一条指令地址</code>。</p>
<p>&emsp;最后，可以写脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"># @Time  : 2023/06/15 16:49:09</span></span><br><span class="line"><span class="string"># @Author: wd-2711</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">arr = [<span class="number">0x71</span>, <span class="number">0x31</span>, <span class="number">0x28</span>, <span class="number">0x97</span>, <span class="number">0x7D</span>, <span class="number">0x13</span>, <span class="number">0x48</span>, <span class="number">0xD4</span>, <span class="number">0x50</span>, <span class="number">0x1B</span>, <span class="number">0x73</span>, <span class="number">0x79</span>, <span class="number">0xC2</span>, <span class="number">0x1A</span>, <span class="number">0xB5</span>, <span class="number">0xE7</span>, <span class="number">0x29</span>, <span class="number">0x64</span>, <span class="number">0xEB</span>, <span class="number">0x85</span>, <span class="number">0x1C</span>, <span class="number">0x00</span>, <span class="number">0x77</span>, <span class="number">0x16</span>, <span class="number">0xFD</span>, <span class="number">0x23</span>, <span class="number">0x43</span>, <span class="number">0xC9</span>, <span class="number">0xD0</span>, <span class="number">0x7C</span>, <span class="number">0xFF</span>, <span class="number">0xC3</span>, <span class="number">0xA5</span>, <span class="number">0xED</span>, <span class="number">0xA3</span>, <span class="number">0xAA</span>, <span class="number">0xD9</span>, <span class="number">0x66</span>, <span class="number">0xFB</span>, <span class="number">0x92</span>, <span class="number">0x38</span>, <span class="number">0x74</span>, <span class="number">0x04</span>, <span class="number">0x9E</span>, <span class="number">0xC1</span>, <span class="number">0x3A</span>, <span class="number">0x08</span>, <span class="number">0x68</span>, <span class="number">0x37</span>, <span class="number">0xF6</span>, <span class="number">0x4B</span>, <span class="number">0x09</span>, <span class="number">0x45</span>, <span class="number">0x35</span>, <span class="number">0x6C</span>, <span class="number">0x1E</span>, <span class="number">0x14</span>, <span class="number">0xAE</span>, <span class="number">0x3C</span>, <span class="number">0xA9</span>, <span class="number">0xFE</span>, <span class="number">0x4A</span>, <span class="number">0x03</span>, <span class="number">0x62</span>, <span class="number">0x87</span>, <span class="number">0x2E</span>, <span class="number">0x2C</span>, <span class="number">0x55</span>, <span class="number">0xE6</span>, <span class="number">0xAB</span>, <span class="number">0x7F</span>, <span class="number">0x12</span>, <span class="number">0x0B</span>, <span class="number">0x21</span>, <span class="number">0x2B</span>, <span class="number">0x94</span>, <span class="number">0xC7</span>, <span class="number">0x96</span>, <span class="number">0x65</span>, <span class="number">0x11</span>, <span class="number">0x95</span>, <span class="number">0xC0</span>, <span class="number">0x6B</span>, <span class="number">0x0D</span>, <span class="number">0xF1</span>, <span class="number">0xBF</span>, <span class="number">0x8A</span>, <span class="number">0x2D</span>, <span class="number">0xB8</span>, <span class="number">0x81</span>, <span class="number">0xE3</span>, <span class="number">0xFC</span>, <span class="number">0xDF</span>, <span class="number">0xD2</span>, <span class="number">0x7E</span>, <span class="number">0xA6</span>, <span class="number">0x0E</span>, <span class="number">0x6A</span>, <span class="number">0x36</span>, <span class="number">0x70</span>, <span class="number">0x01</span>, <span class="number">0x88</span>, <span class="number">0x6F</span>, <span class="number">0xBD</span>, <span class="number">0x99</span>, <span class="number">0x3E</span>, <span class="number">0x2F</span>, <span class="number">0x5D</span>, <span class="number">0xAF</span>, <span class="number">0xDA</span>, <span class="number">0x75</span>, <span class="number">0x34</span>, <span class="number">0xCB</span>, <span class="number">0xD5</span>, <span class="number">0x47</span>, <span class="number">0x22</span>, <span class="number">0x90</span>, <span class="number">0x58</span>, <span class="number">0x9A</span>, <span class="number">0xA4</span>, <span class="number">0x3F</span>, <span class="number">0xB0</span>, <span class="number">0x15</span>, <span class="number">0x7A</span>, <span class="number">0xF2</span>, <span class="number">0x5F</span>, <span class="number">0xEE</span>, <span class="number">0xF4</span>, <span class="number">0xF0</span>, <span class="number">0xDC</span>, <span class="number">0x61</span>, <span class="number">0x76</span>, <span class="number">0x06</span>, <span class="number">0xC8</span>, <span class="number">0xD6</span>, <span class="number">0xDE</span>, <span class="number">0xDB</span>, <span class="number">0x69</span>, <span class="number">0x8C</span>, <span class="number">0x0F</span>, <span class="number">0x8B</span>, <span class="number">0x44</span>, <span class="number">0x40</span>, <span class="number">0x9C</span>, <span class="number">0x41</span>, <span class="number">0xF7</span>, <span class="number">0x30</span>, <span class="number">0x67</span>, <span class="number">0x27</span>, <span class="number">0xF8</span>, <span class="number">0xCA</span>, <span class="number">0x24</span>, <span class="number">0x39</span>, <span class="number">0xA2</span>, <span class="number">0x05</span>, <span class="number">0x63</span>, <span class="number">0x51</span>, <span class="number">0xC4</span>, <span class="number">0xD3</span>, <span class="number">0xE2</span>, <span class="number">0xF3</span>, <span class="number">0x93</span>, <span class="number">0x0C</span>, <span class="number">0x07</span>, <span class="number">0x2A</span>, <span class="number">0x59</span>, <span class="number">0xA7</span>, <span class="number">0x0A</span>, <span class="number">0x82</span>, <span class="number">0x1D</span>, <span class="number">0xBC</span>, <span class="number">0x9B</span>, <span class="number">0x3D</span>, <span class="number">0xF9</span>, <span class="number">0x10</span>, <span class="number">0xB9</span>, <span class="number">0xCC</span>, <span class="number">0xB1</span>, <span class="number">0x5C</span>, <span class="number">0x84</span>, <span class="number">0xB2</span>, <span class="number">0x32</span>, <span class="number">0xEF</span>, <span class="number">0xB7</span>, <span class="number">0xB4</span>, <span class="number">0x25</span>, <span class="number">0xBE</span>, <span class="number">0x52</span>, <span class="number">0x86</span>, <span class="number">0xCF</span>, <span class="number">0x57</span>, <span class="number">0x17</span>, <span class="number">0x1F</span>, <span class="number">0x6E</span>, <span class="number">0xEA</span>, <span class="number">0x4D</span>, <span class="number">0x4E</span>, <span class="number">0x18</span>, <span class="number">0xCE</span>, <span class="number">0x5A</span>, <span class="number">0x4C</span>, <span class="number">0x91</span>, <span class="number">0xE1</span>, <span class="number">0xEC</span>, <span class="number">0x42</span>, <span class="number">0xBA</span>, <span class="number">0x33</span>, <span class="number">0xDD</span>, <span class="number">0x5B</span>, <span class="number">0xD1</span>, <span class="number">0xFA</span>, <span class="number">0x8D</span>, <span class="number">0xAD</span>, <span class="number">0xB3</span>, <span class="number">0xD7</span>, <span class="number">0x78</span>, <span class="number">0x9F</span>, <span class="number">0xD8</span>, <span class="number">0xA0</span>, <span class="number">0xE5</span>, <span class="number">0x4F</span>, <span class="number">0xE0</span>, <span class="number">0xE4</span>, <span class="number">0xE8</span>, <span class="number">0xB6</span>, <span class="number">0x3B</span>, <span class="number">0xBB</span>, <span class="number">0x53</span>, <span class="number">0x6D</span>, <span class="number">0xC6</span>, <span class="number">0xC5</span>, <span class="number">0x19</span>, <span class="number">0x54</span>, <span class="number">0xE9</span>, <span class="number">0xCD</span>, <span class="number">0xAC</span>, <span class="number">0x8E</span>, <span class="number">0x83</span>, <span class="number">0x80</span>, <span class="number">0xF5</span>, <span class="number">0xA1</span>, <span class="number">0x89</span>, <span class="number">0x60</span>, <span class="number">0x8F</span>, <span class="number">0x72</span>, <span class="number">0x98</span>, <span class="number">0xA8</span>, <span class="number">0x5E</span>, <span class="number">0x02</span>, <span class="number">0x49</span>, <span class="number">0x26</span>, <span class="number">0x20</span>, <span class="number">0x46</span>, <span class="number">0x56</span>, <span class="number">0x9D</span>, <span class="number">0x7B</span>, <span class="number">0x71</span>, <span class="number">0x77</span>, <span class="number">0x65</span>, <span class="number">0x72</span>, <span class="number">0x74</span>, <span class="number">0x79</span>, <span class="number">0x75</span>, <span class="number">0x69</span>, <span class="number">0x6F</span>, <span class="number">0x70</span>, <span class="number">0x00</span>]</span><br><span class="line">tar = [<span class="number">0x00</span>, <span class="number">0x88</span>, <span class="number">0xEA</span>, <span class="number">0x4F</span>, <span class="number">0x00</span>, <span class="number">0x38</span>, <span class="number">0x19</span>, <span class="number">0x6A</span>, <span class="number">0x00</span>, <span class="number">0x68</span>, <span class="number">0x07</span>, <span class="number">0x6A</span>, <span class="number">0x00</span>, <span class="number">0xD8</span>, <span class="number">0xF6</span>, <span class="number">0x4F</span>, <span class="number">0x00</span>, <span class="number">0x5B</span>, <span class="number">0xD6</span>, <span class="number">0xD0</span>, <span class="number">0x26</span>, <span class="number">0xC8</span>, <span class="number">0xDD</span>, <span class="number">0x19</span>, <span class="number">0x7E</span>, <span class="number">0x6E</span>, <span class="number">0x3E</span>, <span class="number">0xCB</span>, <span class="number">0x16</span>, <span class="number">0x91</span>, <span class="number">0x7D</span>, <span class="number">0xFF</span>, <span class="number">0xAF</span>, <span class="number">0xDD</span>, <span class="number">0x76</span>, <span class="number">0x64</span>, <span class="number">0xB0</span>, <span class="number">0xF7</span>, <span class="number">0xE5</span>, <span class="number">0x89</span>, <span class="number">0x57</span>, <span class="number">0x82</span>, <span class="number">0x9F</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0x9E</span>, <span class="number">0xD0</span>, <span class="number">0x45</span>, <span class="number">0xFA</span>]</span><br><span class="line">tar = tar[::-<span class="number">1</span>][:<span class="number">32</span>]</span><br><span class="line">tar = tar[::-<span class="number">1</span>]</span><br><span class="line">v6 = <span class="number">32</span></span><br><span class="line">v4 = <span class="number">123</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    i = <span class="number">31</span> - i</span><br><span class="line">    tar[i] ^= arr[(arr[v4] + arr[v6]) % <span class="number">256</span>]</span><br><span class="line">    v7 = arr[v4]</span><br><span class="line">    arr[v4] = arr[v6]</span><br><span class="line">    arr[v6] = v7</span><br><span class="line">    v4 = (v4 - arr[v6]) % <span class="number">256</span></span><br><span class="line">    v6 = (v6 - <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line"></span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> tar[:<span class="number">32</span>]:</span><br><span class="line">    res += <span class="built_in">chr</span>(i)</span><br><span class="line"></span><br><span class="line">res = res[<span class="number">16</span>:][::-<span class="number">1</span>] + res[:<span class="number">16</span>][::-<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;flag&#123;&quot;</span> + res + <span class="string">&quot;&#125;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>&emsp;结果：</p>
<p><img src="/images/re-part-6/image-20230615165135998.png" alt="image-20230615165135998" style="zoom:67%;" /></p>
<p>&emsp;patch后的程序如下：<code>https://github.com/WD-2711/re_files/tree/main/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/Junk_Instruction</code></p>
<h1 id="icekey"><a href="#icekey" class="headerlink" title="icekey"></a>icekey</h1><p>&emsp;64位程序。<code>.NET</code>是由微软开发的一个软件框架，用于开发和运行各种类型的应用程序，包括桌面应用程序、Web应用程序、移动应用程序、服务端应用程序等。<code>.NET</code>框架提供了一个通用的基础设施，让开发人员可以使用多种编程语言（如<code>C#</code>、<code>VB.NET</code>、<code>F#</code>等）来编写应用程序，并利用<code>.NET</code>框架提供的库和工具来进行开发、测试、调试和部署。</p>
<p>&emsp;ILSpy是<code>.net</code>反编译工具。dnSpy也是一个<code>.net</code>反编译工具。找到一个main函数：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">unsafe</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">main</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">string</span> b = <span class="string">&quot;3ACF8D62AAA0B630C4AF43AF327CE129D46F0FEB98D9040F713BE65502A5107A&quot;</span>;</span><br><span class="line">	&lt;Module&gt;.std.<span class="keyword">operator</span>&lt;&lt;&lt;<span class="keyword">struct</span>\u0020std::char_traits&lt;<span class="built_in">char</span>&gt;\u0020&gt;(&lt;Module&gt;.__imp_std.cout, (<span class="built_in">sbyte</span>*)(&amp;&lt;Module&gt;.??_C@_0CP@LOCJIKOA@flag?$CIformat?<span class="number">3</span>xxxxxxxxxxxxxxxxxxx@));</span><br><span class="line">	IceKey iceKey;</span><br><span class="line">	&lt;Module&gt;.IceKey.&#123;ctor&#125;(<span class="keyword">ref</span> iceKey, <span class="number">0</span>); <span class="comment">// 初始化icekey</span></span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		<span class="built_in">byte</span>[] bytes = Encoding.ASCII.GetBytes(Console.ReadLine());</span><br><span class="line">		<span class="built_in">int</span> num = bytes.Length;</span><br><span class="line">		<span class="keyword">ref</span> <span class="built_in">byte</span> <span class="built_in">byte</span>&amp; = <span class="keyword">ref</span> bytes[<span class="number">0</span>];</span><br><span class="line">		<span class="built_in">byte</span>[] array = <span class="keyword">new</span> <span class="built_in">byte</span>[num];</span><br><span class="line">		<span class="keyword">ref</span> <span class="built_in">byte</span> <span class="built_in">byte</span>&amp;<span class="number">2</span> = <span class="keyword">ref</span> array[<span class="number">0</span>];</span><br><span class="line">		MD5CryptoServiceProvider md5CryptoServiceProvider = <span class="keyword">new</span> MD5CryptoServiceProvider();</span><br><span class="line">		<span class="built_in">byte</span> key;</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			MD5CryptoServiceProvider md5CryptoServiceProvider2 = md5CryptoServiceProvider;</span><br><span class="line">			key = <span class="keyword">ref</span> Encoding.ASCII.GetBytes(BitConverter.ToString(md5CryptoServiceProvider.ComputeHash(Encoding.ASCII.GetBytes(<span class="string">&quot;iriszero&quot;</span>))).Replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>).ToLower())[<span class="number">0</span>]; <span class="comment">// key=md5(&#x27;iriszero&#x27;)</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span>&#123;</span><br><span class="line">			...</span><br><span class="line">		&#125;</span><br><span class="line">		((IDisposable)md5CryptoServiceProvider).Dispose();</span><br><span class="line">		&lt;Module&gt;.IceKey.Set(<span class="keyword">ref</span> iceKey, <span class="keyword">ref</span> key); <span class="comment">// 设置icekey的key，函数具体细节先忽略</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="number">0</span> &lt; num)&#123;</span><br><span class="line">			<span class="built_in">long</span> num2 = <span class="number">0L</span>;</span><br><span class="line">			<span class="built_in">uint</span> num3 = (num - <span class="number">1</span> &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">do</span>&#123;</span><br><span class="line">				&lt;Module&gt;.IceKey.Encrypt(<span class="keyword">ref</span> iceKey, <span class="keyword">ref</span> <span class="built_in">byte</span>&amp; + num2, <span class="keyword">ref</span> <span class="built_in">byte</span>&amp;<span class="number">2</span> + num2); <span class="comment">// 对于输入，每8位使用Icekey加密</span></span><br><span class="line">				num2 += <span class="number">8L</span>;</span><br><span class="line">				num3 += <span class="built_in">uint</span>.MaxValue;</span><br><span class="line">			&#125; <span class="keyword">while</span> (num3 &gt; <span class="number">0U</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">sbyte</span>* val = <span class="keyword">ref</span> (BitConverter.ToString(array).Replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>).ToString() == b) ? <span class="keyword">ref</span> &lt;Module&gt;.??_C@_04LOAJBDKD@true@ : <span class="keyword">ref</span> &lt;Module&gt;.??_C@_05LAPONLG@false@; <span class="comment">// 判断加密是否等于b</span></span><br><span class="line">		&lt;Module&gt;.std.basic_ostream&lt;<span class="built_in">char</span>,std::char_traits&lt;<span class="built_in">char</span>&gt;\u0020&gt;.&lt;&lt;(&lt;Module&gt;.std.<span class="keyword">operator</span>&lt;&lt;&lt;<span class="keyword">struct</span>\u0020std::char_traits&lt;<span class="built_in">char</span>&gt;\u0020&gt;(&lt;Module&gt;.__imp_std.cout, val), &lt;Module&gt;.__unep@??$endl@DU?$char_traits@D@std@@@std@@$$FYAAEAV?$basic_ostream@DU?$char_traits@D@std@@@<span class="number">0</span>@AEAV10@@Z);</span><br><span class="line">		<span class="keyword">if</span> (<span class="number">0</span> &lt; num)&#123;</span><br><span class="line">			<span class="built_in">long</span> num4 = <span class="number">0L</span>;</span><br><span class="line">			<span class="built_in">uint</span> num5 = (num - <span class="number">1</span> &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">do</span>&#123;</span><br><span class="line">				&lt;Module&gt;.IceKey.Decrypt(<span class="keyword">ref</span> iceKey, <span class="keyword">ref</span> <span class="built_in">byte</span>&amp;<span class="number">2</span> + num4, <span class="keyword">ref</span> <span class="built_in">byte</span>&amp; + num4);</span><br><span class="line">				num4 += <span class="number">8L</span>;</span><br><span class="line">				num5 += <span class="built_in">uint</span>.MaxValue;</span><br><span class="line">			&#125; <span class="keyword">while</span> (num5 &gt; <span class="number">0U</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span>&#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	&lt;Module&gt;.IceKey.&#123;dtor&#125;(<span class="keyword">ref</span> iceKey);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;可以看到，程序中还提供了解密字段。那么很简单，我们只需要动态调试，并在<code>if(0&lt;num)</code>时将array字段改为<code>3ACF8D62AAA0B630C4AF43AF327CE129D46F0FEB98D9040F713BE65502A5107A</code>即可，最终得到：<code>5acb06231724c8c369bae711166dbe85</code>。flag为<code>flag&#123;5acb06231724c8c369bae711166dbe85&#125;</code>。</p>
<h1 id="xx"><a href="#xx" class="headerlink" title="xx"></a>xx</h1><p>&emsp;64位程序。程序逻辑挺清晰的。输入字符串，进行某些操作，与另一些字符串作比较。输入长度为19。</p>
<p>&emsp;其中使用了tea加密（find_crypt与newbing都这么说。），但是仔细瞅了瞅，应该使用了XXTEA（主要是看移位）。</p>
<h2 id="0x00-某些逻辑"><a href="#0x00-某些逻辑" class="headerlink" title="0x00 某些逻辑"></a>0x00 某些逻辑</h2><p><img src="/images/re-part-6/image-20230616151545998.png" alt="image-20230616151545998" style="zoom:67%;" /></p>
<p>&emsp;其主要操作如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">v20[<span class="number">3</span>]=v20[<span class="number">0</span>]^v20[<span class="number">3</span>]</span><br><span class="line">v20[<span class="number">4</span>]=v20[<span class="number">0</span>]^v20[<span class="number">4</span>] </span><br><span class="line">v20[<span class="number">5</span>]=v20[<span class="number">0</span>]^v20[<span class="number">5</span>] </span><br><span class="line">v20[<span class="number">6</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">6</span>] </span><br><span class="line">v20[<span class="number">7</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">7</span>] </span><br><span class="line">v20[<span class="number">8</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">8</span>] </span><br><span class="line">v20[<span class="number">9</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">9</span>] </span><br><span class="line">v20[<span class="number">10</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">10</span>] </span><br><span class="line">v20[<span class="number">11</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">11</span>] </span><br><span class="line">v20[<span class="number">12</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">12</span>]  </span><br><span class="line">v20[<span class="number">13</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">13</span>]  </span><br><span class="line">v20[<span class="number">14</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">14</span>]  </span><br><span class="line">v20[<span class="number">15</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">15</span>] </span><br><span class="line">v20[<span class="number">16</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">16</span>] </span><br><span class="line">v20[<span class="number">17</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">17</span>] </span><br><span class="line">v20[<span class="number">18</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">18</span>] </span><br><span class="line">v20[<span class="number">19</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">19</span>] </span><br><span class="line">v20[<span class="number">20</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">20</span>] </span><br><span class="line">v20[<span class="number">21</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">6</span>]^v20[<span class="number">21</span>]  </span><br><span class="line">v20[<span class="number">22</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">6</span>]^v20[<span class="number">22</span>] </span><br><span class="line">v20[<span class="number">23</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">6</span>]^v20[<span class="number">23</span>] </span><br></pre></td></tr></table></figure>
<p>&emsp;其逆如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">v20[<span class="number">23</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">6</span>]^v20[<span class="number">23</span>]</span><br><span class="line">v20[<span class="number">22</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">6</span>]^v20[<span class="number">22</span>]</span><br><span class="line">v20[<span class="number">21</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">6</span>]^v20[<span class="number">21</span>]</span><br><span class="line">v20[<span class="number">20</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">20</span>]</span><br><span class="line">v20[<span class="number">19</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">19</span>]</span><br><span class="line">v20[<span class="number">18</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">18</span>]</span><br><span class="line">v20[<span class="number">17</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">17</span>]</span><br><span class="line">v20[<span class="number">16</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">16</span>]</span><br><span class="line">v20[<span class="number">15</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">15</span>]</span><br><span class="line">v20[<span class="number">14</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">14</span>]</span><br><span class="line">v20[<span class="number">13</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">13</span>]</span><br><span class="line">v20[<span class="number">12</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">12</span>]  </span><br><span class="line">v20[<span class="number">11</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">11</span>]</span><br><span class="line">v20[<span class="number">10</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">10</span>]</span><br><span class="line">v20[<span class="number">9</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">9</span>]</span><br><span class="line">v20[<span class="number">8</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">8</span>]</span><br><span class="line">v20[<span class="number">7</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">7</span>]</span><br><span class="line">v20[<span class="number">6</span>]=v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">6</span>] </span><br><span class="line">v20[<span class="number">5</span>]=v20[<span class="number">0</span>]^v20[<span class="number">5</span>]</span><br><span class="line">v20[<span class="number">4</span>]=v20[<span class="number">0</span>]^v20[<span class="number">4</span>]</span><br><span class="line">v20[<span class="number">3</span>]=v20[<span class="number">0</span>]^v20[<span class="number">3</span>]</span><br></pre></td></tr></table></figure>
<p><img src="/images/re-part-6/image-20230616152533142.png" alt="image-20230616152533142" style="zoom:67%;" /></p>
<p>&emsp;其逆如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">v19[<span class="number">21</span>]=v20[<span class="number">23</span>]</span><br><span class="line">v19[<span class="number">23</span>]=v20[<span class="number">22</span>]</span><br><span class="line">v19[<span class="number">20</span>]=v20[<span class="number">21</span>]</span><br><span class="line">v19[<span class="number">22</span>]=v20[<span class="number">20</span>]</span><br><span class="line">v19[<span class="number">17</span>]=v20[<span class="number">19</span>]</span><br><span class="line">v19[<span class="number">19</span>]=v20[<span class="number">18</span>]</span><br><span class="line">v19[<span class="number">16</span>]=v20[<span class="number">17</span>]</span><br><span class="line">v19[<span class="number">18</span>]=v20[<span class="number">16</span>]</span><br><span class="line">v19[<span class="number">13</span>]=v20[<span class="number">15</span>]</span><br><span class="line">v19[<span class="number">15</span>]=v20[<span class="number">14</span>]</span><br><span class="line">v19[<span class="number">12</span>]=v20[<span class="number">13</span>]</span><br><span class="line">v19[<span class="number">14</span>]=v20[<span class="number">12</span>]</span><br><span class="line">v19[<span class="number">9</span>]=v20[<span class="number">11</span>]</span><br><span class="line">v19[<span class="number">11</span>]=v20[<span class="number">10</span>]</span><br><span class="line">v19[<span class="number">8</span>]=v20[<span class="number">9</span>]</span><br><span class="line">v19[<span class="number">10</span>]=v20[<span class="number">8</span>]</span><br><span class="line">v19[<span class="number">5</span>]=v20[<span class="number">7</span>]</span><br><span class="line">v19[<span class="number">7</span>]=v20[<span class="number">6</span>]</span><br><span class="line">v19[<span class="number">4</span>]=v20[<span class="number">5</span>]</span><br><span class="line">v19[<span class="number">6</span>]=v20[<span class="number">4</span>]</span><br><span class="line">v19[<span class="number">1</span>]=v20[<span class="number">3</span>]</span><br><span class="line">v19[<span class="number">3</span>]=v20[<span class="number">2</span>]</span><br><span class="line">v19[<span class="number">0</span>]=v20[<span class="number">1</span>]</span><br><span class="line">v19[<span class="number">2</span>]=v20[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>&emsp;对于XXTEA，其加密数据为：<code>输入（19字节）+0x0013000000</code>（注意顺序），密钥为：<code>输入的前4位（4个字节）+0x00*12</code>。delta为默认值，即<code>0x9e3779b9</code>。</p>
<p>&emsp;最终脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"># @Time  : 2023/06/16 19:54:01</span></span><br><span class="line"><span class="string"># @Author: wd-2711</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">target = [<span class="number">0xCE</span>, <span class="number">0xBC</span>, <span class="number">0x40</span>, <span class="number">0x6B</span>, <span class="number">0x7C</span>, <span class="number">0x3A</span>, <span class="number">0x95</span>, <span class="number">0xC0</span>, <span class="number">0xEF</span>, <span class="number">0x9B</span>, <span class="number">0x20</span>, <span class="number">0x20</span>, <span class="number">0x91</span>, <span class="number">0xF7</span>, <span class="number">0x02</span>, <span class="number">0x35</span>, <span class="number">0x23</span>, <span class="number">0x18</span>, <span class="number">0x02</span>, <span class="number">0xC8</span>, <span class="number">0xE7</span>, <span class="number">0x56</span>, <span class="number">0x56</span>, <span class="number">0xFA</span>]</span><br><span class="line">v20 = target</span><br><span class="line">v20[<span class="number">23</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">6</span>]^v20[<span class="number">23</span>]</span><br><span class="line">v20[<span class="number">22</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">6</span>]^v20[<span class="number">22</span>]</span><br><span class="line">v20[<span class="number">21</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">6</span>]^v20[<span class="number">21</span>]</span><br><span class="line">v20[<span class="number">20</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">20</span>]</span><br><span class="line">v20[<span class="number">19</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">19</span>]</span><br><span class="line">v20[<span class="number">18</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">5</span>]^v20[<span class="number">18</span>]</span><br><span class="line">v20[<span class="number">17</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">17</span>]</span><br><span class="line">v20[<span class="number">16</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">16</span>]</span><br><span class="line">v20[<span class="number">15</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">4</span>]^v20[<span class="number">15</span>]</span><br><span class="line">v20[<span class="number">14</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">14</span>]</span><br><span class="line">v20[<span class="number">13</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">13</span>]</span><br><span class="line">v20[<span class="number">12</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">3</span>]^v20[<span class="number">12</span>]  </span><br><span class="line">v20[<span class="number">11</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">11</span>]</span><br><span class="line">v20[<span class="number">10</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">10</span>]</span><br><span class="line">v20[<span class="number">9</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">2</span>]^v20[<span class="number">9</span>]</span><br><span class="line">v20[<span class="number">8</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">8</span>]</span><br><span class="line">v20[<span class="number">7</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">7</span>]</span><br><span class="line">v20[<span class="number">6</span>] = v20[<span class="number">0</span>]^v20[<span class="number">1</span>]^v20[<span class="number">6</span>] </span><br><span class="line">v20[<span class="number">5</span>] = v20[<span class="number">0</span>]^v20[<span class="number">5</span>]</span><br><span class="line">v20[<span class="number">4</span>] = v20[<span class="number">0</span>]^v20[<span class="number">4</span>]</span><br><span class="line">v20[<span class="number">3</span>] = v20[<span class="number">0</span>]^v20[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">v19 = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">24</span>)]</span><br><span class="line">v19[<span class="number">21</span>]=v20[<span class="number">23</span>]</span><br><span class="line">v19[<span class="number">23</span>]=v20[<span class="number">22</span>]</span><br><span class="line">v19[<span class="number">20</span>]=v20[<span class="number">21</span>]</span><br><span class="line">v19[<span class="number">22</span>]=v20[<span class="number">20</span>]</span><br><span class="line">v19[<span class="number">17</span>]=v20[<span class="number">19</span>]</span><br><span class="line">v19[<span class="number">19</span>]=v20[<span class="number">18</span>]</span><br><span class="line">v19[<span class="number">16</span>]=v20[<span class="number">17</span>]</span><br><span class="line">v19[<span class="number">18</span>]=v20[<span class="number">16</span>]</span><br><span class="line">v19[<span class="number">13</span>]=v20[<span class="number">15</span>]</span><br><span class="line">v19[<span class="number">15</span>]=v20[<span class="number">14</span>]</span><br><span class="line">v19[<span class="number">12</span>]=v20[<span class="number">13</span>]</span><br><span class="line">v19[<span class="number">14</span>]=v20[<span class="number">12</span>]</span><br><span class="line">v19[<span class="number">9</span>]=v20[<span class="number">11</span>]</span><br><span class="line">v19[<span class="number">11</span>]=v20[<span class="number">10</span>]</span><br><span class="line">v19[<span class="number">8</span>]=v20[<span class="number">9</span>]</span><br><span class="line">v19[<span class="number">10</span>]=v20[<span class="number">8</span>]</span><br><span class="line">v19[<span class="number">5</span>]=v20[<span class="number">7</span>]</span><br><span class="line">v19[<span class="number">7</span>]=v20[<span class="number">6</span>]</span><br><span class="line">v19[<span class="number">4</span>]=v20[<span class="number">5</span>]</span><br><span class="line">v19[<span class="number">6</span>]=v20[<span class="number">4</span>]</span><br><span class="line">v19[<span class="number">1</span>]=v20[<span class="number">3</span>]</span><br><span class="line">v19[<span class="number">3</span>]=v20[<span class="number">2</span>]</span><br><span class="line">v19[<span class="number">0</span>]=v20[<span class="number">1</span>]</span><br><span class="line">v19[<span class="number">2</span>]=v20[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> v19:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(i), end = <span class="string">&quot; &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0xbc 0xa5 0xce 0x40 0xf4 0xb2 0xb2 0xe7 0xa9 0x12 0x9d 0x12 0xae 0x10 0xc8 0x5b 0x3d 0xd7 0x6 0x1d 0xdc 0x70 0xf8 0xdc</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELTA 0x9e3779b9</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MX (((z&gt;&gt;5^y<span class="string">&lt;&lt;2) + (y&gt;</span>&gt;3^z&lt;&lt;4)) ^ ((sum^y) + (key[(p&amp;3)^e] ^ z)))  </span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">btea</span><span class="params">(<span class="type">uint32_t</span> *v, <span class="type">int</span> n, <span class="type">uint32_t</span> <span class="type">const</span> key[<span class="number">4</span>])</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="type">uint32_t</span> y, z, sum;  </span><br><span class="line">    <span class="type">unsigned</span> p, rounds, e;  </span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">1</span>)            <span class="comment">/* Coding Part */</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span>/n; </span><br><span class="line">        sum = <span class="number">0</span>;  </span><br><span class="line">        z = v[n<span class="number">-1</span>];  </span><br><span class="line">        <span class="keyword">do</span>  </span><br><span class="line">        &#123;  </span><br><span class="line">            sum += DELTA;  </span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;  </span><br><span class="line">            <span class="keyword">for</span> (p=<span class="number">0</span>; p&lt;n<span class="number">-1</span>; p++)  </span><br><span class="line">            &#123;  </span><br><span class="line">                y = v[p+<span class="number">1</span>];  </span><br><span class="line">                z = v[p] += MX;  </span><br><span class="line">            &#125;  </span><br><span class="line">            y = v[<span class="number">0</span>];  </span><br><span class="line">            z = v[n<span class="number">-1</span>] += MX;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">while</span> (--rounds);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n &lt; <span class="number">-1</span>)      <span class="comment">/* Decoding Part */</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        n = -n;  </span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span>/n;  </span><br><span class="line">        sum = rounds*DELTA;  </span><br><span class="line">        y = v[<span class="number">0</span>];  </span><br><span class="line">        <span class="keyword">do</span>  </span><br><span class="line">        &#123;  </span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;  </span><br><span class="line">            <span class="keyword">for</span> (p=n<span class="number">-1</span>; p&gt;<span class="number">0</span>; p--)  </span><br><span class="line">            &#123;  </span><br><span class="line">                z = v[p<span class="number">-1</span>];  </span><br><span class="line">                y = v[p] -= MX;  </span><br><span class="line">            &#125;  </span><br><span class="line">            z = v[n<span class="number">-1</span>];  </span><br><span class="line">            y = v[<span class="number">0</span>] -= MX;  </span><br><span class="line">            sum -= DELTA;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">while</span> (--rounds);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="comment">// python脚本得出的结果</span></span><br><span class="line">    <span class="type">uint32_t</span> v[<span class="number">6</span>]= &#123;<span class="number">0x40cea5bc</span>,<span class="number">0xe7b2b2f4</span>,<span class="number">0x129d12a9</span>,<span class="number">0x5bc810ae</span>,<span class="number">0x1d06d73d</span>,<span class="number">0xdcf870dc</span>&#125;;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 猜测key是 &quot;flag&quot;</span></span><br><span class="line">    <span class="type">uint32_t</span> <span class="type">const</span> k[<span class="number">4</span>]= &#123;<span class="number">0x67616c66</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> n=<span class="number">6</span>;</span><br><span class="line">    <span class="built_in">btea</span>(v, -n, k);  </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">6</span>; i++)&#123;</span><br><span class="line">        <span class="type">int</span> now = v[i];</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="type">int</span> tmp1 = now &amp; <span class="number">0xff</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, tmp1);</span><br><span class="line">            now = now &gt;&gt; <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">if</span>(now == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">// flag&#123;CXX_and_++tea&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="easyvm"><a href="#easyvm" class="headerlink" title="easyvm"></a>easyvm</h1><p>&emsp;64位的ELF，看题目名称是个虚拟机。运行如下：</p>
<p><img src="/images/re-part-6/image-20230616200402015.png" alt="image-20230616200402015" style="zoom:80%;" /></p>
<p>&emsp;打开后要求输入32位的flag。</p>
<p><img src="/images/re-part-6/image-20230616200842305.png" alt="image-20230616200842305" style="zoom:67%;" /></p>
<p>&emsp;重点是红框部分，其中应该有关于验证的具体逻辑。其中，<code>sub_400c1e</code>函数如下：</p>
<p><img src="/images/re-part-6/image-20230616201658404.png" alt="image-20230616201658404" style="zoom:67%;" /></p>
<p>&emsp;它是对上上图第一个红框中的<code>v3</code>进行值的分配。<code>off_4010a8</code>是好多函数的偏移。经过分析，上上图第2个红框是<code>sub_400806</code>函数，很明显是一个虚拟机<code>switch ... case ...</code>函数。</p>
<p>&emsp;分析之后，总结其流程如下（伪代码）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">*(_QWORD *)(a1 + 24) = arr2</span><br><span class="line">*(_QWORD *)(a1 + 32) = input</span><br><span class="line"></span><br><span class="line">labelA:</span><br><span class="line">    *(_BYTE *)(a1 + 16) = *(_BYTE *)(*(_QWORD *)(a1 + 32) + *(unsigned __int8 *)(a1 + 18))</span><br><span class="line">    *(_BYTE *)(a1 + 16) -= *(_BYTE *)(a1 + 18)</span><br><span class="line">    *(_BYTE *)(a1 + 17) ^= *(_BYTE *)(a1 + 16)</span><br><span class="line">    *(_BYTE *)(a1 + 16) = -51</span><br><span class="line">    *(_BYTE *)(a1 + 16) ^= *(_BYTE *)(a1 + 17)</span><br><span class="line"></span><br><span class="line">    if ( *(a1 + 16) == *(*(a1 + 24) + *(a1 + 18)) )</span><br><span class="line">    &#123;</span><br><span class="line">        *(a1 + 20) = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        if ( *(a1 + 16) &gt;= *(*(a1 + 24) + *(a1 + 18)) )</span><br><span class="line">            *(a1 + 20) = 1;</span><br><span class="line">        else</span><br><span class="line">            *(a1 + 20) = -1;</span><br><span class="line">    &#125;</span><br><span class="line">    *(_BYTE *)(a1 + 17) = *(_BYTE *)(a1 + 16);</span><br><span class="line">    if (*(_DWORD *)(a1 + 20))</span><br><span class="line">        return 0LL; </span><br><span class="line">    ++*(_BYTE *)(a1 + 18);</span><br><span class="line">    *(_DWORD *)(a1 + 20) = *(_BYTE *)(a1 + 18) &gt; 0x1Fu;</span><br><span class="line">    if (*(_DWORD *)(a1 + 20) != 1)</span><br><span class="line">        goto labelA</span><br><span class="line">    print(&quot;good&quot;)</span><br></pre></td></tr></table></figure>
<p>&emsp;经过究极简化，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">*(_QWORD *)(a1 + 24)          ----&gt; arr2</span><br><span class="line">*(_QWORD *)(a1 + 32)          ----&gt; input</span><br><span class="line">*(unsigned __int8 *)(a1 + 18) ----&gt; i</span><br><span class="line">*(_BYTE *)(a1 + 18)           ----&gt; i</span><br><span class="line">*(_BYTE *)(a1 + 16)           ----&gt; j</span><br><span class="line">*(_BYTE *)(a1 + 17)           ----&gt; m</span><br><span class="line">*(_DWORD *)(a1 + 20)          ----&gt; k</span><br></pre></td></tr></table></figure>
<p>最终可以得到：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">i = <span class="number">0</span></span><br><span class="line">m = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    j = m ^ (<span class="built_in">input</span>[i] - i) ^ <span class="number">0xCD</span></span><br><span class="line">    <span class="keyword">if</span> j == arr2[i]:</span><br><span class="line">        k = <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    m = arr2[i]</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">    k = i &gt; <span class="number">31</span></span><br><span class="line">    <span class="keyword">if</span> k == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;good&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>&emsp;可以写脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"># @Time  : 2023/06/16 23:06:53</span></span><br><span class="line"><span class="string"># @Author: wd-2711</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">arr2 = [<span class="number">0xF4</span>, <span class="number">0x0A</span>, <span class="number">0xF7</span>, <span class="number">0x64</span>, <span class="number">0x99</span>, <span class="number">0x78</span>, <span class="number">0x9E</span>, <span class="number">0x7D</span>, <span class="number">0xEA</span>, <span class="number">0x7B</span>, <span class="number">0x9E</span>, <span class="number">0x7B</span>, <span class="number">0x9F</span>, <span class="number">0x7E</span>, <span class="number">0xEB</span>, <span class="number">0x71</span>, <span class="number">0xE8</span>, <span class="number">0x00</span>, <span class="number">0xE8</span>, <span class="number">0x07</span>, <span class="number">0x98</span>, <span class="number">0x19</span>, <span class="number">0xF4</span>, <span class="number">0x25</span>, <span class="number">0xF3</span>, <span class="number">0x21</span>, <span class="number">0xA4</span>, <span class="number">0x2F</span>, <span class="number">0xF4</span>, <span class="number">0x2F</span>, <span class="number">0xA6</span>, <span class="number">0x7C</span>]</span><br><span class="line"></span><br><span class="line">m = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;UNCTF&#123;&quot;</span>, end = <span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    out = (arr2[i] ^ m ^ <span class="number">0xCD</span>) + i</span><br><span class="line">    m = arr2[i]</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(out), end = <span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#125;&quot;</span>, end = <span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># UNCTF&#123;942a4115be2359ffd675fa6338ba23b6&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="seven"><a href="#seven" class="headerlink" title="seven"></a>seven</h1><p>&emsp;是sys驱动文件！</p>

  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2023/05/25/re-core-principle-6/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> 上一页</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2023/05/21/pinocchio/" type="button" class="btn btn-default ">下一页<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>


	<!-- comment -->
	
<section id="comment">
    <h2 class="title">留言</h2>

    <!-- 
    <div id="disqus_thread" class="ds-thread">
        <script type="text/javascript">
            /**
             * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
             * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
             */
                /*
                 var disqus_config = function () {
                 this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                 this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                 };
                 */
            (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');

                s.src = 'https://https-wd-2711-tech.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by
                Disqus.</a></noscript>
    </div> -->
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <div id="vcomments"></div>
    <script>
        new Valine({
            el: '#vcomments',
            appId: 'wLIJ70s3fPvW8WJPgVVAuWVR-gzGzoHsz',
            appKey: 'NVGqxhUkqtFv2CbwmXXWjCdR'
        })
    </script>

    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2023-05-22 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/re/">re<span>38</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>

	<!-- copyright -->
	<div>
    <ul class="post-copyright">
      <li class="post-copyright-author">
      <strong>作者:  </strong>wd-z711</a>
      </li>
      <li class="post-copyright-link">
      <strong>文章链接:  </strong>
      <a href="/" target="_blank" title="">https://wd-2711.tech/</a>
      </li>
      <li class="post-copyright-license">
        <strong>版权声明:   </strong>
        本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
        许可协议。转载请注明出处!
      </li>
    </ul>
  <div>
 	

		


</div><!-- row -->




	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2024 wd-z711
  
      <!-- with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.     -->

     <!-- <script type="text/javascript">
      (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
      (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
      e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
      })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
      
      _st('install','aB-vgeB8gEDrnRJuhceL','2.0.0');
    </script> -->
    </p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
   </html>
