<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>wmctf-2023 | wd-z711&#39;s B10g</title>
  <meta name="author" content="wd-z711">
  
  <meta name="description" content="Common student in China. Interested in web &amp; re.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="wmctf-2023"/>
  <meta property="og:site_name" content="wd-z711&#39;s B10g"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'G-YHJSKZDC3Y', 'auto');
  ga('send', 'pageview');
</script>




<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="wd-z711's B10g" type="application/atom+xml">
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">wd-z711&#39;s B10g</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> wmctf-2023</h1>
		</div>
	



<div class="row post">

	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h1 id="WMCTF2023"><a href="#WMCTF2023" class="headerlink" title="WMCTF2023"></a>WMCTF2023</h1><p>&emsp;8.20的比赛，拖了快两个月，我是懒狗，呜呜呜。</p>
<span id="more"></span>
<h2 id="0x00-ezAndroid"><a href="#0x00-ezAndroid" class="headerlink" title="0x00 ezAndroid"></a>0x00 ezAndroid</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">耐心搜索</span><br></pre></td></tr></table></figure>
<p>&emsp;Android killer与PKID显示未加壳。jeb打开：</p>
<p><img src="/images/wmctf-2023/image-20231011140306345.png" alt="image-20231011140306345" style="zoom:67%;" /></p>
<p>&emsp;跟踪this.CheckUsername与this.check2函数。发现是naive层的函数，如下所示：</p>
<p><img src="/images/wmctf-2023/image-20231011140418292.png" alt="image-20231011140418292" style="zoom:67%;" /></p>
<p>&emsp;（1）找到java函数在native层对应的函数符号，并以此找到函数地址。（包名：<code>com.wmctf.ezandroid</code>）</p>
<p>&emsp;&emsp;（a）objection注入失败（frida反调试），但是幸运的是，关键函数CheckUsername与check2都使用动态注册，根据frida_hook_libart，有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f com.wmctf.ezandroid -l hook_RegisterNatives.js --no-pause</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;（2）可以得到CheckUsername和check2在libezandroid.so中的名字：<code>0x35a4</code>与<code>0x3f0c</code>。如下所示：</p>
<p><img src="/images/wmctf-2023/image-20231011143020836.png" alt="image-20231011143020836" style="zoom:67%;" /></p>
<h3 id="sub-35a4-CheckUsername"><a href="#sub-35a4-CheckUsername" class="headerlink" title="sub_35a4-CheckUsername"></a>sub_35a4-CheckUsername</h3><h4 id="Step1"><a href="#Step1" class="headerlink" title="Step1"></a>Step1</h4><p>&emsp;分析libezandroid.so，对于sub_35a4（CheckUsername），其中首先调用了sub_3EC0(a1, name, 0LL)，其中a1为JNIEnv，name为用户名。跟进后，发现是JNIEnv+0x548函数。</p>
<p><img src="/images/wmctf-2023/image-20231011144740090.png" alt="image-20231011144740090" style="zoom:67%;" /></p>
<p>&emsp;因此，打算hook sub_3EC0函数，并打印其输入与返回值。但是首先，先绕过反调试（<code>因为frida注入时总会退出</code>）。</p>
<h4 id="Step2"><a href="#Step2" class="headerlink" title="Step2"></a>Step2</h4><p>&emsp;&emsp;反调试绕过，见<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/278827">链接</a>。首先查看open了哪些文件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// look_open.js</span></span><br><span class="line"><span class="comment">// find open function in all modules</span></span><br><span class="line"><span class="keyword">var</span> pth = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;open&quot;</span>)</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pth, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">filename</span> = args[<span class="number">0</span>]</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">filename</span>.<span class="title function_">readCString</span>())</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">ret</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>&emsp;发现断在了：</p>
<p><img src="/images/wmctf-2023/image-20231011160627564.png" alt="image-20231011160627564" style="zoom:67%;" /></p>
<p>&emsp;/proc/self/maps用于访问当前进程的内存映射信息。查看此映射信息：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// look_maps.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">look_maps</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">var</span> source_path = <span class="string">&quot;file://&quot;</span> + <span class="string">&quot;/proc/self/maps&quot;</span></span><br><span class="line">		<span class="keyword">var</span> <span class="title class_">Paths</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.nio.file.Paths&quot;</span>);</span><br><span class="line">		<span class="keyword">var</span> <span class="variable constant_">URI</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.net.URI&quot;</span>);</span><br><span class="line">		<span class="keyword">var</span> path = <span class="title class_">Paths</span>.<span class="title function_">get</span>(<span class="variable constant_">URI</span>.<span class="title function_">create</span>(source_path));</span><br><span class="line">		<span class="keyword">var</span> <span class="title class_">Files</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.nio.file.Files&quot;</span>);</span><br><span class="line">		<span class="keyword">var</span> fileBytes = <span class="title class_">Files</span>.<span class="title function_">readAllBytes</span>(path);</span><br><span class="line">		<span class="keyword">var</span> <span class="title class_">JString</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">		<span class="keyword">var</span> ret = <span class="title class_">JString</span>.$new(fileBytes);</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(ret)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(look_maps)</span><br></pre></td></tr></table></figure>
<p>&emsp;当挂上frida之后，如下所示：</p>
<p><img src="/images/wmctf-2023/image-20231011164144232.png" alt="image-20231011164144232" style="zoom:67%;" /></p>
<p>&emsp;要绕过此检测，就要备份一个正常启动的maps文件，如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bypass.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bypass</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> openPtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> open = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">    <span class="comment">// 事先准备好</span></span><br><span class="line">    <span class="keyword">var</span> fakePath = <span class="string">&quot;/data/local/tmp/ezandroid.maps&quot;</span>;</span><br><span class="line">    <span class="comment">// 替换 open 函数</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(openPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">pathnameptr, flag</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> pathname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(pathnameptr);</span><br><span class="line">        <span class="keyword">var</span> realFd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">        <span class="comment">// pathname 中含有 &quot;maps&quot;，此时返回 fakePath 的 fd</span></span><br><span class="line">        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;maps&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> filename = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(fakePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">open</span>(filename, flag);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> fd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">  &#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(bypass)</span><br></pre></td></tr></table></figure>
<h4 id="Step3"><a href="#Step3" class="headerlink" title="Step3"></a>Step3</h4><p>&emsp;快乐的hook sub_3EC0()：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hook_sub_3EC0.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bypass</span>(<span class="params"></span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(bypass)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_3ec0</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> offset = <span class="number">0x3ec0</span></span><br><span class="line">    <span class="keyword">var</span> base = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libezandroid.so&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> func_addr = base.<span class="title function_">add</span>(offset)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title function_">ptr</span>(func_addr), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">1</span>].<span class="title function_">readCString</span>())</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">ret</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ret:&quot;</span>, ret.<span class="title function_">readCString</span>())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;发现返回值ret为用户名，但是args[1]并不是想象中的，为用户名，猜测应该是用户名的jstring对象。</p>
<h4 id="Step4"><a href="#Step4" class="headerlink" title="Step4"></a>Step4</h4><p>&emsp;&emsp;紧接着分析，发现sub_35a4函数貌似经过ollvm的混淆，有很多while循环，如下所示：</p>
<p><img src="/images/wmctf-2023/image-20231011194917434.png" alt="image-20231011194917434" style="zoom:67%;" /></p>
<p>&emsp;使用<a target="_blank" rel="noopener" href="https://github.com/cq674350529/deflat/tree/master">项目</a>，将deflat.py代码改为：</p>
<p><img src="/images/wmctf-2023/image-20231011214247374.png" alt="image-20231011214247374" style="zoom:67%;" /></p>
<p>&emsp;即可扫描到sub_35a4函数，运行指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 deflat.py -f libezandroid.so --addr 0x4035A4</span><br></pre></td></tr></table></figure>
<p>&emsp;但是效果不尽人意。</p>
<h4 id="Step5"><a href="#Step5" class="headerlink" title="Step5"></a>Step5</h4><p>&emsp;&emsp;经过艰苦卓绝的手动测试，终于得到如下结论：</p>
<ul>
<li>一共三轮大循环，前两轮大循环无用。</li>
<li>用户名长度为10，如下所示，其中v47为用户名长度：</li>
</ul>
<p><img src="/images/wmctf-2023/image-20231011221556799.png" alt="image-20231011221556799" style="zoom:67%;" /></p>
<ul>
<li><code>memcmp(v30, &amp;byte_A138, 0xAu)</code>应总返回0，即比较成功。</li>
</ul>
<p>&emsp;接下来，重点关注以下部分（仅执行一次）：</p>
<p><img src="/images/wmctf-2023/image-20231011221904999.png" alt="image-20231011221904999" style="zoom:67%;" /></p>
<p>&emsp;钩取sub_60A0函数，得到返回值为<code>12345678</code>。</p>
<p>&emsp;钩取sub_6C2C函数，其参数分别为：用户名，返回字符串（要返回），用户名长度，字符串”12345678”，某个值（要返回）。</p>
<p>&emsp;钩取memcmp函数，但是系统可能一直在调用memcmp，且Interceptor.attach开销很大，导致钩取时直接卡住。</p>
<h4 id="Step6"><a href="#Step6" class="headerlink" title="Step6"></a>Step6</h4><p>&emsp;分析sub_6C2C函数，首先使用deflat olllvm反混淆，但失败。之后，将程序划分为多个Block，分别为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// block 1</span></span><br><span class="line">v21 = <span class="number">0</span>;</span><br><span class="line">i = <span class="number">0x6A42046E</span>;</span><br><span class="line"><span class="comment">// block 2</span></span><br><span class="line"><span class="keyword">if</span>(v21 + <span class="number">1</span> &gt;= <span class="number">0</span>)</span><br><span class="line">    v10 = v21 + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    v10 = v21 + <span class="number">256</span>;</span><br><span class="line">v21 = v21 + <span class="number">1</span> - (v10 &amp; <span class="number">0xFFFFFF00</span>);</span><br><span class="line">v11 = v15 + (<span class="type">unsigned</span> __int8)v22[v21 + <span class="number">256</span>];</span><br><span class="line">v12 = v11 + <span class="number">255</span>;</span><br><span class="line"><span class="keyword">if</span> (v11 &gt;= <span class="number">0</span>)</span><br><span class="line">    v12 = v15 + (<span class="type">unsigned</span> __int8)v22[v21 + <span class="number">256</span>];</span><br><span class="line">v15 = v11 - (v12 &amp; <span class="number">0xFFFFFF00</span>);</span><br><span class="line">result = <span class="built_in">swap</span>(&amp;v22[v21 + <span class="number">256</span>], &amp;v22[v15 + <span class="number">256</span>]);</span><br><span class="line">*(_BYTE *)(a2 + j) = *(_BYTE *)(v20 + j) ^ v22[(<span class="type">unsigned</span> __int8)(v22[v21 + <span class="number">256</span>] + v22[v15 + <span class="number">256</span>]) + <span class="number">256</span>] ^ j;</span><br><span class="line">i = <span class="number">-0x235CE214</span>u;</span><br><span class="line"><span class="comment">// block 3</span></span><br><span class="line">v5 = <span class="number">0x3D13C5C</span>;</span><br><span class="line"><span class="keyword">if</span>(v21 &gt;= <span class="number">256</span>)</span><br><span class="line">    v5 = <span class="number">-0x59910D2C</span>u;</span><br><span class="line">i = v5;</span><br><span class="line"><span class="comment">// block 4</span></span><br><span class="line">++j;</span><br><span class="line">i = <span class="number">-0x16F5EC03</span>u;</span><br><span class="line"><span class="comment">// block 5</span></span><br><span class="line"><span class="keyword">if</span> ( j &gt;= a3 )</span><br><span class="line">    v9 = <span class="number">0x531796B4</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    v9 = <span class="number">-0x338869E1</span>u;</span><br><span class="line">i = v9;</span><br><span class="line"><span class="comment">// block 6</span></span><br><span class="line">++v21;</span><br><span class="line">i = <span class="number">-0x3F77EF18</span>u;</span><br><span class="line"><span class="comment">// block 7</span></span><br><span class="line">v15 = <span class="number">0</span>;</span><br><span class="line">v21 = <span class="number">0</span>;</span><br><span class="line">j = <span class="number">0</span>;</span><br><span class="line">i = <span class="number">-0x16F5EC03</span>u;</span><br><span class="line"><span class="comment">// block 8</span></span><br><span class="line">v6 = <span class="number">0x63790CC6</span>;</span><br><span class="line"><span class="keyword">if</span>(v21 &gt;= <span class="number">256</span>)</span><br><span class="line">    v6 = <span class="number">0x5BE5E1B6</span>;</span><br><span class="line">i = v6;</span><br><span class="line"><span class="comment">// block 9</span></span><br><span class="line">v7 = v15 + (<span class="type">unsigned</span> __int8)v22[v21 + <span class="number">256</span>] + (<span class="type">unsigned</span> __int8)v22[v21];</span><br><span class="line">v8 = v7 + <span class="number">255</span>;</span><br><span class="line"><span class="keyword">if</span> ( v7 &gt;= <span class="number">0</span> )</span><br><span class="line">    v8 = v15 + (<span class="type">unsigned</span> __int8)v22[v21 + <span class="number">256</span>] + (<span class="type">unsigned</span> __int8)v22[v21];</span><br><span class="line">v15 = v7 - (v8 &amp; <span class="number">0xFFFFFF00</span>);</span><br><span class="line">result = <span class="built_in">swap</span>(&amp;v22[v21 + <span class="number">256</span>], &amp;v22[v15 + <span class="number">256</span>]);</span><br><span class="line">i = <span class="number">0x25E9A458</span>;</span><br><span class="line"><span class="comment">// block 10</span></span><br><span class="line">v22[v21 + <span class="number">256</span>] = v21;</span><br><span class="line">v22[v21] = *(_BYTE *)(a4 + v21 % a5);</span><br><span class="line">i = <span class="number">-0x1F4D6769</span>u;</span><br><span class="line"><span class="comment">// block 11</span></span><br><span class="line">++v21;</span><br></pre></td></tr></table></figure>
<p>&emsp;block的运行逻辑为：先256次 <code>block3-&gt;block10-&gt;block6</code>，block3，block1，再256次 <code>block8-&gt;block9-&gt;block11</code>，block8，block7，最后10次<code>block5-&gt;block2-&gt;block4</code>。经过分析，属于<code>RC4算法</code>，密钥为<code>12345678</code>。RC4魔改了一下，最后异或j。</p>
<h4 id="Step7"><a href="#Step7" class="headerlink" title="Step7"></a>Step7</h4><p>&emsp;这一步主要是获取memcmp的第2个参数<code>byte_A138</code>。前面钩取memcmp的方法行不通，那么找到byte_A138在哪儿赋值的。找到相关函数，如下所示：</p>
<p><img src="/images/wmctf-2023/image-20231012122728031.png" alt="image-20231012122728031" style="zoom:67%;" /></p>
<p>&emsp;得到<code>byte_A138 = [0xe9,0x97,0x64,0xe6,0x7e,0xeb,0xbd,0xc1,0x0,0x1e]</code>。解密脚本出不了，猜测是不是byte_A138的计算有问题，frida钩取一下。打印内存的脚本：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">print_mem</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libezandroid.so&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> byte_A138 = addr.<span class="title function_">add</span>(<span class="number">0xa138</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(byte_A138, &#123;</span><br><span class="line">            <span class="attr">offset</span>:<span class="number">0</span>,</span><br><span class="line">            <span class="attr">length</span>: <span class="number">64</span>,</span><br><span class="line">            <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">ansi</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;))</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;发现<code>byte_A138</code>应该为：<code>[0xe9,0x97,0x64,0xe6,0x7e,0xeb,0xbd,0xc1,0xab,0x43]</code>。</p>
<p>&emsp;针对用户名的解密脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ARC4</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">rc4util</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(key, <span class="built_in">str</span>):</span><br><span class="line">            self.__keyGen = key.encode()</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(key, <span class="built_in">bytes</span>):</span><br><span class="line">            self.__keyGen = key        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__encrypt</span>(<span class="params">self, data</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        rc4 = ARC4.new(self.__keyGen)</span><br><span class="line">        res = rc4.encrypt(data)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__decrypt</span>(<span class="params">self, data</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        rc4 = ARC4.new(self.__keyGen)</span><br><span class="line">        res = rc4.decrypt(data)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Encrypt</span>(<span class="params">self, d</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">      res = self.__encrypt(d)</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Decrypt</span>(<span class="params">self, d</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">      res = self.__decrypt(d)</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">key = <span class="string">&quot;12345678&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Entry</span>(<span class="params">d</span>):</span><br><span class="line">  rc4 = rc4util(key)</span><br><span class="line">  ret = rc4.Encrypt(d)</span><br><span class="line">  <span class="keyword">return</span> ret</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Decry</span>(<span class="params">d</span>):</span><br><span class="line">  rc4 = rc4util(key)</span><br><span class="line">  ret = rc4.Decrypt(d)</span><br><span class="line">  <span class="keyword">return</span> ret</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">  ciphertext = <span class="built_in">bytes</span>([<span class="number">0xe9</span>,<span class="number">0x97</span>,<span class="number">0x64</span>,<span class="number">0xe6</span>,<span class="number">0x7e</span>,<span class="number">0xeb</span>,<span class="number">0xbd</span>,<span class="number">0xc1</span>,<span class="number">0xab</span>,<span class="number">0x43</span>])</span><br><span class="line">  res = Entry(ciphertext)</span><br><span class="line">  <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">enumerate</span>(res):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(i^j), end = <span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># Re_1s_eaSy</span></span><br></pre></td></tr></table></figure>
<h3 id="sub-3f0c-check2"><a href="#sub-3f0c-check2" class="headerlink" title="sub_3f0c-check2"></a>sub_3f0c-check2</h3><p>&emsp;再来看验证密码的函数，与上个函数的分析类似，密码长度为16。重点关注sub_AFC与unk_A158。</p>
<p><img src="/images/wmctf-2023/image-20231012144127979.png" alt="image-20231012144127979" style="zoom:67%;" /></p>
<h4 id="Step1-1"><a href="#Step1-1" class="headerlink" title="Step1"></a>Step1</h4><p>&emsp;钩取sub_AFC，发现参数为：密码、0x10、Re_1s_eaSy123456。分析sub_AFC，划分block（化简版）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// block1</span></span><br><span class="line">v19 = <span class="built_in">strlen</span>(v27);</span><br><span class="line">v29 = v30 - <span class="number">354358356</span>;</span><br><span class="line">result = <span class="built_in">sub_11A0</span>(&amp;v29, v20);</span><br><span class="line">v18 = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// block2</span></span><br><span class="line">v29 = v30 + <span class="number">51219284</span>;</span><br><span class="line">v8 = &amp;v29;</span><br><span class="line">v7 = v33;</span><br><span class="line"><span class="built_in">sub_1CD8</span>(&amp;v29, v33);</span><br><span class="line">v29 = v30 - <span class="number">1988849943</span>;</span><br><span class="line"><span class="built_in">sub_2000</span>(v8, v7);</span><br><span class="line">v29 = v30 + <span class="number">1568064809</span>;</span><br><span class="line"><span class="built_in">sub_1990</span>(v8, v7, <span class="number">10LL</span>);</span><br><span class="line">v29 = v30 + <span class="number">901913056</span>;</span><br><span class="line">result = <span class="built_in">sub_2ADC</span>(v8, v7, v22 + v18);</span><br><span class="line"><span class="comment">// block3</span></span><br><span class="line">v29 = v30 + <span class="number">51219284</span>;</span><br><span class="line">v10 = &amp;v29;</span><br><span class="line">v9 = v33;</span><br><span class="line"><span class="built_in">sub_1CD8</span>(&amp;v29, v33);</span><br><span class="line">v29 = v30 - <span class="number">1988849943</span>;</span><br><span class="line"><span class="built_in">sub_2000</span>(v10, v9);</span><br><span class="line">v29 = v30 - <span class="number">879117111</span>;</span><br><span class="line"><span class="built_in">sub_23FC</span>(v10, v9);</span><br><span class="line">v29 = v30 + <span class="number">1568064809</span>;</span><br><span class="line">result = <span class="built_in">sub_1990</span>(v10, v9, v17);</span><br><span class="line"><span class="comment">// block4</span></span><br><span class="line">++v17;</span><br><span class="line"><span class="comment">// block5</span></span><br><span class="line"><span class="comment">// block6</span></span><br><span class="line"><span class="comment">// block7</span></span><br><span class="line">v18 += <span class="number">16</span>;</span><br><span class="line"><span class="comment">// block8</span></span><br><span class="line">v29 = v30 - <span class="number">739967527</span>;</span><br><span class="line">v12 = &amp;v29;</span><br><span class="line">v11 = v33;</span><br><span class="line"><span class="built_in">sub_165C</span>(&amp;v29, v22 + v18, v33);</span><br><span class="line">v29 = v30 + <span class="number">1568064809</span>;</span><br><span class="line">result = <span class="built_in">sub_1990</span>(v12, v11, <span class="number">0LL</span>);</span><br><span class="line">v17 = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>&emsp;计算过程：block1、block6、block8、9次<code>block5-&gt;block3-&gt;block4</code>、block5、block2、block7、block6。化简后：block1、block8、9次<code>block3-&gt;block4</code>、block2、block7。</p>
<p>&emsp;分析block1中的sub_11A0，参数分别为：-2263271711、Re_1s_eaSy123456，猜测是初始化参数，在此跳过。</p>
<p>&emsp;再分析block8中的sub_165C，是将用户输入的密码传递到另一个变量中，例如存到变量里是<code>abcdefghijklmnoz</code>，那么变量则为<code>aeimbfjncgkodhlz</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">d = &#123;<span class="string">&quot;0&quot;</span>:[], <span class="string">&quot;1&quot;</span>:[], <span class="string">&quot;2&quot;</span>:[], <span class="string">&quot;3&quot;</span>:[]&#125;</span><br><span class="line">inp = <span class="string">&quot;...&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    ind = i % <span class="number">4</span></span><br><span class="line">    d[<span class="built_in">str</span>(ind)].append(inp[i])</span><br><span class="line">inp = d[<span class="string">&quot;0&quot;</span>] + d[<span class="string">&quot;1&quot;</span>] + d[<span class="string">&quot;2&quot;</span>] + d[<span class="string">&quot;3&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>&emsp;block8中的sub_1990，逻辑为（轮密钥加）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">byte_A178 = [...]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">	<span class="keyword">if</span> i % <span class="number">4</span> == <span class="number">0</span>:</span><br><span class="line">        k = <span class="number">3</span> - i / <span class="number">4</span></span><br><span class="line">    j = k + (i % <span class="number">4</span>) * <span class="number">4</span></span><br><span class="line">    ret[i] ^= byte_A178[j + arg3 * <span class="number">16</span>]</span><br></pre></td></tr></table></figure>
<p>&emsp;block3中的sub_1CD8，是字节替换。block3中的sub_2000，是行移位。sub_23FC是列混淆。sub_2ADC则是重新得到密文。综上，属于<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/98514678">AES加密流程</a>。</p>
<p>&emsp;既然，AES是对称加密，那么我们把要比较的密文扔进去，再过一遍，不就得到明文了吗？（<code>我真傻逼</code>）</p>
<p>&emsp;hook得到要比较的密文：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2bc8208b5c0da79b2a513ad27171ca50</span><br></pre></td></tr></table></figure>
<p>&emsp;主动调用sub_afc函数（不要忘记前面的bypass哦）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">bypass</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> openPtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> open = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">    <span class="comment">// 事先准备好</span></span><br><span class="line">    <span class="keyword">var</span> fakePath = <span class="string">&quot;/data/local/tmp/ezandroid.maps&quot;</span>;</span><br><span class="line">    <span class="comment">// 替换 open 函数</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(openPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">pathnameptr, flag</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> pathname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(pathnameptr);</span><br><span class="line">        <span class="keyword">var</span> realFd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">        <span class="comment">// pathname 中含有 &quot;maps&quot;，此时返回 fakePath 的 fd</span></span><br><span class="line">        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;maps&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> filename = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(fakePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">open</span>(filename, flag);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> fd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">  &#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(bypass)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">call_sub_afc</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> offset = <span class="number">0x0AFC</span></span><br><span class="line">    <span class="keyword">var</span> base = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libezandroid.so&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> addr = base.<span class="title function_">add</span>(offset)</span><br><span class="line">    <span class="keyword">var</span> func  = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(addr, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">	<span class="comment">// 密文</span></span><br><span class="line">    <span class="keyword">var</span> arg0 = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">writeByteArray</span>(arg0, [<span class="number">0x2b</span>, <span class="number">0xc8</span>, <span class="number">0x20</span>, <span class="number">0x8b</span>, <span class="number">0x5c</span>, <span class="number">0x0d</span>, <span class="number">0xa7</span>, <span class="number">0x9b</span>, <span class="number">0x2a</span>, <span class="number">0x51</span>, <span class="number">0x3a</span>, <span class="number">0xd2</span>, <span class="number">0x71</span>, <span class="number">0x71</span>, <span class="number">0xca</span>, <span class="number">0x50</span>]);</span><br><span class="line">    <span class="comment">// 密钥</span></span><br><span class="line">    <span class="keyword">var</span> arg2 = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">writeByteArray</span>(arg2, [<span class="number">0x52</span>, <span class="number">0x65</span>, <span class="number">0x5f</span>, <span class="number">0x31</span>, <span class="number">0x73</span>, <span class="number">0x5f</span>, <span class="number">0x65</span>, <span class="number">0x61</span>, <span class="number">0x53</span>, <span class="number">0x79</span>, <span class="number">0x31</span>, <span class="number">0x32</span>, <span class="number">0x33</span>, <span class="number">0x34</span>, <span class="number">0x35</span>, <span class="number">0x36</span>]);</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> env = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>()</span><br><span class="line">        <span class="comment">// 主动调用 sub_afc</span></span><br><span class="line">        <span class="title function_">func</span>(<span class="title function_">ptr</span>(arg0), <span class="number">0x10</span>, <span class="title function_">ptr</span>(arg2))</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_afc</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> offset = <span class="number">0x0AFC</span></span><br><span class="line">    <span class="keyword">var</span> base = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libezandroid.so&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> func_addr = base.<span class="title function_">add</span>(offset)</span><br><span class="line">    <span class="keyword">var</span> arg0 = <span class="literal">null</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title function_">ptr</span>(func_addr), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            arg0 = args[<span class="number">0</span>]</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;enter&quot;</span>)</span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="title function_">ptr</span>(arg0), &#123;</span><br><span class="line">                    <span class="attr">offset</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">length</span>: <span class="number">64</span>,</span><br><span class="line">                    <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">                    <span class="attr">ansi</span>: <span class="literal">true</span>,</span><br><span class="line">                &#125;)) </span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">ret</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;return&quot;</span>)</span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="title function_">ptr</span>(arg0), &#123;</span><br><span class="line">                    <span class="attr">offset</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">length</span>: <span class="number">64</span>,</span><br><span class="line">                    <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">                    <span class="attr">ansi</span>: <span class="literal">true</span>,</span><br><span class="line">                &#125;)) </span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Step2-1"><a href="#Step2-1" class="headerlink" title="Step2"></a>Step2</h4><p>&emsp;与正常的AES加密结果不同，猜测更换了S盒。表面上没改，实际用的时候改了，真狗啊。下面是抓取S盒的脚本：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">bypass</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> openPtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> open = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">    <span class="comment">// 事先准备好</span></span><br><span class="line">    <span class="keyword">var</span> fakePath = <span class="string">&quot;/data/local/tmp/ezandroid.maps&quot;</span>;</span><br><span class="line">    <span class="comment">// 替换 open 函数</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(openPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">pathnameptr, flag</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> pathname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(pathnameptr);</span><br><span class="line">        <span class="keyword">var</span> realFd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">        <span class="comment">// pathname 中含有 &quot;maps&quot;，此时返回 fakePath 的 fd</span></span><br><span class="line">        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;maps&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> filename = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(fakePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">open</span>(filename, flag);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> fd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">  &#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(bypass)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_2fb4</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> offset = <span class="number">0x2fb4</span></span><br><span class="line">    <span class="keyword">var</span> base = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libezandroid.so&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> func_addr = base.<span class="title function_">add</span>(offset)</span><br><span class="line">    <span class="keyword">var</span> data = base.<span class="title function_">add</span>(<span class="number">0xa000</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title function_">ptr</span>(func_addr), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">ret</span>)&#123;</span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="title function_">ptr</span>(data), &#123;</span><br><span class="line">                    <span class="attr">offset</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">length</span>: <span class="number">256</span>,</span><br><span class="line">                    <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">                    <span class="attr">ansi</span>: <span class="literal">true</span>,</span><br><span class="line">                &#125;)) </span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;抓到的S盒为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[0x29, 0x40, 0x57, 0x6e, 0x85, 0x9c, 0xb3, 0xca, 0xe1, 0xf8, 0x0f, 0x26, 0x3d, 0x54, 0x6b, 0x82,0x99, 0xb0, 0xc7, 0xde, 0xf5, 0x0c, 0x23, 0x3a, 0x51, 0x68, 0x7f, 0x96, 0xad, 0xc4, 0xdb, 0xf2,0x09, 0x20, 0x37, 0x4e, 0x65, 0x7c, 0x93, 0xaa, 0xc1, 0xd8, 0xef, 0x06, 0x1d, 0x34, 0x4b, 0x62,0x79, 0x90, 0xa7, 0xbe, 0xd5, 0xec, 0x03, 0x1a, 0x31, 0x48, 0x5f, 0x76, 0x8d, 0xa4, 0xbb, 0xd2,0xe9, 0x00, 0x17, 0x2e, 0x45, 0x5c, 0x73, 0x8a, 0xa1, 0xb8, 0xcf, 0xe6, 0xfd, 0x14, 0x2b, 0x42,0x59, 0x70, 0x87, 0x9e, 0xb5, 0xcc, 0xe3, 0xfa, 0x11, 0x28, 0x3f, 0x56, 0x6d, 0x84, 0x9b, 0xb2,0xc9, 0xe0, 0xf7, 0x0e, 0x25, 0x3c, 0x53, 0x6a, 0x81, 0x98, 0xaf, 0xc6, 0xdd, 0xf4, 0x0b, 0x22,0x39, 0x50, 0x67, 0x7e, 0x95, 0xac, 0xc3, 0xda, 0xf1, 0x08, 0x1f, 0x36, 0x4d, 0x64, 0x7b, 0x92,0xa9, 0xc0, 0xd7, 0xee, 0x05, 0x1c, 0x33, 0x4a, 0x61, 0x78, 0x8f, 0xa6, 0xbd, 0xd4, 0xeb, 0x02,0x19, 0x30, 0x47, 0x5e, 0x75, 0x8c, 0xa3, 0xba, 0xd1, 0xe8, 0xff, 0x16, 0x2d, 0x44, 0x5b, 0x72,0x89, 0xa0, 0xb7, 0xce, 0xe5, 0xfc, 0x13, 0x2a, 0x41, 0x58, 0x6f, 0x86, 0x9d, 0xb4, 0xcb, 0xe2,0xf9, 0x10, 0x27, 0x3e, 0x55, 0x6c, 0x83, 0x9a, 0xb1, 0xc8, 0xdf, 0xf6, 0x0d, 0x24, 0x3b, 0x52,0x69, 0x80, 0x97, 0xae, 0xc5, 0xdc, 0xf3, 0x0a, 0x21, 0x38, 0x4f, 0x66, 0x7d, 0x94, 0xab, 0xc2,0xd9, 0xf0, 0x07, 0x1e, 0x35, 0x4c, 0x63, 0x7a, 0x91, 0xa8, 0xbf, 0xd6, 0xed, 0x04, 0x1b, 0x32,0x49, 0x60, 0x77, 0x8e, 0xa5, 0xbc, 0xd3, 0xea, 0x01, 0x18, 0x2f, 0x46, 0x5d, 0x74, 0x8b, 0xa2,0xb9, 0xd0, 0xe7, 0xfe, 0x15, 0x2c, 0x43, 0x5a, 0x71, 0x88, 0x9f, 0xb6, 0xcd, 0xe4, 0xfb, 0x12]</span><br></pre></td></tr></table></figure>
<p>&emsp;S盒求逆，得到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[65, 232, 143, 54, 221, 132, 43, 210, 121, 32, 199, 110, 21, 188, 99, 10, 177, 88, 255, 166, 77, 244, 155, 66, 233, 144, 55, 222, 133, 44, 211, 122, 33, 200, 111, 22, 189, 100, 11, 178, 89, 0, 167, 78, 245, 156, 67, 234, 145, 56, 223, 134, 45, 212, 123, 34, 201, 112, 23, 190, 101, 12, 179, 90, 1, 168, 79, 246, 157, 68, 235, 146, 57, 224, 135, 46, 213, 124, 35, 202, 113, 24, 191, 102, 13, 180, 91, 2, 169, 80, 247, 158, 69, 236, 147, 58, 225, 136, 47, 214, 125, 36, 203, 114, 25, 192, 103, 14, 181, 92, 3, 170, 81, 248, 159, 70, 237, 148, 59, 226, 137, 48, 215, 126, 37, 204, 115, 26, 193, 104, 15, 182, 93, 4, 171, 82, 249, 160, 71, 238, 149, 60, 227, 138, 49, 216, 127, 38, 205, 116, 27, 194, 105, 16, 183, 94, 5, 172, 83, 250, 161, 72, 239, 150, 61, 228, 139, 50, 217, 128, 39, 206, 117, 28, 195, 106, 17, 184, 95, 6, 173, 84, 251, 162, 73, 240, 151, 62, 229, 140, 51, 218, 129, 40, 207, 118, 29, 196, 107, 18, 185, 96, 7, 174, 85, 252, 163, 74, 241, 152, 63, 230, 141, 52, 219, 130, 41, 208, 119, 30, 197, 108, 19, 186, 97, 8, 175, 86, 253, 164, 75, 242, 153, 64, 231, 142, 53, 220, 131, 42, 209, 120, 31, 198, 109, 20, 187, 98, 9, 176, 87, 254, 165, 76, 243, 154]</span><br></pre></td></tr></table></figure>
<p>&emsp;根据<a target="_blank" rel="noopener" href="https://github.com/lmshao/AES">项目</a>，快乐得到：<code>_eZ_Rc4_@nd_AES!</code>。最后flag：<code>Re_1s_eaSy_eZ_Rc4_@nd_AES!</code>。</p>
<h2 id="0x01-ez-v1deo"><a href="#0x01-ez-v1deo" class="headerlink" title="0x01 ez_v1deo"></a>0x01 ez_v1deo</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">视频好像被L1near弄坏掉了</span><br></pre></td></tr></table></figure>
<p>&emsp;7s的avi视频，92.8MB，感觉离谱，肯定藏了什么东西。根据<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/162679898">AVI格式</a>看了看，感觉没啥问题，单纯就是觉得strl块（存放avi数据流）太大了，92MB。但是看了一下，<a target="_blank" rel="noopener" href="https://wooyun.js.org/drops/CTF%E4%B8%AD%E6%AF%94%E8%BE%83%E5%A5%BD%E7%8E%A9%E7%9A%84stego.html">链接</a>说avi文件体积本来就很大，所以应该也没啥问题，还推荐了MSU VideoStego工具来分析avi文件。</p>
<p>&emsp;详细的avi格式：<a target="_blank" rel="noopener" href="https://sp4n9x.github.io/2020/12/30/AVI%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90/">链接</a>。</p>
<p>&emsp;MSU VideoStego工具解压缩需要密码，试了几个说不行。最后使用binwalk提取出了sit类型的文件。但是感觉方向错了，看wp。</p>
<h3 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h3><p>（1）首先使用ffmpeg将avi转为帧格式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i flag.avi -r 20 ./images/image-%3d.png</span><br></pre></td></tr></table></figure>
<p>（2）使用lsb提取。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">144</span>):</span><br><span class="line">    img = Image.<span class="built_in">open</span>(<span class="string">&quot;C:\\Users\\23957\\Desktop\\images\\image-&#123;:0&gt;3d&#125;.png&quot;</span>.<span class="built_in">format</span>(n))</span><br><span class="line">    img = img.convert(<span class="string">&quot;RGB&quot;</span>)</span><br><span class="line">    width, height = img.size</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, width):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, height):</span><br><span class="line">            tmp = img.getpixel((i,j))</span><br><span class="line">            <span class="comment"># 最后一位为 0，则为 0 </span></span><br><span class="line">            <span class="keyword">if</span> tmp[<span class="number">1</span>] &amp; <span class="number">0x1</span> == <span class="number">0</span>:</span><br><span class="line">                img.putpixel((i,j), <span class="number">0</span>)</span><br><span class="line">            <span class="comment"># 最后一位为 1，则为 255 </span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                img.putpixel((i,j), <span class="number">255</span>)</span><br><span class="line">    img.save(<span class="string">&quot;C:\\Users\\23957\\Desktop\\images\\output\\image-&#123;:0&gt;3d&#125;.png&quot;</span>.<span class="built_in">format</span>(n))</span><br></pre></td></tr></table></figure>
<p>&emsp;最终得到flag：<code>WMCTF&#123;5b658ab9-946c-3869-fc21-6ad99b3bc714&#125;</code>。虽然和逆向没太大关系，但是学到了。</p>
<hr>
<p>&emsp;发现我好像把题目记录错了，日了狗了，以下是更改版本。</p>
<h2 id="0x02-gohunt"><a href="#0x02-gohunt" class="headerlink" title="0x02 gohunt"></a>0x02 gohunt</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmctf&#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;一个flag.jpg，一个gohunt。jpg扫出来数据为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">YMQHsYFQu7kkTqu3Xmt1ruYUDLU8uaMoPpsfjqYF4TQMMKtw5KF7cpWrkWpk3</span><br></pre></td></tr></table></figure>
<p>&emsp;跑一跑Gohunt，猜测逻辑是有一个original.jpg，输入flag，之后输出了flag.jpg。</p>
<h3 id="Gohunt分析"><a href="#Gohunt分析" class="headerlink" title="Gohunt分析"></a>Gohunt分析</h3><p>&emsp;发现其中导入了很多github相关函数，那么，直接binaryAI处理一波（没啥卵用），Go_parser报错，显示找不到Moduledata，看来是作者自己删了。</p>
<p>&emsp;重点是分析main_main函数。对于<code>__encoding_base64_Encoding__DecodeString</code>函数，得到其转换码表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">decodeMap = [<span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;.&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\x0e&#x27;</span>, <span class="string">b&#x27;\x17&#x27;</span>, <span class="string">b&#x27;\x1b&#x27;</span>, <span class="string">b&#x27;0&#x27;</span>, <span class="string">b&#x27;)&#x27;</span>, <span class="string">b&#x27;\x0f&#x27;</span>, <span class="string">b&#x27;$&#x27;</span>, <span class="string">b&#x27;\x13&#x27;</span>, <span class="string">b&#x27;=&#x27;</span>, <span class="string">b&#x27;-&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;!&#x27;</span>, <span class="string">b&#x27;*&#x27;</span>, <span class="string">b&#x27;\x18&#x27;</span>, <span class="string">b&#x27;5&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>, <span class="string">b&#x27;\x1a&#x27;</span>, <span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;?&#x27;</span>, <span class="string">b&#x27;\x04&#x27;</span>, <span class="string">b&#x27;%&#x27;</span>, <span class="string">b&#x27;8&#x27;</span>, <span class="string">b&#x27;6&#x27;</span>, <span class="string">b&#x27;\x1e&#x27;</span>, <span class="string">b&#x27; &#x27;</span>, <span class="string">b&#x27;\x00&#x27;</span>, <span class="string">b&#x27;4&#x27;</span>, <span class="string">b&#x27;,&#x27;</span>, <span class="string">b&#x27;\x02&#x27;</span>, <span class="string">b&#x27;\x0b&#x27;</span>, <span class="string">b&#x27;\x1c&#x27;</span>, <span class="string">b&#x27;\n&#x27;</span>, <span class="string">b&#x27;&amp;&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>, <span class="string">b&#x27;;&#x27;</span>, <span class="string">b&#x27;\x06&#x27;</span>, <span class="string">b&#x27;9&#x27;</span>, <span class="string">b&#x27;\t&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;+&#x27;</span>, <span class="string">b&#x27;(&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>, <span class="string">b&#x27;\x14&#x27;</span>, <span class="string">b&#x27;\x0c&#x27;</span>, <span class="string">b&#x27;\x1d&#x27;</span>, <span class="string">b&#x27;\x11&#x27;</span>, <span class="string">b&#x27;7&#x27;</span>, <span class="string">b&#x27;\x08&#x27;</span>, <span class="string">b&quot;&#x27;&quot;</span>, <span class="string">b&#x27;\x01&#x27;</span>, <span class="string">b&#x27;\x15&#x27;</span>, <span class="string">b&#x27;\x07&#x27;</span>, <span class="string">b&#x27;\x10&#x27;</span>, <span class="string">b&#x27;\r&#x27;</span>, <span class="string">b&#x27;\x19&#x27;</span>, <span class="string">b&#x27;&quot;&#x27;</span>, <span class="string">b&#x27;#&#x27;</span>, <span class="string">b&#x27;&lt;&#x27;</span>, <span class="string">b&#x27;&gt;&#x27;</span>, <span class="string">b&#x27;\x12&#x27;</span>, <span class="string">b&#x27;\x16&#x27;</span>, <span class="string">b&#x27;\x1f&#x27;</span>, <span class="string">b&#x27;\x03&#x27;</span>, <span class="string">b&#x27;\x05&#x27;</span>, <span class="string">b&#x27;/&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;\xff&#x27;</span>, <span class="string">b&#x27;=&#x27;</span>, <span class="string">b&#x27;\x00&#x27;</span>, <span class="string">b&#x27;\x00&#x27;</span>, <span class="string">b&#x27;\x00&#x27;</span>]</span><br><span class="line">base64Key = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> ind, d <span class="keyword">in</span> <span class="built_in">enumerate</span>(decodeMap):</span><br><span class="line">    <span class="keyword">if</span> d != <span class="string">b&#x27;\xff&#x27;</span> <span class="keyword">and</span> ind &lt;= <span class="number">255</span>:</span><br><span class="line">        base64Key[<span class="built_in">int</span>.from_bytes(d, byteorder=<span class="string">&#x27;little&#x27;</span>, signed=<span class="literal">True</span>)] = <span class="built_in">chr</span>(ind)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">    <span class="built_in">print</span>(base64Key[i], end = <span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># NkQxHyXmiZTReo05ngu7dlv1BpE2SfLwM@qr6IUjb4AaP9+z3cDVOCKhJYFWs8tG</span></span><br></pre></td></tr></table></figure>
<hr>
<p>&emsp;时间过了好久好久，已经到 2024-02-29，我又开启了 CTF 的刷题旅程。</p>
<p>Step1：发现函数 <code>__github_com_yeqown_go_qrcode_v2_QRCode__Save(*&amp;old[56LL], __PAIR128__(v417.value, v185.len))</code>，动态调试查看最终保存的数据是哪个参数。最终发现 <code>v.len</code> 保存要输出的数据。</p>
<p><img src="/images/wmctf-2023/image-20240229152023582.png" alt="image-20240229152023582" style="zoom:67%;" /></p>
<p>Step2：对 <code>v.len</code> 的写操作进行分析，分析不出来啥。已知题目中使用的项目为 <a target="_blank" rel="noopener" href="https://github.com/yeqown/go-qrcode">link1</a>，因此打算先做一个 demo，然后对 demo 进行分析。通过对 demo 和 gohunt 的文件进行相似性查看，找到最初的点（也就是把加密后的 flag 使用 QRcode 这个项目进行处理的最开始的点）。</p>
<p>&emsp;在此补充一个知识点，这是 go 协程的逆向对比。</p>
<p><img src="/images/wmctf-2023/image-20240302104912346.png" alt="image-20240302104912346" style="zoom:67%;" /></p>
<p><img src="/images/wmctf-2023/image-20240302105005779.png" alt="image-20240302105005779" style="zoom:67%;" /></p>
<p>Step3: 最终，可以分析出程序的大致逻辑如下。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/yeqown/go-qrcode/v2&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/yeqown/go-qrcode/writer/standard&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// begin</span></span><br><span class="line">    Print(<span class="string">&quot;Please enter a flag:&quot;</span>)</span><br><span class="line">    data = input()</span><br><span class="line">    encrypted_data = encrypt(data)</span><br><span class="line">    <span class="comment">// end</span></span><br><span class="line">	qrc, err := qrcode.New(encrypted_data)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	w0, err := standard.New(<span class="string">&quot;./repository_qrcode.png&quot;</span>,</span><br><span class="line">		standard.WithHalftone(<span class="string">&quot;./test.jpeg&quot;</span>),</span><br><span class="line">		standard.WithQRWidth(<span class="number">21</span>),</span><br><span class="line">	)</span><br><span class="line">	handleErr(err)</span><br><span class="line">	err = qrc.Save(w0)</span><br><span class="line">	handleErr(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleErr</span><span class="params">(err <span class="type">error</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Step4: 分析 Step3 中 encrypt 函数的逻辑。并可以写脚本，得到 flag：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1. 使用 xxtea 算法加密输入，v = 输入，k = FMT2ZCEHS6pcfD2R，输出为 out_1。</span><br><span class="line">23 -&gt; 0x977E50ED 0xE4EAF734</span><br><span class="line">2. 有字符串 s = NPWrpd1CEJH2QcJ3，输出 out_2 = s[i % 0x10] ^ out_1[i]。</span><br><span class="line">23 -&gt; 0xE52900A3 0xA7DB9344 -&gt; (这里需要一次反转) 0xA30029E54493DBA7</span><br><span class="line">3. 循环。ss = &quot;nY7TwcE41bzWvMQZXa8fyeprJoBdmhsu9DqVgxRPtFLKN65UH2CikG3SAj&quot;，商 = 被除数 % 除数，余数 = 被除数 % 除数，除数一直为 0x3A，之后被除数 = 商。result.append(ss[余数])。</span><br><span class="line">23 -&gt; KqzAHV4n8Zd</span><br><span class="line">4. 反转，得到结果。</span><br><span class="line">23 -&gt; dZ8n4VHAzqK</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    inp = <span class="string">&quot;YMQHsYFQu7kkTqu3Xmt1ruYUDLU8uaMoPpsfjqYF4TQMMKtw5KF7cpWrkWpk3&quot;</span></span><br><span class="line">    </span><br><span class="line">    byte_arr = <span class="string">&quot;nY7TwcE41bzWvMQZXa8fyeprJoBdmhsu9DqVgxRPtFLKN65UH2CikG3SAj&quot;</span></span><br><span class="line">    tmp = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> inp:</span><br><span class="line">        tmp *= <span class="number">0x3A</span></span><br><span class="line">        ind = byte_arr.index(c)</span><br><span class="line">        tmp += ind</span><br><span class="line"></span><br><span class="line">    byte_string = binascii.unhexlify(<span class="built_in">hex</span>(tmp)[<span class="number">2</span>:])</span><br><span class="line">    int_list = <span class="built_in">list</span>(byte_string)</span><br><span class="line"></span><br><span class="line">    byte_arr_2 = <span class="string">&quot;NPWrpd1CEJH2QcJ3&quot;</span></span><br><span class="line">    out_1 = []</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> l <span class="keyword">in</span> int_list:</span><br><span class="line">        val = l ^ <span class="built_in">ord</span>(byte_arr_2[i%<span class="number">0x10</span>])</span><br><span class="line">        out_1.append(val)</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    p = <span class="string">&quot;&quot;</span></span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> out_1:</span><br><span class="line">        <span class="keyword">if</span> (j % <span class="number">4</span> == <span class="number">0</span>):</span><br><span class="line">            result.append(p)</span><br><span class="line">            p = <span class="string">&quot;&quot;</span></span><br><span class="line">        p = <span class="built_in">hex</span>(i)[<span class="number">2</span>:].zfill(<span class="number">2</span>) + p   </span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">    result.append(p)</span><br><span class="line"></span><br><span class="line">    result = result[<span class="number">1</span>:]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&#123;&quot;</span>, end = <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;0x&#x27;</span>+r, end = <span class="string">&quot;, &quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &#123;0x98b97795, 0x0c96d2e8, 0x80c6ec1b, 0x584a00f6, 0xb18aa61e, 0xb378425b, 0x7249b4fe, 0xc53ac4d1, 0xff9ae037, 0x0ccc6250, 0x1c6e0290, &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELTA 0x9e3779b9  </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MX (((z&gt;&gt;5^y<span class="string">&lt;&lt;2) + (y&gt;</span>&gt;3^z&lt;&lt;4)) ^ ((sum^y) + (key[(p&amp;3)^e] ^ z)))  </span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">btea</span><span class="params">(<span class="type">uint32_t</span> *v, <span class="type">int</span> n, <span class="type">uint32_t</span> <span class="type">const</span> key[<span class="number">4</span>])</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="type">uint32_t</span> y, z, sum;  </span><br><span class="line">    <span class="type">uint32_t</span> tmp = n;</span><br><span class="line">    <span class="type">unsigned</span> p, rounds, e;  </span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">1</span>)</span><br><span class="line">    &#123;  </span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span>/n;  </span><br><span class="line">        sum = <span class="number">0</span>;  </span><br><span class="line">        z = v[n<span class="number">-1</span>];  </span><br><span class="line">        <span class="comment">// z = tmp;</span></span><br><span class="line">        <span class="keyword">do</span>  </span><br><span class="line">        &#123;  </span><br><span class="line">            sum += DELTA;  </span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;  </span><br><span class="line">            <span class="keyword">for</span> (p=<span class="number">0</span>; p&lt;n<span class="number">-1</span>; p++)  </span><br><span class="line">            &#123;  </span><br><span class="line">                y = v[p+<span class="number">1</span>];  </span><br><span class="line">                z = v[p] += MX;   </span><br><span class="line">            &#125;  </span><br><span class="line">            y = v[<span class="number">0</span>];  </span><br><span class="line">            z = v[n<span class="number">-1</span>] += MX;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">while</span> (--rounds);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n &lt; <span class="number">-1</span>)</span><br><span class="line">    &#123;  </span><br><span class="line">        n = -n;  </span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span>/n;  </span><br><span class="line">        sum = rounds*DELTA;  </span><br><span class="line">        y = v[<span class="number">0</span>];  </span><br><span class="line">        <span class="keyword">do</span>  </span><br><span class="line">        &#123;  </span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;  </span><br><span class="line">            <span class="keyword">for</span> (p=n<span class="number">-1</span>; p&gt;<span class="number">0</span>; p--)  </span><br><span class="line">            &#123;  </span><br><span class="line">                z = v[p<span class="number">-1</span>];  </span><br><span class="line">                y = v[p] -= MX;  </span><br><span class="line">            &#125;  </span><br><span class="line">            z = v[n<span class="number">-1</span>];  </span><br><span class="line">            y = v[<span class="number">0</span>] -= MX;  </span><br><span class="line">            sum -= DELTA;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">while</span> (--rounds);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="type">uint32_t</span> v[<span class="number">11</span>] = &#123;<span class="number">0x98b97795</span>, <span class="number">0x0c96d2e8</span>, <span class="number">0x80c6ec1b</span>, <span class="number">0x584a00f6</span>, <span class="number">0xb18aa61e</span>, <span class="number">0xb378425b</span>, <span class="number">0x7249b4fe</span>, <span class="number">0xc53ac4d1</span>, <span class="number">0xff9ae037</span>, <span class="number">0x0ccc6250</span>, <span class="number">0x1c6e0290</span>&#125;;</span><br><span class="line">    <span class="type">uint32_t</span> <span class="type">const</span> k[<span class="number">4</span>] = &#123;<span class="number">0x32544D46</span>,<span class="number">0x4845435A</span>,<span class="number">0x63703653</span>,<span class="number">0x52324466</span>&#125;;  </span><br><span class="line">    <span class="type">int</span> n = <span class="number">11</span>; </span><br><span class="line">    <span class="built_in">btea</span>(v, -n, k); </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; n; j += <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> number = v[j];</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> byte1 = (number &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> byte2 = (number &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> byte3 = (number &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> byte4 = number &amp; <span class="number">0xFF</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c%c%c%c&quot;</span>, byte4, byte3, byte2, byte1);        </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// wmctf&#123;YHNEBJx1WG0cKtZk8e2PNbxJa45WQF09&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="0x03-ios"><a href="#0x03-ios" class="headerlink" title="0x03 ios"></a>0x03 ios</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmctf&#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;发现是 IOS 的 IPA 文件，改为 zip 文件解压缩后，发现 IDA 的调试文件：</p>
<p><img src="/images/wmctf-2023/image-20240303131652109.png" alt="image-20240303131652109" style="zoom:67%;" /></p>
<p>&emsp;打开后发现是典型的 OLLVM 混淆：</p>
<p><img src="/images/wmctf-2023/image-20240303140623423.png" alt="image-20240303140623423" style="zoom:67%;" /></p>
<p>Step1: 使用 Binary Ninja 的去混淆脚本 llvm-deobfuscator 报错，分析发现是此脚本将程序入口定位到了 <code>0x10000a9a0</code>，且此函数并没有其他函数的入口。但是可以看到红框部分应该是主程序的入口，其地址是由参数控制的。</p>
<p><img src="/images/wmctf-2023/image-20240303200448117.png" alt="image-20240303200448117" style="zoom:67%;" /></p>
<p>&emsp;根据 <a target="_blank" rel="noopener" href="https://blog.csdn.net/shihuboke/article/details/73929514">link</a>，可以知道：IOS 程序会先执行 main 函数（也就是上图中的 <code>MEMORY[0x10000A9A0]</code>），main 函数内部会调用 UIApplicationMain 函数。如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]))</span><br></pre></td></tr></table></figure>
<p>&emsp;在 UIApplicationMain 中，会创建 UIApplication 对象与 UIApplication 的 delegate 对象（又叫做 AppDelegate，它会开启一个消息循环，并监听对应的系统事件）。当应用程序启动完成后，UIApplicationMain 会调用 application:didFinishLaunchingWithOptions 方法，在这个方法中，会创建窗口、设置视图控制器、配置数据模型。它标志着程序启动完成。</p>
<p>Step2: 查看 application:didFinishLaunchingWithOptions，并未发现什么有用的逻辑。</p>
<p><img src="/images/wmctf-2023/image-20240303213402576.png" alt="image-20240303213402576" style="zoom:67%;" /></p>
<p>Step3: 询问 GPT 后发现，IOS 程序的主逻辑大概有以下几个地方：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（1）View Controllers，主要就是 window.rootViewController。</span><br><span class="line">（2）Storyboards 和 XIBs。</span><br><span class="line">（3）AppDelegate 的其他方法，在 iOS 13 及以上为 SceneDelegate。</span><br><span class="line">（4）定时器、网络请求等。</span><br><span class="line">（5）第三方框架，例如 Firebase、Realm。</span><br></pre></td></tr></table></figure>
<p>&emsp;找到一个 ViewController handleButtonClick 函数，但是还是 OLLVM，所以打算手动修复一下 llvm-deobfuscator 的脚本，猜测：</p>
<p>（1）脚本不 work 的原因可能是函数一开始是有参数的。但是经过调研，了解插件的运行原理之后，发现是自己插件使用的有问题。</p>
<p>（2）继续调研后发现，即使正常调用脚本，也会出现错误，我真是服了，继续调研。</p>
<p>（3）我用的 binary ninja 3.5 的版本，很多 API 更新了。经过调研，应该就是这个问题。</p>
<p>Step4: 本来想将 x64 的脚本改成 ARM 的，但是发现很多地方都不适配，所以想自己写一个 binary ninja 的脚本。首先，找到此题目中 OLLVM 的规律。</p>
<p><img src="/images/wmctf-2023/image-20240308195917702.png" alt="image-20240308195917702" style="zoom:67%;" /></p>
<p>规律 1：看黄框，每一个函数的开头都定义了一些变量，这些变量供下面的 cmp 使用。</p>
<p>规律 2：看红框，之后紧接着好多 cmp 指令，用于 dispatch。</p>
<p>规律 3：看蓝框，紧接着有好多实际的逻辑块，最后是 return 块。</p>
<p>&emsp;那么，我们可以设计如下去 OLLVM 的算法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 根据红框，确定要关注的变量，例如这里的 w11。</span><br><span class="line">2. 计算黄框中 w11 的值，作为起始点。</span><br><span class="line">3. 根据红框中其他的 cmp 变量，使用黄框计算出这些变量的值，并创建映射表，即 w11 = ?，应跳转到哪些实际块（蓝框与 return）。</span><br><span class="line">4. 构建块之间的顺序。</span><br></pre></td></tr></table></figure>
<p>&emsp;但是我看其他函数好多还不是这个逻辑，头疼，打算用符号执行了。具体可以见 <a target="_blank" rel="noopener" href="http://s0rry.cn/posts/ollvm/">link2</a>。</p>
<p>Step5: 符号执行可以使用 angr 或者 unicorn 工具。使用 angr 去 OLLVM 时，见 useful-scripts。<code>Angr 去除 OLLVM 时，是直接以块为起点，模拟执行来找到下一个块的，如果在这个块之前还产生了某个事件，这个事件对这个块的执行流程产生了影响的，那么本次模拟处理的结果就是不准确的。</code>相比而言，unicorn 在去除花指令或去除 OLLVM 方面更有优势，这是因为：<code>unicorn 相当于一个虚拟 cpu，所以处理的细微程度高于 angr 的代码块级，修复出来的代码精度更高。</code></p>
<p>&emsp;与 angr 类似，unicorn 写去 OLLVM 脚本的思路也是<code>通过代码的CFG图，分析出代码块之间的关系，然后模拟执行每个代码块</code>。但是 fallwind 的脚本是针对 ELF 文件的，我也懒得该脚本了。直接看 wp。wm 给出的 wp 是使用 iPhone 进行的 frida-hook，与我的解题思路不同。</p>
<p>Step6：wp 的复现，<a target="_blank" rel="noopener" href="https://github.com/wm-team/WMCTF-2023/blob/main/WMCTF%202023_OFFICAL_WRITE-UP_CN.pdf">wp1</a>，<a target="_blank" rel="noopener" href="https://www.cnblogs.com/gaoyucan/p/17646186.html">wp2</a>。在 wp1 中，我一直不能使自己的 ipad 越狱，会出现以下报错，且我是 intel 的处理器（网上说只有 AMD 的处理器才会报这种错误）。</p>
<p><img src="/images/wmctf-2023/image-20240309182930221.png" alt="image-20240309182930221" style="zoom:67%;" /></p>
<p>&emsp;可以采取上题 ezandroid 中划分 block 的方法，对 handleButtonClick 函数进行分析。最终用 unicorn 脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> unicorn.arm64_const <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_function_blocks</span>(<span class="params">func_ea</span>):</span><br><span class="line">    func = idaapi.get_func(func_ea)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> func:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    flowchart = idaapi.FlowChart(func)</span><br><span class="line">    blocks = [b <span class="keyword">for</span> b <span class="keyword">in</span> flowchart]</span><br><span class="line">    <span class="keyword">assert</span> blocks <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> blocks</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_instructions_in_block</span>(<span class="params">start_addr, end_addr</span>):</span><br><span class="line">    instructions = []</span><br><span class="line">    <span class="keyword">for</span> head <span class="keyword">in</span> idautils.Heads(start_addr, end_addr):</span><br><span class="line">        instructions.append((head, idc.GetDisasm(head)))</span><br><span class="line">    <span class="keyword">return</span> instructions</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">divide_block_to_different_type</span>(<span class="params">blocks</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_entry_blocks</span>(<span class="params">blocks</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; 入度为 0 &quot;&quot;&quot;</span></span><br><span class="line">        entry_blocks = []</span><br><span class="line">        <span class="keyword">for</span> block <span class="keyword">in</span> blocks:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">list</span>(block.preds()) == []:</span><br><span class="line">                entry_blocks.append(block)</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(entry_blocks) == <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> entry_blocks</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_exit_blocks</span>(<span class="params">blocks</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; 出度为 0 &quot;&quot;&quot;</span></span><br><span class="line">        exit_blocks = []</span><br><span class="line">        <span class="keyword">for</span> block <span class="keyword">in</span> blocks:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">list</span>(block.succs()) == []:</span><br><span class="line">                exit_blocks.append(block)</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(exit_blocks) == <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> exit_blocks</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_dispatch_blocks</span>(<span class="params">blocks, n</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; 入度为 n，出度为 2 &quot;&quot;&quot;</span></span><br><span class="line">        dispatch_blocks = []</span><br><span class="line">        <span class="keyword">for</span> block <span class="keyword">in</span> blocks:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">list</span>(block.preds())) &gt;= n <span class="keyword">and</span> <span class="built_in">len</span>(<span class="built_in">list</span>(block.succs())) == <span class="number">2</span>:</span><br><span class="line">                dispatch_blocks.append(block)</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(dispatch_blocks) &gt;= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> dispatch_blocks</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_if_blocks</span>(<span class="params">blocks</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; 入度为 1，出度为 2 &quot;&quot;&quot;</span></span><br><span class="line">        if_blocks = []</span><br><span class="line">        <span class="keyword">for</span> block <span class="keyword">in</span> blocks:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">list</span>(block.preds())) == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(<span class="built_in">list</span>(block.succs())) == <span class="number">2</span>:</span><br><span class="line">                if_blocks.append(block)</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(if_blocks) &gt;= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> if_blocks</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_real_blocks</span>(<span class="params">blocks, n_instruction</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        入度为 1，出度为 1。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        real_blocks = []</span><br><span class="line">        <span class="keyword">for</span> block <span class="keyword">in</span> blocks:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">list</span>(block.preds())) == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(<span class="built_in">list</span>(block.succs())) == <span class="number">1</span>:</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 测试其后继是否为 dispatch 块</span></span><br><span class="line">                succ = <span class="built_in">list</span>(block.succs())[<span class="number">0</span>]</span><br><span class="line">                assumption_1 = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">list</span>(succ.preds())) &gt;= <span class="number">4</span> <span class="keyword">and</span> <span class="built_in">len</span>(<span class="built_in">list</span>(succ.succs())) == <span class="number">2</span>:</span><br><span class="line">                    <span class="keyword">pass</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;test&quot;</span>, <span class="built_in">hex</span>(block.start_ea))</span><br><span class="line">                    assumption_1 = <span class="literal">False</span></span><br><span class="line">                <span class="comment"># assert assumption_1 == True</span></span><br><span class="line">                </span><br><span class="line">                real_blocks.append(block)</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(real_blocks) &gt;= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> real_blocks</span><br><span class="line"></span><br><span class="line">    ret = &#123;&#125;</span><br><span class="line">    <span class="comment"># ----------------------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment"># 不同类型的块</span></span><br><span class="line">    info = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> blocks:</span><br><span class="line">        preds = <span class="built_in">len</span>(<span class="built_in">list</span>(b.preds()))</span><br><span class="line">        succs = <span class="built_in">len</span>(<span class="built_in">list</span>(b.succs()))</span><br><span class="line">        key = <span class="built_in">str</span>(preds) + <span class="string">&quot;-&quot;</span> + <span class="built_in">str</span>(succs)</span><br><span class="line">        info[key].append(b)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Block types:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> info.keys():</span><br><span class="line">        [preds, succs] = k.split(<span class="string">&quot;-&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] preds:&#123;:&lt;2&#125; | succs:&#123;:&lt;2&#125; | num:&#123;:&lt;2&#125;&quot;</span>.<span class="built_in">format</span>(preds, succs, <span class="built_in">len</span>(info[k])))</span><br><span class="line">    <span class="comment"># ----------------------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment"># 函数的入口块和出口块</span></span><br><span class="line">    entry_block = find_entry_blocks(blocks)</span><br><span class="line">    exit_block = find_exit_blocks(blocks)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[*] Entry blocks:&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[+] Start: %s, End: %s&#x27;</span> % (<span class="built_in">hex</span>(entry_block[<span class="number">0</span>].start_ea), <span class="built_in">hex</span>(entry_block[<span class="number">0</span>].end_ea)))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[*] Exit blocks:&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[+] Start: %s, End: %s&#x27;</span> % (<span class="built_in">hex</span>(exit_block[<span class="number">0</span>].start_ea), <span class="built_in">hex</span>(exit_block[<span class="number">0</span>].end_ea)))</span><br><span class="line">    <span class="comment"># ----------------------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment"># 函数的 dispatch 块</span></span><br><span class="line">    n = <span class="number">4</span></span><br><span class="line">    dispatch_blocks = find_dispatch_blocks(blocks, n)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Dispatch blocks:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> dispatch_blocks:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[+] Start: %s, End: %s&#x27;</span> % (<span class="built_in">hex</span>(b.start_ea), <span class="built_in">hex</span>(b.end_ea)))</span><br><span class="line">    <span class="comment"># ----------------------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment"># 函数的 if 块</span></span><br><span class="line">    if_blocks = find_if_blocks(blocks)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] If blocks:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> if_blocks:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[+] Start: %s, End: %s&#x27;</span> % (<span class="built_in">hex</span>(b.start_ea), <span class="built_in">hex</span>(b.end_ea)))</span><br><span class="line">    <span class="comment"># ----------------------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment"># 函数的真实逻辑块与小块（指令 &lt;= 3）</span></span><br><span class="line">    n_instruction = <span class="number">3</span></span><br><span class="line">    real_blocks = find_real_blocks(blocks, n_instruction)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Real blocks:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> real_blocks:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[+] Start: %s, End: %s&#x27;</span> % (<span class="built_in">hex</span>(b.start_ea), <span class="built_in">hex</span>(b.end_ea)))</span><br><span class="line">    <span class="comment"># ----------------------------------------------------------------------------------------------</span></span><br><span class="line">    ret[<span class="string">&#x27;entry_block&#x27;</span>] = entry_block</span><br><span class="line">    ret[<span class="string">&#x27;exit_block&#x27;</span>] = exit_block</span><br><span class="line">    ret[<span class="string">&#x27;dispatch_blocks&#x27;</span>] = dispatch_blocks</span><br><span class="line">    ret[<span class="string">&#x27;if_blocks&#x27;</span>] = if_blocks</span><br><span class="line">    ret[<span class="string">&#x27;real_blocks&#x27;</span>] = real_blocks</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_data</span>(<span class="params">start, end</span>):</span><br><span class="line">    <span class="keyword">return</span> ida_bytes.get_bytes(start, end - start)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_data</span>(<span class="params">start, data</span>):</span><br><span class="line">    ida_bytes.patch_bytes(start, data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unicorn_exec</span>(<span class="params">blocks</span>):</span><br><span class="line">    hook_seq = []</span><br><span class="line">    main_blocks = blocks[<span class="string">&#x27;entry_block&#x27;</span>] + blocks[<span class="string">&#x27;exit_block&#x27;</span>] + blocks[<span class="string">&#x27;real_blocks&#x27;</span>]</span><br><span class="line">    main_blocks_addr = <span class="built_in">set</span>([b.start_ea <span class="keyword">for</span> b <span class="keyword">in</span> main_blocks])</span><br><span class="line">    start_addr = blocks[<span class="string">&#x27;entry_block&#x27;</span>][<span class="number">0</span>].start_ea</span><br><span class="line">    end_addr = blocks[<span class="string">&#x27;exit_block&#x27;</span>][<span class="number">0</span>].start_ea</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">uc, address, size, user_data</span>):</span><br><span class="line">        instruction = uc.mem_read(address, size)</span><br><span class="line">        disasm = <span class="built_in">list</span>(cs.disasm(instruction, address))</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(disasm) == <span class="number">1</span></span><br><span class="line">        disasm = disasm[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 查看是否为函数调用，若为函数调用则跳过</span></span><br><span class="line">        <span class="keyword">if</span> disasm.mnemonic == <span class="string">&quot;bl&quot;</span>:</span><br><span class="line">            uc.reg_write(UC_ARM64_REG_PC, address + size)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hook_block</span>(<span class="params">uc, address, size, user_data</span>):</span><br><span class="line">        <span class="keyword">if</span> address <span class="keyword">in</span> main_blocks_addr:</span><br><span class="line">            hook_seq.append((address, size))</span><br><span class="line">        <span class="keyword">if</span> end_addr == address:</span><br><span class="line">            uc.emu_stop()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">                 </span><br><span class="line">    <span class="comment"># Step1: 模拟准备工作</span></span><br><span class="line">    uc = Uc(UC_ARCH_ARM64, UC_MODE_LITTLE_ENDIAN)</span><br><span class="line">    cs = Cs(CS_ARCH_ARM64, CS_MODE_ARM)</span><br><span class="line"></span><br><span class="line">    mem_size = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024</span> <span class="comment"># 1GB</span></span><br><span class="line">    addr = idaapi.get_imagebase()</span><br><span class="line">    uc.mem_map(addr, mem_size)</span><br><span class="line"></span><br><span class="line">    stack_start = <span class="number">0x80000000</span></span><br><span class="line">    stack_size = <span class="number">0x10000</span> * <span class="number">8</span> <span class="comment"># 512 KB</span></span><br><span class="line">    stack_sp = <span class="number">0x80000000</span> + <span class="number">0x10000</span> * <span class="number">6</span></span><br><span class="line">    uc.mem_map(stack_start, stack_size)</span><br><span class="line">    uc.reg_write(UC_ARM64_REG_SP, stack_sp)</span><br><span class="line"></span><br><span class="line">    func = ida_funcs.get_func(start_addr)</span><br><span class="line">    func_code = read_data(func.start_ea, func.end_ea)</span><br><span class="line">    uc.mem_write(func.start_ea, func_code)</span><br><span class="line"></span><br><span class="line">    uc.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">    uc.hook_add(UC_HOOK_BLOCK, hook_block)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Step2: 开始模拟</span></span><br><span class="line">    uc.emu_start(start_addr, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Step3: 展示结果</span></span><br><span class="line">    <span class="keyword">for</span> ind, addr <span class="keyword">in</span> <span class="built_in">enumerate</span>(hook_seq):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;------------------------- Block &#123;:2d&#125; | Addr &#123;&#125; -------------------------&quot;</span>.<span class="built_in">format</span>(ind, <span class="built_in">hex</span>(addr[<span class="number">0</span>])))</span><br><span class="line">        ins = get_instructions_in_block(addr[<span class="number">0</span>], addr[<span class="number">0</span>] + addr[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> ins:</span><br><span class="line">            <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line">func_ea = <span class="number">0x100006D50</span></span><br><span class="line">blocks = get_function_blocks(func_ea)</span><br><span class="line">different_blocks = divide_block_to_different_type(blocks)</span><br><span class="line"></span><br><span class="line">unicorn_exec(different_blocks)</span><br></pre></td></tr></table></figure>
<p>&emsp;可以将 handleButtonClick 展平为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br></pre></td><td class="code"><pre><span class="line">------------------------- Block  0 | Addr 0x100006d50 -------------------------</span><br><span class="line">(4294995280, &#x27;STP             X28, X27, [SP,#-0x10+var_50]!&#x27;)</span><br><span class="line">(4294995284, &#x27;STP             X26, X25, [SP,#0x50+var_40]&#x27;)</span><br><span class="line">(4294995288, &#x27;STP             X24, X23, [SP,#0x50+var_30]&#x27;)</span><br><span class="line">(4294995292, &#x27;STP             X22, X21, [SP,#0x50+var_20]&#x27;)</span><br><span class="line">(4294995296, &#x27;STP             X20, X19, [SP,#0x50+var_10]&#x27;)</span><br><span class="line">(4294995300, &#x27;STP             X29, X30, [SP,#0x50+var_s0]&#x27;)</span><br><span class="line">(4294995304, &#x27;ADD             X29, SP, #0x50&#x27;)</span><br><span class="line">(4294995308, &#x27;SUB             SP, SP, #0x100&#x27;)</span><br><span class="line">(4294995312, &#x27;SUB             X8, X29, #-var_38&#x27;)</span><br><span class="line">(4294995316, &#x27;STUR            X2, [X8,#-0x100]&#x27;)</span><br><span class="line">(4294995320, &#x27;SUB             X8, X29, #-var_40&#x27;)</span><br><span class="line">(4294995324, &#x27;STUR            X0, [X8,#-0x100]&#x27;)</span><br><span class="line">...</span><br><span class="line">(4294995372, &#x27;LDR             X9, =sel_show; &quot;show&quot;&#x27;)</span><br><span class="line">(4294995376, &#x27;NOP&#x27;)</span><br><span class="line">(4294995380, &#x27;LDR             X8, =sel_length; &quot;length&quot;&#x27;)</span><br><span class="line">(4294995384, &#x27;STUR            X8, [X29,#var_98]&#x27;)</span><br><span class="line">(4294995388, &#x27;NOP&#x27;)</span><br><span class="line">(4294995392, &#x27;LDR             X8, =sel_substringWithRange_; &quot;substringWithRange:&quot;&#x27;)</span><br><span class="line">(4294995396, &#x27;STP             X8, X9, [X29,#var_C0]&#x27;)</span><br><span class="line">(4294995400, &#x27;NOP&#x27;)</span><br><span class="line">(4294995404, &#x27;LDR             X9, =sel_UTF8String; &quot;UTF8String&quot;&#x27;)</span><br><span class="line">(4294995408, &#x27;NOP&#x27;)</span><br><span class="line">(4294995412, &#x27;LDR             X8, =sel_hasPrefix_; &quot;hasPrefix:&quot;&#x27;)</span><br><span class="line">(4294995416, &#x27;STP             X8, X9, [X29,#var_D0]&#x27;)</span><br><span class="line">(4294995420, &#x27;NOP&#x27;)</span><br><span class="line">(4294995424, &#x27;LDR             X9, =sel_theTextField; &quot;theTextField&quot;&#x27;)</span><br><span class="line">(4294995428, &#x27;NOP&#x27;)</span><br><span class="line">(4294995432, &#x27;LDR             X8, =sel_text; &quot;text&quot;&#x27;)</span><br><span class="line">(4294995436, &#x27;STP             X8, X9, [X29,#var_E0]&#x27;)</span><br><span class="line">(4294995440, &#x27;NOP&#x27;)</span><br><span class="line">(4294995444, &#x27;LDR             X9, =sel_showJailbreakAlert; &quot;showJailbreakAlert&quot;&#x27;)</span><br><span class="line">(4294995448, &#x27;NOP&#x27;)</span><br><span class="line">(4294995452, &#x27;LDR             X8, =sel_initWithTitle_message_delegate_cancelButtonTitle_otherButtonTitles_; &quot;initWithTitle:message:delegate:cancelBu&quot;...&#x27;)</span><br><span class="line">(4294995456, &#x27;STP             X8, X9, [X29,#var_F0]&#x27;)</span><br><span class="line">(4294995460, &#x27;NOP&#x27;)</span><br><span class="line">(4294995464, &#x27;LDR             Q0, xmmword_10000DD80&#x27;)</span><br><span class="line">(4294995468, &#x27;STUR            Q0, [X29,#var_100]&#x27;)</span><br><span class="line">(4294995472, &#x27;NOP&#x27;)</span><br><span class="line">(4294995476, &#x27;LDR             Q0, xmmword_10000DD90&#x27;)</span><br><span class="line">(4294995480, &#x27;SUB             X8, X29, #-var_10&#x27;)</span><br><span class="line">(4294995484, &#x27;STUR            Q0, [X8,#-0x100]&#x27;)</span><br><span class="line">(4294995488, &#x27;NOP&#x27;)</span><br><span class="line">(4294995492, &#x27;LDR             Q0, xmmword_10000DDA0&#x27;)</span><br><span class="line">(4294995496, &#x27;SUB             X8, X29, #-var_20&#x27;)</span><br><span class="line">(4294995500, &#x27;STUR            Q0, [X8,#-0x100]&#x27;)</span><br><span class="line">(4294995504, &#x27;NOP&#x27;)</span><br><span class="line">(4294995508, &#x27;LDR             Q0, xmmword_10000DDB0&#x27;)</span><br><span class="line">(4294995512, &#x27;SUB             X8, X29, #-var_30&#x27;)</span><br><span class="line">(4294995516, &#x27;STUR            Q0, [X8,#-0x100]&#x27;)</span><br><span class="line">(4294995520, &#x27;NOP&#x27;)</span><br><span class="line">(4294995524, &#x27;LDR             X8, =sel_hasSuffix_; &quot;hasSuffix:&quot;&#x27;)</span><br><span class="line">(4294995528, &#x27;SUB             X9, X29, #-var_48&#x27;)</span><br><span class="line">(4294995532, &#x27;STUR            X8, [X9,#-0x100]&#x27;)</span><br><span class="line">...</span><br><span class="line">------------------------- Block  1 | Addr 0x10000767c -------------------------</span><br><span class="line">(4294997628, &#x27;LDUR            W8, [X29,#var_A0]&#x27;)</span><br><span class="line">(4294997632, &#x27;TST             W8, #1&#x27;)</span><br><span class="line">...</span><br><span class="line">------------------------- Block  2 | Addr 0x100007e1c -------------------------</span><br><span class="line">(4294999580, &#x27;ADR             X8, unk_100011CC0&#x27;)</span><br><span class="line">(4294999584, &#x27;NOP&#x27;)</span><br><span class="line">(4294999588, &#x27;LDAR            W8, [X8]&#x27;)</span><br><span class="line">(4294999592, &#x27;CMP             W8, #0&#x27;)</span><br><span class="line">(4294999596, &#x27;CSET            W8, EQ&#x27;)</span><br><span class="line">(4294999600, &#x27;STUR            W8, [X29,#var_88]&#x27;)</span><br><span class="line">...</span><br><span class="line">------------------------- Block  3 | Addr 0x10000715c -------------------------</span><br><span class="line">...</span><br><span class="line">------------------------- Block  4 | Addr 0x10000712c -------------------------</span><br><span class="line">...</span><br><span class="line">------------------------- Block  5 | Addr 0x100007b24 -------------------------</span><br><span class="line">(4294998820, &#x27;ADR             X9, byte_100011950&#x27;)</span><br><span class="line">(4294998824, &#x27;NOP&#x27;)</span><br><span class="line">(4294998828, &#x27;LDRB            W8, [X9]&#x27;)</span><br><span class="line">(4294998832, &#x27;MOV             W10, #0x90&#x27;)</span><br><span class="line">(4294998836, &#x27;EOR             W8, W8, W10&#x27;)</span><br><span class="line">(4294998840, &#x27;ADR             X10, asc_100011953; &quot;�\\x0F\\t&quot;&#x27;)</span><br><span class="line">(4294998844, &#x27;NOP&#x27;)</span><br><span class="line">(4294998848, &#x27;STRB            W8, [X10]; &quot;�\\x0F\\t&quot;&#x27;)</span><br><span class="line">(4294998852, &#x27;LDRB            W8, [X9,#(byte_100011951 - 0x100011950)]&#x27;)</span><br><span class="line">(4294998856, &quot;MOV             W11, #0x50 ; &#x27;P&#x27;&quot;)</span><br><span class="line">(4294998860, &#x27;EOR             W8, W8, W11&#x27;)</span><br><span class="line">(4294998864, &#x27;STRB            W8, [X10,#(asc_100011953+1 - 0x100011953)]; &quot;\\x0F\\t&quot;&#x27;)</span><br><span class="line">(4294998868, &#x27;LDRB            W8, [X9,#(byte_100011952 - 0x100011950)]&#x27;)</span><br><span class="line">(4294998872, &quot;MOV             W9, #0x42 ; &#x27;B&#x27;&quot;)</span><br><span class="line">(4294998876, &#x27;EOR             W8, W8, W9&#x27;)</span><br><span class="line">(4294998880, &#x27;STRB            W8, [X10,#(asc_100011953+2 - 0x100011953)]; &quot;\\t&quot;&#x27;)</span><br><span class="line">(4294998884, &#x27;ADR             X9, byte_100011956&#x27;)</span><br><span class="line">(4294998888, &#x27;NOP&#x27;)</span><br><span class="line">(4294998892, &#x27;LDRB            W8, [X9]&#x27;)</span><br><span class="line">(4294998896, &#x27;MOV             W10, #0xE8&#x27;)</span><br><span class="line">(4294998900, &#x27;EOR             W8, W8, W10&#x27;)</span><br><span class="line">(4294998904, &#x27;ADR             X10, asc_10001195D; &quot;\\r���\\x01�)&quot;&#x27;)</span><br><span class="line">(4294998908, &#x27;NOP&#x27;)</span><br><span class="line">(4294998912, &#x27;STRB            W8, [X10]; &quot;\\r���\\x01�)&quot;&#x27;)</span><br><span class="line">(4294998916, &#x27;LDRB            W8, [X9,#(byte_100011957 - 0x100011956)]&#x27;)</span><br><span class="line">(4294998920, &#x27;EOR             W8, W8, #4&#x27;)</span><br><span class="line">(4294998924, &#x27;STRB            W8, [X10,#(asc_10001195D+1 - 0x10001195D)]; &quot;���\\x01�)&quot;&#x27;)</span><br><span class="line">(4294998928, &#x27;LDRB            W8, [X9,#(byte_100011958 - 0x100011956)]&#x27;)</span><br><span class="line">(4294998932, &#x27;MOV             W11, #0xD8&#x27;)</span><br><span class="line">(4294998936, &#x27;EOR             W8, W8, W11&#x27;)</span><br><span class="line">(4294998940, &#x27;STRB            W8, [X10,#(asc_10001195D+2 - 0x10001195D)]; &quot;��\\x01�)&quot;&#x27;)</span><br><span class="line">(4294998944, &#x27;LDRB            W8, [X9,#(byte_100011959 - 0x100011956)]&#x27;)</span><br><span class="line">(4294998948, &#x27;EOR             W8, W8, #0xC&#x27;)</span><br><span class="line">(4294998952, &#x27;STRB            W8, [X10,#(asc_10001195D+3 - 0x10001195D)]; &quot;�\\x01�)&quot;&#x27;)</span><br><span class="line">(4294998956, &#x27;LDRB            W8, [X9,#(byte_10001195A - 0x100011956)]&#x27;)</span><br><span class="line">(4294998960, &#x27;MOV             W11, #0x13&#x27;)</span><br><span class="line">(4294998964, &#x27;EOR             W8, W8, W11&#x27;)</span><br><span class="line">(4294998968, &#x27;STRB            W8, [X10,#(asc_10001195D+4 - 0x10001195D)]; &quot;\\x01�)&quot;&#x27;)</span><br><span class="line">(4294998972, &#x27;LDRB            W8, [X9,#(byte_10001195B - 0x100011956)]&#x27;)</span><br><span class="line">(4294998976, &#x27;MOV             W11, #0xFA&#x27;)</span><br><span class="line">(4294998980, &#x27;EOR             W8, W8, W11&#x27;)</span><br><span class="line">(4294998984, &#x27;STRB            W8, [X10,#(asc_10001195D+5 - 0x10001195D)]; &quot;�)&quot;&#x27;)</span><br><span class="line">(4294998988, &#x27;LDRB            W8, [X9,#(byte_10001195C - 0x100011956)]&#x27;)</span><br><span class="line">(4294998992, &quot;MOV             W9, #0x51 ; &#x27;Q&#x27;&quot;)</span><br><span class="line">(4294998996, &#x27;EOR             W8, W8, W9&#x27;)</span><br><span class="line">(4294999000, &#x27;STRB            W8, [X10,#(asc_10001195D+6 - 0x10001195D)]; &quot;)&quot;&#x27;)</span><br><span class="line">(4294999004, &#x27;ADR             X9, byte_100011964&#x27;)</span><br><span class="line">(4294999008, &#x27;NOP&#x27;)</span><br><span class="line">(4294999012, &#x27;LDRB            W8, [X9]&#x27;)</span><br><span class="line">(4294999016, &quot;MOV             W10, #0x4A ; &#x27;J&#x27;&quot;)</span><br><span class="line">(4294999020, &#x27;EOR             W8, W8, W10&#x27;)</span><br><span class="line">(4294999024, &#x27;ADR             X10, asc_100011966; &quot;�&quot;&#x27;)</span><br><span class="line">(4294999028, &#x27;NOP&#x27;)</span><br><span class="line">(4294999032, &#x27;STRB            W8, [X10]; &quot;�&quot;&#x27;)</span><br><span class="line">(4294999036, &#x27;LDRB            W8, [X9,#(byte_100011965 - 0x100011964)]&#x27;)</span><br><span class="line">------------------------- Block  6 | Addr 0x10000789c -------------------------</span><br><span class="line">(4294998172, &#x27;ADR             X8, unk_100011CC0&#x27;)</span><br><span class="line">(4294998176, &#x27;NOP&#x27;)</span><br><span class="line">(4294998180, &#x27;MOV             W9, #1&#x27;)</span><br><span class="line">(4294998184, &#x27;STLR            W9, [X8]&#x27;)</span><br><span class="line">(4294998188, &#x27;MOV             X8, SP&#x27;)</span><br><span class="line">(4294998192, &#x27;SUB             X9, X8, #0x10&#x27;)</span><br><span class="line">(4294998196, &#x27;STUR            X9, [X29,#var_68]&#x27;)</span><br><span class="line">(4294998200, &#x27;MOV             SP, X9&#x27;)</span><br><span class="line">(4294998204, &#x27;MOV             X23, SP&#x27;)</span><br><span class="line">(4294998208, &#x27;SUB             X9, X23, #0x10&#x27;)</span><br><span class="line">(4294998212, &#x27;STUR            X9, [X29,#var_A8]&#x27;)</span><br><span class="line">(4294998216, &#x27;MOV             SP, X9&#x27;)</span><br><span class="line">(4294998220, &#x27;MOV             X21, SP&#x27;)</span><br><span class="line">(4294998224, &#x27;SUB             X9, X21, #0x10&#x27;)</span><br><span class="line">(4294998228, &#x27;STUR            X9, [X29,#var_78]&#x27;)</span><br><span class="line">(4294998232, &#x27;MOV             SP, X9&#x27;)</span><br><span class="line">(4294998236, &#x27;SUB             X22, SP, #0x10&#x27;)</span><br><span class="line">(4294998240, &#x27;MOV             SP, X22&#x27;)</span><br><span class="line">(4294998244, &#x27;SUB             X9, SP, #0x10&#x27;)</span><br><span class="line">(4294998248, &#x27;STUR            X9, [X29,#var_B0]&#x27;)</span><br><span class="line">(4294998252, &#x27;MOV             SP, X9&#x27;)</span><br><span class="line">(4294998256, &#x27;SUB             X9, SP, #0x10&#x27;)</span><br><span class="line">(4294998260, &#x27;STUR            X9, [X29,#var_80]&#x27;)</span><br><span class="line">(4294998264, &#x27;MOV             SP, X9&#x27;)</span><br><span class="line">(4294998268, &#x27;SUB             X9, SP, #0x10&#x27;)</span><br><span class="line">(4294998272, &#x27;STUR            X9, [X29,#var_70]&#x27;)</span><br><span class="line">(4294998276, &#x27;MOV             SP, X9&#x27;)</span><br><span class="line">(4294998280, &#x27;SUB             X9, X29, #-var_40&#x27;)</span><br><span class="line">(4294998284, &#x27;LDUR            X9, [X9,#-0x100]&#x27;)</span><br><span class="line">(4294998288, &#x27;STUR            X9, [X8,#-0x10]&#x27;)</span><br><span class="line">(4294998292, &#x27;SUB             X8, X29, #-var_38&#x27;)</span><br><span class="line">(4294998296, &#x27;LDUR            X0, [X8,#-0x100]; id&#x27;)</span><br><span class="line">(4294998300, &#x27;BL              _objc_retain&#x27;)</span><br><span class="line">------------------------- Block  7 | Addr 0x100007778 -------------------------</span><br><span class="line">(4294997880, &#x27;LDUR            X8, [X29,#var_68]&#x27;)</span><br><span class="line">(4294997884, &#x27;LDR             X0, [X8]; id&#x27;)</span><br><span class="line">(4294997888, &#x27;LDUR            X1, [X29,#var_D8]; SEL&#x27;)</span><br><span class="line">(4294997892, &#x27;BL              _objc_msgSend&#x27;)</span><br><span class="line">------------------------- Block  8 | Addr 0x10000767c -------------------------</span><br><span class="line">(4294997628, &#x27;LDUR            W8, [X29,#var_A0]&#x27;)</span><br><span class="line">(4294997632, &#x27;TST             W8, #1&#x27;)</span><br><span class="line">(4294997636, &#x27;MOV             W8, #0x1663B27E&#x27;)</span><br><span class="line">(4294997644, &#x27;CSEL            W8, W8, W23, NE&#x27;)</span><br><span class="line">(4294997648, &#x27;MOV             W10, #0xEA914DFB&#x27;)</span><br><span class="line">(4294997656, &#x27;CMP             W9, W10&#x27;)</span><br><span class="line">(4294997660, &#x27;CSEL            W8, W8, W9, EQ&#x27;)</span><br><span class="line">(4294997664, &#x27;CSEL            W10, WZR, W24, EQ&#x27;)</span><br><span class="line">(4294997668, &#x27;MOV             W11, #0xEA5AAFFE&#x27;)</span><br><span class="line">(4294997676, &#x27;CMP             W9, W11&#x27;)</span><br><span class="line">(4294997680, &#x27;MOV             W9, #0x6C694815&#x27;)</span><br><span class="line">(4294997688, &#x27;CSEL            W8, W9, W8, EQ&#x27;)</span><br><span class="line">(4294997692, &#x27;CSEL            W10, W24, W10, EQ&#x27;)</span><br><span class="line">(4294997696, &#x27;B               loc_100006E70&#x27;)</span><br><span class="line">------------------------- Block  9 | Addr 0x100007288 -------------------------</span><br><span class="line">(4294996616, &#x27;MOV             W8, #0xD259F2E6&#x27;)</span><br><span class="line">(4294996624, &#x27;CMP             W9, W8&#x27;)</span><br><span class="line">(4294996628, &#x27;CSEL            W8, W21, W9, EQ&#x27;)</span><br><span class="line">(4294996632, &#x27;MOV             W10, #0xCF9F21BD&#x27;)</span><br><span class="line">(4294996640, &#x27;CMP             W9, W10&#x27;)</span><br><span class="line">(4294996644, &#x27;MOV             W10, #0x667AEC8C&#x27;)</span><br><span class="line">(4294996652, &#x27;CSEL            W8, W10, W8, EQ&#x27;)</span><br><span class="line">(4294996656, &#x27;CMP             W9, W23&#x27;)</span><br><span class="line">(4294996660, &#x27;MOV             W9, #0xC8F813D0&#x27;)</span><br><span class="line">(4294996668, &#x27;CSEL            W8, W9, W8, EQ&#x27;)</span><br><span class="line">(4294996672, &#x27;LDUR            W9, [X29,#var_5C]&#x27;)</span><br><span class="line">(4294996676, &#x27;CSEL            W9, W24, W9, EQ&#x27;)</span><br><span class="line">(4294996680, &#x27;STUR            W9, [X29,#var_5C]&#x27;)</span><br><span class="line">(4294996684, &#x27;MOV             X10, X24&#x27;)</span><br><span class="line">(4294996688, &#x27;B               loc_100006E70&#x27;)</span><br><span class="line">------------------------- Block 10 | Addr 0x1000077e8 -------------------------</span><br><span class="line">(4294997992, &#x27;LDUR            X8, [X29,#var_70]&#x27;)</span><br><span class="line">(4294997996, &#x27;LDRB            W8, [X8]&#x27;)</span><br><span class="line">(4294998000, &#x27;STUR            W8, [X29,#var_84]&#x27;)</span><br><span class="line">(4294998004, &#x27;MOV             W8, #0x84B17691&#x27;)</span><br><span class="line">(4294998012, &#x27;MOV             X10, X24&#x27;)</span><br><span class="line">------------------------- Block 11 | Addr 0x1000071c8 -------------------------</span><br><span class="line">(4294996424, &#x27;LDUR            W8, [X29,#var_84]&#x27;)</span><br><span class="line">(4294996428, &#x27;TST             W8, #1&#x27;)</span><br><span class="line">(4294996432, &#x27;MOV             W11, #0x3BE56CAF&#x27;)</span><br><span class="line">(4294996440, &#x27;MOV             W8, #0xCAC4CC96&#x27;)</span><br><span class="line">(4294996448, &#x27;CSEL            W8, W8, W11, NE&#x27;)</span><br><span class="line">(4294996452, &#x27;LDUR            W10, [X29,#var_5C]&#x27;)</span><br><span class="line">(4294996456, &#x27;TST             W10, #1&#x27;)</span><br><span class="line">(4294996460, &#x27;MOV             W10, #0xAC51EE34&#x27;)</span><br><span class="line">(4294996468, &#x27;MOV             W12, #0x359CA206&#x27;)</span><br><span class="line">(4294996476, &#x27;CSEL            W10, W12, W10, NE&#x27;)</span><br><span class="line">(4294996480, &#x27;MOV             W12, #0x8F7507B2&#x27;)</span><br><span class="line">(4294996488, &#x27;CMP             W9, W12&#x27;)</span><br><span class="line">(4294996492, &#x27;CSEL            W10, W10, W9, EQ&#x27;)</span><br><span class="line">(4294996496, &#x27;MOV             W12, #0x85E430EB&#x27;)</span><br><span class="line">(4294996504, &#x27;CMP             W9, W12&#x27;)</span><br><span class="line">(4294996508, &#x27;CSEL            W10, W11, W10, EQ&#x27;)</span><br><span class="line">(4294996512, &#x27;MOV             W11, #0x84B17691&#x27;)</span><br><span class="line">(4294996520, &#x27;CMP             W9, W11&#x27;)</span><br><span class="line">(4294996524, &#x27;CSEL            W8, W8, W10, EQ&#x27;)</span><br><span class="line">(4294996528, &#x27;MOV             X10, X24&#x27;)</span><br><span class="line">(4294996532, &#x27;B               loc_100006E70&#x27;)</span><br><span class="line">------------------------- Block 12 | Addr 0x100006eb8 -------------------------</span><br><span class="line">(4294995640, &#x27;LDUR            W8, [X29,#var_9C]&#x27;)</span><br><span class="line">(4294995644, &#x27;TST             W8, #1&#x27;)</span><br><span class="line">(4294995648, &#x27;MOV             W8, #0xD71F0709&#x27;)</span><br><span class="line">(4294995656, &#x27;CSEL            W8, W8, W23, NE&#x27;)</span><br><span class="line">(4294995660, &#x27;CMP             W9, W21&#x27;)</span><br><span class="line">(4294995664, &#x27;MOV             W10, #0x8F7507B2&#x27;)</span><br><span class="line">(4294995672, &#x27;CSEL            W10, W10, W9, EQ&#x27;)</span><br><span class="line">(4294995676, &#x27;MOV             W11, #0xF8F0E135&#x27;)</span><br><span class="line">(4294995684, &#x27;CMP             W9, W11&#x27;)</span><br><span class="line">(4294995688, &#x27;CSEL            W8, W8, W10, EQ&#x27;)</span><br><span class="line">(4294995692, &#x27;CSEL            W10, WZR, W24, EQ&#x27;)</span><br><span class="line">(4294995696, &#x27;B               loc_100006E70&#x27;)</span><br><span class="line">------------------------- Block 13 | Addr 0x1000071c8 -------------------------</span><br><span class="line">(4294996424, &#x27;LDUR            W8, [X29,#var_84]&#x27;)</span><br><span class="line">(4294996428, &#x27;TST             W8, #1&#x27;)</span><br><span class="line">(4294996432, &#x27;MOV             W11, #0x3BE56CAF&#x27;)</span><br><span class="line">(4294996440, &#x27;MOV             W8, #0xCAC4CC96&#x27;)</span><br><span class="line">(4294996448, &#x27;CSEL            W8, W8, W11, NE&#x27;)</span><br><span class="line">(4294996452, &#x27;LDUR            W10, [X29,#var_5C]&#x27;)</span><br><span class="line">(4294996456, &#x27;TST             W10, #1&#x27;)</span><br><span class="line">(4294996460, &#x27;MOV             W10, #0xAC51EE34&#x27;)</span><br><span class="line">(4294996468, &#x27;MOV             W12, #0x359CA206&#x27;)</span><br><span class="line">(4294996476, &#x27;CSEL            W10, W12, W10, NE&#x27;)</span><br><span class="line">(4294996480, &#x27;MOV             W12, #0x8F7507B2&#x27;)</span><br><span class="line">(4294996488, &#x27;CMP             W9, W12&#x27;)</span><br><span class="line">(4294996492, &#x27;CSEL            W10, W10, W9, EQ&#x27;)</span><br><span class="line">(4294996496, &#x27;MOV             W12, #0x85E430EB&#x27;)</span><br><span class="line">(4294996504, &#x27;CMP             W9, W12&#x27;)</span><br><span class="line">(4294996508, &#x27;CSEL            W10, W11, W10, EQ&#x27;)</span><br><span class="line">(4294996512, &#x27;MOV             W11, #0x84B17691&#x27;)</span><br><span class="line">(4294996520, &#x27;CMP             W9, W11&#x27;)</span><br><span class="line">(4294996524, &#x27;CSEL            W8, W8, W10, EQ&#x27;)</span><br><span class="line">(4294996528, &#x27;MOV             X10, X24&#x27;)</span><br><span class="line">(4294996532, &#x27;B               loc_100006E70&#x27;)</span><br><span class="line">------------------------- Block 14 | Addr 0x100007840 -------------------------</span><br><span class="line">(4294998080, &#x27;NOP&#x27;)</span><br><span class="line">(4294998084, &#x27;LDR             X0, =_OBJC_CLASS_$_UIAlertView; Class&#x27;)</span><br><span class="line">(4294998088, &#x27;BL              _objc_alloc&#x27;)</span><br><span class="line">------------------------- Block 15 | Addr 0x10000715c -------------------------</span><br><span class="line">(4294996316, &#x27;LDUR            W8, [X29,#var_88]&#x27;)</span><br><span class="line">(4294996320, &#x27;TST             W8, #1&#x27;)</span><br><span class="line">(4294996324, &#x27;MOV             W8, #0x1E3B6CBA&#x27;)</span><br><span class="line">(4294996332, &#x27;MOV             W10, #0xDB3303D3&#x27;)</span><br><span class="line">(4294996340, &#x27;CSEL            W8, W10, W8, NE&#x27;)</span><br><span class="line">(4294996344, &#x27;MOV             W10, #0x667AEC8C&#x27;)</span><br><span class="line">(4294996352, &#x27;CMP             W9, W10&#x27;)</span><br><span class="line">(4294996356, &#x27;MOV             W10, #0xB92A2324&#x27;)</span><br><span class="line">(4294996364, &#x27;CSEL            W10, W10, W9, EQ&#x27;)</span><br><span class="line">(4294996368, &#x27;MOV             W11, #0x65FF66ED&#x27;)</span><br><span class="line">(4294996376, &#x27;CMP             W9, W11&#x27;)</span><br><span class="line">(4294996380, &#x27;CSEL            W8, W8, W10, EQ&#x27;)</span><br><span class="line">(4294996384, &#x27;MOV             W10, #0x5F66DF9D&#x27;)</span><br><span class="line">(4294996392, &#x27;CMP             W9, W10&#x27;)</span><br><span class="line">(4294996396, &#x27;MOV             W9, #0x3E81DC70&#x27;)</span><br><span class="line">(4294996404, &#x27;B               loc_10000727C&#x27;)</span><br><span class="line">------------------------- Block 16 | Addr 0x100006fc4 -------------------------</span><br><span class="line">(4294995908, &#x27;LDR             X0, [X22]; id&#x27;)</span><br><span class="line">(4294995912, &#x27;BL              _objc_release&#x27;)</span><br><span class="line">------------------------- Block 17 | Addr 0x100007288 -------------------------</span><br><span class="line">(4294996616, &#x27;MOV             W8, #0xD259F2E6&#x27;)</span><br><span class="line">(4294996624, &#x27;CMP             W9, W8&#x27;)</span><br><span class="line">(4294996628, &#x27;CSEL            W8, W21, W9, EQ&#x27;)</span><br><span class="line">(4294996632, &#x27;MOV             W10, #0xCF9F21BD&#x27;)</span><br><span class="line">(4294996640, &#x27;CMP             W9, W10&#x27;)</span><br><span class="line">(4294996644, &#x27;MOV             W10, #0x667AEC8C&#x27;)</span><br><span class="line">(4294996652, &#x27;CSEL            W8, W10, W8, EQ&#x27;)</span><br><span class="line">(4294996656, &#x27;CMP             W9, W23&#x27;)</span><br><span class="line">(4294996660, &#x27;MOV             W9, #0xC8F813D0&#x27;)</span><br><span class="line">(4294996668, &#x27;CSEL            W8, W9, W8, EQ&#x27;)</span><br><span class="line">(4294996672, &#x27;LDUR            W9, [X29,#var_5C]&#x27;)</span><br><span class="line">(4294996676, &#x27;CSEL            W9, W24, W9, EQ&#x27;)</span><br><span class="line">(4294996680, &#x27;STUR            W9, [X29,#var_5C]&#x27;)</span><br><span class="line">(4294996684, &#x27;MOV             X10, X24&#x27;)</span><br><span class="line">(4294996688, &#x27;B               loc_100006E70&#x27;)</span><br><span class="line">------------------------- Block 18 | Addr 0x10000715c -------------------------</span><br><span class="line">(4294996316, &#x27;LDUR            W8, [X29,#var_88]&#x27;)</span><br><span class="line">(4294996320, &#x27;TST             W8, #1&#x27;)</span><br><span class="line">(4294996324, &#x27;MOV             W8, #0x1E3B6CBA&#x27;)</span><br><span class="line">(4294996332, &#x27;MOV             W10, #0xDB3303D3&#x27;)</span><br><span class="line">(4294996340, &#x27;CSEL            W8, W10, W8, NE&#x27;)</span><br><span class="line">(4294996344, &#x27;MOV             W10, #0x667AEC8C&#x27;)</span><br><span class="line">(4294996352, &#x27;CMP             W9, W10&#x27;)</span><br><span class="line">(4294996356, &#x27;MOV             W10, #0xB92A2324&#x27;)</span><br><span class="line">(4294996364, &#x27;CSEL            W10, W10, W9, EQ&#x27;)</span><br><span class="line">(4294996368, &#x27;MOV             W11, #0x65FF66ED&#x27;)</span><br><span class="line">(4294996376, &#x27;CMP             W9, W11&#x27;)</span><br><span class="line">(4294996380, &#x27;CSEL            W8, W8, W10, EQ&#x27;)</span><br><span class="line">(4294996384, &#x27;MOV             W10, #0x5F66DF9D&#x27;)</span><br><span class="line">(4294996392, &#x27;CMP             W9, W10&#x27;)</span><br><span class="line">(4294996396, &#x27;MOV             W9, #0x3E81DC70&#x27;)</span><br><span class="line">(4294996404, &#x27;B               loc_10000727C&#x27;)</span><br><span class="line">------------------------- Block 19 | Addr 0x100007a28 -------------------------</span><br><span class="line">(4294998568, &#x27;LDUR            X21, [X29,#var_78]&#x27;)</span><br><span class="line">(4294998572, &#x27;LDR             X0, [X21]; id&#x27;)</span><br><span class="line">(4294998576, &#x27;LDUR            X1, [X29,#var_B8]; SEL&#x27;)</span><br><span class="line">(4294998580, &#x27;BL              _objc_msgSend&#x27;)</span><br></pre></td></tr></table></figure>
<p>&emsp;展平脚本还是不对，猜测是函数返回的结果也会影响执行流。</p>
<p>Step7：硬看 OLLVM。几个函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. objc_msgSend：当向一个对象发送消息时，objc_msgSend 负责找到对应的方法实现并执行它。</span><br><span class="line"></span><br><span class="line">2. objc_retainAutoreleasedReturnValue：当一个方法返回一个自动释放的对象作为其返回值时，此函数负责捕获这个返回值，并将其注册为需要保留（retain）的对象，这样调用者就可以安全地使用它，而不用担心它会在自动释放池清空时被释放。</span><br><span class="line"></span><br><span class="line">3. objc_retainAutorelease：将一个对象加入到当前的自动释放池中，同时保留（retain）它。这意味着对象将在自动释放池被清空时被释放（release）。</span><br></pre></td></tr></table></figure>
<p>&emsp;可以得到一些信息：</p>
<p><img src="/images/wmctf-2023/image-20240315205527333.png" alt="image-20240315205527333" style="zoom:67%;" /></p>
<p><img src="/images/wmctf-2023/image-20240315205539041.png" alt="image-20240315205539041" style="zoom:67%;" /></p>
<p><img src="/images/wmctf-2023/image-20240315205559054.png" alt="image-20240315205559054" style="zoom:67%;" /></p>
<p>&emsp;跟踪此函数，发现有 RC4 算法（主要是问了一下 GPT），然后又发现：</p>
<p><img src="/images/wmctf-2023/image-20240315211009852.png" alt="image-20240315211009852" style="zoom:67%;" /></p>
<p>&emsp;这题需要读 <code>__dyld_get_image_header/__dyld_get_image_vmaddr_slide</code>，可能必须得动调？直接放弃好吧。草！我怎么这么菜。</p>
<h2 id="0x04-RightBack"><a href="#0x04-RightBack" class="headerlink" title="0x04 RightBack"></a>0x04 RightBack</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmctf&#123;...&#125;</span><br></pre></td></tr></table></figure>

  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2023/08/24/gray-wolf-analysis/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> 上一页</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2023/08/09/recentlyThink-3/" type="button" class="btn btn-default ">下一页<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>


	<!-- comment -->
	
<section id="comment">
    <h2 class="title">留言</h2>

    <!-- 
    <div id="disqus_thread" class="ds-thread">
        <script type="text/javascript">
            /**
             * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
             * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
             */
                /*
                 var disqus_config = function () {
                 this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                 this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                 };
                 */
            (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');

                s.src = 'https://https-wd-2711-tech.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by
                Disqus.</a></noscript>
    </div> -->
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <div id="vcomments"></div>
    <script>
        new Valine({
            el: '#vcomments',
            appId: 'wLIJ70s3fPvW8WJPgVVAuWVR-gzGzoHsz',
            appKey: 'NVGqxhUkqtFv2CbwmXXWjCdR'
        })
    </script>

    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2023-08-20 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/re/">re<span>39</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>

	<!-- copyright -->
	<div>
    <ul class="post-copyright">
      <li class="post-copyright-author">
      <strong>作者:  </strong>wd-z711</a>
      </li>
      <li class="post-copyright-link">
      <strong>文章链接:  </strong>
      <a href="/" target="_blank" title="">https://wd-2711.tech/</a>
      </li>
      <li class="post-copyright-license">
        <strong>版权声明:   </strong>
        本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
        许可协议。转载请注明出处!
      </li>
    </ul>
  <div>
 	

		


</div><!-- row -->




	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2024 wd-z711
  
      <!-- with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.     -->

     <!-- <script type="text/javascript">
      (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
      (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
      e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
      })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
      
      _st('install','aB-vgeB8gEDrnRJuhceL','2.0.0');
    </script> -->
    </p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
   </html>
