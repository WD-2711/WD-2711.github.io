<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>OP-TEE-study | wd-z711&#39;s B10g</title>
  <meta name="author" content="wd-z711">
  
  <meta name="description" content="OP-TEE，open source project Trusted Execution Environment (TEE)， 开源可信执行环境。Rich Execution Environment (REE)相对应。REE中运行的是non-secure OS，例如安卓，Linux系统等。TEE中运行的是secure OS，需要Arm TrustZone技术的支持，依赖硬件设计...">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="OP-TEE-study"/>
  <meta property="og:site_name" content="wd-z711&#39;s B10g"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'G-YHJSKZDC3Y', 'auto');
  ga('send', 'pageview');
</script>




<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="wd-z711's B10g" type="application/atom+xml">
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">wd-z711&#39;s B10g</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> OP-TEE-study</h1>
		</div>
	



<div class="row post">

	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> OP-TEE，open source project Trusted Execution Environment (TEE)， 开源可信执行环境。Rich Execution Environment (REE)相对应。REE中运行的是non-secure OS，例如安卓，Linux系统等。TEE中运行的是secure OS，需要Arm TrustZone技术的支持，依赖硬件设计...
		 </div> <!-- alert -->
	  		

	  <h1 id="OP-TEE"><a href="#OP-TEE" class="headerlink" title="OP-TEE"></a>OP-TEE</h1><p>&emsp;SCTF2023的一道题是关于OP-TEE的，学习一波。</p>
<p>&emsp;OP-TEE，open source project Trusted Execution Environment (TEE)， 开源可信执行环境。Rich Execution Environment (REE)相对应。REE中运行的是non-secure OS，例如安卓，Linux系统等。TEE中运行的是secure OS，需要Arm TrustZone技术的支持，依赖硬件设计。</p>
<span id="more"></span>
<p>&emsp;TrustZone是操作系统间实现了相互独立。可以在同一个CPU上运行两个OS，其中一个OS只负责安全存储或者计算的操作。另一个OS就是平时用的OS，比如安卓系统，对于这个OS来说，安全OS是不可见的，其没有权限获取到安全OS中的隐私数据。 两个OS之间需要交互，也就是CA/TA这种调用机制。</p>
<h2 id="0x00-OP-TEE组件功能"><a href="#0x00-OP-TEE组件功能" class="headerlink" title="0x00 OP-TEE组件功能"></a>0x00 OP-TEE组件功能</h2><p>&emsp;其执行流程如下：</p>
<p><img src="/images/OP-TEE-study/image-20230713182350737.png" alt="image-20230713182350737" style="zoom:67%;" /></p>
<p>（1）CA（代理应用）发起函数调用。完成一次完整的CA请求时在linux userspace端（图的左上部分）需要执行的操作依次如下 ：</p>
<p>&emsp;&emsp;a. 调用TEEC_InitializeContext函数打开op-tee驱动文件，获取到操作句柄并存放到TEE_Context类型的变量中。</p>
<p>&emsp;&emsp;b. 调用TEEC_OpenSession函数，通过获取到的TEE_Context类型的变量创建一个CA与TA之间通信的通道，如果TA image被存放在file system中，那么OP-TEE OS端还会将TA image从file system中加载到OP-TEE。</p>
<p>&emsp;&emsp;c. 初始化TEEC_Operation类型的变量，并根据实际需要借助TEEC_PARAM_TYPES宏来设定TEEC_Operation类型变量中paramTypes成员的值，该值规定传递到OP-TEE中的最多4个变量的作用（作为输入还是输出）。</p>
<p>&emsp;&emsp;d. 使用session，TA与CA端规定的command ID以及TEEC_Operation作为参数，调用TEEC_InvokeCommand函数来发起请求。 调用TEEC_InvokeCommand成功之后，剩下的事情就由OP-TEE和TA进行处理并将结果和相关的数据通过TEEC_Operation中的params返回给CA。</p>
<p>&emsp;&emsp;e. 调用成功之后，如果不需要调用该TA则需要注销session和context，通过调用TEEC_CloseSession函数和TEEC_FinalizeContext函数来实现。</p>
<p>注：libteec库是OP-TEE提供给用户在linux userspace层面调用的接口实现，上述函数都是libteec库中的函数。</p>
<p><strong>（2）tee_supplicant可以使OP-TEE能够通过它来访问REE端文件系统中的资源，例如加载存放在文件系统中的TA镜像到TEE中。</strong></p>
<ul>
<li>tee_supplicant在REE启动的时候会作为一个后台程序被自启动，而且常驻于系统中。</li>
<li>tee_supplicant的启动代码存放在build/init.d.optee文件中，在编译的时候init.d.optee文件将会被打包到根文件系统（rootfs）中。这些操作是在编译生成rootfs的时候所做的。</li>
<li>当tee_supplicant接收到来自TA的请求并解析出对应的请求func ID之后，tee_supplicant将会根据func ID来执行具体的请求操作，例如：<code>RPC_CMD_LOAD_TA</code>指tee_supplicant将会到文件系统中将TA镜像的内容读取到共享内存中，<code>RPC_CMD_FS</code>指TA对常规的文件和目录进行打开、关闭、读取等操作。</li>
</ul>
<p>（3）OP-TEE驱动主要作用是在REE与TEE端进行数据交互。</p>
<ul>
<li><p>tee_supplicant和libteec调用之后都会进入到kernel space，然后kernel根据传递的参数找到OP-TEE驱动，并命中驱动的operation结构体中的具体处理函数来完成实际的操作。对于OP-TEE驱动，会触发SMC调用（非安全模式向安全模式的调用），并带参数进入到ARM cortex的monitor模式，执行normal world和secure world的切换，切换完成之后，会将驱动端带入的参数传递给OP-TEE中的thread进行进一步的处理。</p>
</li>
<li><p>Step1：OP-TEE驱动挂载。</p>
<ul>
<li><p>linux kernel中加载驱动的函数有两个：subsys_initcall和module_init。</p>
</li>
<li><p>OP-TEE驱动的加载过程分为两步，第一步是初始化class和设备号（由subsys_initcall完成），第二步是probe过程（由module_init完成）。在OP-TEE驱动源代码中使用subsys_init定义的函数为tee_init，使用module_init定义的函数为optee_driver_init。</p>
</li>
<li><p><strong>OP-TEE驱动会分别针对libteec和tee_supplicant建立不同的设备/dev/tee0和/dev/teepriv0</strong>。并且为两个设备建立消息队列，来存放normal world与secure world之间的请求，这样libteec和tee_supplicant使用OP-TEE驱动的时就能做到相对独立。<strong>secure world与OP-TEE驱动之间使用共享内存进行数据交互。</strong></p>
</li>
</ul>
</li>
<li><p>Step2：驱动挂载完成之后，CA程序通过调用libteec中的接口调用OP-TEE驱动，来切换到secure world中，从而调用对应的TA程序。其中，有4个比较重要的结构体：</p>
<ul>
<li><p>tee_fops。当在userspace层面调用open/release/ioctl进行文件操作时，就会调用到tee_fops中的函数。</p>
</li>
<li><p>optee_ops。存放针对/dev/tee0设备的具体操作函数的指针。当用户调用libteec中的接口时（即操作/dev/tee0设备），首先会调用到tee_fops中的函数，tee_fops中的函数再会调用optee_ops中的函数，来完成对/dev/tee0设备的实际操作。</p>
</li>
<li><p>optee_supp_ops。与optee_ops类似，只不过存放的是针对/dev/teepriv0设备的函数的指针。</p>
</li>
<li><p>tee_shm_dma_buf_ops。略。</p>
</li>
</ul>
</li>
</ul>
<p>&emsp;libteec提供给上层使用的接口总共有10个，这10个接口通过系统调用最终会调用到驱动中，在接口libteec中调用Open函数的时候，在驱动中就会调用到file_operations结构体变量tee_fops中的Open成员。同理在libteec接口中调用ioctl函数，则在驱动中最终会调用tee_fops中的ioctl函数。<strong>tee_supplicant与secure world之间的交互则是分为3步：1. 驱动获取来自TEE侧的请求。2.tee_supplicant从驱动中获取TEE侧的请求。3.驱动返回请求操作结果给TEE侧。</strong></p>
<p>（4）Monitor如何处理SMC请求。</p>
<ul>
<li>libteec和tee_supplicant调用接口之后，最终会调用到OP-TEE驱动来触发对应的SMC操作。具体做法是：调用arm_smccc_smc之后，CPU中的cortex就会切换到monitor模式，其后会去获取MVBAR寄存器中存放的monitor模式的中断向量表地址，然后查找smc的处理函数。进入到处理函数之后，再根据从REE侧带入的参数判定是进行快速smc处理还是标准的smc处理。</li>
<li>fast smc一般会在驱动挂载过程中被调用。fast smc的特点就是在OP-TEE不会使用一个thread来对fast smc进行处理，而是在OP-TEE的kernel space层面<strong>直接对smc进行请求</strong>，并返回处理结果。</li>
</ul>
<h2 id="0x01-demo"><a href="#0x01-demo" class="headerlink" title="0x01 demo"></a>0x01 demo</h2><p>&emsp;下面是一个optee的官方示例hello_world。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">hello_world</span><br><span class="line">│  Android.mk</span><br><span class="line">│  CMakeLists.txt</span><br><span class="line">│  Makefile</span><br><span class="line">│  tree</span><br><span class="line">│</span><br><span class="line">├─host</span><br><span class="line">│      main.c</span><br><span class="line">│      Makefile</span><br><span class="line">│</span><br><span class="line">└─ta</span><br><span class="line">    │  Android.mk</span><br><span class="line">    │  hello_world_ta.c</span><br><span class="line">    │  Makefile</span><br><span class="line">    │  sub.mk</span><br><span class="line">    │  user_ta_header_defines.h</span><br><span class="line">    │</span><br><span class="line">    └─include</span><br><span class="line">            hello_world_ta.h</span><br></pre></td></tr></table></figure>
<p>&emsp;上面的结构中，ta负责可信应用TA部分，而host（代理应用CA）则是调用TA的提供的功能。</p>
<p>&emsp;以此为基础，写一个数据的加密保存和读取恢复的功能。</p>
<p>Step1：修改主目录下Cmakelist的文件名，修改host文件夹下Makefile的二进制文件名。</p>
<p>Step2：修改host文件夹下的main.c：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* OP-TEE TEE client API (built by optee_client) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tee_client_api.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* TA API: UUID and command IDs */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;read_write_ta.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* TEE resources */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">test_ctx</span> &#123;</span><br><span class="line">	TEEC_Context ctx;</span><br><span class="line">	TEEC_Session sess;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">prepare_tee_session</span><span class="params">(<span class="keyword">struct</span> test_ctx *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TEEC_UUID uuid = TA_READ_WRITE_UUID;</span><br><span class="line">	<span class="type">uint32_t</span> origin;</span><br><span class="line">	TEEC_Result res;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Initialize a context connecting us to the TEE */</span></span><br><span class="line">	res = <span class="built_in">TEEC_InitializeContext</span>(<span class="literal">NULL</span>, &amp;ctx-&gt;ctx);</span><br><span class="line">	<span class="keyword">if</span> (res != TEEC_SUCCESS)</span><br><span class="line">		<span class="built_in">errx</span>(<span class="number">1</span>, <span class="string">&quot;TEEC_InitializeContext failed with code 0x%x&quot;</span>, res);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Open a session with the TA */</span></span><br><span class="line">	res = <span class="built_in">TEEC_OpenSession</span>(&amp;ctx-&gt;ctx, &amp;ctx-&gt;sess, &amp;uuid,</span><br><span class="line">			       TEEC_LOGIN_PUBLIC, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;origin);</span><br><span class="line">	<span class="keyword">if</span> (res != TEEC_SUCCESS)</span><br><span class="line">		<span class="built_in">errx</span>(<span class="number">1</span>, <span class="string">&quot;TEEC_Opensession failed with code 0x%x origin 0x%x&quot;</span>,</span><br><span class="line">			res, origin);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">terminate_tee_session</span><span class="params">(<span class="keyword">struct</span> test_ctx *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">TEEC_CloseSession</span>(&amp;ctx-&gt;sess);</span><br><span class="line">	<span class="built_in">TEEC_FinalizeContext</span>(&amp;ctx-&gt;ctx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">TEEC_Result <span class="title">read_secure_object</span><span class="params">(<span class="keyword">struct</span> test_ctx *ctx, <span class="type">char</span> *id,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="type">char</span> *data, <span class="type">size_t</span> data_len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TEEC_Operation op;</span><br><span class="line">	<span class="type">uint32_t</span> origin;</span><br><span class="line">	TEEC_Result res;</span><br><span class="line">	<span class="type">size_t</span> id_len = <span class="built_in">strlen</span>(id);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;op, <span class="number">0</span>, <span class="built_in">sizeof</span>(op));</span><br><span class="line">	op.paramTypes = <span class="built_in">TEEC_PARAM_TYPES</span>(TEEC_MEMREF_TEMP_INPUT,</span><br><span class="line">					 TEEC_MEMREF_TEMP_OUTPUT,</span><br><span class="line">					 TEEC_NONE, TEEC_NONE);</span><br><span class="line"></span><br><span class="line">	op.params[<span class="number">0</span>].tmpref.buffer = id;</span><br><span class="line">	op.params[<span class="number">0</span>].tmpref.size = id_len;</span><br><span class="line"></span><br><span class="line">	op.params[<span class="number">1</span>].tmpref.buffer = data;</span><br><span class="line">	op.params[<span class="number">1</span>].tmpref.size = data_len;</span><br><span class="line"></span><br><span class="line">	res = <span class="built_in">TEEC_InvokeCommand</span>(&amp;ctx-&gt;sess,</span><br><span class="line">				 TA_READ_WRITE_CMD_READ_RAW,</span><br><span class="line">				 &amp;op, &amp;origin);</span><br><span class="line">	<span class="keyword">switch</span> (res) &#123;</span><br><span class="line">	<span class="keyword">case</span> TEEC_SUCCESS:</span><br><span class="line">	<span class="keyword">case</span> TEEC_ERROR_SHORT_BUFFER:</span><br><span class="line">	<span class="keyword">case</span> TEEC_ERROR_ITEM_NOT_FOUND:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Command READ_RAW failed: 0x%x / %u\n&quot;</span>, res, origin);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">TEEC_Result <span class="title">write_secure_object</span><span class="params">(<span class="keyword">struct</span> test_ctx *ctx, <span class="type">char</span> *id, <span class="type">char</span> *data, <span class="type">size_t</span> data_len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TEEC_Operation op;</span><br><span class="line">	<span class="type">uint32_t</span> origin;</span><br><span class="line">	TEEC_Result res;</span><br><span class="line">	<span class="type">size_t</span> id_len = <span class="built_in">strlen</span>(id);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;op, <span class="number">0</span>, <span class="built_in">sizeof</span>(op));</span><br><span class="line">	op.paramTypes = <span class="built_in">TEEC_PARAM_TYPES</span>(TEEC_MEMREF_TEMP_INPUT,</span><br><span class="line">					 TEEC_MEMREF_TEMP_INPUT,</span><br><span class="line">					 TEEC_NONE, TEEC_NONE);</span><br><span class="line"></span><br><span class="line">	op.params[<span class="number">0</span>].tmpref.buffer = id;</span><br><span class="line">	op.params[<span class="number">0</span>].tmpref.size = id_len;</span><br><span class="line"></span><br><span class="line">	op.params[<span class="number">1</span>].tmpref.buffer = data;</span><br><span class="line">	op.params[<span class="number">1</span>].tmpref.size = data_len;</span><br><span class="line"></span><br><span class="line">	res = <span class="built_in">TEEC_InvokeCommand</span>(&amp;ctx-&gt;sess,</span><br><span class="line">				 TA_READ_WRITE_CMD_WRITE_RAW,</span><br><span class="line">				 &amp;op, &amp;origin);</span><br><span class="line">	<span class="keyword">if</span> (res != TEEC_SUCCESS)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Command WRITE_RAW failed: 0x%x / %u\n&quot;</span>, res, origin);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (res) &#123;</span><br><span class="line">		<span class="keyword">case</span> TEEC_SUCCESS:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Command WRITE_RAW failed: 0x%x / %u\n&quot;</span>, res, origin);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">TEEC_Result <span class="title">delete_secure_object</span><span class="params">(<span class="keyword">struct</span> test_ctx *ctx, <span class="type">char</span> *id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TEEC_Operation op;</span><br><span class="line">	<span class="type">uint32_t</span> origin;</span><br><span class="line">	TEEC_Result res;</span><br><span class="line">	<span class="type">size_t</span> id_len = <span class="built_in">strlen</span>(id);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;op, <span class="number">0</span>, <span class="built_in">sizeof</span>(op));</span><br><span class="line">	op.paramTypes = <span class="built_in">TEEC_PARAM_TYPES</span>(TEEC_MEMREF_TEMP_INPUT,</span><br><span class="line">					 TEEC_NONE, TEEC_NONE, TEEC_NONE);</span><br><span class="line"></span><br><span class="line">	op.params[<span class="number">0</span>].tmpref.buffer = id;</span><br><span class="line">	op.params[<span class="number">0</span>].tmpref.size = id_len;</span><br><span class="line"></span><br><span class="line">	res = <span class="built_in">TEEC_InvokeCommand</span>(&amp;ctx-&gt;sess,</span><br><span class="line">				 TA_READ_WRITE_CMD_DELETE,</span><br><span class="line">				 &amp;op, &amp;origin);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (res) &#123;</span><br><span class="line">	<span class="keyword">case</span> TEEC_SUCCESS:</span><br><span class="line">	<span class="keyword">case</span> TEEC_ERROR_ITEM_NOT_FOUND:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Command DELETE failed: 0x%x / %u\n&quot;</span>, res, origin);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TEST_OBJECT_SIZE	7000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">test_ctx</span> ctx;</span><br><span class="line">	<span class="type">char</span> obj1_id[<span class="number">50</span>];		<span class="comment">/* object的字符串标识 */</span></span><br><span class="line">	<span class="type">char</span> obj2_id[<span class="number">50</span>];		<span class="comment">/* object的字符串标识 */</span></span><br><span class="line">	<span class="type">char</span> obj1_data[TEST_OBJECT_SIZE];</span><br><span class="line">	<span class="type">char</span> read_data[TEST_OBJECT_SIZE];</span><br><span class="line">	TEEC_Result res;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(argc == <span class="number">3</span>)&#123;</span><br><span class="line">		<span class="built_in">strcpy</span>(obj1_id, argv[<span class="number">1</span>]); <span class="comment">/* 参数1为第1个object */</span></span><br><span class="line">		<span class="built_in">strcpy</span>(obj2_id, argv[<span class="number">2</span>]); <span class="comment">/* 参数2为第2个object */</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">strcpy</span>(obj1_id, <span class="string">&quot;#object1&quot;</span>);</span><br><span class="line">		<span class="built_in">strcpy</span>(obj2_id, <span class="string">&quot;#object2&quot;</span>);</span><br><span class="line">	&#125;    	</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Prepare session with the TA\n&quot;</span>);</span><br><span class="line">	<span class="built_in">prepare_tee_session</span>(&amp;ctx);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 创建/读取/删除object</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\nTest on object \&quot;%s\&quot;\n&quot;</span>, obj1_id);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;- Create and load object in the TA secure storage\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(obj1_data, <span class="number">0xA1</span>, <span class="built_in">sizeof</span>(obj1_data));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 向TEE写入obj1_data</span></span><br><span class="line">	res = <span class="built_in">write_secure_object</span>(&amp;ctx, obj1_id, obj1_data, <span class="built_in">sizeof</span>(obj1_data));</span><br><span class="line">	<span class="keyword">if</span> (res != TEEC_SUCCESS)</span><br><span class="line">		<span class="built_in">errx</span>(<span class="number">1</span>, <span class="string">&quot;Failed to create an object in the secure storage&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;- Read back the object\n&quot;</span>);</span><br><span class="line">	<span class="comment">// 从TEE读取obj1_data</span></span><br><span class="line">	res = <span class="built_in">read_secure_object</span>(&amp;ctx, obj1_id, read_data, <span class="built_in">sizeof</span>(read_data));</span><br><span class="line">	<span class="keyword">if</span> (res != TEEC_SUCCESS)</span><br><span class="line">		<span class="built_in">errx</span>(<span class="number">1</span>, <span class="string">&quot;Failed to read an object from the secure storage&quot;</span>);</span><br><span class="line">	<span class="comment">// 比较写入与读取的是否相同</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">memcmp</span>(obj1_data, read_data, <span class="built_in">sizeof</span>(obj1_data)))</span><br><span class="line">		<span class="built_in">errx</span>(<span class="number">1</span>, <span class="string">&quot;Unexpected content found in secure storage&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;- Delete the object\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 删除object1</span></span><br><span class="line">	res = <span class="built_in">delete_secure_object</span>(&amp;ctx, obj1_id);</span><br><span class="line">	<span class="keyword">if</span> (res != TEEC_SUCCESS)</span><br><span class="line">		<span class="built_in">errx</span>(<span class="number">1</span>, <span class="string">&quot;Failed to delete the object: 0x%x&quot;</span>, res);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 非易失性存储：如果没有找到则创建object2，如果找到则删除它</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\nTest on object \&quot;%s\&quot;\n&quot;</span>, obj2_id);</span><br><span class="line"></span><br><span class="line">	res = <span class="built_in">read_secure_object</span>(&amp;ctx, obj2_id, read_data, <span class="built_in">sizeof</span>(read_data));</span><br><span class="line">	<span class="keyword">if</span> (res != TEEC_SUCCESS &amp;&amp; res != TEEC_ERROR_ITEM_NOT_FOUND)</span><br><span class="line">		<span class="built_in">errx</span>(<span class="number">1</span>, <span class="string">&quot;Unexpected status when reading an object : 0x%x&quot;</span>, res);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (res == TEEC_ERROR_ITEM_NOT_FOUND) &#123;</span><br><span class="line">		<span class="type">char</span> data[] = <span class="string">&quot;This is data stored in the secure storage.\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;- Object not found in TA secure storage, create it.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">		res = <span class="built_in">write_secure_object</span>(&amp;ctx, obj2_id, data, <span class="built_in">sizeof</span>(data));</span><br><span class="line">		<span class="keyword">if</span> (res != TEEC_SUCCESS)</span><br><span class="line">			<span class="built_in">errx</span>(<span class="number">1</span>, <span class="string">&quot;Failed to create/load an object&quot;</span>);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (res == TEEC_SUCCESS) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;- Object found in TA secure storage, delete it.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">		res = <span class="built_in">delete_secure_object</span>(&amp;ctx, obj2_id);</span><br><span class="line">		<span class="keyword">if</span> (res != TEEC_SUCCESS)</span><br><span class="line">			<span class="built_in">errx</span>(<span class="number">1</span>, <span class="string">&quot;Failed to delete an object&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\nWe&#x27;re done, close and release TEE resources\n&quot;</span>);</span><br><span class="line">	<span class="built_in">terminate_tee_session</span>(&amp;ctx);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Step3：清空ta文件夹下Android.mk的内容，修改sub.mk中的文件名，修改Makefile中的uuid值（任意更改都可）。</p>
<p>Step4：修改user-ta-header-defines.h为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> USER_TA_HEADER_DEFINES_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USER_TA_HEADER_DEFINES_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hello_world_change_ta.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TA_UUID				TA_READ_WRITE_UUID</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TA_FLAGS			(TA_FLAG_EXEC_DDR | TA_FLAG_SINGLE_INSTANCE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TA_STACK_SIZE			(2 * 1024)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TA_DATA_SIZE			(32 * 1024)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TA_CURRENT_TA_EXT_PROPERTIES \</span></span><br><span class="line"><span class="meta">    &#123; <span class="string">&quot;gp.ta.description&quot;</span>, USER_TA_PROP_TYPE_STRING, \</span></span><br><span class="line"><span class="meta">        <span class="string">&quot;Example of TA writing/reading data from its secure storage&quot;</span> &#125;, \</span></span><br><span class="line"><span class="meta">    &#123; <span class="string">&quot;gp.ta.version&quot;</span>, USER_TA_PROP_TYPE_U32, &amp;(const uint32_t)&#123; 0x0010 &#125; &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/*USER_TA_HEADER_DEFINES_H*/</span></span></span><br></pre></td></tr></table></figure>
<p>Step5：修改include/hello_world_change_ta.h，hello_world_change_ta.c的内容，具体看<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/146723420">链接</a>。</p>
<h2 id="0x02-运行hello-world以及0x01中的demo"><a href="#0x02-运行hello-world以及0x01中的demo" class="headerlink" title="0x02 运行hello_world以及0x01中的demo"></a>0x02 运行hello_world以及0x01中的demo</h2><p>&emsp;没看出来。不知道咋运行啊？</p>
<p>To be continue..</p>

  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2023/07/19/pdd-analysis-by-kaspersky/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> 上一页</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2023/07/10/IOT-security-vulnerabilities-mining/" type="button" class="btn btn-default ">下一页<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>


	<!-- comment -->
	
<section id="comment">
    <h2 class="title">留言</h2>

    <!-- 
    <div id="disqus_thread" class="ds-thread">
        <script type="text/javascript">
            /**
             * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
             * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
             */
                /*
                 var disqus_config = function () {
                 this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                 this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                 };
                 */
            (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');

                s.src = 'https://https-wd-2711-tech.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by
                Disqus.</a></noscript>
    </div> -->
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <div id="vcomments"></div>
    <script>
        new Valine({
            el: '#vcomments',
            appId: 'wLIJ70s3fPvW8WJPgVVAuWVR-gzGzoHsz',
            appKey: 'NVGqxhUkqtFv2CbwmXXWjCdR'
        })
    </script>

    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2023-07-13 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/TEE/">TEE<span>1</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>

	<!-- copyright -->
	<div>
    <ul class="post-copyright">
      <li class="post-copyright-author">
      <strong>作者:  </strong>wd-z711</a>
      </li>
      <li class="post-copyright-link">
      <strong>文章链接:  </strong>
      <a href="/" target="_blank" title="">https://wd-2711.tech/</a>
      </li>
      <li class="post-copyright-license">
        <strong>版权声明:   </strong>
        本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
        许可协议。转载请注明出处!
      </li>
    </ul>
  <div>
 	

		


</div><!-- row -->




	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2023 wd-z711
  
      <!-- with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.     -->

     <!-- <script type="text/javascript">
      (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
      (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
      e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
      })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
      
      _st('install','aB-vgeB8gEDrnRJuhceL','2.0.0');
    </script> -->
    </p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
   </html>
