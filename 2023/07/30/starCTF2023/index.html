<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>starCTF2023 | wd-z711&#39;s B10g</title>
  <meta name="author" content="wd-z711">
  
  <meta name="description" content="Common student in China. Interested in web &amp; re.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="starCTF2023"/>
  <meta property="og:site_name" content="wd-z711&#39;s B10g"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'G-YHJSKZDC3Y', 'auto');
  ga('send', 'pageview');
</script>




<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="wd-z711's B10g" type="application/atom+xml">
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">wd-z711&#39;s B10g</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> starCTF2023</h1>
		</div>
	



<div class="row post">

	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h1 id="starCTF2023"><a href="#starCTF2023" class="headerlink" title="starCTF2023"></a>starCTF2023</h1><p>&emsp;7.29的startCTF，我以为打两天呢，第二天刚准备上线，没想到只打一天…</p>
<span id="more"></span>
<h2 id="0x00-SIMPLEX-WMM"><a href="#0x00-SIMPLEX-WMM" class="headerlink" title="0x00 SIMPLEX-WMM"></a>0x00 SIMPLEX-WMM</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">有人真的可以模拟或仿真 ARM 机器吗？</span><br><span class="line">使用MD5的目的只是为了排除作者可能没有考虑到的情况，与问题的逻辑无关。据作者所知，该问题只有一个解决方案。</span><br><span class="line">HINT2：F**k 弱内存模型 (WMM)</span><br><span class="line">HINT3：你知道单纯形算法的原理吗？</span><br></pre></td></tr></table></figure>
<p>&emsp;本体有两个hint，一个是让了解WMM弱内存模型，第二个是simplex算法。64位arm64。</p>
<h3 id="弱内存模型"><a href="#弱内存模型" class="headerlink" title="弱内存模型"></a>弱内存模型</h3><p>&emsp;C++的out of thin air：线程1先写入变量X，之后线程2再写入变量X，但是由于内存模型的灵活性，可能出现线程1占主导的情况，这种情况叫做out of thin air，它还会导致其他好多问题，例如数据竞争、死锁与崩溃。</p>
<p>&emsp;最经典的内存模型就是串行模型（Sequentially Consistent：SC），即并发程序按串行执行（之前计算机组成原理的知识）。举一个例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">最初：x=y=0</span><br><span class="line">x=1   || y=1</span><br><span class="line">r1=y  || r2=x</span><br></pre></td></tr></table></figure>
<p>&emsp;按照原始的内存模型，r1与r2至少有一个为0。</p>
<p>&emsp;但是实际上，的确有可能出现r1=r2=0。这是为什么呢？编译器在编译时发现这两个线程并没有数据依赖关系，那么编译器就会根据需要颠倒<strong>线程内指令的执行顺序</strong>。这样，执行顺序就可能为：<code>r1=y -&gt; y=1 -&gt; r2=x -&gt; x=1</code>，就与原始的SC模型不符，这就叫弱内存模型（Weak Memory Model）。</p>
<h3 id="simplex算法"><a href="#simplex算法" class="headerlink" title="simplex算法"></a>simplex算法</h3><p>&emsp;单纯形算法。在线性规划中，解空间是由一个多面体决定的，最优解一般多面体的某个顶点。单纯形法的基本思想是：以巧妙的方式从一个角到另一个角移动，直到可以证明最优性为止。</p>
<p>&emsp;针对优化问题：</p>
<script type="math/tex; mode=display">\begin{aligned}
&\max z=\sum_{j=1}^{n}c_{j}x_{j} \\
&s.t.\left\{\begin{aligned}\sum_{j=1}^na_{ij}x_j&=b_j,i=1,2,...,n\\xj&\ge0,j=1,2,...,n\end{aligned}\right.
\end{aligned}</script><p>&emsp;写成矩阵形式为：</p>
<script type="math/tex; mode=display">\begin{aligned}
&\operatorname*{max}z=CX \\
&AX=b \\
&X\geq0 \\
&A=\left[\begin{array}{cccc}{a_{11}}&{a_{12}}&{\cdots}&{a_{1n}}\\{\vdots}&{\vdots}&{\ddots}&{\vdots}\\{a_{m1}}&{a_{m2}}&{\cdots}&{a_{mn}}\end{array}\right]
\end{aligned}</script><p>&emsp;标准形的形式为：</p>
<p>（1）目标函数要求max</p>
<p>（2）约束条件均为等式</p>
<p>（3）决策变量为非负约束</p>
<p>&emsp;普通线性规划如何转化成标准形：</p>
<p>（1）若目标函数为最小化，可以通过取负，求最大化</p>
<p>（2）约束不等式为小于等于不等式，可以在左端加入非负松弛变量，转变为等式，比如：</p>
<script type="math/tex; mode=display">x_1+2x_2\leq9\Rightarrow\left\{\begin{array}{c}x_1+2x_2+x_3=9\\x_3\geq0\end{array}\right.</script><p>（3）若存在取值无约束的变量，可转变为两个非负变量的差，比如：</p>
<script type="math/tex; mode=display">-\infty\leq x_k\leq+\infty\Rightarrow\left\{\begin{array}{c}x_k=x_m-x_n\\x_m,x_n\geq0\end{array}\right.</script><p>&emsp;例如，将如下线性规划转化为标准形：</p>
<script type="math/tex; mode=display">\max z=x_1+x_2\\s.t.\left\{\begin{array}{c}2x_1+x_2\leq12\\x_1+2x_2\leq9\\x_1,x_2\geq0\end{array}\right.</script><script type="math/tex; mode=display">\max z=x_1+x_2\\s.t.\left\{\begin{array}{c}2x_1+x_2+x_3=12\\x_1+2x_2+x_4=9\\x_1,x_2,x_3,x_4\geq0\end{array}\right.</script><p>&emsp;其可行域为：</p>
<p><img src="/images/starCTF2023/image-20230912175821632.png" alt="image-20230912175821632" style="zoom:67%;" /></p>
<p>&emsp;线性规划问题的目标函数最优解必然在可行域的顶点上达到最优。可以总结出：在标准形中，假设有$m$个约束条件（不包括非负约束），$n$个决策变量，那么有$n&gt;=m$。</p>
<p>&emsp;<strong>单纯形法就是通过设置不同的基向量，经过矩阵的线性变换，求得基可行解（可行域顶点），并判断该解是否最优，否则继续设置另一组基向量，重复执行以上步骤，直到找到最优解。所以，单纯形法的求解过程是一个循环迭代的过程。</strong></p>
<p>&emsp;具体步骤如下：</p>
<p>（1）选取$m$个基变量$x_{j}^{\prime}(j=1,2,…,m)$，基变量对应约束系数矩阵的列向量线性无关。<strong>通过矩阵的线性变换，基变量可由非基变量表示（值得琢磨）</strong>：</p>
<script type="math/tex; mode=display">x'_i=b_i+\sum_{j=m+1}^na_{ij}x'_j(i=1,2,...,m)</script><p>&emsp;如果令非基变量等于0，那么基变量的值为：$x’_i=b_i$。如果为可行解的话，$b_i&gt;0$。</p>
<p>&emsp;下面探讨它的几何意义（以上面的线性规划为例）：如果选择x2、x3为基变量，那么令x1、x4等于0，可以去求解基变量x2、x3的值。对系数矩阵做行变换，如下所示：</p>
<script type="math/tex; mode=display">\left[\begin{array}{cccccc}\text{X}&x_1&x_2&x_3&x_4&b\\&2&1&1&0&12\\&1&2&0&1&9\\\text{C}&1&1&0&0&z\end{array}\right]\rightarrow\left[\begin{array}{cccccc}\text{X}&x_1&x_2&x_3&x_4&b\\&\frac{3}{2}&0&1&-\frac{1}{2}&\frac{15}{2}\\&\frac{1}{2}&1&0&\frac{1}{2}&\frac{9}{2}\\\text{C}&\frac{1}{2}&0&0&-\frac{1}{2}&z-\frac{9}{2}\end{array}\right]</script><p>&emsp;因此，可以得到：$x_2=\frac{9}{2}$、$x_3=\frac{15}{2}$。</p>
<p>&emsp;$X_1=0$表示可行解在y轴上；$X_4=0$表示可行解在$x_1+2x_2=9$的直线上。那么，求得的可行解即表示这两条直线的交点，也是可行域的顶点。<strong>所以，通过选择不同的基变量，可以获得不同的可行域的顶点。</strong></p>
<p>（2）那么，如何判断最优呢？首先，<strong>目标函数也可以由非基变量表示（因为基变量可以由非基变量表示）</strong>，如下所示：</p>
<script type="math/tex; mode=display">z=z_0+\sum_{j=m+1}^n\sigma_jx_j^{\prime}</script><p>&emsp;当达到最优解时，所有的$\sigma_j$应小于等于0。当存在$j$，$\sigma_j&gt;0$时，当前解不是最优解。为什么？这是因为：<strong>当所有非基变量取0时，有$z=z_0$。由上述分析可知，某个非基变量取0代表可行域的边界。如果可行解逐步离开这个边界，$x’_j$会变大，由于$\sigma_j&gt;0$，那么目标函数取值会变大，因此当前解不是最优解。</strong></p>
<p>（3）如何选择新的基变量？<strong>如果存在多个$\sigma_j&gt;0$，选择最大的$\sigma_j&gt;0$对应的变量作为基变量，这表示目标函数随着$x’_j$的增加，增长的最快（我们要保留增长最快的，以获得更大的目标函数）。</strong></p>
<p>（4）如何选择被替换的基变量？</p>
<p>&emsp;假如我们选择非基变量$x’_s$作为下一轮的基变量，且基变量$x’_j$变为非基变量。被替换的基变量$x’_j$要满足的原则：替换后应该尽量使$x’_s$尽量大，因为目标函数会随着$x’_s$的增大而增大。</p>
<p>&emsp;继续以上例说明，上述例子的最后一行：$x_1$的系数为$\frac{1}{2}&gt;0$，所以选$x2,x3$为基变量并没有使目标函数达到最优。下一轮选取$x_1$作为基变量，替换$x_2$、$x_3$中的某个变量。</p>
<h3 id="探索"><a href="#探索" class="headerlink" title="探索"></a>探索</h3><p><strong>Step1：</strong>先跑起来再说。发现啥输出都没有。</p>
<p><strong>Step2：</strong>IDA瞅瞅。是rust的题目，之前没做过。打算看wp。</p>
<h3 id="佬的wp"><a href="#佬的wp" class="headerlink" title="佬的wp"></a>佬的wp</h3><p>&emsp;<a target="_blank" rel="noopener" href="https://github.com/sixstars/starctf2023/blob/main/reverse-SIMPLEX-WMM/writeup.pdf">链接</a>，没看懂啊，不知道在哪儿去找约束什么的。</p>
<p>&emsp;于是，自己看了几道rust的例题，我发现，rust的反汇编代码，就是一坨答辩。直接搬运佬的WP，此题通过ARM的WMM去触发异常分支，此题开了两个线程，分别对内存进行操作，从而引发竞争，最终导致WMM的内存不一致。为了增加竞争的可能性，此题在主线程增加了线程的随机调度。</p>
<p>&emsp;X86为传统的TSO内存模型，而ARM是WMM内存模型。因此必须在ARM架构上才能能正常打印flag。</p>
<p>&emsp;此外，为了防止动态调试，此题使用了1G的内存污染，如果输入正确，那么就会在一段时间后打印出flag，否则会在3分钟左右打印错误提示。此题可以对数据流进行追踪来解题，或者是找到打印flag的条件（一个全局变量）来解题。我通过后一种方法，交叉引用得到程序逻辑（在<code>sub_A1BC</code>中）：</p>
<p><img src="/images/starCTF2023/image-20230912131301727.png" alt="image-20230912131301727" style="zoom:67%;" /></p>
<p>&emsp;这是一个线性规划问题，总结如下：</p>
<script type="math/tex; mode=display">\begin{gathered}
Max:70x_1+65x_2+80x_3+75x_4 \\
st: \\
4x_1+4x_2+3x_3+7x_4\leq90 \\
6x_1+3x_2+5x_3+4x_4\leq120 \\
5x_1+2x_2+3x_3+3x_4\leq60 \\
6x_1+5x_2+x_3+2x_4\leq100 \\
x_1,x_2,x_3,x_4\geq0 
\end{gathered}</script><p>&emsp;求其最优解即可。至于单纯性算法的应用，是在验证逻辑中，即：如果输入的答案还能松弛得到非0目标值（还能优化），那么说明输入的答案不是最优解，如果是最优解，就无法松弛。</p>
<p>&emsp;最终得到：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"># @Time  : 2023/09/12 13:22:52</span></span><br><span class="line"><span class="string"># @Author: wd-2711</span></span><br><span class="line"><span class="string"># @Link  : https://www.cnblogs.com/joy-1120/p/8529772.html</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> scipy <span class="keyword">import</span> optimize</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标参数</span></span><br><span class="line">c = np.array([<span class="number">70</span>, <span class="number">65</span>, <span class="number">80</span>, <span class="number">75</span>])</span><br><span class="line"><span class="comment"># 小于等于</span></span><br><span class="line">A = np.array([[<span class="number">4</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">7</span>],[<span class="number">6</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">4</span>],[<span class="number">5</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>],[<span class="number">6</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="number">2</span>]])</span><br><span class="line">b = np.array([<span class="number">90</span>,<span class="number">120</span>,<span class="number">60</span>,<span class="number">100</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 求解</span></span><br><span class="line">res = optimize.linprog(-c,A,b,bounds=((<span class="number">0</span>,<span class="literal">None</span>),(<span class="number">0</span>,<span class="literal">None</span>),(<span class="number">0</span>,<span class="literal">None</span>),(<span class="number">0</span>,<span class="literal">None</span>)))</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># x: array([ 0., 15., 10.,  0.])</span></span><br><span class="line"><span class="comment"># max = 1775</span></span><br></pre></td></tr></table></figure>
<p>&emsp;将上值使用float编码并链接：</p>
<p>（1）<code>0</code>的float编码为<code>00000000</code>。</p>
<p>（2）<code>15</code>转为二进制<code>1111</code>，二进制部分为<code>1.111</code>，指数部分为<code>3</code>，符号位为<code>0</code>。最终，指数为<code>3+127=b(10000010)</code>，尾数为<code>11100000000000000000000</code>，最终转为16进制为：<code>41700000</code>，小端序存放为：<code>00007041</code>。见<code>cpp-reverse-analysis</code>。</p>
<p>…</p>
<p>&emsp;最终，flag为：<code>*CTF&#123;0000000000007041000020410000000000e0dd44&#125;</code>。但是在我环境下没跑出来，确定是多核ARM处理器。启动参数为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-aarch64 \</span><br><span class="line">        -M virt \</span><br><span class="line">        -cpu cortex-a57 \</span><br><span class="line">        -smp 4 \</span><br><span class="line">        -m 4G \</span><br><span class="line">        -kernel /home/wd/Desktop/starctf/linux-6.3.8/arch/arm64/boot/Image.gz \</span><br><span class="line">        -drive format=raw,file=$1 \</span><br><span class="line">        -nographic \</span><br><span class="line">        -append &quot;noinitrd root=/dev/vda rw console=ttyAMA0 init=/linuxrc ignore_loglevel&quot; \</span><br><span class="line">        -drive file=$PWD/share.img,if=virtio</span><br></pre></td></tr></table></figure>
<h3 id="再探索"><a href="#再探索" class="headerlink" title="再探索"></a>再探索</h3><p>&emsp;发现WP中给出了原始的rust源码，阅读一波。</p>
<p>&emsp;两个线程的运行流程如下：</p>
<p><img src="/images/starCTF2023/image-20230912163723117.png" alt="image-20230912163723117" style="zoom:67%;" /></p>
<p>&emsp;正常情况下，<code>sum==COUNT</code>一定成立，但是由于是WMM弱内存模型，因此执行顺序可能发生变化，从而出现<code>sum!=COUNT</code>的情况（上图<code>thread2</code>最后两条语句应该靠左对齐）。</p>
<p>&emsp;当第一次出现<code>sum!=COUNT</code>时，<code>wmm_count=1</code>，相继进入<code>place_inp_data()</code>与<code>check_inp_data()</code>。</p>
<p>（1）若检查输入数据不满足约束，则<code>wmm_count+=1</code>。等待下一次出现<code>sum!=COUNT</code>时，<code>wmm_count=3</code>，然后进入<code>check_result()</code>阶段。若<code>check_result()</code>检查输入的数据自洽（不一定是最优解，不一定满足约束），那么<code>succ_flag+=1</code>。</p>
<p>（2）若输入数据满足约束，则等待下一次出现<code>sum!=COUNT</code>时，<code>wmm_count=2</code>，然后进入<code>solve()</code>阶段。<code>solve()</code>函数就利用了单纯性算法进行判断。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入libc</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> libc;</span><br><span class="line"><span class="keyword">mod</span> md5;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> lazy_static::lazy_static;</span><br><span class="line"><span class="keyword">use</span> rand::Rng;</span><br><span class="line"><span class="keyword">use</span> std::collections::HashSet;</span><br><span class="line"><span class="keyword">use</span> std::io;</span><br><span class="line"><span class="keyword">use</span> std::ptr;</span><br><span class="line"><span class="keyword">use</span> std::sync::Mutex;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time::Duration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">handle_alarm</span>(_: <span class="type">i32</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Perhaps your input is incorrect, or it is possible that you are not using an ARM CPU with multiple cores. Bye.&quot;</span>);</span><br><span class="line">    std::process::<span class="title function_ invoke__">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> COUNT: <span class="type">u32</span> = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> TWMM: [<span class="type">u32</span>; <span class="number">102400000</span>] = [<span class="number">0</span>; <span class="number">102400000</span>];</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> AAA: *<span class="keyword">mut</span> <span class="type">u32</span> = <span class="keyword">unsafe</span> &#123; TWMM.<span class="title function_ invoke__">as_mut_ptr</span>() &#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> BBB: <span class="type">u32</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> LOOP: <span class="type">i32</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> succ_flag: <span class="type">i32</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> wmm_count: <span class="type">i32</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义静态变量inp与inp2，它们是可变的长度为40的u8数组</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> inp: [<span class="type">u8</span>; <span class="number">40</span>] = [<span class="number">0</span>; <span class="number">40</span>];</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> inp2: [<span class="type">u8</span>; <span class="number">40</span>] = [<span class="number">0</span>; <span class="number">40</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> CN: <span class="type">usize</span> = <span class="number">9</span>;</span><br><span class="line"><span class="keyword">static</span> BN: <span class="type">usize</span> = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> matrix: <span class="type">Vec</span>&lt;<span class="type">Vec</span>&lt;<span class="type">f64</span>&gt;&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    &quot;lazy_static!&quot;：Rust 的宏，创建在运行时只初始化一次的静态变量。它可以确保变量只在首次被访问时进行初始化，并且之后的访问都会使用已经初始化好的值。</span></span><br><span class="line"><span class="comment">    &quot;P&quot;           ：静态变量，类型为 Mutex&lt;HashSet&lt;usize&gt;&gt;。</span></span><br><span class="line"><span class="comment">    Mutex 包装了 HashSet&lt;usize&gt;，以确保对该集合的并发访问是线程安全的。</span></span><br><span class="line"><span class="comment">    可以在多个线程中共享变量 P，并使用 Mutex 来保证对 HashSet 的并发访问的安全性。</span></span><br><span class="line"><span class="comment">    在需要对 HashSet 进行写操作时，需要先获取 Mutex 的锁，执行完操作后释放锁。</span></span><br><span class="line"><span class="comment">    这样可以确保在同一时间只有一个线程能够修改 HashSet，避免数据竞争和不一致性。</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line">lazy_static! &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">ref</span> P: Mutex&lt;HashSet&lt;<span class="type">usize</span>&gt;&gt; = Mutex::<span class="title function_ invoke__">new</span>(HashSet::<span class="title function_ invoke__">new</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">pivot</span>(p: &amp;<span class="title function_ invoke__">mut</span> (<span class="type">usize</span>, <span class="type">usize</span>)) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">x</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">y</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cmax</span> = -<span class="type">f64</span>::INFINITY;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c_s</span> = matrix[<span class="number">0</span>].<span class="title function_ invoke__">clone</span>();</span><br><span class="line">    <span class="comment">// b_c 保存利用输入计算的不等式结果</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">b_c</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..BN &#123;</span><br><span class="line">        b_c.<span class="title function_ invoke__">push</span>(matrix[i][CN - <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">p_set</span> = P.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..c_s.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">        <span class="comment">// if cmax &lt; matrix[0][i] and ![7,6,5,4].contain(i):</span></span><br><span class="line">        <span class="keyword">if</span> cmax &lt; c_s[i] &amp;&amp; !p_set.<span class="title function_ invoke__">contains</span>(&amp;i) &#123;</span><br><span class="line">            cmax = c_s[i];</span><br><span class="line">            y = i;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// cmax = 80，y = 2</span></span><br><span class="line">    <span class="keyword">if</span> cmax &lt; <span class="number">0.0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">bmin</span> = <span class="type">f64</span>::INFINITY;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..BN &#123;</span><br><span class="line">        <span class="comment">// tmp = 不等式结果/[3/5/3/1]</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">tmp</span> = b_c[i] / matrix[i][y];</span><br><span class="line">        <span class="keyword">if</span> matrix[i][y] != <span class="number">0.0</span> &amp;&amp; bmin &gt; tmp &amp;&amp; tmp &gt;= <span class="number">0.0</span> &#123;</span><br><span class="line">            bmin = tmp;</span><br><span class="line">            x = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> tmp &lt; <span class="number">0.0</span> &#123;</span><br><span class="line">            bmin = tmp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// y = 2，x代表满足min(不等式结果/[3/5/3/1])的等式索引</span></span><br><span class="line">    *p = (x, y);</span><br><span class="line">    <span class="keyword">if</span> bmin &lt; <span class="number">0.0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// p_set -&gt; t_v</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">t_v</span>: <span class="type">Vec</span>&lt;<span class="type">usize</span>&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">it</span> <span class="keyword">in</span> p_set.<span class="title function_ invoke__">iter</span>() &#123;</span><br><span class="line">        t_v.<span class="title function_ invoke__">push</span>(*it);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">it</span> <span class="keyword">in</span> t_v.<span class="title function_ invoke__">iter</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> matrix[x][*it] != <span class="number">0.0</span> &#123;</span><br><span class="line">            p_set.<span class="title function_ invoke__">remove</span>(it);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    p_set.<span class="title function_ invoke__">insert</span>(y);</span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">gaussian</span>(p: (<span class="type">usize</span>, <span class="type">usize</span>)) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = p.<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = p.<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">norm</span> = matrix[x][y];</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..CN &#123;</span><br><span class="line">        matrix[x][i] /= norm;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..BN &#123;</span><br><span class="line">        <span class="keyword">if</span> i != x &amp;&amp; matrix[i][y] != <span class="number">0.0</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">tmp_norm</span> = matrix[i][y];</span><br><span class="line">            <span class="keyword">for</span> <span class="variable">j</span> <span class="keyword">in</span> <span class="number">0</span>..CN &#123;</span><br><span class="line">                matrix[i][j] = matrix[i][j] - tmp_norm * matrix[x][j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">solve</span>() <span class="punctuation">-&gt;</span> <span class="type">f64</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">t</span> = (<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">countt</span> = <span class="number">70</span>;</span><br><span class="line">    <span class="keyword">while</span> countt &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> !<span class="title function_ invoke__">pivot</span>(&amp;<span class="keyword">mut</span> t) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">gaussian</span>(t);</span><br><span class="line">        countt -= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ret_value</span> = matrix[<span class="number">0</span>][CN - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> matrix[<span class="number">0</span>][<span class="number">4</span>] == <span class="number">0.0</span> &amp;&amp; matrix[<span class="number">0</span>][<span class="number">5</span>] == <span class="number">0.0</span> &amp;&amp; matrix[<span class="number">0</span>][<span class="number">6</span>] == <span class="number">0.0</span> &amp;&amp; matrix[<span class="number">0</span>][<span class="number">7</span>] == <span class="number">0.0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">f64</span>::NEG_INFINITY;</span><br><span class="line">    &#125;</span><br><span class="line">    ret_value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">init_data</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vectmp0</span> = <span class="built_in">vec!</span>[<span class="number">70.0</span>, <span class="number">65.0</span>, <span class="number">80.0</span>, <span class="number">75.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>];</span><br><span class="line">    matrix.<span class="title function_ invoke__">push</span>(vectmp0);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vectmp1</span> = <span class="built_in">vec!</span>[<span class="number">4.0</span>, <span class="number">4.0</span>, <span class="number">3.0</span>, <span class="number">7.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>]; <span class="comment">//, 90.0];</span></span><br><span class="line">    matrix.<span class="title function_ invoke__">push</span>(vectmp1);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vectmp2</span> = <span class="built_in">vec!</span>[<span class="number">6.0</span>, <span class="number">3.0</span>, <span class="number">5.0</span>, <span class="number">4.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>]; <span class="comment">//, 120.0];</span></span><br><span class="line">    matrix.<span class="title function_ invoke__">push</span>(vectmp2);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vectmp3</span> = <span class="built_in">vec!</span>[<span class="number">5.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">3.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>]; <span class="comment">//, 60.0];</span></span><br><span class="line">    matrix.<span class="title function_ invoke__">push</span>(vectmp3);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vectmp4</span> = <span class="built_in">vec!</span>[<span class="number">6.0</span>, <span class="number">5.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>]; <span class="comment">//, 100.0];</span></span><br><span class="line">    matrix.<span class="title function_ invoke__">push</span>(vectmp4);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">place_inp_data</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">in_arr</span>: <span class="type">Vec</span>&lt;<span class="type">f32</span>&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">with_capacity</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">5</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">start</span> = i * <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">end</span> = start + <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">bytes_slice</span> = &amp;inp2[start..end];</span><br><span class="line">        <span class="comment">// 将输入变为 5 个 float32 的值</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">value</span> = <span class="keyword">match</span> bytes_slice &#123;</span><br><span class="line">            [b0, b1, b2, b3] =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">bytes_array</span>: [<span class="type">u8</span>; <span class="number">4</span>] = [*b0, *b1, *b2, *b3];</span><br><span class="line">                <span class="comment">// 将字节数组解释为小端字节序的 f32 值</span></span><br><span class="line">                <span class="type">f32</span>::<span class="title function_ invoke__">from_le_bytes</span>(bytes_array) <span class="comment">// or use f64::from_be_bytes(bytes_array) if big-endian</span></span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(<span class="string">&quot;Invalid input&quot;</span>),</span><br><span class="line">        &#125;;</span><br><span class="line">        in_arr.<span class="title function_ invoke__">push</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算 90-4*x1-4*x2-3*x3-7*x4 等</span></span><br><span class="line">    matrix[<span class="number">1</span>].<span class="title function_ invoke__">push</span>(</span><br><span class="line">        <span class="number">90.0</span> - in_arr[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">            - in_arr[<span class="number">1</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">1</span>][<span class="number">1</span>]</span><br><span class="line">            - in_arr[<span class="number">2</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">1</span>][<span class="number">2</span>]</span><br><span class="line">            - in_arr[<span class="number">3</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">1</span>][<span class="number">3</span>],</span><br><span class="line">    );</span><br><span class="line">    matrix[<span class="number">2</span>].<span class="title function_ invoke__">push</span>(</span><br><span class="line">        <span class="number">120.0</span></span><br><span class="line">            - in_arr[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">2</span>][<span class="number">0</span>]</span><br><span class="line">            - in_arr[<span class="number">1</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">2</span>][<span class="number">1</span>]</span><br><span class="line">            - in_arr[<span class="number">2</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">2</span>][<span class="number">2</span>]</span><br><span class="line">            - in_arr[<span class="number">3</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">2</span>][<span class="number">3</span>],</span><br><span class="line">    );</span><br><span class="line">    matrix[<span class="number">3</span>].<span class="title function_ invoke__">push</span>(</span><br><span class="line">        <span class="number">60.0</span> - in_arr[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">3</span>][<span class="number">0</span>]</span><br><span class="line">            - in_arr[<span class="number">1</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">3</span>][<span class="number">1</span>]</span><br><span class="line">            - in_arr[<span class="number">2</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">3</span>][<span class="number">2</span>]</span><br><span class="line">            - in_arr[<span class="number">3</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">3</span>][<span class="number">3</span>],</span><br><span class="line">    );</span><br><span class="line">    matrix[<span class="number">4</span>].<span class="title function_ invoke__">push</span>(</span><br><span class="line">        <span class="number">100.0</span></span><br><span class="line">            - in_arr[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">4</span>][<span class="number">0</span>]</span><br><span class="line">            - in_arr[<span class="number">1</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">4</span>][<span class="number">1</span>]</span><br><span class="line">            - in_arr[<span class="number">2</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">4</span>][<span class="number">2</span>]</span><br><span class="line">            - in_arr[<span class="number">3</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">4</span>][<span class="number">3</span>],</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">input_data</span>() &#123;</span><br><span class="line">    <span class="comment">// 定义数组ss，其可变，元素为uint8，长度为40</span></span><br><span class="line">    <span class="comment">// pointer t = ss</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ss</span>: [<span class="type">u8</span>; <span class="number">40</span>] = [<span class="number">0</span>; <span class="number">40</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">t</span> = ss.<span class="title function_ invoke__">as_mut_ptr</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">input_string</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// inp_string -&gt; ss</span></span><br><span class="line">    io::<span class="title function_ invoke__">stdin</span>().<span class="title function_ invoke__">read_line</span>(&amp;<span class="keyword">mut</span> input_string).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;read error&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">input_bytes</span> = input_string.<span class="title function_ invoke__">trim</span>().<span class="title function_ invoke__">as_bytes</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">input_length</span> = input_bytes.<span class="title function_ invoke__">len</span>().<span class="title function_ invoke__">min</span>(<span class="number">40</span>);</span><br><span class="line">    ss[..input_length].<span class="title function_ invoke__">copy_from_slice</span>(&amp;input_bytes[..input_length]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ss -&gt; inp</span></span><br><span class="line">    inp.<span class="title function_ invoke__">copy_from_slice</span>(&amp;ss[..<span class="number">40</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        if t[i] &gt;= &#x27;0&#x27; &amp;&amp; t[i] &lt;= &#x27;9&#x27;:</span></span><br><span class="line"><span class="comment">            t[i] -= &#x27;0&#x27;</span></span><br><span class="line"><span class="comment">        elif t[i] &gt;= &#x27;a&#x27; &amp;&amp; t[i] &lt;= &#x27;f&#x27;:</span></span><br><span class="line"><span class="comment">            t[i] -= &#x27;a&#x27; + 0xa;</span></span><br><span class="line"><span class="comment">        if i % 2 == 0:</span></span><br><span class="line"><span class="comment">            t[i/2] = t[i] &lt;&lt; 4</span></span><br><span class="line"><span class="comment">        else:</span></span><br><span class="line"><span class="comment">            t[i/2] = t[i/2] | (t[i] &amp; 0xf)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">40</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">if</span> (*t.<span class="title function_ invoke__">offset</span>(i <span class="keyword">as</span> <span class="type">isize</span>) &gt; <span class="string">b&#x27;0&#x27;</span> - <span class="number">1</span> &amp;&amp; *t.<span class="title function_ invoke__">offset</span>(i <span class="keyword">as</span> <span class="type">isize</span>) &lt; <span class="string">b&#x27;9&#x27;</span> + <span class="number">1</span>) &#123;</span><br><span class="line">            *t.<span class="title function_ invoke__">offset</span>(i <span class="keyword">as</span> <span class="type">isize</span>) -= <span class="string">b&#x27;0&#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="title function_ invoke__">if</span> (*t.<span class="title function_ invoke__">offset</span>(i <span class="keyword">as</span> <span class="type">isize</span>) &gt; <span class="string">b&#x27;a&#x27;</span> - <span class="number">1</span> &amp;&amp; *t.<span class="title function_ invoke__">offset</span>(i <span class="keyword">as</span> <span class="type">isize</span>) &lt; <span class="string">b&#x27;g&#x27;</span>) &#123;</span><br><span class="line">            *t.<span class="title function_ invoke__">offset</span>(i <span class="keyword">as</span> <span class="type">isize</span>) = *t.<span class="title function_ invoke__">offset</span>(i <span class="keyword">as</span> <span class="type">isize</span>) - <span class="string">b&#x27;a&#x27;</span> + <span class="number">0xa</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span> &#123;</span><br><span class="line">            *t.<span class="title function_ invoke__">offset</span>((i / <span class="number">2</span>) <span class="keyword">as</span> <span class="type">isize</span>) = *t.<span class="title function_ invoke__">offset</span>(i <span class="keyword">as</span> <span class="type">isize</span>) &lt;&lt; <span class="number">4</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            *t.<span class="title function_ invoke__">offset</span>((i / <span class="number">2</span>) <span class="keyword">as</span> <span class="type">isize</span>) =</span><br><span class="line">                *t.<span class="title function_ invoke__">offset</span>((i / <span class="number">2</span>) <span class="keyword">as</span> <span class="type">isize</span>) | (*t.<span class="title function_ invoke__">offset</span>(i <span class="keyword">as</span> <span class="type">isize</span>) &amp; <span class="number">0xf</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ss -&gt; inp2</span></span><br><span class="line">    inp2.<span class="title function_ invoke__">copy_from_slice</span>(&amp;ss[..<span class="number">40</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// md5(ss[:20])</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ctx</span>: md5::MD5Context = md5::MD5Context &#123;</span><br><span class="line">        size: <span class="number">0</span>,</span><br><span class="line">        buffer: [<span class="number">0</span>; <span class="number">4</span>],</span><br><span class="line">        input: [<span class="number">0</span>; <span class="number">64</span>],</span><br><span class="line">        digest: [<span class="number">0</span>; <span class="number">16</span>],</span><br><span class="line">    &#125;;</span><br><span class="line">    md5::<span class="title function_ invoke__">md5_init</span>(&amp;<span class="keyword">mut</span> ctx);</span><br><span class="line">    md5::<span class="title function_ invoke__">md5_update</span>(&amp;<span class="keyword">mut</span> ctx, &amp;<span class="keyword">mut</span> ss, <span class="number">20</span>);</span><br><span class="line">    md5::<span class="title function_ invoke__">md5_finalize</span>(&amp;<span class="keyword">mut</span> ctx);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">hash_result2</span> = <span class="string">&quot;d2edf678c89caf9979ec2b246634d284&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">hash_buf</span>: [<span class="type">u8</span>; <span class="number">32</span>] = [<span class="number">0</span>; <span class="number">32</span>];</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">16</span> &#123;</span><br><span class="line">        <span class="comment">// ctx.digest[i]的高4位</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">u_data1</span> = (ctx.digest[i] &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xF</span>;</span><br><span class="line">        <span class="comment">// ctx.digest[i]的低4位</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">u_data2</span> = ctx.digest[i] &amp; <span class="number">0xF</span>;</span><br><span class="line">        <span class="comment">// hash_buf = str(ctx.digest)</span></span><br><span class="line">        hash_buf[i * <span class="number">2</span>] = <span class="keyword">if</span> u_data1 &gt; <span class="number">9</span> &#123;</span><br><span class="line">            u_data1 - <span class="number">10</span> + <span class="string">b&#x27;a&#x27;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            u_data1 + <span class="string">b&#x27;0&#x27;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        hash_buf[i * <span class="number">2</span> + <span class="number">1</span>] = <span class="keyword">if</span> u_data2 &gt; <span class="number">9</span> &#123;</span><br><span class="line">            u_data2 - <span class="number">10</span> + <span class="string">b&#x27;a&#x27;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            u_data2 + <span class="string">b&#x27;0&#x27;</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">hash_result</span> = <span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;hash_buf);</span><br><span class="line">    <span class="keyword">if</span> hash_result2 == hash_result &#123;</span><br><span class="line">        succ_flag += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查输入是否合格，返回 1 则不合格</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">check_inp_data</span>() <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="number">90.0</span> &lt; matrix[<span class="number">1</span>][CN - <span class="number">1</span>]</span><br><span class="line">        || <span class="number">120.0</span> &lt; matrix[<span class="number">2</span>][CN - <span class="number">1</span>]</span><br><span class="line">        || <span class="number">60.0</span> &lt; matrix[<span class="number">3</span>][CN - <span class="number">1</span>]</span><br><span class="line">        || <span class="number">100.0</span> &lt; matrix[<span class="number">4</span>][CN - <span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">check_result</span>() <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">in_arr</span>: <span class="type">Vec</span>&lt;<span class="type">f32</span>&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">with_capacity</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">5</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">start</span> = i * <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">end</span> = start + <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">bytes_slice</span> = &amp;inp2[start..end];</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">value</span> = <span class="keyword">match</span> bytes_slice &#123;</span><br><span class="line">            [b0, b1, b2, b3] =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">bytes_array</span>: [<span class="type">u8</span>; <span class="number">4</span>] = [*b0, *b1, *b2, *b3];</span><br><span class="line">                <span class="type">f32</span>::<span class="title function_ invoke__">from_le_bytes</span>(bytes_array) <span class="comment">// or use f64::from_be_bytes(bytes_array) if big-endian</span></span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(<span class="string">&quot;Invalid input&quot;</span>),</span><br><span class="line">        &#125;;</span><br><span class="line">        in_arr.<span class="title function_ invoke__">push</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> in_arr[<span class="number">4</span>] <span class="keyword">as</span> <span class="type">f64</span></span><br><span class="line">        == in_arr[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">            + in_arr[<span class="number">1</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">            + in_arr[<span class="number">2</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">0</span>][<span class="number">2</span>]</span><br><span class="line">            + in_arr[<span class="number">3</span>] <span class="keyword">as</span> <span class="type">f64</span> * matrix[<span class="number">0</span>][<span class="number">3</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> TEMP_FFF: <span class="type">u8</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">thread1</span>() &#123;</span><br><span class="line">    <span class="comment">// 初始化 matrix</span></span><br><span class="line">    <span class="title function_ invoke__">init_data</span>();</span><br><span class="line">    <span class="comment">// 创建随机数生成器 rng</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">rng</span> = rand::<span class="title function_ invoke__">thread_rng</span>();</span><br><span class="line">    <span class="comment">// 循环</span></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="comment">// TWMM[:20] = 1</span></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..COUNT &#123;</span><br><span class="line">            *AAA.<span class="title function_ invoke__">offset</span>(i <span class="keyword">as</span> <span class="type">isize</span>) = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        BBB = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 读取 LOOP 的最新值，如果为 0 则等待</span></span><br><span class="line">        <span class="keyword">while</span> ptr::<span class="title function_ invoke__">read_volatile</span>(&amp;LOOP) == <span class="number">0</span> &#123;&#125;</span><br><span class="line">        <span class="comment">// AAA 跳转到 0-1G 的随机位置</span></span><br><span class="line">        AAA = &amp;<span class="keyword">mut</span> *TWMM.<span class="title function_ invoke__">as_mut_ptr</span>().<span class="title function_ invoke__">offset</span>(rng.<span class="title function_ invoke__">gen_range</span>(<span class="number">0</span>..<span class="number">102300000</span>) <span class="keyword">as</span> <span class="type">isize</span>);</span><br><span class="line">        COUNT = rng.<span class="title function_ invoke__">gen_range</span>(<span class="number">0</span>..<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// AAA[:COUNT] = 0</span></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">j</span> <span class="keyword">in</span> <span class="number">0</span>..COUNT &#123;</span><br><span class="line">            *AAA.<span class="title function_ invoke__">offset</span>(j <span class="keyword">as</span> <span class="type">isize</span>) = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">if</span> (TEMP_FFF == <span class="number">1</span>) &amp;&amp; (succ_flag == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vectmp0</span> = <span class="built_in">vec!</span>[<span class="number">70.0</span>, <span class="number">65.0</span>, <span class="number">80.0</span>, <span class="number">75.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>];</span><br><span class="line">            matrix[<span class="number">0</span>] = vectmp0;</span><br><span class="line">            TEMP_FFF = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        BBB = <span class="number">0</span>;</span><br><span class="line">        LOOP = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">thread2</span>() &#123;</span><br><span class="line">    <span class="comment">// 可以在多个线程中获取 P 的锁，并将锁定的 MutexGuard 绑定到变量 p_a 上，以进行对 HashSet 的可变访问。在使用完毕后，MutexGuard 会在其作用域结束时自动释放锁，允许其他线程获取同一个锁。</span></span><br><span class="line">    <span class="comment">// 通过调用 unwrap()，如果锁定操作成功，就会返回锁定的 MutexGuard 对象；如果锁定操作失败，就会触发 panic。</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">p_a</span> = P.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..(BN - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 向 HashSet 中插入 7,6,5,4</span></span><br><span class="line">        p_a.<span class="title function_ invoke__">insert</span>(CN - i - <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">drop</span>(p_a);</span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="comment">// 读取 BBB 的最新值，如果为 0 则等待</span></span><br><span class="line">        <span class="keyword">while</span> ptr::<span class="title function_ invoke__">read_volatile</span>(&amp;BBB) == <span class="number">0</span> &#123;&#125;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">sum</span>: <span class="type">u32</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            for i in [0,COUNT)[::-1]:</span></span><br><span class="line"><span class="comment">                sum += AAA[i]</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> (<span class="number">0</span>..COUNT).<span class="title function_ invoke__">rev</span>() &#123;</span><br><span class="line">            sum += *AAA.<span class="title function_ invoke__">offset</span>(i <span class="keyword">as</span> <span class="type">isize</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> sum != COUNT &#123;</span><br><span class="line">            wmm_count += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">match</span> wmm_count &#123;</span><br><span class="line">                <span class="number">1</span> =&gt; &#123;</span><br><span class="line">                    <span class="title function_ invoke__">place_inp_data</span>();</span><br><span class="line">                    <span class="keyword">if</span> <span class="title function_ invoke__">check_inp_data</span>() &#123;</span><br><span class="line">                        wmm_count += <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="number">2</span> =&gt; &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="variable">ret</span> = <span class="title function_ invoke__">solve</span>();</span><br><span class="line">                    <span class="keyword">if</span> ret == <span class="number">0.0</span> &#123;</span><br><span class="line">                        succ_flag += <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="number">3</span> =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> <span class="title function_ invoke__">check_result</span>() &#123;</span><br><span class="line">                        succ_flag += <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                _ =&gt; &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        LOOP = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 读取 LOOP 的最新值，如果为 1 则等待</span></span><br><span class="line">        <span class="keyword">while</span> ptr::<span class="title function_ invoke__">read_volatile</span>(&amp;LOOP) == <span class="number">1</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 启动和管理线程的扩展库</span></span><br><span class="line">    <span class="keyword">use</span> std::os::unix::thread::JoinHandleExt;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="comment">// 180s之后，执行handle_alarm函数</span></span><br><span class="line">        libc::<span class="title function_ invoke__">alarm</span>(<span class="number">180</span>);</span><br><span class="line">        libc::<span class="title function_ invoke__">signal</span>(libc::SIGALRM, handle_alarm <span class="keyword">as</span> <span class="type">usize</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">input_data</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">th1</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">th2</span>;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="comment">// move表示将所有捕获的变量移动到闭包内部</span></span><br><span class="line">        <span class="comment">// 创建新线程，返回句柄th1，并运行move+thread1()</span></span><br><span class="line">        th1 = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || <span class="title function_ invoke__">thread1</span>());</span><br><span class="line">        th2 = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || <span class="title function_ invoke__">thread2</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">num_cores</span>: <span class="type">i64</span>;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        num_cores = libc::<span class="title function_ invoke__">sysconf</span>(libc::_SC_NPROCESSORS_CONF);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">unsafe</span> &#123; succ_flag &lt; <span class="number">3</span> &#125; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">cpuid</span> = rand::<span class="title function_ invoke__">thread_rng</span>().<span class="title function_ invoke__">gen_range</span>(<span class="number">0</span>..num_cores);</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cpuset</span>: libc::cpu_set_t = std::mem::<span class="title function_ invoke__">zeroed</span>();</span><br><span class="line">            libc::<span class="title function_ invoke__">CPU_SET</span>(cpuid <span class="keyword">as</span> <span class="type">usize</span>, &amp;<span class="keyword">mut</span> cpuset);</span><br><span class="line">            libc::<span class="title function_ invoke__">pthread_setaffinity_np</span>(</span><br><span class="line">                th1.<span class="title function_ invoke__">as_pthread_t</span>(),</span><br><span class="line">                std::mem::size_of::&lt;libc::cpu_set_t&gt;(),</span><br><span class="line">                &amp;cpuset,</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">cpuid</span> = rand::<span class="title function_ invoke__">thread_rng</span>().<span class="title function_ invoke__">gen_range</span>(<span class="number">0</span>..num_cores);</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cpuset</span>: libc::cpu_set_t = std::mem::<span class="title function_ invoke__">zeroed</span>();</span><br><span class="line">            libc::<span class="title function_ invoke__">CPU_SET</span>(cpuid <span class="keyword">as</span> <span class="type">usize</span>, &amp;<span class="keyword">mut</span> cpuset);</span><br><span class="line">            libc::<span class="title function_ invoke__">pthread_setaffinity_np</span>(</span><br><span class="line">                th2.<span class="title function_ invoke__">as_pthread_t</span>(),</span><br><span class="line">                std::mem::size_of::&lt;libc::cpu_set_t&gt;(),</span><br><span class="line">                &amp;cpuset,</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_micros</span>(<span class="number">500000</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;*CTF&#123;&#123;&#123;&#125;&#125;&#125;&quot;</span>, <span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;inp));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;总结一下：</p>
<p>（1）首先注册定时函数，若3分钟没有结果，则输出错误。</p>
<p>（2）thread1与thread2相互竞争，WMM弱内存模型保证其会在一段时间内执行验证程序。</p>
<p>（3）验证程序使用单纯性算法，具体在<code>gaussian()</code>与<code>pivot()</code>内，但是没具体看，主要是将原理搞懂了。</p>
<p>（4）题目好难。</p>
<h2 id="0x01-GoGpt"><a href="#0x01-GoGpt" class="headerlink" title="0x01 GoGpt"></a>0x01 GoGpt</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">This is a eazy reverse challenge provided by gpt-4. Show me if you can win over AI !</span><br><span class="line">unzip password: gpt4</span><br><span class="line">Notice: this file may be reported as malicious, please don’t worry about it. It does not contain any malicious code.</span><br><span class="line">这是 gpt-4 提供的简单反向挑战。 告诉我你是否能战胜人工智能！</span><br><span class="line">注意：此文件可能会被报告为恶意文件，请不要担心。 它不包含任何恶意代码。</span><br></pre></td></tr></table></figure>
<p>&emsp;64位go。go_parser处理一波。非常简单的逻辑：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"># @Time  : 2023/09/13 12:41:14</span></span><br><span class="line"><span class="string"># @Author: wd-2711</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">arg = <span class="string">&quot;TcR@3t_3hp_5_G1H&quot;</span></span><br><span class="line">res = <span class="string">&quot;fiAGBkgXN3McFy9hAHRfCwYaIjQCRDFsXC8ZYBFmEDU=&quot;</span>.encode()</span><br><span class="line">res = base64.b64decode(res)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(res)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(res[i]^<span class="built_in">ord</span>(arg[i%<span class="number">16</span>])), end = <span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># *CTF&#123;ch@tgpT_3nCRypt10n_4_FUN!!&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="0x02-ez-code"><a href="#0x02-ez-code" class="headerlink" title="0x02 ez_code"></a>0x02 ez_code</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">小明是一个windows的骨灰级用户，他精通各种脚本语言。有一天他突然发给我一份奇怪的文件，你能帮我看看里面藏了什么吗？</span><br><span class="line">注意：可能存在假flag</span><br><span class="line">请注意，该任务可能存在假flag，请仔细分析</span><br></pre></td></tr></table></figure>
<p>&emsp;plaintext。里面的符号有23种，分别为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;@&#x27;, &#x27;;&#x27;, &#x27;&#125;&#x27;, &#x27;$&#x27;, &#x27;&#123;&#x27;, &#x27;)&#x27;, &#x27;]&#x27;, &#x27;%&#x27;, &quot;&#x27;&quot;, &#x27;*&#x27;, &#x27;(&#x27;, &#x27;?&#x27;, &#x27;|&#x27;, &#x27;!&#x27;, &#x27; &#x27;, &#x27;#&#x27;, &#x27;`&#x27;, &#x27;&quot;&#x27;, &#x27;+&#x27;, &#x27;-&#x27;, &#x27;[&#x27;, &#x27;=&#x27;, &#x27;.&#x27;&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;猜测应该是github上某个项目。找了好久没找到（咋搜索的啊），看wp。wp中说是powershell混淆，日了狗。将chall另存为chall.ps1并执行，输出<code>Do you konw PWSH(powershell)?</code>。</p>
<p>&emsp;首先尝试使用PowerShell日志去混淆，但是一直抓不到日志。使用<a target="_blank" rel="noopener" href="https://github.com/Malandrone/PowerDecode">PowerDecode</a>解码，得到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Function A&#123;</span><br><span class="line">    [CmdletBinding()] param(</span><br><span class="line">        [Parameter(Position = 0)]</span><br><span class="line">        [String]</span><br><span class="line">        $param1</span><br><span class="line">    )</span><br><span class="line">    $result = [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($param1))</span><br><span class="line">    return $result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Function B=&#123;</span><br><span class="line">    [CmdletBinding()] param(</span><br><span class="line">        [Parameter(Position = 0)]</span><br><span class="line">        [String]</span><br><span class="line">        $param1</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    $param1 = A -param1 $param1</span><br><span class="line">    $result  = [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($param1))</span><br><span class="line">    $result | out-null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">B = (&quot;S21OMFpudG9hR2hmY0hkemFGOXBjMTlsWVhONVgzSnBaMmgwUDMwPQ==&quot;)</span><br><span class="line">echo &quot;Do you konw PWSH?&quot;</span><br></pre></td></tr></table></figure>
<p>&emsp;两次decode之后是<code>*ctf&#123;hhh_pwsh_is_easy_right?&#125;</code>，这是假的flag。</p>
<p>&emsp;看<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_54894802/article/details/132056771">wp</a>，使用ISE下断点，并<strong>通过<code>$&#123;@*&#125;</code>这条特殊用法，将参数列表作为一个数组展开，然后使用通配符<code>*</code>将数组中的每个元素进行展开，让其解混淆。</strong>如下所示：</p>
<p><img src="/images/starCTF2023/image-20230913170351801.png" alt="image-20230913170351801" style="zoom:67%;" /></p>
<p>&emsp;因此，可以猜出：程序主逻辑并不在脚本里，而是在参数列表中。将输出的参数列表保存到<code>command.txt</code>，并转为程序，脚本如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"># @Time  : 2023/09/13 12:50:10</span></span><br><span class="line"><span class="string"># @Author: wd-2711</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;C:\\Users\\23957\\Desktop\\ez_code\\command.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read()</span><br><span class="line"></span><br><span class="line">pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;\[CHar\]\d+&#x27;</span>)</span><br><span class="line">m = pattern.findall(data)</span><br><span class="line">program = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> mm <span class="keyword">in</span> m:</span><br><span class="line">    mm = <span class="built_in">chr</span>(<span class="built_in">int</span>(mm[<span class="number">6</span>:], <span class="number">10</span>))</span><br><span class="line">    program += mm</span><br><span class="line"><span class="built_in">print</span>(program)</span><br></pre></td></tr></table></figure>
<p>&emsp;得到：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">chiper</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.d = <span class="number">0x87654321</span></span><br><span class="line">        k0 = <span class="number">0x67452301</span></span><br><span class="line">        k1 = <span class="number">0xefcdab89</span></span><br><span class="line">        k2 = <span class="number">0x98badcfe</span></span><br><span class="line">        k3 = <span class="number">0x10325476</span></span><br><span class="line">        self.k = [k0, k1, k2, k3]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">e</span>(<span class="params">self, n, v</span>):</span><br><span class="line">        <span class="keyword">from</span> ctypes <span class="keyword">import</span> c_uint32</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">MX</span>(<span class="params">z, y, total, key, p, e</span>):</span><br><span class="line">            temp1 = (z.value &gt;&gt; <span class="number">6</span> ^ y.value &lt;&lt; <span class="number">4</span>) + \</span><br><span class="line">                (y.value &gt;&gt; <span class="number">2</span> ^ z.value &lt;&lt; <span class="number">5</span>)</span><br><span class="line">            temp2 = (total.value ^ y.value) + \</span><br><span class="line">                (key[(p &amp; <span class="number">3</span>) ^ e.value] ^ z.value)</span><br><span class="line">            <span class="keyword">return</span> c_uint32(temp1 ^ temp2)</span><br><span class="line">        key = self.k</span><br><span class="line">        delta = self.d</span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span>//n</span><br><span class="line">        total = c_uint32(<span class="number">0</span>)</span><br><span class="line">        z = c_uint32(v[n-<span class="number">1</span>])</span><br><span class="line">        e = c_uint32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> rounds &gt; <span class="number">0</span>:</span><br><span class="line">            total.value += delta</span><br><span class="line">            e.value = (total.value &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">            <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(n-<span class="number">1</span>):</span><br><span class="line">                y = c_uint32(v[p+<span class="number">1</span>])</span><br><span class="line">                v[p] = c_uint32(v[p] + MX(z, y, total, key, p, e).value).value</span><br><span class="line">                z.value = v[p]</span><br><span class="line">            y = c_uint32(v[<span class="number">0</span>])</span><br><span class="line">            v[n-<span class="number">1</span>] = c_uint32(v[n-<span class="number">1</span>] + MX(z, y, total,</span><br><span class="line">                              key, n-<span class="number">1</span>, e).value).value</span><br><span class="line">            z.value = v[n-<span class="number">1</span>]</span><br><span class="line">            rounds -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> v</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">bytes2ints</span>(<span class="params">self,cs:<span class="built_in">bytes</span></span>)-&gt;<span class="built_in">list</span>:</span><br><span class="line">        new_length=<span class="built_in">len</span>(cs)+(<span class="number">8</span>-<span class="built_in">len</span>(cs)%<span class="number">8</span>)%<span class="number">8</span></span><br><span class="line">        barray=cs.ljust(new_length,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">        i=<span class="number">0</span></span><br><span class="line">        v=[]</span><br><span class="line">        <span class="keyword">while</span> i &lt; new_length:</span><br><span class="line">            v0 = <span class="built_in">int</span>.from_bytes(barray[i:i+<span class="number">4</span>], <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">            v1 = <span class="built_in">int</span>.from_bytes(barray[i+<span class="number">4</span>:i+<span class="number">8</span>], <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">            v.append(v0)</span><br><span class="line">            v.append(v1)</span><br><span class="line">            i += <span class="number">8</span></span><br><span class="line">        <span class="keyword">return</span> v</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">instr:<span class="built_in">str</span>,checklist:<span class="built_in">list</span></span>)-&gt;<span class="built_in">int</span>:</span><br><span class="line">    length=<span class="built_in">len</span>(instr)</span><br><span class="line">    <span class="keyword">if</span> length%<span class="number">8</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Incorrect format.&quot;</span>)</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">    c=chiper()</span><br><span class="line">    v = c.bytes2ints(instr.encode())</span><br><span class="line">    output=<span class="built_in">list</span>(c.e(<span class="built_in">len</span>(v),v))</span><br><span class="line">    i=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(i&lt;<span class="built_in">len</span>(checklist)):</span><br><span class="line">        <span class="keyword">if</span> i&lt;<span class="built_in">len</span>(output) <span class="keyword">and</span> output[i]==checklist[i]:</span><br><span class="line">            i+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> i==<span class="built_in">len</span>(checklist):</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>    </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ans=[<span class="number">1374278842</span>, <span class="number">2136006540</span>, <span class="number">4191056815</span>, <span class="number">3248881376</span>]</span><br><span class="line">    <span class="comment"># generateRes()</span></span><br><span class="line">    flag=<span class="built_in">input</span>(<span class="string">&#x27;Please input flag:&#x27;</span>)</span><br><span class="line">    res=check(flag,ans)</span><br><span class="line">    <span class="keyword">if</span> res:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Congratulations, you&#x27;ve got the flag!&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Flag is *ctf&#123;your_input&#125;!&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Nope,try again!&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>&emsp;魔改的xxtea，解密脚本为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELTA 0x87654321</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MX (((z&gt;&gt;6^y<span class="string">&lt;&lt;4) + (y&gt;</span>&gt;2^z&lt;&lt;5)) ^ ((sum^y) + (key[(p&amp;3)^e] ^ z)))  </span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">btea</span><span class="params">(<span class="type">uint32_t</span> *v, <span class="type">int</span> n, <span class="type">uint32_t</span> <span class="type">const</span> key[<span class="number">4</span>])</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="type">uint32_t</span> y, z, sum;  </span><br><span class="line">    <span class="type">unsigned</span> p, rounds, e;  </span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">1</span>)            <span class="comment">/* Coding Part */</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span>/n;  </span><br><span class="line">        sum = <span class="number">0</span>;  </span><br><span class="line">        z = v[n<span class="number">-1</span>];  </span><br><span class="line">        <span class="keyword">do</span>  </span><br><span class="line">        &#123;  </span><br><span class="line">            sum += DELTA;  </span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;  </span><br><span class="line">            <span class="keyword">for</span> (p=<span class="number">0</span>; p&lt;n<span class="number">-1</span>; p++)  </span><br><span class="line">            &#123;  </span><br><span class="line">                y = v[p+<span class="number">1</span>];  </span><br><span class="line">                z = v[p] += MX;  </span><br><span class="line">            &#125;  </span><br><span class="line">            y = v[<span class="number">0</span>];  </span><br><span class="line">            z = v[n<span class="number">-1</span>] += MX;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">while</span> (--rounds);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n &lt; <span class="number">-1</span>)      <span class="comment">/* Decoding Part */</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        n = -n;  </span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span>/n;  </span><br><span class="line">        sum = rounds*DELTA;  </span><br><span class="line">        y = v[<span class="number">0</span>];  </span><br><span class="line">        <span class="keyword">do</span>  </span><br><span class="line">        &#123;  </span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;  </span><br><span class="line">            <span class="keyword">for</span> (p=n<span class="number">-1</span>; p&gt;<span class="number">0</span>; p--)  </span><br><span class="line">            &#123;  </span><br><span class="line">                z = v[p<span class="number">-1</span>];  </span><br><span class="line">                y = v[p] -= MX;  </span><br><span class="line">            &#125;  </span><br><span class="line">            z = v[n<span class="number">-1</span>];  </span><br><span class="line">            y = v[<span class="number">0</span>] -= MX;  </span><br><span class="line">            sum -= DELTA;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">while</span> (--rounds);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="type">uint32_t</span> v[<span class="number">4</span>]= &#123;<span class="number">1374278842</span>, <span class="number">2136006540</span>, <span class="number">4191056815</span>, <span class="number">3248881376</span>&#125;;  </span><br><span class="line">    <span class="type">uint32_t</span> <span class="type">const</span> k[<span class="number">4</span>]= &#123;<span class="number">0x67452301</span>,<span class="number">0xefcdab89</span>,<span class="number">0x98badcfe</span>,<span class="number">0x10325476</span>&#125;;  </span><br><span class="line">    <span class="type">int</span> n=<span class="number">4</span>; <span class="comment">//n的绝对值表示v的长度，取正表示加密，取负表示解密  </span></span><br><span class="line">    <span class="built_in">btea</span>(v, -n, k);  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;解密后的数据：%u %u %u %u\n&quot;</span>,v[<span class="number">0</span>],v[<span class="number">1</span>],v[<span class="number">2</span>],v[<span class="number">3</span>]);  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 解密后的数据：1632980857 812069746 1950368879 1211463504</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"># @Time  : 2023/09/13 17:38:15</span></span><br><span class="line"><span class="string"># @Author: wd-2711</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">data = [<span class="number">1632980857</span>,<span class="number">812069746</span>,<span class="number">1950368879</span>,<span class="number">1211463504</span>]</span><br><span class="line"><span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">    d = <span class="built_in">hex</span>(d)[<span class="number">2</span>:]</span><br><span class="line">    cc = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        c = <span class="built_in">chr</span>(<span class="built_in">int</span>(d[i*<span class="number">2</span>:i*<span class="number">2</span>+<span class="number">2</span>],<span class="number">16</span>))</span><br><span class="line">        cc = c + cc</span><br><span class="line">    <span class="built_in">print</span>(cc, end = <span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># yOUar3g0oD@tPw5H</span></span><br></pre></td></tr></table></figure>
<p>&emsp;最终flag为<code>*CTF&#123;yOUar3g0oD@tPw5H&#125;</code>。</p>
<h2 id="0x03-flagfile"><a href="#0x03-flagfile" class="headerlink" title="0x03 flagfile"></a>0x03 flagfile</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag format: flag&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;其中由<code>flag</code>（空文件）、<code>flag.mgc</code>（magic？）、<code>readme.txt</code>。<code>readme.txt</code>内容为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">生成您自己的 flag 文件，使用 file 命令进行验证，如下所示：</span><br><span class="line">$ file -m flag.mgc flag</span><br><span class="line">flag: yes, it&#x27;s a flag!</span><br><span class="line">$ file --version</span><br><span class="line">file-5.41</span><br><span class="line">magic file from /usr/share/file/magic</span><br></pre></td></tr></table></figure>
<p>&emsp;思路：（1）找到这样的 file 命令行程序。（2）搞清<code>file -m</code>的原理。</p>
<p>&emsp;在<a target="_blank" rel="noopener" href="https://www.linuxfromscratch.org/lfs/view/11.1/chapter06/file.html">链接1</a>安装<code>file-5.41</code>，在<a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/lfs/lfs-packages/11.1-rc1/">链接2</a>下载<code>file-5.41</code>。但是出问题，搜索发现使用的是ubuntu20.04，好像得用22.04才行。弄完之后，输出：</p>
<p><img src="/images/starCTF2023/image-20230920221215302.png" alt="image-20230920221215302" style="zoom:67%;" /></p>
<p>&emsp;搜索了一波<code>file -m</code>，发现是这样的：<code>file -m aa.mgc bb</code>，<code>aa.mgc</code>是格式文件，就像010editor的模板文件。我猜测，是将flag文件中放入东西，然后使用<code>flag.mgc</code>模板文件判断输入是否正确。</p>
<p>&emsp;gdb调试一波。结合源码，可以发现：</p>
<p><img src="/images/starCTF2023/image-20230921140300854.png" alt="image-20230921140300854" style="zoom:67%;" /></p>
<p>&emsp;其中，<code>applyparam</code>表示要将<code>mgc</code>文件读取到<code>magic_t</code>对象中。但是我们的选项中没有添加<code>-f</code>，所以接着往下看hh。看到貌似处理函数<code>process()</code>：</p>
<p><img src="/images/starCTF2023/image-20230921163206739.png" alt="image-20230921163206739" style="zoom:67%;" /></p>
<p>&emsp;跟进<code>process</code>的源码：</p>
<p><img src="/images/starCTF2023/image-20230921163340604.png" alt="image-20230921163340604" style="zoom:67%;" /></p>
<p>&emsp;经过调试，感觉需要关注<code>type</code>字段，于是跟进<code>magic_file</code>函数，在<code>magic_file</code>结束后，会输出文件类型。进而跟进到<code>file_or_fd</code>函数。在其中，有：</p>
<p><img src="/images/starCTF2023/image-20230921183450713.png" alt="image-20230921183450713" style="zoom:67%;" /></p>
<p>&emsp;<code>file_fsmagic</code>函数表示：在文件中查找魔术值（magic value）。经过调试，此函数返回0，此时在flag文件中存放的<code>12345678</code>。审计一下<code>file_fsmagic</code>函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ms 是 magic_set</span></span><br><span class="line"><span class="comment">// fn 是要匹配的文件名</span></span><br><span class="line"><span class="comment">// sb 是文件统计信息</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAGIC_MIME		0x0000410</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="type">int</span> <span class="title">file_fsmagic</span><span class="params">(<span class="keyword">struct</span> magic_set *ms, <span class="type">const</span> <span class="type">char</span> *fn, <span class="keyword">struct</span> stat *sb)</span> </span>&#123;</span><br><span class="line">	<span class="type">int</span> ret, did = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> mime = ms-&gt;flags &amp; MAGIC_MIME;</span><br><span class="line">	<span class="type">int</span> silent = ms-&gt;flags &amp; (MAGIC_APPLE|MAGIC_EXTENSION);</span><br><span class="line">	<span class="keyword">if</span> (fn == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMA <span class="string">&quot;&quot;</span></span></span><br><span class="line">	ret = <span class="built_in">stat</span>(fn, sb);	<span class="comment">/* don&#x27;t merge into if; see &quot;ret =&quot; above */</span></span><br><span class="line">    ...</span><br><span class="line">	ret = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (!mime &amp;&amp; !silent) &#123;</span><br><span class="line">    ...</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">switch</span> (sb-&gt;st_mode &amp; S_IFMT) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> S_IFREG:</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             常规文件</span></span><br><span class="line"><span class="comment">             （1）当使用 stat() 函数获取文件大小时，如果文件大小为零（空文件），我们可以跳过打开和读取文件的操作。</span></span><br><span class="line"><span class="comment">             （2）如果用户在命令行中使用了 -s 选项，我们将跳过（1）优化。</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="keyword">if</span> ((ms-&gt;flags &amp; MAGIC_DEVICES) == <span class="number">0</span> &amp;&amp; sb-&gt;st_size == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mime) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">handle_mime</span>(ms, mime, <span class="string">&quot;x-empty&quot;</span>) == <span class="number">-1</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">file_printf</span>(ms, <span class="string">&quot;%sempty&quot;</span>, COMMA) == <span class="number">-1</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ret = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">file_error</span>(ms, <span class="number">0</span>, <span class="string">&quot;invalid mode 0%o&quot;</span>, sb-&gt;st_mode);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            <span class="comment">/*NOTREACHED*/</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!silent &amp;&amp; !mime &amp;&amp; did &amp;&amp; ret == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (<span class="built_in">file_printf</span>(ms, <span class="string">&quot; &quot;</span>) == <span class="number">-1</span>)</span><br><span class="line">		    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (ret == <span class="number">1</span> &amp;&amp; silent)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;调迷糊了。看wp。</p>
<h3 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h3><p>&emsp;wp并不是调试出来的，而是看文档得出的。好，我也看文档，<a target="_blank" rel="noopener" href="https://www.systutorials.com/docs/linux/man/5-magic/">链接</a>。</p>
<p>&emsp;<code>file-5.41</code>的<code>magic</code>文件语法，举几个例子：</p>
<p>（1）例1：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0           string  MZ</span><br><span class="line">&gt;0x18       leshort &lt;0x40   MZ executable (MS-DOS)</span><br><span class="line">&gt;0x18       leshort &gt;0x3f</span><br><span class="line">&gt;&gt;(0x3c.l)  string  PE\0\0  PE executable (MS-Windows)</span><br><span class="line">&gt;&gt;(0x3c.l)  string  LX\0\0  LX executable (OS/2)</span><br></pre></td></tr></table></figure>
<p>&emsp;解释如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if 检查偏移地址 0 是否以字符串 &quot;MZ&quot; 开头:</span><br><span class="line">    if 偏移量为 0x18 处的字段是否是一个小端序的 16 位短整数，并且其值小于 0x40:</span><br><span class="line">    	标识为 MZ executable (MS-DOS)</span><br><span class="line">    else if 偏移量为 0x18 处的字段是否是一个小端序的 16 位短整数，并且其值大于 0x3f:</span><br><span class="line">    	if 偏移量 0x3c 处读取一个长整数值，此值为 &quot;PE\0\0&quot;:</span><br><span class="line">    		标识为 PE executable (MS-Windows)</span><br><span class="line">    	else if 偏移量 0x3c 处读取一个长整数值，此值为 &quot;LX\0\0&quot;:</span><br><span class="line">    		标识为 LX executable (OS/2)</span><br></pre></td></tr></table></figure>
<p>（2）例2：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0           string  MZ</span><br><span class="line">&gt;0x18       leshort &lt;0x40</span><br><span class="line">&gt;&gt;(4.s*512) leshort 0x014c  COFF executable (MS-DOS, DJGPP)</span><br><span class="line">&gt;&gt;(4.s*512) leshort !0x014c MZ executable (MS-DOS)</span><br></pre></td></tr></table></figure>
<p>&emsp;解释如下，其中<code>(4.s*512)=hex(4*512)=0x400</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if 检查偏移地址 0 是否以字符串 &quot;MZ&quot; 开头:</span><br><span class="line">    if 偏移量为 0x18 处的字段是否是一个小端序的 16 位短整数，并且其值小于 0x40:</span><br><span class="line">    	if 偏移量 0x400 处读取一个小端序的 16 位短整数，此值为 0x014c:</span><br><span class="line">    		标识为 COFF executable (MS-DOS, DJGPP)</span><br><span class="line">    	else if 偏移量 0x400 处读取一个小端序的 16 位短整数，此值不为 0x014c:</span><br><span class="line">    		标识为 MZ executable (MS-DOS)</span><br></pre></td></tr></table></figure>
<p>（3）例3：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0           string  MZ</span><br><span class="line">&gt;0x18       leshort &gt;0x3f</span><br><span class="line">&gt;&gt;(0x3c.l)  string  PE\0\0    PE executable (MS-Windows)</span><br><span class="line">&gt;&gt;&gt;&amp;0       leshort 0x14c     for Intel 80386</span><br><span class="line">&gt;&gt;&gt;&amp;0       leshort 0x184     for DEC Alpha</span><br></pre></td></tr></table></figure>
<p>&emsp;解释如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if 检查偏移地址 0 是否以字符串 &quot;MZ&quot; 开头:</span><br><span class="line">    if 偏移量为 0x18 处的字段是否是一个小端序的 16 位短整数，并且其值大于 0x3f:</span><br><span class="line">    	if 偏移量 0x3c 处读取一个长整数值，此值为 &quot;PE\0\0&quot;:</span><br><span class="line">    		标识为 PE executable (MS-Windows)</span><br><span class="line">			if 在当前位置（偏移量为 0）读取一个小端序的 16 位短整数字段，并检查其值是否为 0x14c:</span><br><span class="line">				标识为 for Intel 80386</span><br><span class="line">			else if 在当前位置（偏移量为 0）读取一个小端序的 16 位短整数字段，并检查其值是否为 0x184:</span><br><span class="line">				标识为 for DEC Alpha</span><br></pre></td></tr></table></figure>
<p>（4）例4：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0             string  MZ</span><br><span class="line">&gt;0x18         leshort &lt;0x40</span><br><span class="line">&gt;&gt;(4.s*512)   leshort !0x014c MZ executable (MS-DOS)</span><br><span class="line">&gt;&gt;&gt;&amp;(2.s-514) string  LE      LE executable (MS Windows VxD driver)</span><br></pre></td></tr></table></figure>
<p>&emsp;解释如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if 检查偏移地址 0 是否以字符串 &quot;MZ&quot; 开头:</span><br><span class="line">    if 偏移量为 0x18 处的字段是否是一个小端序的 16 位短整数，并且其值小于 0x40:</span><br><span class="line">    	if 偏移量 0x400 处读取一个小端序的 16 位短整数字段，检查此值是否不为 0x014c:</span><br><span class="line">    		标识为 MZ executable (MS-DOS)</span><br><span class="line">    		if 在当前位置-512 处读取一个长整数值，此值为 &quot;LE&quot;:</span><br><span class="line">    			标识为 LE executable (MS Windows VxD driver)</span><br></pre></td></tr></table></figure>
<p>（5）例5：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0                 string  MZ</span><br><span class="line">&gt;0x18             leshort &gt;0x3f</span><br><span class="line">&gt;&gt;(0x3c.l)        string  LE\0\0  LE executable (MS-Windows)</span><br><span class="line">&gt;&gt;&gt;(&amp;0x7c.l+0x26) string  UPX     \b, UPX compressed</span><br></pre></td></tr></table></figure>
<p>&emsp;解释如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if 检查偏移地址 0 是否以字符串 &quot;MZ&quot; 开头:</span><br><span class="line">    if 偏移量为 0x18 处的字段是否是一个小端序的 16 位短整数，并且其值大于 0x3f:</span><br><span class="line">		if 偏移量 0x3c 处读取一个长整数值，此值为 &quot;LE\0\0&quot;:</span><br><span class="line">			标识为 LE executable (MS-Windows)</span><br><span class="line">			if 在当前位置+0x7c+0x26 处读取一个长整数值，此值为 &quot;UPX&quot;:</span><br><span class="line">				标识为 \b, UPX compressed</span><br></pre></td></tr></table></figure>
<p>（6）例6：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0                string  MZ</span><br><span class="line">&gt;0x18            leshort &gt;0x3f</span><br><span class="line">&gt;&gt;(0x3c.l)       string  LE\0\0 LE executable (MS-Windows)</span><br><span class="line">&gt;&gt;&gt;&amp;(&amp;0x54.l-3)  string  UNACE  \b, ACE self-extracting archive</span><br></pre></td></tr></table></figure>
<p>&emsp;解释如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if 检查偏移地址 0 是否以字符串 &quot;MZ&quot; 开头:</span><br><span class="line">    if 偏移量为 0x18 处的字段是否是一个小端序的 16 位短整数，并且其值大于 0x3f:</span><br><span class="line">		if 偏移量 0x3c 处读取一个长整数值，此值为 &quot;LE\0\0&quot;:</span><br><span class="line">			标识为 LE executable (MS-Windows)</span><br><span class="line">			if 在当前位置+0x51 处读取一个长整数值，此值为 &quot;UNACE&quot;:</span><br><span class="line">				标识为 \b, ACE self-extracting archive</span><br></pre></td></tr></table></figure>
<p>（7）例7：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0                 string       MZ</span><br><span class="line">&gt;0x18             leshort      &gt;0x3f</span><br><span class="line">&gt;&gt;(0x3c.l)        string       PE\0\0 PE executable (MS-Windows)</span><br><span class="line">&gt;&gt;&gt;&amp;0xf4          search/0x140 .idata</span><br><span class="line">&gt;&gt;&gt;&gt;(&amp;0xe.l+(-4)) string       PK\3\4 \b, ZIP self-extracting archive</span><br></pre></td></tr></table></figure>
<p>&emsp;解释如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if 检查偏移地址 0 是否以字符串 &quot;MZ&quot; 开头:</span><br><span class="line">    if 偏移量为 0x18 处的字段是否是一个小端序的 16 位短整数，并且其值大于 0x3f:</span><br><span class="line">		if 偏移量 0x3c 处读取一个长整数值，此值为 &quot;PE\0\0&quot;:</span><br><span class="line">			标识为 PE executable (MS-Windows)</span><br><span class="line">			if 在当前位置+0xf4 ，向后搜索长度为 0x140 字节的数据块，并找到 &quot;.idata&quot;:</span><br><span class="line">				if 在当前位置-4 处读取一个长整数值，此值为 &quot;PK\3\4&quot;:</span><br><span class="line">			处读取一个长整数值，此值为 &quot;UNACE&quot;:</span><br><span class="line">				标识为 \b, ZIP self-extracting archive</span><br></pre></td></tr></table></figure>
<p>（8）例8：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;18     clear</span><br><span class="line">&gt;18     lelong  1       one</span><br><span class="line">&gt;18     lelong  2       two</span><br><span class="line">&gt;18     default x</span><br><span class="line">&gt;&gt;18    lelong  x       unmatched 0x%x</span><br></pre></td></tr></table></figure>
<p>&emsp;解释如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">偏移地址 0x18 清除之前设置的条件</span><br><span class="line">if 偏移地址 0x18 检查一个小端序的长整数，且该值为 1:</span><br><span class="line">	标识为 one</span><br><span class="line">else if 偏移地址 0x18 检查一个小端序的长整数，且该值为 2:</span><br><span class="line">	标识为 two</span><br><span class="line">else:</span><br><span class="line">	偏移地址 0x18 设置为 &quot;x&quot;</span><br><span class="line">	if 偏移地址 0x18 检查一个小端序的长整数，且该值为 &quot;x&quot;:</span><br><span class="line">		标识为 unmatched 0x%x</span><br></pre></td></tr></table></figure>
<p>&emsp;关键问题是，<code>flag.mgc</code>如何转成上述这样的格式？</p>
<p>&emsp;就要用到如下脚本（<code>flag.mgc (binary)--&gt; flag.magic (code)</code>）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hexdump</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;filepath&quot;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每次 0x178 字节，但是每 1 行是 0x30 bytes</span></span><br><span class="line">b = f.read(<span class="number">0x178</span>)</span><br><span class="line">indexes = []</span><br><span class="line">table = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    b = f.read(<span class="number">0x178</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(b) != <span class="number">0x178</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    line = b[:<span class="number">0x30</span>]</span><br><span class="line">    <span class="comment"># type</span></span><br><span class="line">    _<span class="built_in">type</span> = line[<span class="number">6</span>]</span><br><span class="line">    <span class="comment"># offset</span></span><br><span class="line">    <span class="comment"># line 的偏移量 0x0c 处开始，按照小端序解析数据，将该位置的 4 个字节解析为一个无符号的 32 位整数</span></span><br><span class="line">    off = struct.unpack_from(<span class="string">&#x27;&lt;I&#x27;</span>, line, <span class="number">0x0c</span>)[<span class="number">0</span>]</span><br><span class="line">    s = <span class="string">f&#x27;type: <span class="subst">&#123;_<span class="built_in">type</span>:02X&#125;</span>, off: <span class="subst">&#123;off:02X&#125;</span>&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> _<span class="built_in">type</span> == <span class="number">5</span>:</span><br><span class="line">        <span class="comment"># 5 代表解析 line[0x20:] 的字符串</span></span><br><span class="line">        s += <span class="string">&#x27;, str: &#x27;</span>+line[<span class="number">0x20</span>:].decode()</span><br><span class="line">    <span class="keyword">elif</span> _<span class="built_in">type</span> == <span class="number">1</span>:</span><br><span class="line">        <span class="comment"># 1 代表 line[0x18]^line[0x20] 异或的 byte</span></span><br><span class="line">        n1, n2 = line[<span class="number">0x18</span>], line[<span class="number">0x20</span>]</span><br><span class="line">        v = n1 ^ n2</span><br><span class="line">        s += <span class="string">f&#x27;, byte: <span class="subst">&#123;n1:02X&#125;</span> <span class="subst">&#123;n2:02X&#125;</span> <span class="subst">&#123;v:02X&#125;</span> <span class="subst">&#123;<span class="built_in">chr</span>(v)&#125;</span>&#x27;</span></span><br><span class="line">        table += <span class="built_in">chr</span>(v)</span><br><span class="line">    <span class="keyword">elif</span> _<span class="built_in">type</span> == <span class="number">10</span>:</span><br><span class="line">        <span class="comment"># 10 代表 line[0x18]^line[0x20] 异或的 16 比特数</span></span><br><span class="line">        n1, n2 = line[<span class="number">0x18</span>], line[<span class="number">0x20</span>] </span><br><span class="line">        v = n1 ^ n2</span><br><span class="line">        s += <span class="string">f&#x27;, leshort: <span class="subst">&#123;n1:02X&#125;</span> <span class="subst">&#123;n2:02X&#125;</span> <span class="subst">&#123;v:02X&#125;</span> <span class="subst">&#123;v&#125;</span>&#x27;</span></span><br><span class="line">        indexes.append(v)</span><br><span class="line">    <span class="built_in">print</span>(s)</span><br></pre></td></tr></table></figure>
<p>&emsp;上述脚本中，<code>table</code>为字符，<code>index</code>为字符所在的位置。最后可以得到flag：<code>flag&#123;_oh_yes_you_got_the_flag___^_^__&#125;</code>。</p>
<p>&emsp;<strong>总结：不知道他这脚本咋写出来的，感觉主要得靠猜（可能是我看的不仔细吧呜呜）</strong></p>
<h2 id="0x04-boring-cipher"><a href="#0x04-boring-cipher" class="headerlink" title="0x04 boring cipher"></a>0x04 boring cipher</h2><p>&emsp;有一个<code>cipher-release</code>，输入字符串，输出与<code>cipher-release</code>同样大小的加密文件。看到用了llvm混淆+rust，感觉到了shit。</p>
<p>&emsp;题目正向逻辑非常简单：</p>
<p>（1）输入32位字符串，根据每8位输入将<code>0-&gt;15</code>做混淆，混淆20轮。</p>
<p>（2）根据<code>0-&gt;15</code>的混淆对<code>data[256]</code>做混淆，混淆15轮。</p>
<p>（3）根据<code>data[256]</code>对当前文件做<code>self_exe[ii] += data[self_exe[ii]]</code>处理。</p>
<p>&emsp;相关正向脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1)(2) 步对输入的混淆，得到 data[256]</span></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line">data = []</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;D:\\Code\\Python\\re\\boringcipher\\boringcipher-data&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    d = f.read()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1260</span>):</span><br><span class="line">    dd = d[i*<span class="number">4</span>:(i+<span class="number">1</span>)*<span class="number">4</span>]</span><br><span class="line">    dd = struct.unpack_from(<span class="string">&#x27;&lt;I&#x27;</span>, dd, <span class="number">0</span>)[<span class="number">0</span>]</span><br><span class="line">    data.append(dd)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">    v1 = <span class="number">0</span></span><br><span class="line">    v46 = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line">    v31 = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 输入</span></span><br><span class="line">    inp_origin = <span class="string">&quot;!eX`vLk maQt;$_!b-2/2 *;U3([+47%&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        inp = inp_origin[<span class="number">8</span>*v1:<span class="number">8</span>*v1+<span class="number">8</span>]</span><br><span class="line">        d = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x15</span>)]</span><br><span class="line">        inp = [<span class="built_in">hex</span>(<span class="built_in">ord</span>(i))[<span class="number">2</span>:] <span class="keyword">for</span> i <span class="keyword">in</span> inp]</span><br><span class="line">        inp = <span class="string">&quot;&quot;</span>.join(inp)</span><br><span class="line">        v4 = <span class="built_in">int</span>(inp, <span class="number">16</span>)</span><br><span class="line">        v7 = [<span class="number">2432902008176640000</span>,<span class="number">121645100408832000</span>,<span class="number">6402373705728000</span>,<span class="number">355687428096000</span>,<span class="number">20922789888000</span>,<span class="number">1307674368000</span>,<span class="number">87178291200</span>,<span class="number">6227020800</span>,<span class="number">479001600</span>,<span class="number">39916800</span>,<span class="number">3628800</span>,<span class="number">362880</span>,<span class="number">40320</span>,<span class="number">5040</span>,<span class="number">720</span>,<span class="number">120</span>,<span class="number">24</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">1</span>]</span><br><span class="line">        jj = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            j = jj + v4 // v7[jj]</span><br><span class="line">            v4 = v4 % v7[jj]</span><br><span class="line">            tmp = d[j]</span><br><span class="line">            d[j] = d[jj]</span><br><span class="line">            d[jj] = tmp           </span><br><span class="line">            jj += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> jj == <span class="number">20</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x15</span>):</span><br><span class="line">            v16 = <span class="number">15</span> * (<span class="number">21</span> * v1 + d[i])</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>):</span><br><span class="line">                tmp = data[v16 + j]</span><br><span class="line">                <span class="keyword">if</span> tmp != <span class="number">0xFFFFFFFF</span>:</span><br><span class="line">                    <span class="keyword">if</span> j == <span class="number">14</span>:</span><br><span class="line">                        v31 = tmp</span><br><span class="line">                    <span class="keyword">if</span> tmp &gt; <span class="number">0xFF</span> <span class="keyword">or</span> j == <span class="number">14</span>:</span><br><span class="line">                        v46[v31] += i</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    v46[tmp] += i      </span><br><span class="line">        v1 += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> v1 == <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">break</span>  </span><br><span class="line">    <span class="built_in">print</span>(d)</span><br><span class="line">    <span class="built_in">print</span>(v46)</span><br><span class="line">    <span class="built_in">print</span>([<span class="built_in">hex</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> v46])</span><br><span class="line">func()</span><br></pre></td></tr></table></figure>
<p>&emsp;应该得到的<code>data[256]</code>数组为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># target data[256]</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;D:\\Code\\Python\\re\\boringcipher\\origin-elf&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    origin_elf = f.read()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;D:\\Code\\Python\\re\\boringcipher\\output&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    output = f.read()</span><br><span class="line"></span><br><span class="line">MIN = -<span class="number">10000000</span></span><br><span class="line">v46 = [MIN <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x8000</span>):</span><br><span class="line">    tmp = output[i] - origin_elf[i]</span><br><span class="line">    <span class="keyword">if</span> v46[origin_elf[i]] == MIN:</span><br><span class="line">        v46[origin_elf[i]] = tmp</span><br><span class="line">    <span class="keyword">elif</span> v46[origin_elf[i]] != tmp:</span><br><span class="line">        <span class="built_in">print</span>(i, v46[origin_elf[i]], tmp)</span><br><span class="line"></span><br><span class="line">miss = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> v46:</span><br><span class="line">    <span class="keyword">if</span> i == MIN:</span><br><span class="line">        miss += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;miss:&quot;</span>, miss)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v46)):</span><br><span class="line">    <span class="keyword">if</span> v46[i] &lt; <span class="number">0</span>:</span><br><span class="line">        v46[i] = <span class="number">0xffffffff</span> - (-v46[i]) + <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(v46)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">[39, 3, 53, 38, 17, 35, 12, 0, 21, 1, 24, 18, 68, 18, 3, 11, 3, 40, 16, 38, 21, 52, 5, 63, 34, 21, 8, 7, 24, 24, 40, 4, 40, 51, 56, 14, 19, 20, 9, 31, 15, 9, 8, 21, 0, 15, 18, 4, 29, 22, 32, 17, 16, 23, 35, 25, 26, 11, 14, 33, 18, 35, 9, 17, 42, 31, 30, 19, 36, 22, 43, 19, 11, 20, 29, 40, 24, 20, 13, 9, 18, 48, 20, 19, 6, 35, 5, 38, 43, 29, 44, 37, 37, 20, 25, 16, 7, 17, 17, 2, 41, 24, 18, 25, 10, 14, 57, 43, 46, 24, 27, 10, 38, 17, 26, 17, 37, 52, 57, 18, 17, 50, 44, 6, 21, 29, 30, 43, 11, 11, 4, 36, 59, 24, 33, 8, 15, 13, 15, 13, 30, 37, 21, 14, 18, 49, 3, 40, 22, 18, 39, 44, 16, 36, 1, 20, 25, 35, 21, 10, 55, 28, 6, 13, 13, 18, 36, 28, 14, 32, 0, 11, 4, 14, 40, 30, 53, 7, 11, 14, 21, 9, 41, 29, 26, 13, 5, 2, 23, 7, 27, 16, 17, 8, 59, 18, 35, 7, 24, 36, 19, 8, 6, 37, 35, 41, 17, 15, 4, 5, 12, 19, 23, 2, 32, 2, 10, 8, 23, 4294967086, 23, 4294967087, 3, 1, 30, 4294967095, 13, 4294967072, 8, 21, 10, 4294967070, 16, 4294967069, 4294967078, 12, 4294967090, 4294967070, 4294967074, 4294967099, 12, 4294967062, 4294967076, 4294967074, 1, 4294967081, 4294967066, 5, 4294967079, 4294967056, 0, 4294967054, 4294967066, 4294967064, 4294967065, 4294967103]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p>&emsp;如何由<code>data[256]</code>得到输入？这步没做出来。看wp（没找到wp..）</p>
<h2 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h2><p>&emsp;拖了好久，终于基本完成了。遇到了 powershell 混淆，rust 等，学习到了很多，仍要再接再厉！</p>

  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2023/08/01/useful-scripts/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> 上一页</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2023/07/23/cpp-reverse-analysis/" type="button" class="btn btn-default ">下一页<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>


	<!-- comment -->
	
<section id="comment">
    <h2 class="title">留言</h2>

    <!-- 
    <div id="disqus_thread" class="ds-thread">
        <script type="text/javascript">
            /**
             * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
             * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
             */
                /*
                 var disqus_config = function () {
                 this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                 this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                 };
                 */
            (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');

                s.src = 'https://https-wd-2711-tech.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by
                Disqus.</a></noscript>
    </div> -->
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <div id="vcomments"></div>
    <script>
        new Valine({
            el: '#vcomments',
            appId: 'wLIJ70s3fPvW8WJPgVVAuWVR-gzGzoHsz',
            appKey: 'NVGqxhUkqtFv2CbwmXXWjCdR'
        })
    </script>

    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2023-07-30 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/re/">re<span>38</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#starCTF2023"><span class="toc-article-text">starCTF2023</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#0x00-SIMPLEX-WMM"><span class="toc-article-text">0x00 SIMPLEX-WMM</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%BC%B1%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B"><span class="toc-article-text">弱内存模型</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#simplex%E7%AE%97%E6%B3%95"><span class="toc-article-text">simplex算法</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%8E%A2%E7%B4%A2"><span class="toc-article-text">探索</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E4%BD%AC%E7%9A%84wp"><span class="toc-article-text">佬的wp</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%86%8D%E6%8E%A2%E7%B4%A2"><span class="toc-article-text">再探索</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#0x01-GoGpt"><span class="toc-article-text">0x01 GoGpt</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#0x02-ez-code"><span class="toc-article-text">0x02 ez_code</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#0x03-flagfile"><span class="toc-article-text">0x03 flagfile</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#wp"><span class="toc-article-text">wp</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#0x04-boring-cipher"><span class="toc-article-text">0x04 boring cipher</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#0x05-%E6%80%BB%E7%BB%93"><span class="toc-article-text">0x05 总结</span></a></li></ol></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>

	<!-- copyright -->
	<div>
    <ul class="post-copyright">
      <li class="post-copyright-author">
      <strong>作者:  </strong>wd-z711</a>
      </li>
      <li class="post-copyright-link">
      <strong>文章链接:  </strong>
      <a href="/" target="_blank" title="">https://wd-2711.tech/</a>
      </li>
      <li class="post-copyright-license">
        <strong>版权声明:   </strong>
        本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
        许可协议。转载请注明出处!
      </li>
    </ul>
  <div>
 	

		


</div><!-- row -->




	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2024 wd-z711
  
      <!-- with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.     -->

     <!-- <script type="text/javascript">
      (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
      (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
      e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
      })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
      
      _st('install','aB-vgeB8gEDrnRJuhceL','2.0.0');
    </script> -->
    </p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
   </html>
